<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMSI Countdown - Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="/live-tracker/manifest-omsi.json"> {/* Adjusted path */}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OMSI Arrivals"> {/* Or your preferred PWA title */}
    <meta name="theme-color" content="#2b5876"> 
    <link rel="apple-touch-icon" href="/live-tracker/assets/icons/apple-touch-icon-180x180.png"> {/* Adjusted path - ensure you have this icon */}

    <style>
        /* Global and Body Styles */
        @font-face {
            font-family: 'NJFont Medium Web';
            src: url('fonts/NJFont-Medium.ttf') format('truetype'); /* Relative path, should be fine */
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        html {
            height: 100%;
        }
        body {
            font-family: 'NJFont Medium Web', sans-serif;
            background: linear-gradient(135deg, #2b5876, #4e4376);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }

        #clock-container {
            text-align: center;
            margin-bottom: 2rem;
            margin-top: 13;!important
            padding-top: 1rem;
        }
        #clock-time {
            font-size: 20vmin;
            font-weight: normal;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
        }
        #clock-date {
            font-size: clamp(1.25rem, 5vmin, 1.75rem);
            opacity: 0.8;
            margin-top: -2.5rem;!important
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        #bus-arrivals-container {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 600px;
            text-align: left;
            position: relative;
            margin-bottom: 1rem;
        }

        #stop-letter-display {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            z-index: 10;
        }
        #stop-letter-display .stop-letter-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: red;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.25rem;
            width: 1.6em;
            height: 1.6em;
            line-height: 1;
            box-sizing: border-box;
            overflow: hidden;
        }
        #stop-letter-display .stop-letter-circle > span {
            display: block;
            line-height: 1;
            white-space: nowrap;
            text-align: center;
            padding: 0.05em;
        }

        #bus-stop-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 0.75rem;
            cursor: pointer;
            text-align: center;
            margin-top: -0.5rem;
        }
        #bus-stop-header:hover .main-stop-name-line,
        #bus-stop-header:hover .stop-name-qualifier {
             filter: brightness(1.2);
        }

        .main-stop-name-line {
            font-size: clamp(1.25rem, 5vmin, 1.75rem);
            font-weight: normal;
            text-align: center;
            line-height: 1.1;
        }
        .stop-name-qualifier {
            font-size: clamp(0.8rem, 3vmin, 1rem);
            font-weight: normal;
            text-align: center;
            opacity: 0.75;
            margin-top: 0.1em;
            line-height: 1;
        }

        #bus-stop-direction {
            font-size: clamp(0.8rem, 3vmin, 1rem);
            font-weight: normal;
            text-align: center;
            opacity: 0.75;
            margin-top: -0.25rem;
            margin-bottom: 0.5rem;
            min-height: 1.2em; 
        }

        .route-tiles-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.25rem 0;
            min-height: 3rem; 
        }

        .route-tile {
            display: inline-block;
            padding: 0.2em 0.55em;
            margin: 0.2em;
            border-radius: 0.25rem;
            font-size: 0.70rem;
            font-weight: normal; 
            color: white;
            text-align: center;
            line-height: 1.3;
            min-width: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
            transition: background-color 0.3s, color 0.3s; 
        }

        #bus-list {
            list-style-type: none !important;
            margin-block-start: 0 !important;
            margin-block-end: 0 !important;
            margin-inline-start: 0 !important;
            margin-inline-end: 0 !important;
            padding-inline-start: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            padding-bottom: 0 !important;
            padding-top: 0.75rem !important; 
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
            height: 152px; 
            overflow-y: auto; 
            position: relative; 
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #bus-list::-webkit-scrollbar {
            display: none !important;
        }

        #bus-list li:not(.loading-message):not(.error-message):not(.no-buses-message):not(.stop-closed-message):not(.system-update-message) {
            display: flex;
            justify-content: space-between; 
            align-items: baseline;
            margin: 0 !important; 
            padding-left: 0 !important;
            padding-right: 0 !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: clamp(0.85rem, 3.2vmin, 1.05rem);
        }
        #bus-list li:last-child {
            border-bottom: none;
        }

        .bus-item-number {
            width: 0.9em; 
            text-align: right;
            margin-right: 1em; 
            flex-shrink: 0; 
        }
        .bus-item-linecode { 
            min-width: 3.5em; 
            margin-right: 0.75em; 
            flex-shrink: 0;
        }
        .bus-item-destination {
            flex-grow: 1; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 0.75em; 
        }
        .bus-item-time {
            min-width: 3.5em; 
            text-align: right;
            flex-shrink: 0;
        }

        .loading-message, .error-message, .no-buses-message, .stop-closed-message, .system-update-message {
            display: block;
            text-align: center;
            width: 100%;
            padding: 1rem; 
            font-style: italic;
            opacity: 0.8;
        }

        body #bus-arrivals-container #bus-list li.stop-closed-message {
            display: block !important;
            width: 100% !important;
            padding: 1rem !important;
            font-style: italic !important;
            opacity: 0.8 !important;
            color: #FFD700 !important;
            font-weight: bold !important;
            font-size: 1.1em !important;
            text-align: center !important;
            background-color: transparent !important;
        }
        .system-update-message {
            color: #FFD700;
            font-weight: bold;
            font-size: 1.0em;
        }

        @keyframes itemSlideUp {
          from { opacity: 0.3; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .bus-item-animate {
          animation: itemSlideUp 4s cubic-bezier(0.25, 0.8, 0.25, 1); 
        }

        #tfl-logo {
            position: absolute !important;
            bottom: 30px !important;
            right: 45px !important;
            width: 150px;
            opacity: 1 !important;
            transition: opacity 0.3s ease;
            z-index: 500;
        }
        #tfl-logo:hover {
            opacity: 1;
        }

        #disclaimer-button {
            position: absolute;
            bottom: 30px;
            left: 45px;
            background-color: rgba(0,0,0,0.3);
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.6rem;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.2s, color 0.2s;
        }
        #disclaimer-button:hover {
            background-color: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.9);
        }
       .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            display: none;
            justify-content: center; align-items: center; z-index: 1040;
        }
        .disclaimer-modal-content {
            background-color: #2d3748; color: #e2e8f0; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 600px;
            max-height: 80vh; overflow-y: auto; position: relative;
            font-size: 0.8rem; line-height: 1.5;
        }
        .disclaimer-modal-content h3 {
            font-size: 1.1rem; font-weight: bold; color: #ffffff; margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;
        }
        .disclaimer-modal-content p { margin-bottom: 0.75rem; }
        .modal-close-button {
            position: absolute; top: 10px; right: 15px; background: none; border: none;
            color: #cbd5e1; font-size: 1.8rem; font-weight: bold; cursor: pointer; line-height: 1;
        }
        .modal-close-button:hover { color: #ffffff; }

        #stop-selection-modal-content {
            background-color: #2d3748; color: #e2e8f0; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 500px;
            max-height: 80vh; display: flex; flex-direction: column; position: relative;
        }
        #stop-selection-modal-content h3 {
            font-size: 1.25rem; font-weight: bold; color: #ffffff; margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.75rem;
        }
        #stop-search-input {
            width: 100%; padding: 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem;
            border: 1px solid #4A5568; background-color: #1A202C; color: #E2E8F0; font-size: 0.9rem;
        }
        #stop-search-input::placeholder { color: #A0AEC0; }
        #available-stops-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #available-stops-list li {
            padding: 0.75rem 0.5rem; border-bottom: 1px solid #4A5568; cursor: pointer;
            transition: background-color 0.15s ease-in-out; font-size: 0.9rem;
        }
        #available-stops-list li:last-child { border-bottom: none; }
        #available-stops-list li:hover { background-color: #4A5568; }
        #available-stops-list::-webkit-scrollbar { width: 8px; } 
        #available-stops-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        #available-stops-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        #available-stops-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        @media (max-height: 300px), (max-width: 300px) {
            body { padding-top: 0; }
            #clock-container {
                margin-top: 0;
                padding-top: 0.5rem;
                margin-bottom: 1rem;
            }
            #clock-time { font-size: 18vmin; }
            #clock-date { font-size: clamp(1rem, 4.5vmin, 1.5rem); margin-top: -0.5rem; }
            #bus-arrivals-container { padding: 1rem; }
            .main-stop-name-line { font-size: clamp(1rem, 4vmin, 1.3rem); }
            .stop-name-qualifier { font-size: clamp(0.7rem, 2.5vmin, 0.8rem); margin-top: -0.1em; }
            #bus-stop-direction {
                font-size: clamp(0.7rem, 2.5vmin, 0.8rem);
                margin-top: -0.15rem;
                margin-bottom: 0.5rem;
                min-height: 1em; 
            }
            .route-tile { font-size: 0.65rem; padding: 0.15em 0.4em; margin: 0.15em;}
            #bus-list { height: 120px; } 
            #bus-list li:not(.loading-message):not(.error-message):not(.no-buses-message):not(.stop-closed-message):not(.system-update-message) {
                padding-top: 0.4rem !important;    
                padding-bottom: 0.4rem !important; 
                padding-left: 0 !important;
                padding-right: 0 !important;
                font-size: clamp(0.8rem, 3vmin, 1rem);
            }
            #stop-letter-display .stop-letter-circle { width: 1.6em; height: 1.6em; font-size: 0.7rem;}
            #stop-selection-modal-content { padding: 1rem; }
            #stop-selection-modal-content h3 { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <img id="tfl-logo" src="assets/TfL.png" alt="Transport for London Logo">

    <button id="disclaimer-button">Copyright Disclaimer</button>
    <div id="disclaimer-modal-overlay" class="modal-overlay">
        <div class="disclaimer-modal-content">
            <button id="disclaimer-modal-close-button" class="modal-close-button">&times;</button>
            <h3>Disclaimer: Use of TfL-Inspired Assets</h3>
            <p>Please note that any Transport for London (TfL) inspired fonts, logos, or other visual elements used in this project are for <strong>personal, non-commercial, and recreational purposes only</strong>.</p>
            <p>This project is a personal endeavor created for fun and to explore design and development concepts. It is not affiliated with, endorsed by, or connected to TfL in any official capacity.</p>
            <p>The use of these elements is not intended for online distribution, public display in a commercial context, or any use that could imply an official association with TfL or cause confusion. My intention is solely for private enjoyment and learning.</p>
            <p>All TfL intellectual property, including official fonts (like New Johnston) and the TfL roundel logo, are the property of Transport for London. For any official or commercial use of TfL assets, please refer to TfL's official guidelines and obtain necessary permissions.</p>
            <p>The design of this page is © 2025 Ryan Hunter.</p>
            <p>V1 - 07/05/25</p>
        </div>
    </div>

    <div id="clock-container">
        <div id="clock-time">Loading...</div>
        <div id="clock-date"></div>
    </div>

    <div id="bus-arrivals-container">
        <div id="stop-letter-display"></div>
        <div id="bus-stop-header" title="Click to change stop">
        </div>
        <p id="bus-stop-direction"></p>
        <div id="route-tiles-container" class="route-tiles-container">
        </div>
        <ul id="bus-list">
            <li class="loading-message">Connecting to live data...</li>
        </ul>
        
        </div>

    <div id="stop-selection-modal-overlay" class="modal-overlay">
        <div id="stop-selection-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Select a Bus Stop</h3>
                <button id="close-stop-modal-button" class="modal-close-button">&times;</button>
            </div>
            <input type="text" id="stop-search-input" placeholder="Search stops by name or direction..." autocomplete="off">
            <ul id="available-stops-list"></ul>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"; 

      const firebaseConfig = {
        apiKey: "AIzaSyDePDF-kZahjzh9ij6tkuApIhoGePwVQ2s",
        authDomain: "omsi-c5505.firebaseapp.com",
        databaseURL: "https://omsi-c5505-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "omsi-c5505",
        storageBucket: "omsi-c5505.appspot.com",
        messagingSenderId: "503595375440",
        appId: "1:503595375440:web:356be6684b77ff5909ea55",
        measurementId: "G-VN7X65V3F9"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      window.firebaseOMSI = {
          database: database,
          dbRef: ref, 
          dbOnValue: onValue, 
          dbGet: get,
          dbChild: child
      };
      console.log("Firebase Initialized for OMSI Arrivals.");
    </script>

    <script>
        let clockTimeElement, clockDateElement, busListElement, busStopDirectionElement,
            busStopHeader, stopLetterDisplayElement, routeTilesContainerElement,
            stopSelectionModalOverlay, closeStopModalButton,
            availableStopsList, stopSearchInput, disclaimerButton,
            disclaimerModalOverlayElement, disclaimerModalCloseButton,
            closedStopIDsGlobal = [];

        let allScheduledData = [];
        let uniqueStops = [];
        let currentSelectedStopID = null;
        let ukBankHolidaysData = { dates: [], titles: {} };
        
        const MAX_DISPLAY_ROWS = 4; 
        const CYCLING_ROWS_COUNT = 3; 
        const MAX_DEPARTURES_OVERALL = 10; 
        const MAX_TIME_TO_STATION_SECONDS = 1800; 

        let previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null); 

        let liveUpdateIntervalId = null;
        let animationTimeoutId = null; 
        let currentScheduleStatus = 'idle';

        let currentDepartureCycleStartIndex = 0; 
        let allUpcomingBusesMasterList = []; 
        
        const schoolHolidayDateRanges = [];

        const initialRouteColourMap = {
            "1": "#DC2626", "2": "#DC2626", "3": "#DC2626", "4": "#00783A", "5": "#00783A", "6": "#00783A",
            "7": "#FFD300", "8": "#FFD300", "9": "#FFD300", "10": "#970006", "11": "#76D0BD", "12": "#F3A9BB",
            "186": "#E32017", "32":  "#00A4A7", "N5":  "#0019A8", "C11": "#FFD300","107": "#76D0BD",
            "221": "#93002F", "240": "#C9A0DC", "251": "#F8A960","303": "#868F98", "305": "#CF7EA2",
            "SL1": "#5F259F", "SL10": "#A05A2C"
        };
        const DEFAULT_ROUTE_COLOUR = "#73809C";
        let effectiveRouteColourMap = { ...initialRouteColourMap };

        function updateClock() { const now=new Date(),h=String(now.getHours()).padStart(2,'0'),m=String(now.getMinutes()).padStart(2,'0'),s=String(now.getSeconds()).padStart(2,'0'),dn=now.toLocaleDateString(undefined,{weekday:'long'}),d=now.getDate(),mn=now.toLocaleDateString(undefined,{month:'long'}),y=now.getFullYear();if(clockTimeElement)clockTimeElement.textContent=`${h}:${m}:${s}`;if(clockDateElement)clockDateElement.textContent=`${dn} ${d} ${mn} ${y}`;}
        async function fetchBankHolidays(){try{const r=await fetch('https://www.gov.uk/bank-holidays.json');if(!r.ok)throw new Error(`HTTP error! ${r.status}`);const d=await r.json();if(d['england-and-wales']&&d['england-and-wales'].events){const e=d['england-and-wales'].events;ukBankHolidaysData={dates:e.map(ev=>ev.date),titles:e.reduce((a,ev)=>{a[ev.date]=ev.title;return a},{})};}else console.warn("Bank hol format error.")}catch(e){console.error("Failed to fetch bank hols:",e)}};
        function isSchoolHolidayPeriod(dObj){if(!schoolHolidayDateRanges||schoolHolidayDateRanges.length===0)return false;const cT=dObj.getTime();for(const r of schoolHolidayDateRanges){try{if(new Date(r.start+"T00:00:00").getTime()<=cT&&cT<=new Date(r.end+"T23:59:59").getTime())return true}catch(e){console.error("Invalid date in school ranges:",r,e)}}return false}

        function getOperatingCodesForToday() {
            const n = new Date();
            const dOW = n.getDay();
            const tds = `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
            let dCodes = new Set();
            let isBH = false;
            if (ukBankHolidaysData && ukBankHolidaysData.dates.includes(tds)) {
                const hT = ukBankHolidaysData.titles[tds] || "";
                isBH = true;
                if (hT.toLowerCase().includes("good friday")) { dCodes.add("Sa"); } else { dCodes.add("Su"); }
            }
            if (!isBH) {
                const iSH = isSchoolHolidayPeriod(n); const sSuf = iSH ? "NSD" : "Sch"; let dCode = "";
                switch (dOW) {
                    case 0: dCode = "Su"; break; case 1: dCode = "Mo"; break; case 2: dCode = "Tu"; break;
                    case 3: dCode = "We"; break; case 4: dCode = "Th"; break; case 5: dCode = "Fr"; break;
                    case 6: dCode = "Sa"; break;
                }
                dCodes.add(dCode);
                if (dOW >= 1 && dOW <= 5) { dCodes.add(dCode + sSuf); dCodes.add("MF" + sSuf); dCodes.add("Mo-Fr"); }
                if (iSH) dCodes.add("SchoolHoliday");
            } else {
                const iSH_on_BH = isSchoolHolidayPeriod(n);
                if (iSH_on_BH) { dCodes.add("SchoolHoliday"); if (dCodes.has("Sa")) dCodes.add("SaNSD"); if (dCodes.has("Su") && !dCodes.has("Sa")) dCodes.add("SuNSD");}
            }
            return Array.from(dCodes);
        }

        function getTargetOperatingCodes(){return getOperatingCodesForToday()}
        function generateArrivalText(s){return s<-59?null:(s<60?'due':`${Math.round(s/60)} min`)}
        function sanitize(s){const e=document.createElement('div');e.textContent=s;return e.innerHTML}
        function getTextWidth(t,fS){const c=getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas")),ctx=c.getContext("2d");ctx.font=fS;return ctx.measureText(t).width}
        function simpleCompareLineNames(a, b) { const numA = parseInt(a, 10); const numB = parseInt(b, 10); const isNumA = !isNaN(numA); const isNumB = !isNaN(numB); if (isNumA && isNumB) { if (numA < numB) return -1; if (numA > numB) return 1; return a.localeCompare(b); } if (isNumA && !isNumB) return -1; if (!isNumA && isNumB) return 1; return a.localeCompare(b); }
        function getRouteTileColour(lineName) { const upperLineName = lineName.toUpperCase(); if (effectiveRouteColourMap[upperLineName]) return effectiveRouteColourMap[upperLineName]; if (upperLineName.startsWith("N")) return effectiveRouteColourMap["N5"] || DEFAULT_ROUTE_COLOUR; if (upperLineName.startsWith("SL")) return effectiveRouteColourMap["SL1"] || DEFAULT_ROUTE_COLOUR; return DEFAULT_ROUTE_COLOUR; }
        function getTextColourForBackground(hexColour) { if (!hexColour || hexColour.length < 7) return '#FFFFFF'; const r = parseInt(hexColour.slice(1, 3), 16); const g = parseInt(hexColour.slice(3, 5), 16); const b = parseInt(hexColour.slice(5, 7), 16); const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.5 ? '#000000' : '#FFFFFF'; }

        function displaySystemUpdateMessage() {
            console.log("[ARRIVALS DEBUG] Displaying system update message.");
            if (busListElement) { busListElement.innerHTML = `<li class="system-update-message">Live bus arrivals are not available at this time.<br>System update in progress.</li>`; }
            if (liveUpdateIntervalId) { clearInterval(liveUpdateIntervalId); liveUpdateIntervalId = null; }
        }

        function updateAndDisplayLiveArrivals() {
            if (currentScheduleStatus === 'simulating_scheduled_update_downtime') { displaySystemUpdateMessage(); return; }
            
            const targetCodesToMatch = getTargetOperatingCodes();
            if (!currentSelectedStopID || !allScheduledData || allScheduledData.length === 0) {
                if (busListElement) { busListElement.innerHTML = `<li class="loading-message">${(!allScheduledData || allScheduledData.length === 0) ? 'No schedule data. <a href="setup.html" style="color:#90cdf4;">Setup</a>.' : 'Select a stop.'}</li>`;}
                previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null);
                return;
            }
            if (closedStopIDsGlobal.includes(currentSelectedStopID)) {
                if (busListElement && !busListElement.querySelector('.stop-closed-message')) { busListElement.innerHTML = `<li class="stop-closed-message">Bus stop closed.<br>Please use the next or previous stop.</li>`; }
                previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null);
                return;
            }
            
            const now = new Date();
            const newPotentialMasterList = allScheduledData
                .filter(bus => { 
                    if (!bus || bus.stopID !== currentSelectedStopID || !bus.OperatingProfile || typeof bus.OperatingProfile !== 'string' || bus.OperatingProfile.trim() === "") return false;
                    const busOpCodes = bus.OperatingProfile.split(',').map(c => c.trim().toLowerCase());
                    const targetLCCodes = targetCodesToMatch.map(c => c.toLowerCase());
                    return targetLCCodes.some(tc => busOpCodes.includes(tc));
                })
                .map((bus, mapIndex) => { 
                    let timeStr = String(bus.scheduledTime).trim();
                    const numTime = parseFloat(timeStr);
                    if (!isNaN(numTime) && numTime >= 0 && numTime < 1 && !timeStr.includes(':')) { const totalMins = Math.round(numTime * 1440); timeStr = `${String(Math.floor(totalMins/60)).padStart(2,'0')}:${String(totalMins%60).padStart(2,'0')}`; }
                    const parts = timeStr.match(/^(\d{1,2}):(\d{2})$/);
                    if (!parts) return null;
                    const hrs = parseInt(parts[1],10), mins = parseInt(parts[2],10);
                    if (isNaN(hrs)||hrs<0||hrs>23||isNaN(mins)||mins<0||mins>59) return null;
                    const dayOffset = parseInt(bus.DayOffset || "0") || 0;
                    const schedTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() + dayOffset, hrs, mins, 0);
                    const diffSecs = Math.round((schedTime.getTime() - now.getTime()) / 1000);
                    const arrTxt = generateArrivalText(diffSecs);
                    const internalId = bus.internalId || `${bus.stopID}_${bus.lineName}_${(bus.scheduledTime||"0000").replace(':', '')}_${hrs}${mins}_mapIdx${mapIndex}`;
                    return arrTxt === null ? null : { ...bus, timeToStationInSeconds: diffSecs, calculatedArrivalText: arrTxt, internalId: internalId, originalMasterIndex: -1 };
                })
                .filter(b => b !== null && b.timeToStationInSeconds < MAX_TIME_TO_STATION_SECONDS)
                .sort((a,b) => a.timeToStationInSeconds - b.timeToStationInSeconds)
                .slice(0, MAX_DEPARTURES_OVERALL) 
                .map((bus, index) => ({ ...bus, originalMasterIndex: index })); 

            const currentMasterIds = newPotentialMasterList.map(b => b.internalId).join(',');
            const previousMasterIds = allUpcomingBusesMasterList.map(b => b.internalId).join(',');
            if (currentMasterIds !== previousMasterIds) {
                currentDepartureCycleStartIndex = 0; 
            }
            allUpcomingBusesMasterList = newPotentialMasterList;

            const finalBusesToDisplayInSlots = new Array(MAX_DISPLAY_ROWS).fill(null);

            if (allUpcomingBusesMasterList.length > 0) {
                finalBusesToDisplayInSlots[0] = { ...allUpcomingBusesMasterList[0], displayNumber: 1 };

                const cyclingCandidates = allUpcomingBusesMasterList.slice(1); 
                if (cyclingCandidates.length > 0) {
                    if (currentDepartureCycleStartIndex >= cyclingCandidates.length) {
                        currentDepartureCycleStartIndex = 0;
                    }
                    const busesForThisCycle = cyclingCandidates.slice(
                        currentDepartureCycleStartIndex, 
                        currentDepartureCycleStartIndex + CYCLING_ROWS_COUNT
                    );
                    busesForThisCycle.forEach((bus, cycleIndex) => {
                        finalBusesToDisplayInSlots[1 + cycleIndex] = { ...bus, displayNumber: bus.originalMasterIndex + 1 };
                    });
                    currentDepartureCycleStartIndex += CYCLING_ROWS_COUNT;
                    if (currentDepartureCycleStartIndex >= cyclingCandidates.length) {
                        currentDepartureCycleStartIndex = 0; 
                    }
                }
            }
            
            if (busListElement) busListElement.innerHTML = ''; 
            const newSnapshotForThisUpdate = new Array(MAX_DISPLAY_ROWS).fill(null);

            for (let i = 0; i < MAX_DISPLAY_ROWS; i++) {
                const busToDisplayInThisSlot = finalBusesToDisplayInSlots[i];
                const prevSnapshotForThisSlot = previousArrivalsSnapshot[i];

                if (busToDisplayInThisSlot) {
                    const li = document.createElement('li');
                    li.innerHTML = 
                        `<span class="bus-item-number">${busToDisplayInThisSlot.displayNumber}.</span>` +
                        `<span class="bus-item-linecode">${sanitize(busToDisplayInThisSlot.lineName)}</span>` +
                        `<span class="bus-item-destination" title="${sanitize(busToDisplayInThisSlot.destinationName)}">${sanitize(busToDisplayInThisSlot.destinationName)}</span>` +
                        `<span class="bus-item-time">${sanitize(busToDisplayInThisSlot.calculatedArrivalText)}</span>`;
                    
                    let shouldAnimate = false;
                    if (!prevSnapshotForThisSlot) { 
                        shouldAnimate = true;
                    } else {
                        if (busToDisplayInThisSlot.internalId !== prevSnapshotForThisSlot.slot_internalId ||
                            busToDisplayInThisSlot.calculatedArrivalText !== prevSnapshotForThisSlot.slot_calculatedArrivalText ||
                            busToDisplayInThisSlot.displayNumber !== prevSnapshotForThisSlot.slot_displayNumber) { 
                            shouldAnimate = true;
                        }
                    }

                    if (shouldAnimate) {
                        setTimeout(() => li.classList.add('bus-item-animate'), 10);
                    }
                    busListElement.appendChild(li);
                    newSnapshotForThisUpdate[i] = {
                        slot_internalId: busToDisplayInThisSlot.internalId,
                        slot_calculatedArrivalText: busToDisplayInThisSlot.calculatedArrivalText,
                        slot_displayNumber: busToDisplayInThisSlot.displayNumber
                    };
                }
            }
            previousArrivalsSnapshot = newSnapshotForThisUpdate;

            if (allUpcomingBusesMasterList.length === 0 && currentSelectedStopID && !closedStopIDsGlobal.includes(currentSelectedStopID)) {
                 if (busListElement) busListElement.innerHTML = `<li class="no-buses-message">Live bus arrivals are not available at this time.</li>`;
            }
        }

        async function loadInitialData() {
            console.log("[ARRIVALS DEBUG] loadInitialData from Firebase called.");
            if (!window.firebaseOMSI || !window.firebaseOMSI.database) {
                console.error("Firebase not initialized. Cannot load data.");
                if(busListElement) busListElement.innerHTML = `<li class="error-message">Firebase connection error.</li>`;
                return;
            }
            const { database, dbGet, dbChild, dbRef } = window.firebaseOMSI;

            try {
                const appStateSnapshot = await dbGet(dbChild(dbRef(database), '/appState'));
                if (appStateSnapshot.exists()) {
                    const appState = appStateSnapshot.val();
                    currentScheduleStatus = appState.scheduleStatus || 'idle';
                    if (currentScheduleStatus === 'simulating_scheduled_update_downtime') { displaySystemUpdateMessage(); }

                    const fbClosedStops = appState.closedStopIDs || {};
                    closedStopIDsGlobal = [];
                    for (const stopID in fbClosedStops) { if (fbClosedStops[stopID] === true) { closedStopIDsGlobal.push(stopID); } }
                } else { 
                    currentScheduleStatus = 'idle'; 
                }

                const scheduleSnapshot = await dbGet(dbChild(dbRef(database), '/liveSchedule/allScheduledBusData'));
                allScheduledData = scheduleSnapshot.exists() && Array.isArray(scheduleSnapshot.val()) ? scheduleSnapshot.val() : [];

                const stopsSnapshot = await dbGet(dbChild(dbRef(database), '/liveSchedule/uniqueBusStops'));
                uniqueStops = stopsSnapshot.exists() && Array.isArray(stopsSnapshot.val()) ? stopsSnapshot.val() : [];

                const customColoursSnapshot = await dbGet(dbChild(dbRef(database), '/settings/customRouteColours'));
                effectiveRouteColourMap = { ...initialRouteColourMap };
                if (customColoursSnapshot.exists()) {
                    const fbCustomColours = customColoursSnapshot.val();
                    for (const route in fbCustomColours) { effectiveRouteColourMap[route.toUpperCase()] = fbCustomColours[route]; }
                }
                
                console.log("[ARRIVALS DEBUG] Data fetched (diversion logic removed).");

                if (uniqueStops.length > 0) {
                    populateStopSelectionModal();
                    const lastStopFromLocalStorage = localStorage.getItem('lastSelectedStopID');
                    let stopToSelect = uniqueStops[0]?.stopID;
                    if (lastStopFromLocalStorage && uniqueStops.find(s => s && s.stopID === lastStopFromLocalStorage)) { stopToSelect = lastStopFromLocalStorage; } 
                    if (stopToSelect) { selectStop(stopToSelect); }
                    else { if(busListElement) busListElement.innerHTML = `<li class="no-buses-message">No stops to select.</li>`; }
                } else {
                    if(busStopHeader) busStopHeader.innerHTML = `<div class="main-stop-name-line">No Stops Available</div>`;
                    if(busListElement) busListElement.innerHTML = `<li class="no-buses-message">No schedule data. <a href="setup.html" style="color:#90cdf4;">Setup</a>.</li>`;
                }
            } catch (error) { console.error("[ARRIVALS DEBUG] Error in loadInitialData:", error); if(busListElement) busListElement.innerHTML = `<li class="error-message">Error loading. Check console. Error: ${error.message}</li>`; }
            setupFirebaseListeners();
        }

        function setupFirebaseListeners() {
            if (!window.firebaseOMSI || !window.firebaseOMSI.database) { console.error("Firebase not initialized. No listeners."); return; }
            const { database, dbOnValue, dbRef } = window.firebaseOMSI;

            const liveScheduleRef = dbRef(database, '/liveSchedule/allScheduledBusData');
            dbOnValue(liveScheduleRef, (snapshot) => {
                console.log("[ARRIVALS DEBUG] FB: liveScheduleData updated.");
                allScheduledData = snapshot.exists() && Array.isArray(snapshot.val()) ? snapshot.val() : [];
                if (currentSelectedStopID && currentScheduleStatus !== 'simulating_scheduled_update_downtime') updateAndDisplayLiveArrivals();
                else if (currentScheduleStatus === 'simulating_scheduled_update_downtime') displaySystemUpdateMessage();
            });

            const liveStopsRef = dbRef(database, '/liveSchedule/uniqueBusStops');
            dbOnValue(liveStopsRef, (snapshot) => {
                console.log("[ARRIVALS DEBUG] FB: uniqueBusStops updated.");
                uniqueStops = snapshot.exists() && Array.isArray(snapshot.val()) ? snapshot.val() : [];
                populateStopSelectionModal();
                if (currentSelectedStopID && !uniqueStops.find(s => s && s.stopID === currentSelectedStopID)) {
                    currentSelectedStopID = null; 
                     if (uniqueStops.length > 0 && uniqueStops[0]) {
                        selectStop(uniqueStops[0].stopID);
                    } else {
                        if(busListElement) busListElement.innerHTML = `<li class="loading-message">Select a stop.</li>`;
                        previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null);
                    }
                } else if (!currentSelectedStopID && uniqueStops.length > 0 && uniqueStops[0]) {
                     selectStop(uniqueStops[0].stopID); 
                } else if (currentSelectedStopID) {
                    selectStop(currentSelectedStopID); 
                }
            });

            const appStateRef = dbRef(database, '/appState');
            dbOnValue(appStateRef, (snapshot) => {
                if (snapshot.exists()) {
                    const appState = snapshot.val();
                    console.log("[ARRIVALS DEBUG] FB: appState updated:", appState);
                    const newStatus = appState.scheduleStatus || 'idle';
                    if (newStatus !== currentScheduleStatus) {
                        currentScheduleStatus = newStatus;
                        if (currentScheduleStatus === 'simulating_scheduled_update_downtime') displaySystemUpdateMessage();
                        else if (currentSelectedStopID) {
                            updateAndDisplayLiveArrivals();
                        }
                    }
                    const fbClosedStops = appState.closedStopIDs || {};
                    const newClosed = []; for (const stopID in fbClosedStops) { if (fbClosedStops[stopID] === true) newClosed.push(stopID); }
                    if (JSON.stringify(closedStopIDsGlobal) !== JSON.stringify(newClosed)) {
                        console.log("[ARRIVALS DEBUG] Closed stops changed. Old:", closedStopIDsGlobal, "New:", newClosed);
                        closedStopIDsGlobal = newClosed;
                        if (currentSelectedStopID && currentScheduleStatus !== 'simulating_scheduled_update_downtime') {
                             selectStop(currentSelectedStopID); 
                        }
                        populateStopSelectionModal(); 
                    }
                } else { 
                    currentScheduleStatus = 'idle'; 
                    closedStopIDsGlobal = [];
                }
            });

            const customColoursRef = dbRef(database, '/settings/customRouteColours');
            dbOnValue(customColoursRef, (snapshot) => {
                console.log("[ARRIVALS DEBUG] FB: customRouteColours updated.");
                effectiveRouteColourMap = { ...initialRouteColourMap };
                if (snapshot.exists()) { const fbCols = snapshot.val(); for (const r in fbCols) effectiveRouteColourMap[r.toUpperCase()] = fbCols[r];}
                else { console.log("[ARRIVALS DEBUG] Custom route colours node in Firebase is empty or deleted. Reverted to defaults.");}
                if (currentSelectedStopID) selectStop(currentSelectedStopID); 
            });
            console.log("[ARRIVALS DEBUG] Firebase listeners set up (diversion listener removed).");
        }

        function populateStopSelectionModal(searchTerm = "") { if (!availableStopsList) return; availableStopsList.innerHTML = ''; if (!uniqueStops || uniqueStops.length === 0) { availableStopsList.innerHTML = `<li style="padding: 0.75rem 0.5rem; text-align: center; opacity: 0.7;">No stops available. Use <a href="setup.html" style="color:#90cdf4;">Setup page</a>.</li>`; return; } const filteredStops = uniqueStops.filter(stop => stop && ((stop.stopName||"").toLowerCase().includes(searchTerm.toLowerCase()) || (stop.direction||"").toLowerCase().includes(searchTerm.toLowerCase()))); if (filteredStops.length === 0) { availableStopsList.innerHTML = `<li style="padding: 0.75rem 0.5rem; text-align: center; opacity: 0.7;">${searchTerm ? 'No stops match search.' : 'No stops found.'}</li>`; return; } filteredStops.forEach(stop => { if(!stop || !stop.stopID) return; const li = document.createElement('li'); let directionText = stop.direction || ""; if (directionText.trim() !== "") { directionText = `towards ${directionText.trim()}`; } const isClosed = closedStopIDsGlobal.includes(stop.stopID);  li.textContent = `${stop.stopName || "Unknown Stop"} ${directionText ? `(${directionText})` : ''}${isClosed ? ' (Closed)' : ''}`; if (isClosed) { li.style.textDecoration = "line-through"; li.style.opacity = "0.7"; } li.setAttribute('data-stopid', stop.stopID); li.addEventListener('click', () => { selectStop(stop.stopID); closeStopSelectionModal(); }); availableStopsList.appendChild(li); }); }
        function filterStopList() { if (stopSearchInput) populateStopSelectionModal(stopSearchInput.value); }
        function openDisclaimerModal() { if (disclaimerModalOverlayElement) { disclaimerModalOverlayElement.style.display = 'flex'; } }
        function closeDisclaimerModal() { if (disclaimerModalOverlayElement) { disclaimerModalOverlayElement.style.display = 'none'; } }
        function openStopSelectionModal() { if (!uniqueStops || uniqueStops.length === 0) { alert("No schedule data. Use Setup Page."); return; } if (stopSearchInput) stopSearchInput.value = ""; populateStopSelectionModal(); if (stopSelectionModalOverlay) stopSelectionModalOverlay.style.display = 'flex'; }
        function closeStopSelectionModal() { if (stopSelectionModalOverlay) stopSelectionModalOverlay.style.display = 'none'; }

        function selectStop(stopID) {
            console.log(`[ARRIVALS DEBUG] selectStop: ${stopID}`);
            currentSelectedStopID = stopID;
            localStorage.setItem('lastSelectedStopID', stopID);
            
            currentDepartureCycleStartIndex = 0;
            allUpcomingBusesMasterList = [];
            previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null); 

            if (currentScheduleStatus === 'simulating_scheduled_update_downtime') {
                displaySystemUpdateMessage(); 
                if(busStopHeader) busStopHeader.innerHTML = '';
                if(stopLetterDisplayElement) { stopLetterDisplayElement.innerHTML = ''; stopLetterDisplayElement.style.display = 'none'; }
                if(routeTilesContainerElement) routeTilesContainerElement.innerHTML = '';
                if(busListElement) busListElement.innerHTML = '';
                return;
            }
            
            const selectedStopDetails = uniqueStops.find(s => s && s.stopID === stopID);

            if(busStopHeader) busStopHeader.innerHTML = '';
            if(stopLetterDisplayElement) { stopLetterDisplayElement.innerHTML = ''; stopLetterDisplayElement.style.display = 'none';  }
            if(routeTilesContainerElement) routeTilesContainerElement.innerHTML = '';

            if (!selectedStopDetails) {
                console.warn(`[ARRIVALS DEBUG] No details for stopID (selectStop): ${stopID}`);
                if(busStopHeader) busStopHeader.innerHTML = `<div class="main-stop-name-line">Stop Info Missing</div>`;
                if(busListElement) busListElement.innerHTML = `<li class="no-buses-message">Details missing for ${sanitize(stopID)}.</li>`;
                if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId); liveUpdateIntervalId = null;
                return;
            }

            let stopNameFull = selectedStopDetails.stopName || "Unknown Stop";
            let mainNamePart = stopNameFull;
            let qualifierPart = null;
            let stopLetters = null; 
            const qualifierRegex = /^(.*?)\s*\/\s*(.*)$/;
            const qualifierMatch = mainNamePart.match(qualifierRegex);
            if (qualifierMatch) { mainNamePart = qualifierMatch[1].trim(); qualifierPart = qualifierMatch[2].trim(); }
            const letterRegex = /\(([A-Z0-9]{1,3})\)$/; 
            let tempLetterMatch = mainNamePart.match(letterRegex);
            if (tempLetterMatch) { stopLetters = tempLetterMatch[1]; mainNamePart = mainNamePart.replace(tempLetterMatch[0], "").trim(); } 
            else if (qualifierPart) { tempLetterMatch = qualifierPart.match(letterRegex); if (tempLetterMatch) { stopLetters = tempLetterMatch[1]; qualifierPart = qualifierPart.replace(tempLetterMatch[0], "").trim(); } }
            
            const mainNameLineDiv = document.createElement('div');
            mainNameLineDiv.className = 'main-stop-name-line';
            mainNameLineDiv.textContent = sanitize(mainNamePart);
            if(busStopHeader) busStopHeader.appendChild(mainNameLineDiv);

            if (qualifierPart && qualifierPart !== "") { const qElem = document.createElement('div'); qElem.className = 'stop-name-qualifier'; qElem.textContent = sanitize(qualifierPart); if(busStopHeader) busStopHeader.appendChild(qElem); }
            if(busStopDirectionElement) { busStopDirectionElement.textContent = selectedStopDetails.direction ? `towards ${selectedStopDetails.direction}` : ""; }

            if (selectedStopDetails && allScheduledData && allScheduledData.length > 0 && routeTilesContainerElement) {
                const allServingRoutesEver = new Set();
                allScheduledData.forEach(bus => { if (bus && bus.stopID === currentSelectedStopID && bus.lineName) allServingRoutesEver.add(bus.lineName); });
                const sortedServingRoutes = Array.from(allServingRoutesEver).sort(simpleCompareLineNames);
                
                if (sortedServingRoutes.length > 0) { 
                    routeTilesContainerElement.style.borderTop = "1px solid rgba(255,255,255,0.1)"; 
                    routeTilesContainerElement.style.paddingTop = "0.75rem"; 
                    routeTilesContainerElement.style.marginBottom = "1rem"; 
                } else { 
                    routeTilesContainerElement.style.borderTop = "none"; 
                    routeTilesContainerElement.style.paddingTop = "0"; 
                    routeTilesContainerElement.style.marginBottom = "0"; 
                }

                sortedServingRoutes.forEach(lineName => {
                    const tile = document.createElement('span');
                    tile.className = 'route-tile';
                    tile.textContent = sanitize(lineName);
                    let tileBGColour = getRouteTileColour(lineName);
                    let tileTextColour = getTextColourForBackground(tileBGColour);
                    tile.style.backgroundColor = tileBGColour;
                    tile.style.color = tileTextColour;
                    routeTilesContainerElement.appendChild(tile);
                });
            }
            
            if (stopLetters && stopLetterDisplayElement && mainNameLineDiv) { 
                const circleElement = document.createElement('span'); circleElement.className = 'stop-letter-circle'; const letterSpan = document.createElement('span'); letterSpan.textContent = sanitize(stopLetters); circleElement.appendChild(letterSpan);
                stopLetterDisplayElement.innerHTML = ''; stopLetterDisplayElement.appendChild(circleElement); stopLetterDisplayElement.style.display = 'inline-flex';
                requestAnimationFrame(() => { 
                    if (!document.body.contains(circleElement) || !document.body.contains(mainNameLineDiv)) return;
                    const mainStyle=window.getComputedStyle(mainNameLineDiv), baseSize=parseFloat(mainStyle.fontSize), circStyle=window.getComputedStyle(circleElement), circDiam=parseFloat(circStyle.width);
                    if(isNaN(baseSize)||baseSize<=0||isNaN(circDiam)||circDiam<=0)return;
                    letterSpan.style.fontFamily=mainStyle.fontFamily; letterSpan.style.fontWeight="bold";
                    let curSize,tgtWidth;const lCount=stopLetters.length,MIN_FS=6;
                    if(lCount===1){curSize=baseSize*1.0;tgtWidth=circDiam*0.60;}else if(lCount===2){curSize=circDiam*0.45;tgtWidth=circDiam*0.70;}else{curSize=circDiam*0.35;tgtWidth=circDiam*0.75;}
                    curSize=Math.max(MIN_FS,Math.min(curSize,lCount===1?circDiam*0.8:circDiam*0.7));
                    let iter=0;let txtMeasW;
                    do{letterSpan.style.fontSize=curSize+"px";txtMeasW=getTextWidth(stopLetters,`bold ${curSize}px "${mainStyle.fontFamily}"`);if(txtMeasW>tgtWidth&&curSize>MIN_FS)curSize-=0.5;else break;iter++;}while(iter<50&&curSize>MIN_FS);
                    letterSpan.style.fontSize=curSize+"px";
                });
            } else { if (stopLetterDisplayElement) stopLetterDisplayElement.style.display = 'none'; }

            if (closedStopIDsGlobal.includes(stopID)) {
                if(busListElement) { busListElement.innerHTML = `<li class="stop-closed-message">Bus stop closed.<br>Please use the next or previous stop.</li>`;}
                if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId); liveUpdateIntervalId = null;
                return; 
            }
            
            updateAndDisplayLiveArrivals(); 
            if (liveUpdateIntervalId) clearInterval(liveUpdateIntervalId);
            liveUpdateIntervalId = setInterval(updateAndDisplayLiveArrivals, 10000); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            clockTimeElement = document.getElementById('clock-time');
            clockDateElement = document.getElementById('clock-date');
            busListElement = document.getElementById('bus-list');
            busStopDirectionElement = document.getElementById('bus-stop-direction');
            busStopHeader = document.getElementById('bus-stop-header');
            stopLetterDisplayElement = document.getElementById('stop-letter-display');
            routeTilesContainerElement = document.getElementById('route-tiles-container');
            stopSelectionModalOverlay = document.getElementById('stop-selection-modal-overlay');
            closeStopModalButton = document.getElementById('close-stop-modal-button');
            availableStopsList = document.getElementById('available-stops-list');
            stopSearchInput = document.getElementById('stop-search-input');
            disclaimerButton = document.getElementById('disclaimer-button');
            disclaimerModalOverlayElement = document.getElementById('disclaimer-modal-overlay');
            disclaimerModalCloseButton = document.getElementById('disclaimer-modal-close-button');

            updateClock(); setInterval(updateClock, 1000);
            previousArrivalsSnapshot = new Array(MAX_DISPLAY_ROWS).fill(null); 

            if (window.firebaseOMSI && window.firebaseOMSI.database) {
                fetchBankHolidays().then(() => loadInitialData()).catch((err) => {
                    console.error("Error during initial data load sequence:", err);
                    loadInitialData(); 
                });
            } else {
                console.error("Firebase not initialized! Arrivals will not work with Firebase.");
                if(busListElement) busListElement.innerHTML = `<li class="error-message">Error: Firebase not connected.</li>`;
            }

            if (busStopHeader) busStopHeader.addEventListener('click', openStopSelectionModal);
            if (closeStopModalButton) closeStopModalButton.addEventListener('click', closeStopSelectionModal);
            if (stopSelectionModalOverlay) stopSelectionModalOverlay.addEventListener('click', e => { if (e.target === stopSelectionModalOverlay) closeStopSelectionModal(); });
            if (stopSearchInput) stopSearchInput.addEventListener('input', filterStopList);
            if (disclaimerButton) disclaimerButton.addEventListener('click', openDisclaimerModal);
            if (disclaimerModalCloseButton) disclaimerModalCloseButton.addEventListener('click', closeDisclaimerModal);
            if (disclaimerModalOverlayElement) disclaimerModalOverlayElement.addEventListener('click', e => { if (e.target === disclaimerModalOverlayElement) closeDisclaimerModal(); });
            
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/live-tracker/sw-omsi.js') // Ensure this path is correct
                    .then(registration => {
                        console.log('Service Worker (sw-omsi.js) registered successfully with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker (sw-omsi.js) registration failed:', error);
                    });
                });
            }
        });
    </script>
</body>
</html>
