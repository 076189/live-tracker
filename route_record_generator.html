<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Route Record Generator</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { width: 85%; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 10px; } 
        h2 { color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px;}
        .input-section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9;}
        
        #pdfHeaderTypeContainer { text-align: center; margin-bottom: 20px; padding: 10px; background-color: #e9e9e9; border-radius: 4px;}
        #pdfHeaderTypeContainer label { margin: 0 10px; font-weight: normal; }
        #pdfHeaderTypeContainer input[type="radio"] { margin-right: 4px; vertical-align: middle; }

        .input-section label:not(.inline-label) { 
            display: block; margin-bottom: 6px; font-weight: bold; color: #555; 
        }
        .input-section input[type="text"],
        .input-section input[type="date"],
        .input-section input[type="number"],
        .input-section input[type="checkbox"],
        .input-section select,
        .input-section textarea { 
            padding: 10px; 
            margin-bottom: 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px;
            font-family: inherit; 
        }
        
        .input-section > input[type="text"],
        .input-section > input[type="date"],
        .input-section > .select-plus-custom,
        .input-section > textarea,
        #routeDestinationsContainer input[type="text"],
        .location-stand-name 
         {
            width: 100%; 
        }
         .input-section > .select-plus-custom {
            display: flex; align-items: center; gap: 10px; 
        }
        .input-section > .select-plus-custom > select {
             min-width: 200px; flex-basis: 250px; flex-grow: 0; margin-bottom: 0;
        }
         .input-section > .select-plus-custom > .dynamic-input-area {
            flex-grow: 1; 
        }

        .input-section input[type="number"] { width: 70px; padding: 8px; margin-bottom:0; }
        .input-section input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle; }
        #isCircularRouteCheckbox { margin-bottom: 0 !important; } 

        .input-section .inline-label { font-weight: normal; display: inline; margin-bottom: 0; vertical-align: middle; }
        .input-section textarea { min-height: 70px; width: 100%;}


        .label-container { 
            display: flex; 
            align-items: baseline; 
            margin-bottom: 8px; 
            gap: 8px; 
        }
        .label-container label { 
            margin-bottom: 0; 
            flex-shrink: 0; 
            font-weight: bold; 
            color: #555; 
            min-width: 50px; 
        }
         .garage-journey-section .label-container label { min-width: 45px; }


        .label-container input[type="text"] { 
            width: auto; 
            flex-grow: 1; 
            margin-bottom: 0; 
        }
        
        #routeDestinationsContainer input[type="text"] { margin-bottom: 0; } 
        #routeDestinationsContainer > div { margin-bottom: 12px; }
        #routeDestinationsContainer #routeCircularDestination,
        #routeDestinationsContainer #routeDestinationFrom,
        #routeDestinationsContainer #routeDestinationTo {
             margin-bottom: 0; 
        }

        .details-label { 
            display: block; margin-bottom: 6px; font-weight: bold; color: #555; 
        }
        textarea.details-textarea { 
            width: 100%; box-sizing: border-box; min-height: 70px; 
            margin-bottom: 10px; 
        }
        .section-button-container { /* For per-item remove buttons */
            text-align: right; 
            margin-top: 5px;  /* Space above the button if it's directly after a textarea */
        }
        .section-button-container .remove-item-btn {
            margin-top: 0; /* Reset if container handles spacing */
             margin-left: 0; /* Reset if it's the only button */
        }
        
        .action-buttons button { 
            padding: 10px 15px; color: white; border: none; cursor: pointer; font-size: 14px;
            border-radius: 4px; margin-right: 10px; margin-top: 20px;  transition: background-color 0.2s;
        }
        .action-buttons button#generatePdfBtn { background-color: #007bff; }
        .action-buttons button#generatePdfBtn:hover { background-color: #0056b3; }
        .action-buttons button#exportDataBtn { background-color: #ffc107; color: black;}
        .action-buttons button#exportDataBtn:hover { background-color: #e0a800;}
        .action-buttons button#importDataBtn { background-color: #17a2b8; color:white;}
        .action-buttons button#importDataBtn:hover { background-color: #117a8b;}

        .add-row-btn { 
            padding: 9px 15px; background-color: #28a745; color: white; border: none; cursor: pointer;
            font-size: 14px; border-radius: 4px; margin-top: 5px; margin-bottom: 10px; transition: background-color 0.2s;
        }
        .add-row-btn:hover { background-color: #218838; }
        
        .remove-item-btn, 
        .remove-row-btn { 
            padding: 9px 15px; 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            cursor: pointer;
            font-size: 14px; 
            border-radius: 4px; 
            display: inline-block; 
            transition: background-color 0.2s;
        }
        .remove-item-btn:hover, 
        .remove-row-btn:hover { 
            background-color: #c82333; 
        }

        .section-button-container .remove-item-btn { 
            margin-top: 5px; 
            margin-left: 0; 
        }
        .section-actions-footer .remove-row-btn { 
            margin-left: 10px; 
            margin-top: 5px;    
            margin-bottom: 10px;
        }
        
        .availability-grid-options {
            display: grid;
            grid-template-columns: 230px 1fr; 
            gap: 8px 12px; 
            align-items: center; 
            margin-bottom: 15px;
        }
        .availability-grid-options .checkbox-label-group {
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .availability-grid-options .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%; 
        }

        .availability-grid-options .checkbox-label-group input[type="checkbox"] { margin-bottom: 0; }
        .availability-grid-options input[type="checkbox"].toggle-field { 
            margin: 0; height: 16px; width: 16px; flex-shrink: 0; 
        }

        .availability-grid-options .bold-label { font-weight: bold; margin-bottom: 0; } 
        
        .input-section label.grid-label { 
            font-weight: normal; 
            margin-bottom: 0; 
        }

        .availability-grid-options .input-wrapper.hidden-field-wrapper {
            visibility: hidden !important; height: 0 !important; padding: 0 !important;
            margin: 0 !important; border: none !important; overflow: hidden !important;
        }
        .input-section .hidden-field { display: none !important; } 


        .availability-grid-options .input-wrapper .select-plus-custom { 
            display: flex; flex-wrap: wrap; align-items: center; gap: 10px; width:100%;
        }
        .availability-grid-options .input-wrapper .select-plus-custom select {
            width: 100%; min-width: 150px; flex-grow: 1; flex-basis: auto; margin-bottom: 0; 
        }
        .availability-grid-options .input-wrapper .select-plus-custom .dynamic-input-area {
            flex-grow: 1; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; width: 100%;
        }
        .availability-grid-options .input-wrapper .select-plus-custom .dynamic-input-area textarea,
        .availability-grid-options .input-wrapper .select-plus-custom .dynamic-input-area input[type="text"],
        .availability-grid-options .input-wrapper input[type="text"].location-blind-display,
        .availability-grid-options .input-wrapper textarea.location-other-info
         {
            width:100%; margin-bottom: 0;
        }
        .availability-grid-options .input-wrapper .select-plus-custom .dynamic-input-area input[type="number"] { margin-bottom: 0; }

        .bold-label { font-weight: bold; } 
        .italic-note { font-style: italic; margin-bottom: 15px; display: block; color: #666; font-size: 0.9em; }
        
        .curtailment-options { margin-top: 15px; margin-bottom: 10px; }
        .curtailment-options > div { margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        .curtailment-options input[type="radio"] { margin-right: 4px; width:auto; margin-bottom: 0; } 
        .curtailment-options label { font-weight: normal; margin-bottom: 0; }

        .curtailment-directions-container { margin-top: 10px; margin-bottom: 10px; }
        .curtailment-direction-block {
            border: none; padding: 0; margin-bottom: 10px;
        }
        .curtailment-direction-block label { font-size: 0.95em; color: #444; display: block; margin-bottom: 6px;}
        .curtailment-direction-block textarea, 
        .curtailment-direction-block input[type="text"]{ 
            width: 100%; 
        }
        
        hr.section-separator { margin-top: 20px; margin-bottom: 20px; border: 0; border-top: 1px dashed #ccc;}

        @media (max-width: 768px) { 
            .availability-grid-options {
                grid-template-columns: 1fr; 
                gap: 5px 0; 
            }
            .availability-grid-options .checkbox-label-group {
                justify-content: flex-start; 
                padding-bottom: 5px; 
                align-items: center; 
            }
            .availability-grid-options .input-wrapper .select-plus-custom {
                flex-direction: column; align-items: stretch; gap: 8px; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enter Route Record Information</h1>

        <div id="pdfHeaderTypeContainer">
            <label><input type="radio" name="pdfHeaderType" value="OMSI" checked> OMSI</label>
            <label><input type="radio" name="pdfHeaderType" value="TfL"> TfL</label>
        </div>

        <div class="input-section">
            <h2>Route Description</h2>
            <label for="routeNumberInput">Route Number:</label>
            <input type="text" id="routeNumberInput" placeholder="e.g., 12, 32A, N73" value="">

            <div style="margin-top: 15px; margin-bottom: 0px;">
                <label class="bold-label" style="margin-bottom: 5px;">Route Details:</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="isCircularRouteCheckbox" onchange="updateRouteDetailsInputs()" style="margin-bottom: 0;">
                    <label for="isCircularRouteCheckbox" class="inline-label">Is this a circular route?</label>
                </div>
            </div>
            <div id="routeDestinationsContainer">
            </div>

            <label for="structuralChangeDate">Date of Structural Change:</label>
            <input type="date" id="structuralChangeDate" value="">

            <label for="serviceChangeDate">Date of Service Change:</label>
            <input type="date" id="serviceChangeDate" value="">
            
            <label for="reasonForIssueSelect">Reason for Issue:</label>
            <div class="select-plus-custom">
                <select id="reasonForIssueSelect" onchange="handleGenericDropdownChange(this, 'reasonForIssue', null, true)">
                    <option value="" disabled selected>Please select...</option>
                    <option value="New Issue">New Issue</option>
                    <option value="custom">Custom text...</option>
                </select>
                <div id="reasonForIssueDynamicInputArea" class="dynamic-input-area">
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2>Streets Traversed</h2>
            <div id="streetsTraversedContainer"></div>
             <button type="button" class="add-row-btn" onclick="addStreetSection()" style="margin-top:15px;">Add Streets Traversed Section</button>
        </div>

        <div class="input-section">
            <h2>Garage Journeys</h2>
            <div id="garageJourneysContainer"> 
            </div>
             <button type="button" class="add-row-btn" onclick="addGarageJourneySection()">Add Garage Journey</button>
        </div>

        <div class="input-section">
            <h2>Authorised Stands, Curtailment Points, & Blind Descriptions</h2>
            <p class="italic-note">Please note that only stands, curtailment points, & blind descriptions as detailed in this contractual document may be used.</p>
            <div id="authorisedStandsContainer"></div>
             <button type="button" class="add-row-btn" onclick="addLocationSection()" style="margin-top:15px;">Add Authorised Stand</button>
        </div>

        <div class="action-buttons" style="text-align: center; margin-top: 20px; padding-bottom: 20px;">
            <input type="file" id="importFile" accept=".RECORD" style="display: none;">
            <button type="button" id="importDataBtn">Import Data</button>
            <button type="button" id="exportDataBtn">Export Data</button> 
            <button type="button" id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <script>
    // ****** START: pdfMake Font Configuration ******
    pdfMake.fonts = {
        Arial: {
            normal: 'https://076189.github.io/live-tracker/fonts/ARIAL.TTF',      
            bold: 'https://076189.github.io/live-tracker/fonts/ARIALBD.TTF',    
            italics: 'https://076189.github.io/live-tracker/fonts/ARIALI.TTF',   
            bolditalics: 'https://076189.github.io/live-tracker/fonts/ARIALBI.TTF' 
        }
    };
    // ****** END: pdfMake Font Configuration ******

    let locationSectionCounter = 0; 
    let streetSectionCounter = 0;
    let garageJourneyCounter = 0; 
    let uniqueCurtailmentIdCounter = 0;

    const FORM_DATA_KEY = 'busRouteFormData_v1.1_button_style_fix'; 
    const DATA_FORMAT_VERSION = "1.1"; 
    const COMPATIBLE_DATA_VERSIONS = ["1.0", "1.1", "1.2", "1.3", "1.4"]; 

    let debounceTimer;

    function eventDebouncer() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            saveFormToSessionStorage();
        }, 300); 
    }

    function attachSaveListeners() {
        const elements = document.querySelectorAll(
            '.container input:not([type="file"]), .container select, .container textarea'
        );
        elements.forEach(el => {
            el.removeEventListener('input', eventDebouncer);
            el.removeEventListener('change', eventDebouncer); 
            if (el.type === 'checkbox' || el.type === 'radio' || el.tagName.toLowerCase() === 'select') {
                el.addEventListener('change', eventDebouncer);
            } else {
                el.addEventListener('input', eventDebouncer);
            }
        });
        document.querySelectorAll('input[name="pdfHeaderType"]').forEach(radio => {
            radio.removeEventListener('change', eventDebouncer); 
            radio.addEventListener('change', eventDebouncer);
        });
    }

    function updateRouteDetailsInputs() {
        const isCircular = document.getElementById('isCircularRouteCheckbox').checked;
        const container = document.getElementById('routeDestinationsContainer');
        container.innerHTML = ''; 
        if (isCircular) {
            const div = document.createElement('div');
            const input = document.createElement('input');
            input.type = 'text'; input.id = 'routeCircularDestination';
            input.placeholder = 'e.g., Town Centre via Hospital'; input.style.width = '100%';
            div.appendChild(input); 
            container.appendChild(div);
        } else {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap = '10px'; 
            const inputFrom = document.createElement('input');
            inputFrom.type = 'text'; inputFrom.id = 'routeDestinationFrom';
            inputFrom.placeholder = 'Start Destination'; inputFrom.style.flex = '1';
            const hyphen = document.createElement('span');
            hyphen.textContent = '-'; hyphen.style.fontWeight = 'bold'; hyphen.style.padding = '0 5px';
            const inputTo = document.createElement('input');
            inputTo.type = 'text'; inputTo.id = 'routeDestinationTo';
            inputTo.placeholder = 'End Destination'; inputTo.style.flex = '1';
            div.appendChild(inputFrom); div.appendChild(hyphen); div.appendChild(inputTo); container.appendChild(div);
        }
        attachSaveListeners(); 
    }

    function toggleFieldVisibility(checkboxElement) {
        const targetContainerId = checkboxElement.dataset.targetInputId; 
        const targetContainer = document.getElementById(targetContainerId);
        if (targetContainer) {
            targetContainer.classList.toggle('hidden-field-wrapper', !checkboxElement.checked);
        }
    }
    
    function initializeFieldVisibility(sectionElement) {
        sectionElement.querySelectorAll('.toggle-field').forEach(checkbox => toggleFieldVisibility(checkbox));
    }
    
    function initializeCurtailmentForLocation(locationSection) {
        let curtailmentRadio = locationSection.querySelector('input[name^="curtailmentType"]:checked');
        if (!curtailmentRadio) {
            curtailmentRadio = locationSection.querySelector('input[name^="curtailmentType"][value="one"]');
            if (curtailmentRadio) curtailmentRadio.checked = true;
        }
        if (curtailmentRadio) handleCurtailmentTypeChange(curtailmentRadio);
    }

    function addCurtailmentBlockToContainer(container, blockNumber, type) {
        uniqueCurtailmentIdCounter++; 
        const newDirectionDiv = document.createElement('div');
        newDirectionDiv.className = 'curtailment-direction-block';
        let blockHTML = '';
        if (type === "one") {
            blockHTML = `<label for="curtailmentDetails_UID${uniqueCurtailmentIdCounter}">Instructions:</label> 
                         <textarea id="curtailmentDetails_UID${uniqueCurtailmentIdCounter}" class="curtailment-details-text details-textarea" rows="4" placeholder="Enter instructions"></textarea>`;
        } else { 
            let dPH = "From..."; 
            blockHTML = `<label for="curtailmentDestination_UID${uniqueCurtailmentIdCounter}">From:</label>
                         <input type="text" id="curtailmentDestination_UID${uniqueCurtailmentIdCounter}" class="curtailment-destination" placeholder="${dPH}">
                         <label for="curtailmentDetails_UID${uniqueCurtailmentIdCounter}">Instructions:</label>
                         <textarea id="curtailmentDetails_UID${uniqueCurtailmentIdCounter}" class="curtailment-details-text details-textarea" rows="3" placeholder="Enter instructions for this direction..."></textarea>`;
        }
        newDirectionDiv.innerHTML = blockHTML;
        container.appendChild(newDirectionDiv);
        attachSaveListeners();
    }

    function handleCurtailmentTypeChange(radioElement) {
        const container = radioElement.closest('.location-section').querySelector('.curtailment-directions-container');
        container.innerHTML = ''; 
        if (radioElement.value === "one") addCurtailmentBlockToContainer(container, 0, "one");
        else if (radioElement.value === "two") { addCurtailmentBlockToContainer(container, 0, "two"); addCurtailmentBlockToContainer(container, 1, "two"); }
    }
    
    function updateBusPluralText(numInput, prefix) {
        const span = document.getElementById(`opRestrictionsBusText_${prefix}`);
        if (span) span.textContent = (numInput.value === '1' || numInput.value === 1) ? " bus" : " buses";
    }

    function updateRouteNumberInOpRestrictions() {
        const num = document.getElementById('routeNumberInput').value.trim() || '[Route#]';
        document.querySelectorAll('[id^="opRestrictionsRouteNumValue_L"]').forEach(s => {
            const dynamicArea = s.closest('.dynamic-input-area');
            if (dynamicArea && !dynamicArea.classList.contains('hidden-field-wrapper')) { 
                s.textContent = num;
            }
        });
    }
    
    function handleGenericDropdownChange(select, fieldName, prefix, isTopLevel = false) {
        const areaId = isTopLevel ? `${fieldName}DynamicInputArea` : `${fieldName}DynamicInputArea_${prefix}`;
        const customId = isTopLevel ? `${fieldName}CustomText` : `${fieldName}CustomText_${prefix}`; 
        const area = document.getElementById(areaId);
        if (!area) return;
        area.innerHTML = ''; area.style.display = 'none'; 
        if (select.value === 'custom') {
            area.style.display = 'flex'; 
            const ta = document.createElement('textarea');
            ta.id = customId; 
            ta.rows = isTopLevel ? "1" : "2";
            ta.placeholder = `Enter custom ${fieldName.toLowerCase().replace(/([A-Z])/g, " $1").trim().toLowerCase()}...`;
            ta.style.cssText="width:100%; flex-grow:1;"; area.appendChild(ta);
            attachSaveListeners();
        }
    }
    
    function handleOpRestrictionsChange(select, prefix) {
        const area = document.getElementById(`opRestrictionsDynamicInputArea_${prefix}`);
        area.innerHTML = ''; area.style.display = 'none'; 
        if (select.value === 'specific_max_buses') {
            area.style.cssText = 'display:flex; gap:5px; align-items:center; flex-wrap:wrap;';
            area.appendChild(document.createTextNode("No more than "));
            const numInput = document.createElement('input');
            numInput.type='number'; numInput.id=`opRestrictionsMaxBusesNum_${prefix}`; numInput.min="1"; numInput.value="1";
            numInput.oninput = () => updateBusPluralText(numInput, prefix); 
            area.appendChild(numInput);
            const busSpan = document.createElement('span'); busSpan.id = `opRestrictionsBusText_${prefix}`; area.appendChild(busSpan);
            area.appendChild(document.createTextNode(" on Route "));
            const routeSpan = document.createElement('span'); routeSpan.id = `opRestrictionsRouteNumValue_${prefix}`;
            routeSpan.textContent = document.getElementById('routeNumberInput').value.trim()||'[Route#]';
            routeSpan.style.fontWeight = 'bold'; area.appendChild(routeSpan);
            area.appendChild(document.createTextNode(" should be scheduled to stand at any one time."));
            updateBusPluralText(numInput, prefix);
            attachSaveListeners();
        } else if (select.value === 'custom') {
            area.style.display = 'block';
            const ta = document.createElement('textarea');
            ta.id=`opRestrictionsCustomText_${prefix}`; 
            ta.rows="2"; ta.placeholder="Enter custom operating restriction...";
            ta.style.width="100%"; area.appendChild(ta);
            attachSaveListeners();
        }
    }

    function addStreetSection() { 
        const container = document.getElementById('streetsTraversedContainer');
        streetSectionCounter++; 
        const newStreetIndex = streetSectionCounter - 1; 
        const newSection = document.createElement('div');
        newSection.className = 'dynamic-section street-section';
        newSection.dataset.index = newStreetIndex;
        newSection.innerHTML = `
            <div class="label-container">
                <label for="streetsTraversedDestination_${newStreetIndex}">Towards:</label>
                <input type="text" id="streetsTraversedDestination_${newStreetIndex}" class="street-destination" placeholder="Enter Destination" value="">
            </div>
            <label for="streetsTraversedDetails_${newStreetIndex}" class="details-label">Road Names:</label>
            <textarea id="streetsTraversedDetails_${newStreetIndex}" class="details-textarea" rows="4" placeholder="Enter road names"></textarea>
            <div class="section-button-container">
                <button type="button" class="remove-item-btn" onclick="removeStreetSection(this)">Remove Streets Traversed</button>
            </div>
        `;
        container.appendChild(newSection); 
        attachSaveListeners(); 
        saveFormToSessionStorage(); 
    }
    function removeStreetSection(btn) { btn.closest('.street-section').remove(); saveFormToSessionStorage(); }

    function addLocationSection() {
        const container = document.getElementById('authorisedStandsContainer');
        locationSectionCounter++; const idx = locationSectionCounter-1; const prefix = `L${idx}`;
        const section = document.createElement('div');
        section.className = 'dynamic-section location-section';
        section.dataset.index = idx;
        section.innerHTML = `
            <label for="locationStandName_${prefix}">Authorised Stand Name:</label><input type="text" id="locationStandName_${prefix}" class="location-stand-name" placeholder="Name" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
            <div class="curtailment-options" id="curtailmentOptions_${prefix}"><label class="bold-label" style="margin-bottom:8px;">Layout:</label><div><input type="radio" id="curtailmentTypeOne_${prefix}" name="curtailmentType_${prefix}" value="one" checked onchange="handleCurtailmentTypeChange(this)"><label for="curtailmentTypeOne_${prefix}" class="inline-label">One Direction</label></div><div><input type="radio" id="curtailmentTypeTwo_${prefix}" name="curtailmentType_${prefix}" value="two" onchange="handleCurtailmentTypeChange(this)"><label for="curtailmentTypeTwo_${prefix}" class="inline-label">Two Directions</label></div></div>
            <div class="curtailment-directions-container" id="curtailmentDirectionsContainer_${prefix}"></div><hr class="section-separator">
            <div class="availability-grid-options">
                <div class="checkbox-label-group"><input type="checkbox" id="toggleAvailability_${prefix}" class="toggle-field" data-target-input-id="availabilityContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleAvailability_${prefix}">AVAILABILITY:</label></div><div class="input-wrapper" id="availabilityContainer_${prefix}"><div class="select-plus-custom"><select id="availabilitySelect_${prefix}" onchange="handleGenericDropdownChange(this,'availability','${prefix}')"><option value="" disabled selected>Select...</option><option value="At any time">At any time</option><option value="custom">Custom...</option></select><div id="availabilityDynamicInputArea_${prefix}" class="dynamic-input-area"></div></div></div>
                <div class="checkbox-label-group"><input type="checkbox" id="toggleOpRestrictions_${prefix}" class="toggle-field" data-target-input-id="opRestrictionsContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleOpRestrictions_${prefix}">OPERATING RESTRICTIONS:</label></div><div class="input-wrapper" id="opRestrictionsContainer_${prefix}"><div class="select-plus-custom"><select id="opRestrictionsSelect_${prefix}" class="op-restrictions-select" onchange="handleOpRestrictionsChange(this,'${prefix}')"><option value="" disabled selected>Select...</option><option value="Turning Point Only - Buses must not stand">Turning Point Only - Buses must not stand</option><option value="Hesitation Point Only - Buses must not stand for no more than 2 minutes">Hesitation Point Only - Buses must not stand for no more than 2 minutes</option><option value="Unscheduled curtailments only">Unscheduled curtailments only</option><option value="specific_max_buses">No more than...</option><option value="custom">Custom...</option></select><div id="opRestrictionsDynamicInputArea_${prefix}" class="dynamic-input-area"></div></div></div>
                <div class="checkbox-label-group"><input type="checkbox" id="toggleMealReliefs_${prefix}" class="toggle-field" data-target-input-id="mealReliefsContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleMealReliefs_${prefix}">MEAL RELIEFS:</label></div><div class="input-wrapper" id="mealReliefsContainer_${prefix}"><div class="select-plus-custom"><select id="mealReliefsSelect_${prefix}" onchange="handleGenericDropdownChange(this,'mealReliefs','${prefix}')"><option value="" disabled selected>Select...</option><option value="No meal relief vehicles to stand at any time">No meal relief vehicles</option><option value="Meal relief vehicles are permitted to stand at any time">Meal relief vehicles are permitted to stand at any time</option><option value="custom">Custom...</option></select><div id="mealReliefsDynamicInputArea_${prefix}" class="dynamic-input-area"></div></div></div>
                <div class="checkbox-label-group"><input type="checkbox" id="toggleFerryVehicles_${prefix}" class="toggle-field" data-target-input-id="ferryVehiclesContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleFerryVehicles_${prefix}">FERRY VEHICLES:</label></div><div class="input-wrapper" id="ferryVehiclesContainer_${prefix}"><div class="select-plus-custom"><select id="ferryVehiclesSelect_${prefix}" onchange="handleGenericDropdownChange(this,'ferryVehicles','${prefix}')"><option value="" disabled selected>Select...</option><option value="No ferry vehicles to park on stand at any time">No ferry vehicles</option><option value="Ferry vehicles are permitted to stand at any time">Ferry vehicles are permitted to stand at any time</option><option value="custom">Custom...</option></select><div id="ferryVehiclesDynamicInputArea_${prefix}" class="dynamic-input-area"></div></div></div>
                <div class="checkbox-label-group"><input type="checkbox" id="toggleBlindDisplay_${prefix}" class="toggle-field" data-target-input-id="blindDisplayContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleBlindDisplay_${prefix}">BLIND DISPLAY:</label></div><div class="input-wrapper" id="blindDisplayContainer_${prefix}"><input type="text" id="locationBlindDisplay_${prefix}" class="location-blind-display" placeholder="Enter blind display"></div>
                <div class="checkbox-label-group"><input type="checkbox" id="toggleOtherInfo_${prefix}" class="toggle-field" data-target-input-id="otherInfoContainer_${prefix}" checked onchange="toggleFieldVisibility(this)"><label class="grid-label" for="toggleOtherInfo_${prefix}">OTHER INFO:</label></div><div class="input-wrapper" id="otherInfoContainer_${prefix}"><textarea id="locationOtherInfo_${prefix}" class="location-other-info details-textarea" rows="2" placeholder="Other info..."></textarea></div>
            </div>
            <div class="section-button-container">
                <button type="button" class="remove-item-btn" onclick="removeLocationSection(this)">Remove Authorised Stand</button>
            </div>
            `;
        container.appendChild(section); initializeFieldVisibility(section); initializeCurtailmentForLocation(section);
        section.querySelectorAll('select').forEach(s => { 
            const fieldNameFromId = s.id.replace(`Select_${prefix}`, '').replace('toggle', '').toLowerCase(); 
            if (s.id.includes('OpRestriction')) handleOpRestrictionsChange(s, prefix);
            else if (s.id.includes('Select_L')) { 
                 handleGenericDropdownChange(s, fieldNameFromId, prefix);
            }
        });
        attachSaveListeners(); saveFormToSessionStorage();
    }
    function removeLocationSection(btn){ btn.closest('.location-section').remove(); saveFormToSessionStorage(); } 

    function addGarageJourneySection() {
        const container = document.getElementById('garageJourneysContainer');
        garageJourneyCounter++;
        const journeyIndex = garageJourneyCounter; 

        const newSection = document.createElement('div');
        newSection.className = 'dynamic-section garage-journey-section';
        newSection.dataset.index = journeyIndex -1; 

        newSection.innerHTML = `
            <div class="label-container">
                <label for="garageFrom_${journeyIndex}">From:</label>
                <input type="text" id="garageFrom_${journeyIndex}" class="garage-from" placeholder="e.g., Brumby Garage">
            </div>
            <div class="label-container">
                <label for="garageTo_${journeyIndex}">To:</label>
                <input type="text" id="garageTo_${journeyIndex}" class="garage-to" placeholder="e.g., Scunthorpe, Bus Station">
            </div>
            <label for="garageRoads_${journeyIndex}" class="details-label">Road Names:</label> 
            <textarea id="garageRoads_${journeyIndex}" class="garage-roads details-textarea" rows="3" placeholder="Enter road names"></textarea> 
            <div class="section-button-container">
                <button type="button" class="remove-item-btn" onclick="removeGarageJourneySection(this)">Remove Garage Journey</button>
            </div>
        `;
        container.appendChild(newSection);
        attachSaveListeners();
        saveFormToSessionStorage();
    }

    function removeGarageJourneySection(buttonElement) {
        buttonElement.closest('.garage-journey-section').remove();
        saveFormToSessionStorage();
    }
    
    function saveFormToSessionStorage() {
        const formData = collectAllFormData();
        if (formData) { 
            try {
                sessionStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));
            } catch (e) {
                console.error("SessionStorage save error:", e);
            }
        }
    }

    function loadFormFromSessionStorage() {
        const savedDataString = sessionStorage.getItem(FORM_DATA_KEY);
        if (savedDataString) {
            try {
                const data = JSON.parse(savedDataString);
                const allElements = document.querySelectorAll('.container input:not([type="file"]), .container select, .container textarea, input[name="pdfHeaderType"]');
                allElements.forEach(el => {
                    el.removeEventListener('input', eventDebouncer);
                    el.removeEventListener('change', eventDebouncer);
                });

                if (populateForm(data)) {
                    // Form populated
                } else {
                    console.warn("populateForm returned false or data was incompatible. Clearing sessionStorage for this key.");
                    sessionStorage.removeItem(FORM_DATA_KEY); 
                    initializeNewFormState(); 
                }
                 attachSaveListeners(); 
            } catch (error) { 
                console.error("SessionStorage load error (parsing or populating):", error); 
                sessionStorage.removeItem(FORM_DATA_KEY);
                initializeNewFormState(); 
            }
        } else { 
            initializeNewFormState();
        }
    }

    function initializeNewFormState() {
        updateRouteDetailsInputs(); 
        if(document.querySelectorAll('#streetsTraversedContainer .street-section').length === 0) addStreetSection();
        if(document.querySelectorAll('#garageJourneysContainer .garage-journey-section').length === 0) addGarageJourneySection(); 
        if(document.querySelectorAll('#authorisedStandsContainer .location-section').length === 0) addLocationSection(); 
        
        const reasonSelect = document.getElementById('reasonForIssueSelect');
        if (reasonSelect) handleGenericDropdownChange(reasonSelect, 'reasonForIssue', null, true);
        const defaultPdfHeaderRadio = document.querySelector('input[name="pdfHeaderType"][value="OMSI"]');
        if (defaultPdfHeaderRadio) defaultPdfHeaderRadio.checked = true;
    }

    function collectAllFormData() { 
        const data = { 
            version: DATA_FORMAT_VERSION, 
            pdfHeaderType: document.querySelector('input[name="pdfHeaderType"]:checked')?.value || "OMSI",
            routeDescription: {}, 
            streetsTraversed: [], 
            garageJourneys: [], 
            authorisedStands: [] 
        }; 
        try {
            const rd = data.routeDescription;
            rd.routeNumber = document.getElementById('routeNumberInput').value;
            rd.isCircular = document.getElementById('isCircularRouteCheckbox').checked;
            if (rd.isCircular) {
                rd.circularDestination = document.getElementById('routeCircularDestination')?.value || "";
            } else {
                rd.destinationFrom = document.getElementById('routeDestinationFrom')?.value || "";
                rd.destinationTo = document.getElementById('routeDestinationTo')?.value || "";
            }
            rd.structuralChangeDate = document.getElementById('structuralChangeDate').value;
            rd.serviceChangeDate = document.getElementById('serviceChangeDate').value;
            const reasonSelectEl = document.getElementById('reasonForIssueSelect');
            if (reasonSelectEl.value === 'custom') {
                const customTextEl = document.getElementById('reasonForIssueCustomText');
                rd.reasonForIssue = customTextEl ? customTextEl.value : "";
            } else {
                rd.reasonForIssue = reasonSelectEl.value;
            }

            document.querySelectorAll('#streetsTraversedContainer .street-section').forEach(s => {
                data.streetsTraversed.push({destination: s.querySelector('.street-destination').value, details: s.querySelector('.details-textarea').value});
            });
            
            document.querySelectorAll('#garageJourneysContainer .garage-journey-section').forEach(section => {
                data.garageJourneys.push({
                    from: section.querySelector('.garage-from')?.value || "",
                    to: section.querySelector('.garage-to')?.value || "",
                    roads: section.querySelector('.garage-roads')?.value || ""
                });
            });

            document.querySelectorAll('#authorisedStandsContainer .location-section').forEach(s => {
                const prefix = `L${s.dataset.index}`; 
                const stand = {
                    standName: document.getElementById(`locationStandName_${prefix}`).value||"", 
                    curtailmentType: document.querySelector(`input[name="curtailmentType_${prefix}"]:checked`).value||"one", 
                    curtailmentDirections:[], 
                    availability:{shown: true, selectedValue: ""}, 
                    opRestrictions:{shown: true, selectedValue: ""}, 
                    mealReliefs:{shown: true, selectedValue: ""}, 
                    ferryVehicles:{shown: true, selectedValue: ""}, 
                    blindDisplay:"", otherInfo:"", 
                    blindDisplayShown:true, otherInfoShown:true
                };
                s.querySelectorAll('.curtailment-direction-block').forEach(b => {
                    const destInput = b.querySelector('.curtailment-destination');
                    stand.curtailmentDirections.push({
                        destination: destInput ? destInput.value : "", 
                        procedure:b.querySelector('.curtailment-details-text').value
                    });
                });
                const fields = [ 
                    {k:'availability',sID:`availabilitySelect_${prefix}`,cID:`availabilityCustomText_${prefix}`,tID:`toggleAvailability_${prefix}`}, 
                    {k:'opRestrictions',sID:`opRestrictionsSelect_${prefix}`,cID:`opRestrictionsCustomText_${prefix}`,nID:`opRestrictionsMaxBusesNum_${prefix}`,tID:`toggleOpRestrictions_${prefix}`}, 
                    {k:'mealReliefs',sID:`mealReliefsSelect_${prefix}`,cID:`mealReliefsCustomText_${prefix}`,tID:`toggleMealReliefs_${prefix}`}, 
                    {k:'ferryVehicles',sID:`ferryVehiclesSelect_${prefix}`,cID:`ferryVehiclesCustomText_${prefix}`,tID:`toggleFerryVehicles_${prefix}`} 
                ];
                fields.forEach(fDef => { 
                    const toggleEl = document.getElementById(fDef.tID);
                    if (toggleEl) stand[fDef.k].shown = toggleEl.checked; 
                    const selEl = document.getElementById(fDef.sID); 
                    if(selEl){ 
                        stand[fDef.k].selectedValue = selEl.value; 
                        if(selEl.value==='custom') {
                            const customEl = document.getElementById(fDef.cID);
                            if(customEl) stand[fDef.k].customText = customEl.value||"";
                        } else if(selEl.value==='specific_max_buses'&&fDef.k==='opRestrictions') {
                            const numEl = document.getElementById(fDef.nID);
                            if (numEl) stand[fDef.k].maxBuses = numEl.value||"1";
                        }
                    } 
                });
                const blindToggleEl = document.getElementById(`toggleBlindDisplay_${prefix}`);
                if (blindToggleEl) stand.blindDisplayShown = blindToggleEl.checked; 
                stand.blindDisplay = document.getElementById(`locationBlindDisplay_${prefix}`)?.value||"";
                const otherInfoToggleEl = document.getElementById(`toggleOtherInfo_${prefix}`);
                if (otherInfoToggleEl) stand.otherInfoShown = otherInfoToggleEl.checked; 
                stand.otherInfo = document.getElementById(`locationOtherInfo_${prefix}`)?.value||"";
                data.authorisedStands.push(stand);
            });
            return data;
        } catch (e) {
            console.error("Error during collectAllFormData:", e);
            return null; 
        }
    }

    function populateForm(data) { 
        if (!data || !data.version || !COMPATIBLE_DATA_VERSIONS.includes(data.version) ) { 
             console.warn(`Data version "${data ? data.version : 'undefined'}" is not compatible. Expected one of: ${COMPATIBLE_DATA_VERSIONS.join(', ')}. Not populating.`);
             return false; 
        }
        
        try {
            document.getElementById('streetsTraversedContainer').innerHTML = ''; streetSectionCounter=0; 
            document.getElementById('garageJourneysContainer').innerHTML = ''; garageJourneyCounter = 0; 
            document.getElementById('authorisedStandsContainer').innerHTML = ''; locationSectionCounter=0; uniqueCurtailmentIdCounter=0; 

            const pdfHeaderTypeToSet = data.pdfHeaderType || "OMSI";
            const headerRadioToSet = document.querySelector(`input[name="pdfHeaderType"][value="${pdfHeaderTypeToSet}"]`);
            if (headerRadioToSet) headerRadioToSet.checked = true;
            else { 
                const omsiDefaultRadio = document.querySelector('input[name="pdfHeaderType"][value="OMSI"]');
                if (omsiDefaultRadio) omsiDefaultRadio.checked = true;
            }

            const rd = data.routeDescription || {};
            document.getElementById('routeNumberInput').value = rd.routeNumber||""; 
            const circCheck = document.getElementById('isCircularRouteCheckbox');
            circCheck.checked = rd.isCircular||false;
            circCheck.dispatchEvent(new Event('change')); 
            if(rd.isCircular) {
                const circDestEl = document.getElementById('routeCircularDestination');
                if(circDestEl) circDestEl.value = rd.circularDestination||""; 
            } else {
                const destFromEl = document.getElementById('routeDestinationFrom');
                const destToEl = document.getElementById('routeDestinationTo');
                if(destFromEl) destFromEl.value = rd.destinationFrom||""; 
                if(destToEl) destToEl.value = rd.destinationTo||"";
            }
            document.getElementById('structuralChangeDate').value = rd.structuralChangeDate||""; 
            document.getElementById('serviceChangeDate').value = rd.serviceChangeDate||"";
            const reasonSelectPopulateEl = document.getElementById('reasonForIssueSelect');
            if (reasonSelectPopulateEl && rd.reasonForIssue !== undefined) { 
                let foundOption = false;
                for (let i = 0; i < reasonSelectPopulateEl.options.length; i++) {
                    if (reasonSelectPopulateEl.options[i].value === rd.reasonForIssue) {
                        reasonSelectPopulateEl.value = rd.reasonForIssue;
                        foundOption = true; break;
                    }
                }
                if (!foundOption && rd.reasonForIssue) { 
                    reasonSelectPopulateEl.value = 'custom';
                }
                reasonSelectPopulateEl.dispatchEvent(new Event('change')); 
                if (reasonSelectPopulateEl.value === 'custom' && rd.reasonForIssue) { 
                    const customTextElPopulate = document.getElementById('reasonForIssueCustomText');
                    if (customTextElPopulate) { 
                        if (!foundOption || (foundOption && rd.reasonForIssue !== reasonSelectPopulateEl.options[reasonSelectPopulateEl.selectedIndex].value) ) {
                             customTextElPopulate.value = rd.reasonForIssue;
                        }
                    }
                }
            }
            
            (data.streetsTraversed||[]).forEach(item => {
                addStreetSection(); 
                const currentStreetSection = document.querySelector(`#streetsTraversedContainer .street-section:last-child`);
                if(currentStreetSection){
                    currentStreetSection.querySelector('.street-destination').value = item.destination||""; 
                    currentStreetSection.querySelector('.details-textarea').value = item.details||""; 
                }
            });
            
            (data.garageJourneys||[]).forEach(item => {
                addGarageJourneySection(); 
                const lastSection = document.querySelector('#garageJourneysContainer .garage-journey-section:last-child');
                if (lastSection) {
                    const fromInput = lastSection.querySelector('.garage-from');
                    const toInput = lastSection.querySelector('.garage-to');
                    const roadsTextarea = lastSection.querySelector('.garage-roads');
                    if (fromInput) fromInput.value = item.from || "";
                    if (toInput) toInput.value = item.to || "";
                    if (roadsTextarea) roadsTextarea.value = item.roads || "";
                }
            });
            
            (data.authorisedStands||[]).forEach(stand => { 
                addLocationSection(); 
                const prefix = `L${locationSectionCounter-1}`; 
                const currentSection = document.querySelector(`#authorisedStandsContainer .location-section[data-index="${locationSectionCounter-1}"]`);
                document.getElementById(`locationStandName_${prefix}`).value = stand.standName||""; 
                const curtailRadio = document.querySelector(`input[name="curtailmentType_${prefix}"][value="${stand.curtailmentType||'one'}"]`);
                if(curtailRadio) {curtailRadio.checked = true; curtailRadio.dispatchEvent(new Event('change'));}
                const cBlocks = currentSection.querySelectorAll('.curtailment-direction-block'); 
                (stand.curtailmentDirections||[]).forEach((d,i) => {if(cBlocks[i]){const destIn=cBlocks[i].querySelector('.curtailment-destination'); if(destIn)destIn.value = d.destination||""; const procTxt=cBlocks[i].querySelector('.curtailment-details-text'); if(procTxt)procTxt.value = d.procedure||"";}});
                const fields = [ {k:'availability',sID:`availabilitySelect_${prefix}`,cID:`availabilityCustomText_${prefix}`,tID:`toggleAvailability_${prefix}`}, {k:'opRestrictions',sID:`opRestrictionsSelect_${prefix}`,cID:`opRestrictionsCustomText_${prefix}`,nID:`opRestrictionsMaxBusesNum_${prefix}`,tID:`toggleOpRestrictions_${prefix}`}, {k:'mealReliefs',sID:`mealReliefsSelect_${prefix}`,cID:`mealReliefsCustomText_${prefix}`,tID:`toggleMealReliefs_${prefix}`}, {k:'ferryVehicles',sID:`ferryVehiclesSelect_${prefix}`,cID:`ferryVehiclesCustomText_${prefix}`,tID:`toggleFerryVehicles_${prefix}`} ];
                fields.forEach(fDef => { 
                    const dKey = stand[fDef.k]; 
                    if(dKey){ 
                        const tChk = document.getElementById(fDef.tID); 
                        if(tChk){tChk.checked = dKey.shown!==false; tChk.dispatchEvent(new Event('change'));} 
                        const sel=document.getElementById(fDef.sID); 
                        if(sel){
                            sel.value = dKey.selectedValue||""; 
                            sel.dispatchEvent(new Event('change')); 
                            if(dKey.selectedValue==='custom' && document.getElementById(fDef.cID))document.getElementById(fDef.cID).value = dKey.customText||""; 
                            else if(dKey.selectedValue==='specific_max_buses'&& fDef.k==='opRestrictions'){
                                const numEl=document.getElementById(fDef.nID); 
                                if(numEl){numEl.value = dKey.maxBuses||"1"; numEl.dispatchEvent(new Event('input'));}
                            }
                        } 
                    }
                });
                const blindToggle = document.getElementById(`toggleBlindDisplay_${prefix}`); if(blindToggle){blindToggle.checked = stand.blindDisplayShown!==false; blindToggle.dispatchEvent(new Event('change')); const blindInput = document.getElementById(`locationBlindDisplay_${prefix}`); if(blindInput) blindInput.value = stand.blindDisplay||"";}
                const otherInfoToggle = document.getElementById(`toggleOtherInfo_${prefix}`); if(otherInfoToggle){otherInfoToggle.checked = stand.otherInfoShown!==false; otherInfoToggle.dispatchEvent(new Event('change')); const otherInfoInput = document.getElementById(`locationOtherInfo_${prefix}`); if(otherInfoInput) otherInfoInput.value = stand.otherInfo||"";}
            });
            updateRouteNumberInOpRestrictions(); 
            return true;
        } catch (e) {
            console.error("Error during populateForm execution:", e);
            return false;
        }
    }
    
    function exportData() {
        let formData;
        try {
            formData = collectAllFormData();
            if (!formData) {
                alert("Could not collect form data for export. Check console for errors.");
                return;
            }
        } catch (e) {
            console.error("Error in collectAllFormData:", e);
            alert("Error collecting data for export. Check console.");
            return;
        }
        
        const jsonData = JSON.stringify(formData, null, 2); 
        const blob = new Blob([jsonData], { type: 'text/plain;charset=utf-8' });
        const routeNumForFilename = document.getElementById('routeNumberInput').value.trim().replace(/[^a-zA-Z0-9_.-]/g, '_') || "UnknownRoute";
        const filename = `Route Record - ${routeNumForFilename}.RECORD`; 
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click(); 
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href); 
    }
    function triggerImport(){ 
        document.getElementById('importFile').click();
    }
    function loadDataFromFile(e){
        const file = e.target.files[0]; 
        if(!file){ 
            return; 
        }
        const reader = new FileReader(); 
        reader.onload=ev=>{
            try{
                const data=JSON.parse(ev.target.result); 
                if(populateForm(data)){
                    alert("Data imported successfully!");
                    saveFormToSessionStorage(); 
                } else {
                    alert("Failed to populate form with imported data. Data might be incompatible or an error occurred.");
                }
            } catch(err){
                console.error("Import error during parsing or populating:",err);
                alert("Error importing data. File might be corrupt or not in the expected JSON format.");
            }
        }; 
        reader.onerror = (err) => {
            console.error("FileReader error:", err);
            alert("Error reading the file.");
        };
        reader.readAsText(file); 
        e.target.value=null; 
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadFormFromSessionStorage(); 
        
        const mainRouteNumberInput = document.getElementById('routeNumberInput');
        if(mainRouteNumberInput) {
            mainRouteNumberInput.addEventListener('input', updateRouteNumberInOpRestrictions);
        }

        document.getElementById('exportDataBtn').addEventListener('click', exportData); 
        document.getElementById('importDataBtn').addEventListener('click', triggerImport);
        document.getElementById('importFile').addEventListener('change', loadDataFromFile);
        
        if (!sessionStorage.getItem(FORM_DATA_KEY)) { 
            const reasonSelect = document.getElementById('reasonForIssueSelect');
            if (reasonSelect) handleGenericDropdownChange(reasonSelect, 'reasonForIssue', null, true);

            document.querySelectorAll('.location-section').forEach(section => {
                const locationIdPrefix = `L${section.dataset.index}`;
                const opSelect = document.getElementById(`opRestrictionsSelect_${locationIdPrefix}`);
                if(opSelect) handleOpRestrictionsChange(opSelect, locationIdPrefix); 
                
                ['availability', 'mealReliefs', 'ferryVehicles'].forEach(fn => {
                    const genSel = document.getElementById(`${fn}Select_${locationIdPrefix}`);
                    if(genSel) handleGenericDropdownChange(genSel, fn, locationIdPrefix); 
                });
            });
        }
         attachSaveListeners(); 
    });

    function generatePDF() {
        function formatTextWithFullStop(text) {
            if (typeof text !== 'string' || text.trim() === "") { return text; }
            const trimmedText = text.trim();
            if (trimmedText.endsWith('.') || trimmedText.endsWith('?') || trimmedText.endsWith('!')) { return trimmedText; }
            return trimmedText + '.';
        }

        const errors = [];

        const routeNum = document.getElementById("routeNumberInput").value.trim();
        if (!routeNum) errors.push("Route Number is missing.");

        const isCircular = document.getElementById('isCircularRouteCheckbox').checked;
        const circularDestInput = document.getElementById('routeCircularDestination');
        const destFromInput = document.getElementById('routeDestinationFrom');
        const destToInput = document.getElementById('routeDestinationTo');
        const circularDestVal = circularDestInput ? circularDestInput.value.trim() : "";
        const destFromVal = destFromInput ? destFromInput.value.trim() : "";
        const destToVal = destToInput ? destToInput.value.trim() : "";
        if (isCircular && !circularDestVal) errors.push("Circular route 'Destination / Via' is missing.");
        if (!isCircular && (!destFromVal || !destToVal)) errors.push("Route From/To destinations are missing.");
        
        let routeDetailsText = ""; 
        if (isCircular) routeDetailsText = circularDestVal ? `${circularDestVal} (circular)` : "[Destination / Via not specified] (circular)";
        else routeDetailsText = (destFromVal || destToVal) ? `${destFromVal || '[Start not specified]'} - ${destToVal || '[End not specified]'}` : "[Route destinations not specified]";
        const fullRoutePdfString = `ROUTE ${routeNum || '[Num]'}: ${routeDetailsText}`;

        const structuralDateVal = document.getElementById("structuralChangeDate").value;
        const serviceDateVal = document.getElementById("serviceChangeDate").value;
        if (!structuralDateVal) errors.push("Date of Structural Change is missing.");
        if (!serviceDateVal) errors.push("Date of Service Change is missing.");
        let structuralChangeDateFormatted = structuralDateVal ? new Date(structuralDateVal + 'T00:00:00Z').toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }) : 'N/A';
        let serviceChangeDateFormatted = serviceDateVal ? new Date(serviceDateVal + 'T00:00:00Z').toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }) : 'N/A';
        if (structuralChangeDateFormatted !== 'N/A') structuralChangeDateFormatted = formatTextWithFullStop(structuralChangeDateFormatted);
        if (serviceChangeDateFormatted !== 'N/A') serviceChangeDateFormatted = formatTextWithFullStop(serviceChangeDateFormatted);
        
        let rawReasonForIssue = "";
        const reasonSelectElPDF = document.getElementById('reasonForIssueSelect');
        if (reasonSelectElPDF.value === 'custom') {
            const customReasonElPDF = document.getElementById('reasonForIssueCustomText');
            rawReasonForIssue = customReasonElPDF ? customReasonElPDF.value.trim() : "";
            if (!rawReasonForIssue) errors.push("Reason for Issue (custom text) is missing.");
        } else {
            rawReasonForIssue = reasonSelectElPDF.value; 
            if (!rawReasonForIssue) errors.push("Reason for Issue is missing (select an option).");
        }
        let reasonForIssueTextPDF = rawReasonForIssue ? formatTextWithFullStop(rawReasonForIssue) : "[Reason not specified]";
        if (!rawReasonForIssue && reasonSelectElPDF.value === "" && reasonSelectElPDF.selectedIndex === 0 && reasonSelectElPDF.options[0].disabled) {
           reasonForIssueTextPDF = "[Reason not specified]"; 
        }
        
        const routePrimaryDetailsPDF = {
            table: { widths: ['auto', '*'], body: [
                [ {text: 'Date of Structural Change:', style: 'infoLabelPdf'}, {text: structuralChangeDateFormatted, style: 'infoValuePdf'} ],
                [ {text: 'Date of Service Change:', style: 'infoLabelPdf'}, {text: serviceChangeDateFormatted, style: 'infoValuePdf'} ],
                [ {text: 'Reason for Issue:', style: 'infoLabelPdf'}, {text: reasonForIssueTextPDF, style: 'infoValuePdf'} ]
            ]}, layout: 'noBorders', margin: [0, 0, 0, 15] 
        };

        const streetsTraversedPdfElements = [];
        let hasRequiredStreetsContent = false;
        const streetSections = document.querySelectorAll('#streetsTraversedContainer .street-section');
        if (streetSections.length === 0) {
            errors.push("At least one Streets Traversed section must be added.");
        } else {
            for (const section of streetSections) {
                const destination = section.querySelector('.street-destination').value.trim();
                let details = section.querySelector('.details-textarea').value.trim();
                if (destination && details) { 
                    hasRequiredStreetsContent = true;
                }
                if (destination || details) { 
                    if (details) details = formatTextWithFullStop(details);
                    const topMargin = streetsTraversedPdfElements.length > 0 ? 10 : 0;
                    streetsTraversedPdfElements.push({ text: `Towards ${destination || '[Destination not specified]'}:`, style: 'towardsLabel', margin: [0, topMargin, 0, 2] });
                    if (details) streetsTraversedPdfElements.push({text: details, style: 'arial12'});
                }
            }
            if (!hasRequiredStreetsContent) {
                errors.push("At least one Streets Traversed section requires BOTH a 'Towards' destination AND 'Road Names'.");
            }
        }

        const garageJourneysContent = [];
        let hasRequiredGarageContent = false;
        const garageJourneySections = document.querySelectorAll('#garageJourneysContainer .garage-journey-section'); 
        if (garageJourneySections.length === 0) {
            errors.push("At least one Garage Journey must be added.");
        } else {
            for (const section of garageJourneySections) {
                const from = section.querySelector('.garage-from').value.trim();
                const to = section.querySelector('.garage-to').value.trim();
                let roads = section.querySelector('.garage-roads').value.trim();
                if (from && to && roads) { 
                    hasRequiredGarageContent = true;
                }
                 if (from || to || roads) { 
                    if(roads) roads = formatTextWithFullStop(roads);
                    garageJourneysContent.push(
                        { text: `From ${from || '[From not specified]'} to ${to || '[To not specified]'}`, style: 'garageJourneyLocationStyle', margin: [0, (garageJourneysContent.length > 0 ? 5: 0) , 0, 2] },
                        { text: roads || '[Roads not specified]', style: 'garageJourneyRoadsStyle' }
                    );
                }
            }
             if (!hasRequiredGarageContent) {
                errors.push("At least one Garage Journey requires 'From', 'To', AND 'Road Names' details to be filled.");
            }
        }
        
        const authorisedStandsPdfElements = [];
        let atLeastOneCompleteAuthStand = false;   
        const standLabelColumnWidthPDF = 187; 
        const authStandSectionsPDF = document.querySelectorAll('#authorisedStandsContainer .location-section'); 

        if (authStandSectionsPDF.length === 0) {
            errors.push("At least one Authorised Stand must be added.");
        } else {
            for (const section_dom of authStandSectionsPDF) {
                const locationIdPrefix = `L${section_dom.dataset.index}`; 
                const standNameInput = document.getElementById(`locationStandName_${locationIdPrefix}`);
                const locationDisplayName = standNameInput ? standNameInput.value.trim() : ""; 
                const locationDisplayNamePDF = locationDisplayName ? locationDisplayName.toUpperCase() : "";
                
                const currentSectionPdfBlock = []; 
                let thisStandHasAnyContentForPDF = !!locationDisplayNamePDF; 
                
                let standHasRequiredInstructions = false;
                const curtailmentType = document.querySelector(`input[name="curtailmentType_${locationIdPrefix}"]:checked`)?.value;
                const directionBlocks = section_dom.querySelectorAll('.curtailment-direction-block');
                const tempCurtailmentContentForPDF = []; 

                if (curtailmentType === "one") {
                    if (directionBlocks.length > 0) {
                        let procedureDetailsText = directionBlocks[0].querySelector('.curtailment-details-text').value.trim();
                        if (procedureDetailsText) {
                            standHasRequiredInstructions = true; 
                            thisStandHasAnyContentForPDF = true;
                            procedureDetailsText = formatTextWithFullStop(procedureDetailsText);
                            tempCurtailmentContentForPDF.push({text: procedureDetailsText, style:'curtailmentDetailsStyle', margin:[0,2,0,5]});
                        }
                    }
                } else if (curtailmentType === "two") {
                    if (directionBlocks.length === 2) { 
                        let completeDirections = 0;
                        directionBlocks.forEach((block, index) => {
                            const dest = block.querySelector('.curtailment-destination')?.value.trim();
                            let procedureDetailsText = block.querySelector('.curtailment-details-text')?.value.trim();
                            
                            if (dest && procedureDetailsText) { 
                                completeDirections++;
                            }
                            if (dest || procedureDetailsText) { 
                                thisStandHasAnyContentForPDF = true;
                                if (procedureDetailsText) procedureDetailsText = formatTextWithFullStop(procedureDetailsText);
                                
                                tempCurtailmentContentForPDF.push({text: `From: ${dest||'[Destination not specified]'}`, style:'curtailmentFromStyle', margin: [0, (index > 0 ? 5 : 0), 0, 2]});
                                if(procedureDetailsText) tempCurtailmentContentForPDF.push({text:procedureDetailsText, style:'curtailmentDetailsStyle', margin:[0,2,0,5]});
                            }
                        });
                        if (completeDirections === 2) { 
                            standHasRequiredInstructions = true;
                        }
                    }
                }

                if (locationDisplayName && standHasRequiredInstructions) {
                    atLeastOneCompleteAuthStand = true;
                }
                
                const availabilityInnerBody = [];
                const fieldDefs = [ 
                    { mid: `toggleAvailability_${locationIdPrefix}`, sid: `availabilitySelect_${locationIdPrefix}`, cID:`availabilityCustomText_${locationIdPrefix}`, lbl: 'AVAILABILITY:', fn: 'availability'}, 
                    { mid: `toggleOpRestrictions_${locationIdPrefix}`, sid: `opRestrictionsSelect_${locationIdPrefix}`, cID:`opRestrictionsCustomText_${locationIdPrefix}`, numID:`opRestrictionsMaxBusesNum_${locationIdPrefix}`, lbl: 'OPERATING RESTRICTIONS:', fn: 'opRestrictions'}, 
                    { mid: `toggleMealReliefs_${locationIdPrefix}`, sid: `mealReliefsSelect_${locationIdPrefix}`, cID:`mealReliefsCustomText_${locationIdPrefix}`, lbl: 'MEAL RELIEFS:', fn:'mealReliefs'}, 
                    { mid: `toggleFerryVehicles_${locationIdPrefix}`, sid: `ferryVehiclesSelect_${locationIdPrefix}`, cID:`ferryVehiclesCustomText_${locationIdPrefix}`, lbl: 'FERRY VEHICLES:', fn:'ferryVehicles'}, 
                    { mid: `toggleBlindDisplay_${locationIdPrefix}`, iid: `locationBlindDisplay_${locationIdPrefix}`, lbl: 'BLIND DISPLAY:'}, 
                    { mid: `toggleOtherInfo_${locationIdPrefix}`, iid: `locationOtherInfo_${locationIdPrefix}`, lbl: 'OTHER INFORMATION:'} 
                ];
                 const autoBoldOpRestrictionsPDF = [ 
                    "Unscheduled curtailments only",
                    "Turning Point Only - Buses must not stand",
                    "Hesitation Point Only - Buses must not stand for no more than 2 minutes"
                ];
                
                fieldDefs.forEach(d => {
                    const toggleEl = document.getElementById(d.mid);
                    if (!toggleEl || !toggleEl.checked) return;
                    let val = "", bold = false; 
                    if (d.sid) { 
                        const sel = document.getElementById(d.sid); 
                        if (sel && sel.value !== "") { 
                            if (sel.value === 'custom') {
                                const customEl = document.getElementById(d.cID);
                                val = customEl ? customEl.value.trim() : "";
                            } else if (sel.value==='specific_max_buses'&&d.fn==='opRestrictions'){
                                const numEl=document.getElementById(d.numID); const num=(numEl?numEl.value:'1'); const busW=(num==='1'||num===1)?"bus":"buses"; const rN=document.getElementById("routeNumberInput").value.trim()||'[Route#]'; val=`No more than ${num} ${busW} on Route ${rN} should be scheduled to stand at any one time.`;
                                val = formatTextWithFullStop(val);
                            } else {
                                val=sel.value; 
                                if (d.fn === 'opRestrictions' && autoBoldOpRestrictionsPDF.includes(val)) {
                                    bold = true; 
                                }
                                if (val && (val === "Turning Point Only - Buses must not stand" || val === "Hesitation Point Only - Buses must not stand for no more than 2 minutes" || val === "Unscheduled curtailments only" || val === "At any time" || val === "No meal relief vehicles to stand at any time" || val === "Meal relief vehicles are permitted to stand at any time" || val === "No ferry vehicles to park on stand at any time" || val === "Ferry vehicles are permitted to stand at any time")) {
                                     val = formatTextWithFullStop(val);
                                }
                            }
                        }
                    } else if (d.iid) { 
                        const inputEl = document.getElementById(d.iid);
                        val = inputEl ? inputEl.value.trim() : "";
                    }

                    if (val) { 
                        availabilityInnerBody.push([{text:d.lbl, style:'infoLabelPdfNormal'}, {text:val, style: bold ? 'infoValuePdfBold' : 'infoValuePdf'}]); 
                        thisStandHasAnyContentForPDF=true;
                    }
                });

                if (thisStandHasAnyContentForPDF) {
                    if (authorisedStandsPdfElements.length > 0) {
                        currentSectionPdfBlock.push({ text: '', margin: [0, 15, 0, 0] }); 
                    }

                    if (locationDisplayNamePDF) {
                        currentSectionPdfBlock.push({ text: locationDisplayNamePDF, style: 'locationHeader', margin: [0, 0, 0, 5] });
                    }
                    
                    if (tempCurtailmentContentForPDF.length > 0) {
                        let curtailmentTopMargin = locationDisplayNamePDF ? 5 : 0;
                        if (tempCurtailmentContentForPDF[0]) { 
                            if (tempCurtailmentContentForPDF[0].margin && Array.isArray(tempCurtailmentContentForPDF[0].margin)) {
                                tempCurtailmentContentForPDF[0].margin[1] = Math.max(tempCurtailmentContentForPDF[0].margin[1] || 0, curtailmentTopMargin);
                            } else {
                                tempCurtailmentContentForPDF[0].margin = [0, curtailmentTopMargin, 0, tempCurtailmentContentForPDF[0].margin && tempCurtailmentContentForPDF[0].margin.length === 4 ? tempCurtailmentContentForPDF[0].margin[3] : 0];
                            }
                        }
                        currentSectionPdfBlock.push(...tempCurtailmentContentForPDF);
                    }

                    if (availabilityInnerBody.length > 0) {
                        let marginTopForGrid = 5; 
                        if (locationDisplayNamePDF || tempCurtailmentContentForPDF.length > 0) {
                            marginTopForGrid = 10; 
                        }
                        currentSectionPdfBlock.push({
                            style: 'availabilityGridStyle', 
                            table: { widths: [standLabelColumnWidthPDF, '*'], body: availabilityInnerBody }, 
                            layout: 'noBorders', 
                            margin: [0, marginTopForGrid, 0, 0]
                        });
                    }
                    authorisedStandsPdfElements.push(...currentSectionPdfBlock);
                }
            } 
            if (!atLeastOneCompleteAuthStand && authStandSectionsPDF.length > 0 && !errors.some(e => e.includes("Authorised Stand must be added."))) {
                let standNameMissingOverall = false;
                let instructionMissingOverall = false;
                authStandSectionsPDF.forEach(section_dom_check => {
                    const name = document.getElementById(`locationStandName_L${section_dom_check.dataset.index}`)?.value.trim();
                    let hasContent = !!name; 

                    const cType = document.querySelector(`input[name="curtailmentType_L${section_dom_check.dataset.index}"]:checked`)?.value;
                    const dBlocks = section_dom_check.querySelectorAll('.curtailment-direction-block');
                    let hasInstr = false;
                    if (cType === 'one' && dBlocks.length > 0 && dBlocks[0].querySelector('.curtailment-details-text')?.value.trim()){
                        hasInstr = true; hasContent = true;
                    }
                    if (cType === 'two' && dBlocks.length === 2) {
                        const dir1Dest = dBlocks[0].querySelector('.curtailment-destination')?.value.trim();
                        const dir1Proc = dBlocks[0].querySelector('.curtailment-details-text')?.value.trim();
                        const dir2Dest = dBlocks[1].querySelector('.curtailment-destination')?.value.trim();
                        const dir2Proc = dBlocks[1].querySelector('.curtailment-details-text')?.value.trim();
                        if(dir1Dest && dir1Proc && dir2Dest && dir2Proc) {
                            hasInstr = true; hasContent = true;
                        } else if (dir1Dest || dir1Proc || dir2Dest || dir2Proc) { 
                            hasContent = true;
                        }
                    }
                    
                    const currentFieldsForCheckInLoop = [ 
                        { mid: `toggleAvailability_L${section_dom_check.dataset.index}`, sid: `availabilitySelect_L${section_dom_check.dataset.index}`}, 
                        { mid: `toggleOpRestrictions_L${section_dom_check.dataset.index}`, sid: `opRestrictionsSelect_L${section_dom_check.dataset.index}`}, 
                        { mid: `toggleMealReliefs_L${section_dom_check.dataset.index}`, sid: `mealReliefsSelect_L${section_dom_check.dataset.index}`}, 
                        { mid: `toggleFerryVehicles_L${section_dom_check.dataset.index}`, sid: `ferryVehiclesSelect_L${section_dom_check.dataset.index}`}, 
                        { mid: `toggleBlindDisplay_L${section_dom_check.dataset.index}`, iid: `locationBlindDisplay_L${section_dom_check.dataset.index}`}, 
                        { mid: `toggleOtherInfo_L${section_dom_check.dataset.index}`, iid: `locationOtherInfo_L${section_dom_check.dataset.index}`} 
                    ];
                    currentFieldsForCheckInLoop.forEach(dDef => {
                        const toggleElCheck = document.getElementById(dDef.mid);
                        if(toggleElCheck && toggleElCheck.checked) {
                            if(dDef.sid) {
                                if(document.getElementById(dDef.sid)?.value) hasContent = true;
                            } else if (dDef.iid) {
                                if(document.getElementById(dDef.iid)?.value) hasContent = true;
                            }
                        }
                    });

                    if (hasContent && (!name || !hasInstr)) { 
                        if (!name) standNameMissingOverall = true;
                        if (!hasInstr) instructionMissingOverall = true;
                    }
                });

                if(standNameMissingOverall || instructionMissingOverall){
                     errors.push("At least one Authorised Stand with some data requires both a Name AND all its mandatory Instructions (based on selected Layout).");
                }
            }
        }


        if (errors.length > 0) {
            alert("PDF Generation Failed. Please complete all mandatory fields:\n\n- " + errors.join("\n- "));
            return;
        }

        const pdfHeaderTypeSelected = document.querySelector('input[name="pdfHeaderType"]:checked').value;
        const pdfMainTitle = pdfHeaderTypeSelected === "TfL" ? "LONDON BUSES - ROUTE DESCRIPTION" : "OMSI BUSES - ROUTE DESCRIPTION";
        const finalContentArray = [ 
            { text: pdfMainTitle, style: 'header', alignment: 'center' },
            { text: fullRoutePdfString, style: 'subheader', alignment: 'center', margin: [0, 10, 0, 10] }, 
            routePrimaryDetailsPDF,
        ];

        if (streetsTraversedPdfElements.length > 0) {
            finalContentArray.push({ text: 'STREETS TRAVERSED', style: 'customSectionHeader13', margin: [0, 10, 0, 5] });
            finalContentArray.push(...streetsTraversedPdfElements);
        }
        if (garageJourneysContent.length > 0) {
            finalContentArray.push({ text: 'GARAGE JOURNEYS', style: 'customSectionHeader16', alignment: 'center', margin: [0, 15, 0, 5], pageBreak: (streetsTraversedPdfElements.length > 0) ? 'before' : undefined });
            finalContentArray.push(...garageJourneysContent);
        }
        
        if (authorisedStandsPdfElements.length > 0) { 
            finalContentArray.push({ text: 'AUTHORISED STANDS, CURTAILMENT POINTS, & BLIND DESCRIPTIONS', style: 'customSectionHeader16', alignment: 'center', margin: [0, 15, 0, 5], pageBreak: (garageJourneysContent.length > 0 || streetsTraversedPdfElements.length > 0) ? 'before' : undefined });
            finalContentArray.push({ text: 'Please note that only stands, curtailment points, & blind descriptions as detailed in this contractual document may be used.', style: 'explanatoryNote', margin: [0, 0, 0, 10] });
            finalContentArray.push(...authorisedStandsPdfElements);
        }

        const docDefinition = { 
            content: finalContentArray,
            defaultStyle: { font: 'Arial', fontSize: 10, color: '#363639' },
            styles: {
                header: { fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
                subheader: { fontSize: 13, bold: true }, 
                infoLabelPdf: { fontSize: 12, bold: true, margin: [0,0,5,5], border: [false,false,false,false] }, 
                infoLabelPdfNormal: { fontSize: 12, margin: [0,0,5,5], border: [false,false,false,false] }, 
                infoValuePdf: { fontSize: 12, margin: [0,0,0,5], border: [false,false,false,false] },     
                infoValuePdfBold: { fontSize: 12, bold: true, margin: [0,0,0,5], border: [false,false,false,false] },     
                customSectionHeader13: { fontSize: 13, bold: true, margin: [0, 10, 0, 5] }, 
                customSectionHeader16: { fontSize: 16, bold: true, margin: [0, 10, 0, 5], alignment: 'center' }, 
                towardsLabel: { fontSize: 12, bold: true, decoration: 'underline' },
                arial12: {fontSize: 12}, 
                garageJourneyLocationStyle: { fontSize: 13, bold: true },
                garageJourneyRoadsStyle: { fontSize: 12 },
                explanatoryNote: { fontSize: 12 },
                locationHeader: { fontSize: 13, bold: true }, 
                curtailmentFromStyle: {fontSize: 12, decoration: 'underline' }, 
                curtailmentDetailsStyle: {fontSize: 12}, 
                availabilityGridStyle: { margin: [0, 5, 0, 5] }
            },
            pageMargins: [ 36, 30, 36, 30 ] 
        };
        
        let fn = routeNum.replace(/[^a-zA-Z0-9_.-]/g, '_').trim() || "UnknownRoute";
        pdfMake.createPdf(docDefinition).download(`Route Record - ${fn}.pdf`);
    }
    </script>
</body>
</html>