<!DOCTYPE html>
<html>
<head>
    <title>Mobitec Barcode Generator</title>
    <link rel="manifest" href="manifest-barcode.json">
    <link rel="apple-touch-icon" href="assets/mb-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* --- CSS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding-top: 20px;
            text-align: center;
        }

        /* Initially hide EVERYTHING except the enter button */
        #loadingMessage,
        h1,
        .input-container,
        #errorMessage,
        #barcodeContainer,
        #simplicityIndex,
        #explanation {
           display: none; /* Use display none initially */
        }

        /* Style the Enter Button */
        #enterButton {
            font-size: 20px;
            padding: 15px 30px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 50px;
            display: inline-block; /* Make it visible */
        }
         #enterButton:hover {
             background-color: #0056b3;
         }

        /* Loading message styles (will be shown by JS) */
        .loading-message {
            font-size: 18px;
            color: #007BFF;
            margin: 0 0 20px 0;
            /* display: none; is set above, JS will change to block */
        }

        /* Class added to body AFTER loading to show main content */
        .content-visible h1,
        .content-visible .input-container,
        .content-visible #errorMessage,
        .content-visible #simplicityIndex,
        .content-visible #explanation {
            display: block; /* Show block elements */
        }
         .content-visible #barcodeContainer {
             display: flex; /* Use flex for barcode layout */
         }
          .content-visible .input-container {
              display: inline-block; /* Center the input container */
         }

        /* Input container styles */
        .input-container {
            background-color: #f9f9f9;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: left;
        }
        .input-container label { margin-right: 5px; }
        .input-container input {
            font-size: 16px; padding: 10px; margin: 5px;
            border: 1px solid #ccc; border-radius: 3px;
        }
        /* Error message styles */
        #errorMessage {
            color: red; margin-top: 20px; min-height: 1.2em; font-weight: bold;
        }
        /* Barcode container - adjusted min-height */
        .barcode {
            flex-direction: column-reverse;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            min-height: 280px; /* Adjusted for margin spacing */
            background-color: white;
            border: 1px solid #eee;
            padding: 5px 0;
            display: inline-flex; /* Use inline-flex for centering */
        }

        /* --- Bar CSS using MARGIN for spacing + BORDER for faint lines --- */
        .bar {
            width: 70px;
            /* USE MARGIN for spacing, like in your reference code */
            margin: 2px 0;
            flex-shrink: 0;
            /* Remove default border used for spacing */
            border: none;
            box-sizing: border-box; /* Good practice */
        }
        /* No :first-child margin override needed with margin: 2px 0 */

        /* Style white bars to ADD the faint top line */
        .bar.white-bar {
             border-top: 1px solid #eee; /* Apply the light grey border */
             /* Background color is set by inline style from JS */
             /* Margin already applied by base .bar rule */
        }

        /* Style black bars (no border needed) */
        .bar.black-bar {
             /* border: none; /* Already default */
             /* Background color is set by inline style from JS */
             /* Margin already applied by base .bar rule */
        }

        /* Heights remain the same */
        .small-bar { height: 20px; }
        .thick-bar { height: 40px; }
        /* --- End of Bar CSS --- */

        /* Info text styles */
        #simplicityIndex, #explanation {
            margin-top: 20px; min-height: 1.2em;
        }
        #explanation {
            margin-top: 5px; font-style: italic;
        }
        /* --- END OF CSS --- */
    </style>
</head>
<body class=""> <button id="enterButton">Enter Site</button> <div id="loadingMessage" class="loading-message" style="display: none;">Self testing. Loading...</div> <div class="input-container">
        <label for="numberInput">Enter a number:</label>
        <input type="text" id="numberInput" inputmode="numeric" pattern="[0-9]*" placeholder="Enter 0-255 or 511" oninput="validateAndGenerate()" />
    </div>

    <h1>Mobitec Barcode Generator</h1>

    <div id="errorMessage"></div>
    <div class="barcode" id="barcodeContainer"></div>
    <div id="simplicityIndex"></div>
    <div id="explanation"></div>
    <audio id="audioPlayer" src="assets/Self Test copy.m4a" type="audio/mp4" preload="auto"></audio>

    <script>
        // --- Get References ---
        const enterButton = document.getElementById('enterButton');
        const loadingMessage = document.getElementById("loadingMessage");
        const audioPlayer = document.getElementById("audioPlayer");
        const numberInputField = document.getElementById("numberInput");

        // --- Function called 5 seconds after button click ---
        function finishLoadingAndPlaySound() {
            console.log("5 second loading timer finished.");

            // 1. Play the sound
            if (audioPlayer) {
                audioPlayer.currentTime = 0;
                audioPlayer.play()
                  .then(() => console.log("Audio playback started."))
                  .catch(e => console.error("Audio play failed:", e));
            } else {
                console.log("Audio player not found.");
            }

            // 2. Hide loading message
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }

            // 3. Show main content area
            document.body.classList.add('content-visible');
            console.log("Main content shown.");

            // 4. Generate the initial barcode frame (empty input state)
            generateBarcode();

            // 5. Optional: focus the input field
            if(numberInputField) {
                numberInputField.focus();
            }
        }

        // --- Main Function triggered by button click ---
        function startSiteEntry() {
            // 1. Hide the button
            if (enterButton) enterButton.style.display = 'none';

            // 2. Show the loading message
            if (loadingMessage) loadingMessage.style.display = 'block';
            console.log("Loading message shown.");

            // 3. Try to "claim" audio permission immediately after click
            if (audioPlayer) {
                audioPlayer.load(); // Encourage loading
                let promise = audioPlayer.play();
                if (promise !== undefined) {
                    promise.then(_ => {
                        // Play started (likely silent/brief), pause immediately.
                        audioPlayer.pause();
                        console.log("Audio permission likely obtained silently.");
                    }).catch(error => {
                        console.warn("Initial silent play/pause failed (might be okay):", error);
                    });
                }
            }

            // 4. Start the fixed 5-second timer for the loading period
            console.log("Starting 5 second loading timer...");
            setTimeout(finishLoadingAndPlaySound, 5000);
        }

        // --- Attach Event Listener to the Enter Button ---
        if (enterButton) {
            enterButton.addEventListener('click', startSiteEntry);
        } else {
             console.error("Enter button not found!");
        }

        // --- Function to validate input and regenerate barcode ---
        function validateAndGenerate() {
            const inputField = document.getElementById("numberInput");
            const nonNumericRegex = /[^0-9]/g;
            if (inputField) {
                 let value = inputField.value;
                 // Remove non-numeric characters
                 if (nonNumericRegex.test(value)) {
                     const start = inputField.selectionStart;
                     const end = inputField.selectionEnd;
                     const originalLength = value.length;
                     inputField.value = value.replace(nonNumericRegex, "");
                     const newLength = inputField.value.length;
                     const diff = originalLength - newLength;
                     // Restore cursor position if characters were removed
                     if (diff > 0 && start !== null && end !== null) {
                         const newCursorPos = Math.max(0, start - diff);
                         // Use setTimeout to ensure DOM update before setting cursor
                         setTimeout(() => {
                             inputField.setSelectionRange(newCursorPos, newCursorPos);
                         }, 0);
                     }
                 }
                 // Regenerate barcode based on current input value
                 generateBarcode();
            }
        }

        // --- Regenerate barcode on Enter key press ---
        if (numberInputField) {
            numberInputField.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                     event.preventDefault(); // Prevent default form submission
                    generateBarcode();
                     numberInputField.blur(); // Hide keyboard on mobile
                }
            });
        }

        // --- Generate Barcode Function (Handles empty/invalid/valid) ---
        function generateBarcode() {
            const container = document.getElementById("barcodeContainer");
            const errorMessage = document.getElementById("errorMessage");
            const simplicityIndex = document.getElementById("simplicityIndex");
            const explanation = document.getElementById("explanation");
            const numberInput = document.getElementById("numberInput");

            // Ensure container exists
            if (!container) { console.error("Barcode container not found!"); return; }

            // 1. Clear previous messages and container content
            if(errorMessage) errorMessage.textContent = "";
            if(simplicityIndex) simplicityIndex.innerHTML = "";
            if(explanation) explanation.innerHTML = "";
            container.innerHTML = ""; // Clear previous bars

            // 2. Always add the bottom (start) bar
            addBar(container, "black", "thick-bar");

            // 3. Decide which data bars to add (real or white placeholders)
            const numberStr = numberInput ? numberInput.value : "";
            let addWhiteBars = true; // Assume we add white bars by default (for empty/invalid)

            if (numberStr !== "") {
                const number = parseInt(numberStr, 10); // Use base 10

                // Check if the number is valid
                if (!isNaN(number) && number >= 0 && (number <= 255 || number === 511)) {
                    // Input is valid - generate real bars
                    addWhiteBars = false; // Don't add the default white bars
                    const binaryArray = number.toString(2).padStart(9, "0").split("");
                    const reversedBinaryArray = [...binaryArray].reverse(); // Reverse for bottom-up drawing

                    // Loop through reversed binary array to add data bars
                    reversedBinaryArray.forEach((bit) => {
                        addBar(container, bit === "1" ? "black" : "white", "small-bar");
                    });

                    // Display info text for valid number
                    const simplicityScore = binaryArray.filter(bit => bit === "1").length;
                    if(simplicityIndex) simplicityIndex.textContent = `Simplicity Index: ${simplicityScore}/9`;
                    if(explanation) explanation.textContent = `Input: ${number} | Binary: ${binaryArray.join("")}`;

                } else {
                    // Input is invalid (but not empty)
                    if(errorMessage) errorMessage.textContent = "Invalid number! Enter 0-255, or 511.";
                    // Keep addWhiteBars = true, so white bars will be added below
                }
            }
            // Else (input is empty), keep addWhiteBars = true

            // 4. Add 9 white bars if needed (input empty or invalid)
            if (addWhiteBars) {
                for (let i = 0; i < 9; i++) {
                    addBar(container, "white", "small-bar");
                }
            }

            // 5. Always add the top (end) bar LAST
            addBar(container, "black", "small-bar");
        }
        // --- End of generateBarcode Function ---


        // --- addBar Function (Adds class for CSS targeting) ---
        function addBar(container, color, sizeClass) {
            const bar = document.createElement("div");
            // Add a specific class based on the color for easier CSS targeting
            const colorClass = (color === 'white') ? 'white-bar' : 'black-bar';
            bar.className = `bar ${sizeClass} ${colorClass}`; // Add the new class

            // Still set the background color directly for simplicity
            bar.style.backgroundColor = color;

            container.appendChild(bar);
        }
        // --- End of addBar Function ---

    </script>

</body>
</html>
