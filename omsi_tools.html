<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMSI Countdown - Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'NJFont Medium Web';
            src: url('fonts/NJFont-Medium.ttf') format('truetype');
            font-weight: normal;font-style: normal;font-display: swap;
        }
        body {
            font-family: 'NJFont Medium Web', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            margin:0;
        }
        .page-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        .tool-content {
            display: none;
        }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; font-weight: normal; text-align: center; color: #ffffff; }
        h2 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: normal; border-bottom: 1px solid #7f8c8d; padding-bottom: 0.25rem;}

        .section {
            background-color: rgba(0,0,0,0.15);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #current-profile-display-container { text-align: center; margin-bottom: 1.5rem; padding: 0.5rem; background-color: rgba(255,255,255,0.05); border-radius: 0.25rem;}
        #current-profile-display { font-size: 0.9rem; opacity: 0.9; font-style: italic;}

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;}
        .form-section div, .manage-service-messages-form div { margin-bottom: 0.75rem; } /* Added .manage-service-messages-form */

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            color: #bdc3c7;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="time"],
        input[type="color"],
        input[type="number"], /* Added for number inputs */
        select,
        textarea { /* Added textarea */
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e;
            color: #ecf0f1;
            font-size:0.9rem;
        }
        textarea { min-height: 80px; }
        input[type="color"] { height: 2.75rem; padding: 0.25rem; }
        #inputOperatingProfile { max-width: 100%;}
        #selectDayOffset, #selectRouteNameColour, #selectStopForDeparturesView, #smTargetValueStop, #smTargetValueRoute { max-width: 100%; } /* Added new selects */
        #selectDayOffset option, #selectRouteNameColour option, #selectStopForDeparturesView option, #smTargetValueStop option, #smTargetValueRoute option { background-color: #34495e; color: #ecf0f1; }


        #inputStopID, #inputLineName, #bulkEditTargetStopID, #bulkEditTargetLineName {
            text-transform: uppercase;
        }

        .button {
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin-right: 0.5rem; margin-top:0.5rem;
        }
        .button:hover { background-color: #2980b9; }
        .button.small-action { padding: 0.2rem 0.4rem; font-size: 0.9rem; margin: 0 0.15rem; line-height: 1; min-width: 20px; text-align:center;}
        .button.secondary { background-color: #e74c3c; }
        .button.secondary:hover { background-color: #c0392b; }
        .button.tertiary { background-color: #f39c12; }
        .button.tertiary:hover { background-color: #e67e22; }
        .button.neutral { background-color: #7f8c8d; }
        .button.neutral:hover { background-color: #95a5a6; color: #2c3e50; }


        .file-upload-label { display: inline-block; cursor: pointer; background-color: #95a5a6; color: #2c3e50; padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem; transition: background-color 0.2s; margin-bottom: 0.5rem; }
        .file-upload-label:hover { background-color: #7f8c8d; }
        #file-status { font-size: 0.9rem; margin-top: 0.25rem; margin-bottom:1rem; opacity: 0.9; min-height: 1.2em; }

        #currentScheduleTableContainer, #serviceMessagesTableContainer { /* Added #serviceMessagesTableContainer */
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto; /* Allow horizontal scroll for wider tables */
            border: 1px solid #7f8c8d;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem;}
        th, td {
            padding: 0.4rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #34495e;
            white-space: nowrap;
        }
        th { background-color: rgba(0,0,0,0.2); font-weight: normal; color: #bdc3c7; cursor: pointer; user-select:none;}
        th:hover { background-color: rgba(0,0,0,0.3); }
        th .sort-arrow { margin-left: 5px; font-size: 0.7em; display:inline-block; width:10px; }

        .actions-section { margin-top: 1.5rem; }
        #stageScheduleButton { background-color: #27ae60; }
        #stagingStatusMessage { text-align:center; margin-bottom: 1rem; font-size: 0.9em; color: #f1c40f; min-height:1.2em; }


        .info-section { margin-top:2rem; padding:1rem; background-color: rgba(0,0,0,0.1); border-radius:0.25rem; font-size:0.8rem; }
        .info-section h3 { font-size:1rem; margin-bottom:0.5rem; color: #ffffff; }
        .info-section p { line-height:1.6; color:#bdc3c7; }

        .tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; font-size:0.8em; background-color:#7f8c8d; color:white; border-radius:50%; width:14px; height:14px; text-align:center; line-height:14px;}
        .tooltip .tooltiptext {
            visibility: hidden; width: 280px; background-color: #34495e; color: #fff;
            text-align: left; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 10; bottom: 135%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.75rem; line-height: 1.4; border: 1px solid #7f8c8d;
        }
        .tooltip .tooltiptext::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #34495e transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; align-items: end;}
        .filter-controls div { margin-bottom: 0; }
        .filter-controls input[type="text"] { margin-bottom:0; }
        .filter-controls button { margin-top:0; }

        .current-details-display {
            margin-top: 0.5rem;
            font-size: 0.85em;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 0.25rem;
            color: #bdc3c7;
        }
        .current-details-display p { margin: 0.2rem 0; }
        .current-details-display span { font-style: italic; color: #ecf0f1; }

        .event-section div, .stop-status-section div, .route-colour-management div, .view-stop-departures div, .service-message-management div {
            margin-bottom: 0.75rem;
        }
        .event-section label, .stop-status-section label, .route-colour-management label, .view-stop-departures label, .service-message-management label {
             margin-bottom: 0.25rem;
        }

        #currentRouteColoursListContainer {
            border: 1px solid #4A5568;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        #currentRouteColoursList li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #34495e;
            font-size: 0.9rem;
        }
        #currentRouteColoursList li:last-child { border-bottom: none; }
        .colour-preview-box {
            width: 20px;
            height: 20px;
            border: 1px solid #ecf0f1;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
        }
        #currentRouteColoursList .route-info { flex-grow: 1; }

        .route-tile-tools-list {
            display: inline-block;
            padding: 0.2em 0.55em;
            margin-right: 0.6em;
            border-radius: 0.25rem;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
            line-height: 1.3;
            min-width: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
            vertical-align: middle;
        }
        #stopDeparturesList li {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.1rem;
            border-bottom: 1px solid #34495e;
            font-size: 0.9rem;
        }
        #stopDeparturesList li:last-child {
            border-bottom: none;
        }
        /* Style for hidden conditional inputs */
        .conditional-input { display: none; }
        .conditional-input.active { display: block; }

    </style>
</head>
<body lang="en-GB">
    <div class="page-container">
        <h1>Bus Schedule Setup & Management</h1>

        <div id="auth-section" class="section">
            <h2>Admin Login</h2>
            <div id="login-form-container">
                <form id="adminLoginForm">
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div><label for="inputEmail">Email</label><input type="email" id="inputEmail" autocomplete="email"></div>
                        <div><label for="inputPassword">Password</label><input type="password" id="inputPassword" autocomplete="current-password"></div>
                    </div>
                    <button id="loginButton" type="submit" class="button">Login</button>
                </form>
                <p id="auth-status" style="margin-top: 0.5em; color: #f1c40f;"></p>
            </div>
            <div id="logout-container" style="display:none;"> <p>Logged in as: <span id="loggedInUserEmail"></span></p> <button id="logoutButton" class="button secondary">Logout</button>
            </div>
        </div>

        <div id="main-tool-content" style="display:none;">

            <div id="current-profile-display-container" class="section">
                <p id="current-profile-display">Today's Auto Profile: (determining...)</p>
            </div>

            <div class="section manual-entry-form">
                <h2>Add / Edit Schedule Entry</h2>
                <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;"><em>Entries added or modified here are part of the working schedule. Use actions below to stage it for automated update or apply it live immediately.</em></p>
                <input type="hidden" id="editingEntryIndex" value="-1">
                <div class="form-grid">
                    <div><label for="inputStopID">Stop ID</label><input type="text" id="inputStopID" autocomplete="off"></div>
                    <div><label for="inputStopName">Stop Name</label><input type="text" id="inputStopName" autocomplete="off"></div>
                    <div><label for="inputDirection">Direction</label><input type="text" id="inputDirection" autocomplete="off"></div>
                    <div><label for="inputLineName">Line Name</label><input type="text" id="inputLineName" autocomplete="off"></div>
                    <div><label for="inputDestinationName">Destination Name</label><input type="text" id="inputDestinationName" autocomplete="off"></div>
                    <div><label for="inputScheduledTime">Scheduled Time (HH:MM)</label><input type="time" id="inputScheduledTime" autocomplete="off"></div>
                </div>
                <div>
                    <label for="inputOperatingProfile">Operating Profile(s)
                        <span class="tooltip">?
                            <span class="tooltiptext">
                                Enter comma-separated codes. Valid codes include: <br>
                                <strong>Days:</strong> Mo, Tu, We, Th, Fr, Sa, Su <br>
                                <strong>Weekday Grps:</strong> Mo-Fr <br>
                                <strong>School Status (Combine):</strong> Sch (School Day), NSD (Non-School Day/Hol). <br>
                                <em>e.g., MoSch, TuNSD, MFSch, MFNSD</em> <br>
                                <strong>Special Days:</strong> GoodFriday, BankHoliday, XmasDay, BoxingDay, NewYearsDay, SchoolHoliday (general) <br>
                                <strong>Example usage:</strong> Sa,Su,BankHoliday
                            </span>
                        </span>
                    </label>
                    <input type="text" id="inputOperatingProfile" placeholder="e.g., MoSch,TuSch or Sa,BankHoliday" autocomplete="off">
                </div>
                <div>
                    <label for="selectDayOffset">Day Offset (for overnight services)</label>
                    <select id="selectDayOffset">
                        <option value="0">0 (Same Day)</option>
                        <option value="1">1 (Next Day)</option>
                    </select>
                </div>
                <div style="margin-top:1rem;">
                    <button id="addEntryButton" class="button">Add Entry</button>
                    <button id="updateEntryButton" class="button tertiary" style="display:none;">Update Entry</button>
                    <button id="cancelEditButton" class="button secondary" style="display:none;">Cancel Edit</button>
                </div>
            </div>

            <div class="section bulk-edit-stop-details-section">
                <h2>Update Stop Name & Direction by Stop ID (in current working schedule)</h2>
                <div class="form-grid" style="grid-template-columns: 1fr; gap: 0.75rem;">
                    <div><label for="bulkEditTargetStopID">Target Stop ID to Update</label><input type="text" id="bulkEditTargetStopID" placeholder="Enter Stop ID (case-insensitive)" autocomplete="off"></div>
                    <div class="current-details-display"><p><strong>Current Name:</strong> <span id="currentBulkEditStopNameDisplay">- Enter Stop ID above -</span></p><p><strong>Current Direction:</strong> <span id="currentBulkEditDirectionDisplay">- Enter Stop ID above -</span></p></div>
                    <div><label for="bulkEditNewStopName">New Stop Name (leave blank to keep current)</label><input type="text" id="bulkEditNewStopName" placeholder="Enter new stop name" autocomplete="off"></div>
                    <div><label for="bulkEditNewDirection">New "Towards" Text (leave blank to keep current)</label><input type="text" id="bulkEditNewDirection" placeholder="Enter new direction text" autocomplete="off"></div>
                    <div style="margin-top: 0.5rem;"><button id="bulkUpdateDetailsButton" class="button" style="width:auto;">Update These Stop Details</button></div>
                </div>
            </div>
             <div class="section bulk-edit-route-destination">
                <h2>Update Destination for a Route (in current working schedule)</h2>
                <div class="form-grid" style="grid-template-columns: 1fr 1.5fr 1.5fr auto; align-items:end; gap: 0.75rem;">
                    <div><label for="bulkEditTargetLineName">Target Line Name</label><input type="text" id="bulkEditTargetLineName" placeholder="e.g., 186" autocomplete="off"></div>
                    <div><label for="bulkEditOldDestination">Old Destination (optional)</label><input type="text" id="bulkEditOldDestination" placeholder="Leave blank to update all" autocomplete="off"></div>
                    <div><label for="bulkEditNewDestination">New Destination Name</label><input type="text" id="bulkEditNewDestination" placeholder="Enter new destination" autocomplete="off"></div>
                    <div style="padding-bottom:0.05rem;"><button id="bulkUpdateRouteDestinationButton" class="button" style="width:100%;">Update Destination</button></div>
                </div>
            </div>
            <div class="section random-event-generator">
                <h2>Random Event Generator (affects current working schedule)</h2>
                <div class="form-grid event-section" style="grid-template-columns: 1.5fr 1.5fr auto; align-items:end;">
                    <div><label for="selectEventRoute">Select Route (Line Name):</label><select id="selectEventRoute"><option value="">-- Select a Route --</option></select></div>
                    <div><label for="selectEventImpactStop">Impact from Stop (Optional):</label><select id="selectEventImpactStop"><option value="">-- Route Wide / First Stop --</option></select></div>
                    <div style="padding-bottom:0.05rem;"><button id="triggerEventButton" class="button tertiary" style="width:100%;">Trigger Random Event</button></div>
                </div>
                <p id="eventStatusMessage" style="font-size:0.9rem; margin-top:0.5rem; min-height:1.2em; color: #f1c40f;"></p>
            </div>
            <div class="section stop-status-section">
                <h2>Manage Bus Stop Status (Live Effect)</h2>
                <div class="form-grid stop-status-section" style="grid-template-columns: 2fr auto auto; align-items:end;">
                    <div><label for="selectStopForStatusChange">Select Stop:</label><select id="selectStopForStatusChange"><option value="">-- Select a Stop --</option></select></div>
                    <div style="padding-bottom:0.05rem;"><button id="closeStopButton" class="button secondary" style="width:100%;">Close Stop</button></div>
                    <div style="padding-bottom:0.05rem;"><button id="reopenStopButton" class="button" style="background-color: #2ecc71; width:100%;">Reopen Stop</button></div>
                </div>
                <p id="stopStatusMessage" style="font-size:0.9rem; margin-top:0.5rem; min-height:1.2em; color: #f1c40f;"></p>
            </div>


            <div class="section manage-service-messages">
                <h2>Manage Service Messages</h2>
                <input type="hidden" id="editingServiceMessageId" value="">
                <div class="form-grid manage-service-messages-form" style="grid-template-columns: 1fr 1fr;">
                    <div>
                        <label for="smTargetType">Target Type</label>
                        <select id="smTargetType">
                            <option value="global">Global (All Stops)</option>
                            <option value="stop">Specific Stop</option>
                            <option value="route">Specific Route</option>
                        </select>
                    </div>
                    <div id="smTargetValueStopContainer" class="conditional-input">
                        <label for="smTargetValueStop">Target Stop</label>
                        <select id="smTargetValueStop">
                            <option value="">-- Select a Stop --</option>
                        </select>
                    </div>
                    <div id="smTargetValueRouteContainer" class="conditional-input">
                        <label for="smTargetValueRoute">Target Route</label>
                        <select id="smTargetValueRoute">
                            <option value="">-- Select a Route --</option>
                        </select>
                    </div>
                     <div> <label for="smText">Message Text</label>
                        <textarea id="smText" placeholder="Enter service message..."></textarea>
                    </div>
                </div>
                 <div class="form-grid manage-service-messages-form" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div>
                        <label for="smScrollSpeed">Scroll Duration (e.g., 20s)</label>
                        <input type="text" id="smScrollSpeed" value="20s" placeholder="e.g., 15s, 30s">
                    </div>
                    <div>
                        <label for="smLoopDelay">Pause Between Loops (seconds)</label>
                        <input type="number" id="smLoopDelay" value="0" min="0" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="smIsActive" style="margin-bottom: 0.5rem;">Active</label>
                        <input type="checkbox" id="smIsActive" checked style="width: auto; height: auto; margin-top: 0.5rem;">
                    </div>
                </div>
                 <div class="form-grid manage-service-messages-form" style="grid-template-columns: 1fr 1fr; display:none;"> <div>
                        <label for="smTextColor">Text Color (optional)</label>
                        <input type="color" id="smTextColor" value="#FFD700">
                    </div>
                    <div>
                        <label for="smBackgroundColor">Background Color (optional, e.g. rgba(0,0,0,0.5))</label>
                        <input type="text" id="smBackgroundColor" placeholder="rgba(0,0,0,0.5)">
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button id="addServiceMessageButton" class="button">Add Service Message</button>
                    <button id="updateServiceMessageButton" class="button tertiary" style="display:none;">Update Message</button>
                    <button id="cancelEditServiceMessageButton" class="button neutral" style="display:none;">Cancel Edit</button>
                </div>
                <p id="serviceMessagesStatus" style="font-size:0.9rem; margin-top:0.75rem; min-height:1.2em; color: #f1c40f;"></p>

                <h3 style="font-size: 1.2rem; margin-top: 2rem; margin-bottom: 0.5rem; color: #ecf0f1; border-bottom: 1px solid #7f8c8d30; padding-bottom: 0.25rem;">Current Service Messages</h3>
                <div id="serviceMessagesTableContainer">
                    <table>
                        <thead>
                            <tr>
                                <th>Text</th>
                                <th>Target</th>
                                <th>Speed</th>
                                <th>Pause (s)</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="serviceMessagesTableBody">
                            <tr><td colspan="6" style="text-align:center; padding:1rem; font-style:italic;">Loading messages...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="section route-colour-management">
                <h2>Route Tile Colour Management</h2>
                <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">Define custom colours for specific routes. These will override default colours on the arrivals board. Select a route from the dropdown (populated from your current working schedule).</p>
                <div class="form-grid" style="grid-template-columns: 1.5fr 1fr auto; align-items: end; gap: 0.75rem;">
                    <div><label for="selectRouteNameColour">Route Name</label><select id="selectRouteNameColour"><option value="">-- Select a Route --</option></select></div>
                    <div><label for="inputRouteColour">Select Colour</label><input type="color" id="inputRouteColour" value="#73809C" autocomplete="off"></div>
                    <div style="padding-bottom:0.05rem;"><button id="saveRouteColourButton" class="button" style="width:100%;">Save Colour</button></div>
                </div>
                <div id="currentRouteColoursListContainer"><h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #ecf0f1;">Current Route Colours</h3><ul id="currentRouteColoursList" style="list-style: none; padding: 0;"></ul><p id="noCustomColoursMessage" style="font-style: italic; opacity: 0.7; text-align:center; padding: 0.5rem 0;">No routes in working schedule to assign colours to.</p></div>
                <p id="routeColourStatusMessage" style="font-size:0.9rem; margin-top:0.75rem; min-height:1.2em; color: #f1c40f;"></p>
            </div>
            <div class="section view-stop-departures">
                <h2>View Scheduled Departures by Stop (from Working Schedule)</h2>
                <div class="form-grid" style="grid-template-columns: 1fr 2fr; align-items: start; gap: 1.5rem;">
                    <div><label for="selectStopForDeparturesView">Select Bus Stop:</label><select id="selectStopForDeparturesView"><option value="">-- Select a Stop --</option></select></div>
                    <div><label>Scheduled Departures:</label><div id="stopDeparturesListContainer" style="max-height: 350px; overflow-y: auto; border: 1px solid #4A5568; border-radius: 0.25rem; padding: 0.75rem; background-color: rgba(0,0,0,0.05);"><ul id="stopDeparturesList" style="list-style: none; padding: 0;"></ul><p id="noDeparturesForStopMessage" style="text-align: center; padding: 1rem; font-style: italic; opacity: 0.7;">Select a stop to view its scheduled departures.</p></div></div>
                </div>
            </div>
            <div class="section schedule-display">
                <h2>Current Working Schedule (<span id="entryCount">0</span> entries)</h2>
                <p style="font-size:0.85em; opacity:0.8; margin-bottom:0.5rem;"><em>This table shows the schedule you are currently preparing. Use actions below to make it live.</em></p>
                <div class="filter-controls">
                    <div><label for="filterStopID">Filter Stop ID:</label><input type="text" id="filterStopID" placeholder="e.g. EDGWHLS" autocomplete="off"></div>
                    <div><label for="filterLineName">Filter Line:</label><input type="text" id="filterLineName" placeholder="e.g. 186" autocomplete="off"></div>
                    <div><label for="filterOperatingProfile">Filter Profile:</label><input type="text" id="filterOperatingProfile" placeholder="e.g. MoSch" autocomplete="off"></div>
                    <div><label>&nbsp;</label><button id="clearFiltersButton" class="button neutral" style="width:100%; padding:0.5rem;">Clear Filters</button></div>
                </div>
                <div id="currentScheduleTableContainer"><table><thead><tr><th data-sortkey="stopID">Stop ID <span class="sort-arrow"></span></th><th data-sortkey="stopName">Stop Name <span class="sort-arrow"></span></th><th data-sortkey="direction">Direction <span class="sort-arrow"></span></th><th data-sortkey="lineName">Line <span class="sort-arrow"></span></th><th data-sortkey="destinationName">Destination <span class="sort-arrow"></span></th><th data-sortkey="scheduledTime">Time <span class="sort-arrow"></span></th><th data-sortkey="OperatingProfile">Profile(s) <span class="sort-arrow"></span></th><th data-sortkey="DayOffset">Offset <span class="sort-arrow"></span></th><th style="width:100px;">Actions</th></tr></thead><tbody id="currentScheduleTableBody"></tbody></table></div>
            </div>
            <div class="section count-file-upload">
                <h2>Upload Full Schedule (replaces current working schedule)</h2>
                <p style="font-size:0.8em; margin-bottom:0.5em;"><em>Note: Uploading a .COUNT file will replace all entries in the "Current Working Schedule" table above.</em></p>
                <label for="count-file-input" class="file-upload-label">Choose .COUNT File</label>
                <input type="file" id="count-file-input" accept=".COUNT,.txt" style="display: none;">
                <p id="file-status">No file selected.</p>
            </div>
            <div class="actions-section section">
                <h2>Schedule Deployment</h2>
                <div id="stagingStatusMessage" style="text-align:center; margin-bottom: 1rem; font-size: 0.9em; color: #f1c40f;">Checking status...</div>
                <button id="stageScheduleButton" class="button">Stage Current Working Schedule for Update</button>
                <button id="applyNowButton" class="button tertiary" style="margin-left: 0.5rem;">Apply Staged Schedule Live NOW</button>
                <hr style="margin: 1.5rem 0; border-color: rgba(255,255,255,0.1);">
                <button id="viewArrivalsButton" class="button" style="margin-left: 0.5rem;">View Arrivals Board</button>
            </div>

        </div> </div> <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getDatabase, ref, set, onValue, get, child, update, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"; // Added push, serverTimestamp

      const firebaseConfig = {
        apiKey: "AIzaSyDePDF-kZahjzh9ij6tkuApIhoGePwVQ2s",
        authDomain: "omsi-c5505.firebaseapp.com",
        databaseURL: "https://omsi-c5505-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "omsi-c5505",
        storageBucket: "omsi-c5505.appspot.com",
        messagingSenderId: "503595375440",
        appId: "1:503595375440:web:356be6684b77ff5909ea55",
        measurementId: "G-VN7X65V3F9"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      window.firebaseOMSI = {
          database: database,
          auth: auth,
          dbRef: ref, dbSet: set, dbOnValue: onValue, dbGet: get,
          dbChild: child, dbUpdate: update, dbRemove: remove, dbPush: push, dbServerTimestamp: serverTimestamp, // Added push and serverTimestamp
          authOnAuthStateChanged: onAuthStateChanged,
          authSignInWithEmailAndPassword: signInWithEmailAndPassword,
          authSignOut: signOut
      };
      console.log("Firebase Initialized for OMSI Tools (with Auth).");
    </script>

    <script>
        // --- Global Variables & DOM Elements (Existing) ---
        const inputStopID = document.getElementById('inputStopID');
        // ... (all your other existing const declarations for UI elements) ...
        const inputStopName = document.getElementById('inputStopName');
        const inputDirection = document.getElementById('inputDirection');
        const inputLineName = document.getElementById('inputLineName');
        const inputDestinationName = document.getElementById('inputDestinationName');
        const inputScheduledTime = document.getElementById('inputScheduledTime');
        const inputOperatingProfile = document.getElementById('inputOperatingProfile');
        const selectDayOffset = document.getElementById('selectDayOffset');
        const addEntryButton = document.getElementById('addEntryButton');
        const updateEntryButton = document.getElementById('updateEntryButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const editingEntryIndexInput = document.getElementById('editingEntryIndex');
        const countFileInput = document.getElementById('count-file-input');
        const fileStatusElement = document.getElementById('file-status');
        const currentProfileDisplayElement = document.getElementById('current-profile-display');
        const currentScheduleTableBody = document.getElementById('currentScheduleTableBody');
        const entryCountElement = document.getElementById('entryCount');
        const filterStopIDInput = document.getElementById('filterStopID');
        const filterLineNameInput = document.getElementById('filterLineName');
        const filterOperatingProfileInput = document.getElementById('filterOperatingProfile');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const bulkEditTargetStopIDInput = document.getElementById('bulkEditTargetStopID');
        const currentBulkEditStopNameDisplay = document.getElementById('currentBulkEditStopNameDisplay');
        const currentBulkEditDirectionDisplay = document.getElementById('currentBulkEditDirectionDisplay');
        const bulkEditNewStopNameInput = document.getElementById('bulkEditNewStopName');
        const bulkEditNewDirectionInput = document.getElementById('bulkEditNewDirection');
        const bulkUpdateDetailsButton = document.getElementById('bulkUpdateDetailsButton');
        const bulkEditTargetLineNameInput = document.getElementById('bulkEditTargetLineName');
        const bulkEditOldDestinationInput = document.getElementById('bulkEditOldDestination');
        const bulkEditNewDestinationInput = document.getElementById('bulkEditNewDestination');
        const bulkUpdateRouteDestinationButton = document.getElementById('bulkUpdateRouteDestinationButton');
        const selectEventRoute = document.getElementById('selectEventRoute');
        const selectEventImpactStop = document.getElementById('selectEventImpactStop');
        const triggerEventButton = document.getElementById('triggerEventButton');
        const eventStatusMessage = document.getElementById('eventStatusMessage');
        const selectStopForStatusChange = document.getElementById('selectStopForStatusChange');
        const closeStopButton = document.getElementById('closeStopButton');
        const reopenStopButton = document.getElementById('reopenStopButton');
        const stopStatusMessage = document.getElementById('stopStatusMessage');
        const stageScheduleButton = document.getElementById('stageScheduleButton');
        const applyNowButton = document.getElementById('applyNowButton');
        const viewArrivalsButton = document.getElementById('viewArrivalsButton');
        const stagingStatusMessage = document.getElementById('stagingStatusMessage');
        const selectRouteNameColour = document.getElementById('selectRouteNameColour');
        const inputRouteColour = document.getElementById('inputRouteColour');
        const saveRouteColourButton = document.getElementById('saveRouteColourButton');
        const currentRouteColoursList = document.getElementById('currentRouteColoursList');
        const noCustomColoursMessage = document.getElementById('noCustomColoursMessage');
        const routeColourStatusMessage = document.getElementById('routeColourStatusMessage');
        const selectStopForDeparturesView = document.getElementById('selectStopForDeparturesView');
        const stopDeparturesList = document.getElementById('stopDeparturesList');
        const noDeparturesForStopMessage = document.getElementById('noDeparturesForStopMessage');
        
        const mainToolContentDiv = document.getElementById('main-tool-content');
        const loginFormContainer = document.getElementById('login-form-container');
        const logoutContainer = document.getElementById('logout-container');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const inputEmail = document.getElementById('inputEmail');
        const inputPassword = document.getElementById('inputPassword');
        const authStatus = document.getElementById('auth-status');
        const loggedInUserEmailDisplay = document.getElementById('loggedInUserEmail');

        // --- Service Message Management UI Elements ---
        const editingServiceMessageIdInput = document.getElementById('editingServiceMessageId');
        const smTargetTypeSelect = document.getElementById('smTargetType');
        const smTargetValueStopContainer = document.getElementById('smTargetValueStopContainer');
        const smTargetValueStopSelect = document.getElementById('smTargetValueStop');
        const smTargetValueRouteContainer = document.getElementById('smTargetValueRouteContainer');
        const smTargetValueRouteSelect = document.getElementById('smTargetValueRoute');
        const smTextTextarea = document.getElementById('smText');
        const smScrollSpeedInput = document.getElementById('smScrollSpeed');
        const smLoopDelayInput = document.getElementById('smLoopDelay');
        const smIsActiveCheckbox = document.getElementById('smIsActive');
        // Optional color pickers - get them if you enable the HTML
        // const smTextColorInput = document.getElementById('smTextColor');
        // const smBackgroundColorInput = document.getElementById('smBackgroundColor');
        const addServiceMessageButton = document.getElementById('addServiceMessageButton');
        const updateServiceMessageButton = document.getElementById('updateServiceMessageButton');
        const cancelEditServiceMessageButton = document.getElementById('cancelEditServiceMessageButton');
        const serviceMessagesStatusP = document.getElementById('serviceMessagesStatus');
        const serviceMessagesTableBody = document.getElementById('serviceMessagesTableBody');
        
        // --- Global State Variables (Existing) ---
        let currentUser = null; 
        let currentWorkingSchedule = [];
        // ... (all your other existing let variables) ...
        let ukBankHolidaysData = { dates: [], titles: {} };
        const schoolHolidayDateRanges = [ ]; 
        let activeFilters = { stopID: '', lineName: '', operatingProfile: '' };
        let sortConfig = { key: null, direction: 'asc' };
        let closedStopIDs = [];
        let customRouteColours = {};
        let effectiveRouteColourMapTools = {};

        const eventTypes = [ 
            { name: "Delay Route (5-15 min)", type: "DELAY_ROUTE", minDelay: 5, maxDelay: 15 },
            { name: "Delay From Stop (3-10 min)", type: "DELAY_FROM_STOP", minDelay: 3, maxDelay: 10 },
            { name: "Curtail Service", type: "CURTAIL" }
        ];
        // --- Firebase Path Constants (Existing & New) ---
        const FB_PATH_LIVE_SCHEDULE_DATA = '/liveSchedule/allScheduledBusData';
        // ... (all your other existing FB_PATH constants) ...
        const FB_PATH_LIVE_UNIQUE_STOPS = '/liveSchedule/uniqueBusStops';
        const FB_PATH_PENDING_SCHEDULE_DATA = '/pendingSchedule/allScheduledBusData';
        const FB_PATH_PENDING_UNIQUE_STOPS = '/pendingSchedule/uniqueBusStops';
        const FB_PATH_PENDING_TIMESTAMP = '/pendingSchedule/uploadTimestamp';
        const FB_PATH_APPSTATE_STATUS = '/appState/scheduleStatus';
        const FB_PATH_APPSTATE_LAST_UPDATED = '/appState/scheduleLastUpdated';
        const FB_PATH_APPSTATE_CLOSED_STOPS = '/appState/closedStopIDs';
        const FB_PATH_SETTINGS_CUSTOM_COLOURS = '/settings/customRouteColours';
        const FB_PATH_OLD_SERVICE_MESSAGE = '/appState/serviceMessage'; // Old path, can be removed later
        const FB_PATH_SERVICE_MESSAGES = '/serviceMessages'; // New path for structured messages

        const CUSTOM_ROUTE_COLOURS_KEY = 'omsiCustomRouteTileColours';
        const initialRouteColourMapForTools = { /* ... */ };
        const DEFAULT_ROUTE_COLOUR_TOOLS = "#73809C";

        // --- Authentication UI Update Function (Existing) ---
        function updateAuthUI(user) { /* ... keep existing ... */ 
            currentUser = user;
            if (user) {
                if (loginFormContainer) loginFormContainer.style.display = 'none';
                if (logoutContainer) logoutContainer.style.display = 'block';
                if (authStatus) authStatus.textContent = '';
                if (loggedInUserEmailDisplay) loggedInUserEmailDisplay.textContent = user.email;
                if (mainToolContentDiv) mainToolContentDiv.style.display = 'block';
            } else {
                if (loginFormContainer) loginFormContainer.style.display = 'block';
                if (logoutContainer) logoutContainer.style.display = 'none';
                if (authStatus) authStatus.textContent = 'Please log in to use the tools.';
                if (loggedInUserEmailDisplay) loggedInUserEmailDisplay.textContent = '';
                if (mainToolContentDiv) mainToolContentDiv.style.display = 'none';
            }
        }

        // --- Existing Helper Functions (Core Logic - keep all your existing functions) ---
        function parseLineName(lineNameStr) { /* ... */ }
        function compareLineNames(lineAStr, lineBStr) { /* ... */ }
        async function fetchBankHolidaysForSetup() { /* ... */ }
        function isSchoolHolidayPeriodForSetup(dateObject) { /* ... */ }
        function updateCurrentProfileDisplayOnSetup() { /* ... */ }
        function applyFiltersAndSort(schedule) { /* ... */ }
        function updateSortArrows() { /* ... */ }
        function resetForm() { /* ... */ } // This is for the schedule entry form
        function loadEntryForEdit(idx) { /* ... */ }
        function handleInputStopIDChange() { /* ... */ }
        function handleAddOrUpdateEntry() { /* ... */ }
        function handleDeleteEntry(originalIndexPassed) { /* ... */ }
        function isValidScheduleDataFromText(jsonData) { /* ... */ }
        function handleCountFileUpload(event) { /* ... */ }
        function handleBulkUpdateStopDetails() { /* ... */ }
        function handleBulkUpdateRouteDestination() { /* ... */ }
        function displayCurrentDetailsForBulkStopEdit() { /* ... */ }
        function handleStageSchedule() { /* ... */ }
        function handleApplyNow() { /* ... */ }
        async function loadInitialData() { /* ... (ensure this is called on auth) ... */ 
            console.log("Tools: Attempting to load initial data, prioritizing Firebase...");
            let sourceMessage = "Loading data...";
            if (fileStatusElement) fileStatusElement.textContent = sourceMessage;

            currentWorkingSchedule = []; 
            closedStopIDs = [];
            customRouteColours = {};

            if (!window.firebaseOMSI) {
                console.warn("Tools: Firebase not initialized. Cannot load data from Firebase.");
                sourceMessage = "Firebase not connected. No data loaded.";
            } else {
                const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI;
                try {
                    const liveScheduleSnapshot = await dbGet(dbChild(dbRef(database), FB_PATH_LIVE_SCHEDULE_DATA));
                    if (liveScheduleSnapshot.exists() && Array.isArray(liveScheduleSnapshot.val())) {
                        currentWorkingSchedule = liveScheduleSnapshot.val().map((entry, index) => ({
                            ...entry,
                            internalId: entry.internalId || `${(entry.stopID || 's')}_${(entry.lineName||'l')}_${(entry.scheduledTime||"").replace(':','')}_${index}_fbloaded`
                        }));
                    }

                    const closedStopsSnapshot = await dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_CLOSED_STOPS));
                    if (closedStopsSnapshot.exists()) { const fbClosedStops = closedStopsSnapshot.val(); for (const stopID in fbClosedStops) { if (fbClosedStops[stopID] === true) { closedStopIDs.push(stopID); } } }

                    const customColoursSnapshot = await dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_CUSTOM_COLOURS));
                    if (customColoursSnapshot.exists()) { customRouteColours = customColoursSnapshot.val(); }
                    
                    sourceMessage = `Data loaded from Firebase. ${currentWorkingSchedule.length} schedule entries.`;
                } catch (error) {
                    console.error("Tools: Error loading initial data from Firebase:", error);
                    sourceMessage = "Error loading data from Firebase. Check console.";
                }
            }
            if (fileStatusElement) fileStatusElement.textContent = sourceMessage;
            loadAndApplyCustomRouteColoursForTools();
            renderScheduleTable(); // This also calls populate functions
            updateStagingStatusDisplay(); 
            populateStopStatusSelector(); // Could be part of renderScheduleTable's chain
        }
        async function updateStagingStatusDisplay() { /* ... */ }
        function saveClosedStops() { /* ... */ }
        function saveCustomRouteColours() { /* ... */ }
        function populateRouteSelectorForEvents() { /* ... */ } // Used by random event gen
        function populateImpactStopSelector() { /* ... */ }  // Used by random event gen
        async function populateStopStatusSelector() { /* ... */ } // For stop status management
        function handleStopStatusChange(action) { /* ... */ }
        function applyRandomEvent() { /* ... */ }
        function loadAndApplyCustomRouteColoursForTools() { /* ... */ }
        function renderCustomRouteColours() { /* ... */ }
        function populateRouteSelectorForColours() { /* ... */ } // For route colour tools
        function handleSaveRouteColour() { /* ... */ }
        function handleRemoveRouteColour(routeNameKey) { /* ... */ }
        function getRouteTileColourForTools(lineName) { /* ... */ }
        function getTextColourForBackgroundTools(hexColour) { /* ... */ }
        function getDaySortOrder(profileString) { /* ... */ }
        function populateStopSelectorForDeparturesView() { /* ... */ } // For view departures tool
        function displayDeparturesForSelectedStop() { /* ... */ }
        function renderScheduleTable() { 
            if (!currentScheduleTableBody || !entryCountElement) return; 
            // ... (rest of your existing renderScheduleTable)
            // At the end of renderScheduleTable or after currentWorkingSchedule is populated:
            populateSmTargetDropdowns(); // Populate service message target dropdowns
        }
        // --- END OF Existing Helper Functions ---


        // --- NEW Service Message Management Functions ---
        function populateSmTargetDropdowns() {
            if (!smTargetValueStopSelect || !smTargetValueRouteSelect) return;

            // Populate Stops Dropdown
            smTargetValueStopSelect.innerHTML = '<option value="">-- Select a Stop --</option>';
            const uniqueStopsForSm = [...new Map(currentWorkingSchedule.map(item => [item.stopID, {id: item.stopID, name: item.stopName || item.stopID}])).values()]
                                  .sort((a,b) => (a.name.toLowerCase()).localeCompare(b.name.toLowerCase()));
            uniqueStopsForSm.forEach(stop => {
                if (stop.id) {
                    const option = document.createElement('option');
                    option.value = stop.id;
                    option.textContent = `${stop.name} (${stop.id})`;
                    smTargetValueStopSelect.appendChild(option);
                }
            });

            // Populate Routes Dropdown
            smTargetValueRouteSelect.innerHTML = '<option value="">-- Select a Route --</option>';
            const uniqueRoutesForSm = [...new Set(currentWorkingSchedule.map(entry => entry.lineName))]
                                    .filter(name => name && name.trim() !== "")
                                    .sort(compareLineNames);
            uniqueRoutesForSm.forEach(routeName => {
                const option = document.createElement('option');
                option.value = routeName;
                option.textContent = routeName;
                smTargetValueRouteSelect.appendChild(option);
            });
        }

        function handleSmTargetTypeChange() {
            const targetType = smTargetTypeSelect.value;
            smTargetValueStopContainer.classList.remove('active');
            smTargetValueRouteContainer.classList.remove('active');
            smTargetValueStopSelect.value = '';
            smTargetValueRouteSelect.value = '';

            if (targetType === 'stop') {
                smTargetValueStopContainer.classList.add('active');
            } else if (targetType === 'route') {
                smTargetValueRouteContainer.classList.add('active');
            }
        }

        function resetServiceMessageForm() {
            editingServiceMessageIdInput.value = '';
            smTargetTypeSelect.value = 'global';
            handleSmTargetTypeChange(); // To reset conditional inputs
            smTextTextarea.value = '';
            smScrollSpeedInput.value = '20s';
            smLoopDelayInput.value = '0';
            smIsActiveCheckbox.checked = true;
            // Reset optional colors if you implement them
            // smTextColorInput.value = '#FFD700';
            // smBackgroundColorInput.value = 'rgba(0,0,0,0.5)';
            addServiceMessageButton.style.display = 'inline-block';
            updateServiceMessageButton.style.display = 'none';
            cancelEditServiceMessageButton.style.display = 'none';
            if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = '';
        }

        function handleAddOrUpdateServiceMessage() {
            if (!currentUser) { alert("Please log in."); return; }
            const { database, dbSet, dbRef, dbPush, dbUpdate, dbServerTimestamp } = window.firebaseOMSI;

            const messageData = {
                text: smTextTextarea.value.trim(),
                targetType: smTargetTypeSelect.value,
                targetValue: '',
                scrollSpeed: smScrollSpeedInput.value.trim() || '20s',
                loopDelay: parseInt(smLoopDelayInput.value) * 1000 || 0, // Convert seconds to ms
                isActive: smIsActiveCheckbox.checked,
                // textColor: smTextColorInput.value, // If using
                // backgroundColor: smBackgroundColorInput.value, // If using
            };

            if (!messageData.text) {
                if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Message text cannot be empty.';
                return;
            }

            if (messageData.targetType === 'stop') {
                messageData.targetValue = smTargetValueStopSelect.value;
                if (!messageData.targetValue) {
                    if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Please select a target stop.';
                    return;
                }
            } else if (messageData.targetType === 'route') {
                messageData.targetValue = smTargetValueRouteSelect.value;
                if (!messageData.targetValue) {
                    if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Please select a target route.';
                    return;
                }
            }
            
            const editingId = editingServiceMessageIdInput.value;
            if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = editingId ? 'Updating message...' : 'Adding message...';

            if (editingId) { // Update existing message
                messageData.updatedAt = dbServerTimestamp(); // Add/update an updatedAt timestamp
                dbUpdate(dbRef(database, `${FB_PATH_SERVICE_MESSAGES}/${editingId}`), messageData)
                    .then(() => {
                        if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Message updated successfully!';
                        resetServiceMessageForm();
                    })
                    .catch(error => {
                        console.error("Error updating service message: ", error);
                        if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = `Error: ${error.message}`;
                    });
            } else { // Add new message
                messageData.createdAt = dbServerTimestamp();
                dbPush(dbRef(database, FB_PATH_SERVICE_MESSAGES), messageData)
                    .then(() => {
                        if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Message added successfully!';
                        resetServiceMessageForm();
                    })
                    .catch(error => {
                        console.error("Error adding service message: ", error);
                        if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = `Error: ${error.message}`;
                    });
            }
        }

        function loadServiceMessagesForTable() {
            if (!currentUser || !window.firebaseOMSI) return;
            const { database, dbOnValue, dbRef } = window.firebaseOMSI;
            const messagesRef = dbRef(database, FB_PATH_SERVICE_MESSAGES);

            dbOnValue(messagesRef, (snapshot) => {
                serviceMessagesTableBody.innerHTML = ''; // Clear existing rows
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    let hasMessages = false;
                    for (const messageId in messages) {
                        hasMessages = true;
                        const msg = messages[messageId];
                        const row = serviceMessagesTableBody.insertRow();
                        row.insertCell().textContent = msg.text.length > 50 ? msg.text.substring(0, 47) + '...' : msg.text;
                        let targetDisplay = msg.targetType.charAt(0).toUpperCase() + msg.targetType.slice(1);
                        if (msg.targetValue) {
                            targetDisplay += `: ${msg.targetValue}`;
                        }
                        row.insertCell().textContent = targetDisplay;
                        row.insertCell().textContent = msg.scrollSpeed || 'N/A';
                        row.insertCell().textContent = (msg.loopDelay / 1000) + 's';
                        row.insertCell().textContent = msg.isActive ? 'Yes' : 'No';
                        
                        const actionsCell = row.insertCell();
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Edit';
                        editBtn.classList.add('button', 'small-action', 'tertiary');
                        editBtn.onclick = () => loadServiceMessageForEdit(messageId, msg);
                        actionsCell.appendChild(editBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Del';
                        deleteBtn.classList.add('button', 'small-action', 'secondary');
                        deleteBtn.onclick = () => handleDeleteServiceMessage(messageId);
                        actionsCell.appendChild(deleteBtn);
                    }
                    if (!hasMessages) {
                        serviceMessagesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem; font-style:italic;">No service messages configured yet.</td></tr>';
                    }
                } else {
                    serviceMessagesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem; font-style:italic;">No service messages configured yet.</td></tr>';
                }
            });
        }

        function loadServiceMessageForEdit(messageId, msgData) {
            editingServiceMessageIdInput.value = messageId;
            smTargetTypeSelect.value = msgData.targetType || 'global';
            handleSmTargetTypeChange(); // Ensure correct conditional inputs are shown
            if (msgData.targetType === 'stop') {
                smTargetValueStopSelect.value = msgData.targetValue || '';
            } else if (msgData.targetType === 'route') {
                smTargetValueRouteSelect.value = msgData.targetValue || '';
            }
            smTextTextarea.value = msgData.text || '';
            smScrollSpeedInput.value = msgData.scrollSpeed || '20s';
            smLoopDelayInput.value = msgData.loopDelay ? msgData.loopDelay / 1000 : '0';
            smIsActiveCheckbox.checked = msgData.isActive === undefined ? true : msgData.isActive;
            
            addServiceMessageButton.style.display = 'none';
            updateServiceMessageButton.style.display = 'inline-block';
            cancelEditServiceMessageButton.style.display = 'inline-block';
            smTextTextarea.focus();
        }

        function handleDeleteServiceMessage(messageId) {
            if (!currentUser) { alert("Please log in."); return; }
            if (!confirm("Are you sure you want to delete this service message?")) return;

            const { database, dbRemove, dbRef } = window.firebaseOMSI;
            dbRemove(dbRef(database, `${FB_PATH_SERVICE_MESSAGES}/${messageId}`))
                .then(() => {
                    if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = 'Message deleted successfully.';
                    // The onValue listener for the table will auto-refresh it.
                })
                .catch(error => {
                    console.error("Error deleting service message: ", error);
                    if (serviceMessagesStatusP) serviceMessagesStatusP.textContent = `Error deleting: ${error.message}`;
                });
        }

        // --- Document Ready ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.firebaseOMSI && window.firebaseOMSI.auth) {
                const { auth, authOnAuthStateChanged, authSignInWithEmailAndPassword, authSignOut } = window.firebaseOMSI;
                const adminLoginForm = document.getElementById('adminLoginForm');

                authOnAuthStateChanged(auth, (user) => {
                    updateAuthUI(user); 
                    if (user) {
                        console.log("User signed in, proceeding to load initial data for tools.");
                        fetchBankHolidaysForSetup();
                        loadInitialData(); // This will call renderScheduleTable, which calls populateSmTargetDropdowns
                        loadServiceMessagesForTable(); // Load and display existing service messages
                    } else {
                        console.log("User signed out or not yet signed in.");
                        currentWorkingSchedule = []; 
                        if(serviceMessagesTableBody) serviceMessagesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem; font-style:italic;">Please log in to manage messages.</td></tr>';
                        renderScheduleTable(); 
                        updateStagingStatusDisplay(); 
                    }
                });

                if (adminLoginForm) { 
                    adminLoginForm.addEventListener('submit', (event) => { 
                        event.preventDefault(); 
                        const email = inputEmail.value; 
                        const password = inputPassword.value; 
                        if(authStatus) authStatus.textContent = 'Logging in...'; 
                        authSignInWithEmailAndPassword(auth, email, password)
                            .then(() => { /* onAuthStateChanged handles UI */ })
                            .catch((error) => { 
                                console.error("Login failed:", error); 
                                if(authStatus) authStatus.textContent = `Error: ${error.message}`; 
                            }); 
                    });
                }
                if (logoutButton) {
                    logoutButton.addEventListener('click', () => { 
                        authSignOut(auth).catch((error) => console.error("Sign-out failed:", error)); 
                    });
                }
            } else {
                console.warn("Firebase Auth object not found on window. OMSI Tools auth will not function.");
                updateAuthUI(null); 
            }

            // --- Existing Event Listeners ---
            if (stageScheduleButton) stageScheduleButton.addEventListener('click', handleStageSchedule);
            // ... (all your other existing event listeners for buttons, inputs etc.)
            if (applyNowButton) applyNowButton.addEventListener('click', handleApplyNow);
            if (viewArrivalsButton) viewArrivalsButton.addEventListener('click', () => { window.location.href = "omsi_arrivals.html"; });
            if (addEntryButton) addEntryButton.addEventListener('click', handleAddOrUpdateEntry);
            if (updateEntryButton) updateEntryButton.addEventListener('click', handleAddOrUpdateEntry);
            if (cancelEditButton) cancelEditButton.addEventListener('click', resetForm);
            if (countFileInput) countFileInput.addEventListener('change', handleCountFileUpload);
            if(filterStopIDInput) filterStopIDInput.addEventListener('input', () => { activeFilters.stopID = filterStopIDInput.value; renderScheduleTable(); });
            if(filterLineNameInput) filterLineNameInput.addEventListener('input', () => { activeFilters.lineName = filterLineNameInput.value; renderScheduleTable(); });
            if(filterOperatingProfileInput) filterOperatingProfileInput.addEventListener('input', () => { activeFilters.operatingProfile = filterOperatingProfileInput.value; renderScheduleTable(); });
            if(clearFiltersButton) clearFiltersButton.addEventListener('click', () => { filterStopIDInput.value = ''; activeFilters.stopID = ''; filterLineNameInput.value = ''; activeFilters.lineName = ''; filterOperatingProfileInput.value = ''; activeFilters.operatingProfile = ''; sortConfig = { key: null, direction: 'asc' }; renderScheduleTable(); });
            document.querySelectorAll('#currentScheduleTableContainer th[data-sortkey]').forEach(headerCell => { headerCell.addEventListener('click', () => { const sortKey = headerCell.dataset.sortkey; if (sortConfig.key === sortKey) { sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc'; } else { sortConfig.key = sortKey; sortConfig.direction = 'asc'; } renderScheduleTable(); }); });
            if(inputStopID) { inputStopID.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); handleInputStopIDChange(); }); inputStopID.addEventListener('blur', handleInputStopIDChange); }
            if(inputLineName) { inputLineName.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); }); }
            if(bulkEditTargetStopIDInput) { bulkEditTargetStopIDInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); displayCurrentDetailsForBulkStopEdit(); }); bulkEditTargetStopIDInput.addEventListener('blur', displayCurrentDetailsForBulkStopEdit); }
            if(bulkEditTargetLineNameInput) { bulkEditTargetLineNameInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); }); }
            if(bulkUpdateDetailsButton) bulkUpdateDetailsButton.addEventListener('click', handleBulkUpdateStopDetails);
            if(bulkUpdateRouteDestinationButton) bulkUpdateRouteDestinationButton.addEventListener('click', handleBulkUpdateRouteDestination);
            if (selectEventRoute) selectEventRoute.addEventListener('change', populateImpactStopSelector);
            if (triggerEventButton) triggerEventButton.addEventListener('click', applyRandomEvent);
            if (closeStopButton) closeStopButton.addEventListener('click', () => handleStopStatusChange('close'));
            if (reopenStopButton) reopenStopButton.addEventListener('click', () => handleStopStatusChange('reopen'));
            if (saveRouteColourButton) saveRouteColourButton.addEventListener('click', handleSaveRouteColour);
            if (selectRouteNameColour) { selectRouteNameColour.addEventListener('change', () => { const selectedRoute = selectRouteNameColour.value; if (selectedRoute && customRouteColours[selectedRoute.toUpperCase()]) { inputRouteColour.value = customRouteColours[selectedRoute.toUpperCase()]; } else { inputRouteColour.value = DEFAULT_ROUTE_COLOUR_TOOLS; } }); }
            if (selectStopForDeparturesView) { selectStopForDeparturesView.addEventListener('change', displayDeparturesForSelectedStop); }
            
            // --- NEW Service Message Event Listeners ---
            if (smTargetTypeSelect) {
                smTargetTypeSelect.addEventListener('change', handleSmTargetTypeChange);
            }
            if (addServiceMessageButton) {
                addServiceMessageButton.addEventListener('click', handleAddOrUpdateServiceMessage);
            }
            if (updateServiceMessageButton) {
                updateServiceMessageButton.addEventListener('click', handleAddOrUpdateServiceMessage);
            }
            if (cancelEditServiceMessageButton) {
                cancelEditServiceMessageButton.addEventListener('click', resetServiceMessageForm);
            }

            // Initial setup
            handleSmTargetTypeChange(); // Set initial state of conditional inputs
            fetchBankHolidaysForSetup(); 
        });
    </script>
</body>
</html>
