<!DOCTYPE html>
<html>
<head>
    <title>Mobitec Barcode Generator</title>
    <link rel="manifest" href="manifest-tools.json">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* --- CSS (Mostly unchanged from previous version) --- */
        body { font-family: Arial, sans-serif; margin: 0; padding-top: 20px; text-align: center; }
        #loadingMessage, h1, .input-container, #errorMessage, #barcodeContainer, #simplicityIndex, #explanation { display: none; }
        #enterButton {
            font-size: 20px; padding: 15px 30px; cursor: pointer; background-color: #007BFF;
            color: white; border: none; border-radius: 5px; margin-top: 50px; display: inline-block;
        }
        #enterButton:hover { background-color: #0056b3; }
        .loading-message { font-size: 18px; color: #007BFF; margin: 0 0 20px 0; }
        .content-visible h1, .content-visible .input-container, .content-visible #errorMessage,
        .content-visible #simplicityIndex, .content-visible #explanation { display: block; }
        .content-visible #barcodeContainer { display: flex; }
        .content-visible .input-container { display: inline-block; }
        /* Input, barcode, bar, etc. styles remain the same */
        .input-container { background-color: #f9f9f9; border-bottom: 1px solid #ddd; padding: 10px 15px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 20px; text-align: left; }
        .input-container label { margin-right: 5px; }
        .input-container input { font-size: 16px; padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        #errorMessage { color: red; margin-top: 20px; min-height: 1.2em; }
        .barcode { flex-direction: column-reverse; align-items: center; justify-content: center; margin: 20px auto; min-height: 260px; background-color: white; border: 1px solid #eee; padding: 5px 0; }
        .bar { width: 70px; margin: 2px 0; flex-shrink: 0; }
        .bar[style*="background-color: white"] { border: 1px solid #eee; box-sizing: border-box;}
        .small-bar { height: 20px; } .thick-bar { height: 40px; }
        #simplicityIndex, #explanation { margin-top: 20px; min-height: 1.2em; }
        #explanation { margin-top: 5px; font-style: italic; }
        /* --- END OF CSS --- */
    </style>
</head>
<body class=""> <button id="enterButton">Start</button>
    <div id="loadingMessage" class="loading-message" style="display: none;">Self testing. Loading...</div>
    <div class="input-container">
        <label for="numberInput">Enter a number:</label>
        <input type="text" id="numberInput" inputmode="numeric" pattern="[0-9]*" placeholder="Enter 0-255 or 511" oninput="validateAndGenerate()" />
    </div>
    <h1>Mobitec Barcode Generator</h1>
    <div id="errorMessage"></div>
    <div class="barcode" id="barcodeContainer"></div>
    <div id="simplicityIndex"></div>
    <div id="explanation"></div>
    <audio id="audioPlayer" src="assets/Self Test copy.m4a" type="audio/mp4" preload="auto"></audio>

    <script>
        // --- Get References ---
        const enterButton = document.getElementById('enterButton');
        const loadingMessage = document.getElementById("loadingMessage");
        const audioPlayer = document.getElementById("audioPlayer");
        const numberInputField = document.getElementById("numberInput");

        // --- Function called 5 seconds after button click ---
        function finishLoadingAndPlaySound() {
            console.log("5 second loading timer finished.");

            // 1. Play the sound NOW (permission should exist from initial click)
            if (audioPlayer) {
                // Reset playback position in case it was paused previously
                audioPlayer.currentTime = 0;
                audioPlayer.play()
                    .then(() => {
                        console.log("Audio playback started as loading finished.");
                    })
                    .catch(e => {
                        console.error("Audio play failed when loading finished:", e);
                    });
            } else {
                console.log("Audio player not found when trying to play sound.");
            }

            // 2. Hide loading message
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }

            // 3. Show main content
            document.body.classList.add('content-visible');
            console.log("Main content shown.");

             // Optional: focus the input field
             if(numberInputField) {
                 numberInputField.focus();
             }
        }


        // --- Main Function triggered by button click ---
        function startSiteEntry() {
            // 1. Hide the button
            if (enterButton) enterButton.style.display = 'none';

            // 2. Show the loading message
            if (loadingMessage) loadingMessage.style.display = 'block';
            console.log("Loading message shown.");

            // 3. Try to "claim" audio permission immediately after click
            if (audioPlayer) {
                // Explicitly load
                audioPlayer.load();
                // Attempt a muted play or play/pause immediately to satisfy interaction requirement
                // This makes the *later* play call more likely to succeed
                let promise = audioPlayer.play();
                if (promise !== undefined) {
                    promise.then(_ => {
                        // Play started (likely silent/brief), pause immediately.
                        // We don't want sound *yet*.
                        audioPlayer.pause();
                        console.log("Audio permission likely obtained silently.");
                    }).catch(error => {
                        // An immediate error here might indicate bigger issues (bad file?)
                        // or sometimes browsers block even this silent attempt.
                        console.warn("Initial silent play/pause failed (might be okay):", error);
                    });
                }
            }

            // 4. Start the fixed 5-second timer for the loading period
            console.log("Starting 5 second loading timer...");
            setTimeout(finishLoadingAndPlaySound, 5000);
        }


        // --- Attach Event Listener to the Enter Button ---
        if (enterButton) {
            enterButton.addEventListener('click', startSiteEntry);
        } else {
             console.error("Enter button not found!");
        }


        // --- Your other original JavaScript functions (Keep them as they were) ---
        function validateAndGenerate() {
            const inputField = document.getElementById("numberInput"); const nonNumericRegex = /[^0-9]/g;
            if (inputField) {
                 let value = inputField.value;
                 if (nonNumericRegex.test(value)) {
                     const start = inputField.selectionStart; const end = inputField.selectionEnd; const originalLength = value.length;
                     inputField.value = value.replace(nonNumericRegex, "");
                     const newLength = inputField.value.length; const diff = originalLength - newLength;
                     if (diff > 0 && start !== null && end !== null) {
                         const newCursorPos = Math.max(0, start - diff);
                         setTimeout(() => { inputField.setSelectionRange(newCursorPos, newCursorPos); }, 0);
                     }
                 }
                 generateBarcode();
            }
        }
        if (numberInputField) { numberInputField.addEventListener("keydown", function (event) { if (event.key === "Enter") { event.preventDefault(); generateBarcode(); numberInputField.blur(); } }); }
        function generateBarcode() {
            const container = document.getElementById("barcodeContainer"); const errorMessage = document.getElementById("errorMessage"); const simplicityIndex = document.getElementById("simplicityIndex"); const explanation = document.getElementById("explanation"); const numberInput = document.getElementById("numberInput");
            if (!container || !errorMessage || !simplicityIndex || !explanation || !numberInput) { return; } const numberStr = numberInput.value;
            errorMessage.textContent = ""; container.innerHTML = ""; simplicityIndex.innerHTML = ""; explanation.innerHTML = ""; if (numberStr === "") { return; } const number = parseInt(numberStr, 10);
            if (isNaN(number) || number < 0 || (number > 255 && number !== 511)) { errorMessage.textContent = "Invalid number! Enter between 0â€“255, or 511."; return; } const binaryArray = number.toString(2).padStart(9, "0").split(""); const reversedBinaryArray = [...binaryArray].reverse();
            addBar(container, "black", "thick-bar"); reversedBinaryArray.forEach((bit) => { addBar(container, bit === "1" ? "black" : "white", "small-bar"); }); addBar(container, "black", "small-bar");
            const simplicityScore = binaryArray.filter(bit => bit === "1").length; simplicityIndex.textContent = `Simplicity Index: ${simplicityScore}/9`; explanation.textContent = `Input: ${number} | Binary: ${binaryArray.join("")}`;
        }
        function addBar(container, color, sizeClass) { const bar = document.createElement("div"); bar.className = `bar ${sizeClass}`; bar.style.backgroundColor = color === "black" ? "black" : "white"; container.appendChild(bar); }
        // --- End of original JavaScript ---
    </script>

</body>
</html>
