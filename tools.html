<!DOCTYPE html>
<html>
<head>
    <title>Live Tracker (Tools) - Debug v14 Corrected Structure</title> <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- CSS Styles (Includes Audit/Suspension styles) --- */
        /* Basic Reset & Font */
        body, html { margin: 0; padding: 0; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: Arial, sans-serif; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; flex-direction: column; }
        /* Containers */
        .login-container, .app-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); text-align: center; margin: 20px auto; width: 90%; max-width: 800px; }
        .login-container { min-width: 300px; max-width: 400px; }
        /* Headings and Text */
        h1, h2, h3, h4 { margin-top: 0; color: #333; }
        h1 { margin-bottom: 20px; } h2 { margin-bottom: 20px; } h3 { margin-bottom: 15px; }
        h4 { margin-top: 25px; border-top: 1px solid #ccc; padding-top: 15px; margin-bottom: 10px; text-align: center; }
        .welcome-message { font-size: 1.2em; color: #555; margin-bottom: 20px; }
        .description-text { font-size: 0.9em; color: #666; margin-top: 5px; margin-bottom: 15px; text-align: center; } /* Default center */
        .status-message { margin-top: 10px; text-align: center; min-height: 1em; font-weight: bold; }
        .export-reminder-message { display: none; padding: 10px 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #ffeeba; background-color: #fff3cd; color: #856404; font-weight: bold; text-align: center; }
        .security-warning { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px 15px; margin: 15px 0; border-radius: 4px; font-size: 0.9em; text-align: left; }
        /* Button Styles & Grouping */
        .blue-button, .reset-button, .danger-button, .secondary-button { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 10px; margin-bottom: 10px; display: inline-block; transition: background-color 0.2s ease, opacity 0.2s ease; }
        .blue-button { background-color: #007bff; } .blue-button:hover { background-color: #0056b3; }
        .reset-button { background-color: #ffc107; color: black; border: 1px solid #d39e00; } .reset-button:hover { background-color: #e0a800; }
        .danger-button { background-color: #dc3545; } .danger-button:hover { background-color: #c82333; }
        .secondary-button { background-color: #6c757d; font-size: 0.9em; padding: 6px 12px;} .secondary-button:hover { background-color: #5a6268; }
        .blue-button:last-of-type, .reset-button:last-of-type, .danger-button:last-of-type, .secondary-button:last-of-type { margin-right: 0; }

        /* --- Disabled Button Style --- */
        button:disabled, .blue-button:disabled, .reset-button:disabled, .danger-button:disabled, .secondary-button:disabled {
             background-color: #cccccc;
             border-color: #cccccc;
             color: #666666;
             cursor: not-allowed;
             opacity: 0.7; /* Make it slightly faded */
        }
         button:disabled:hover, .blue-button:disabled:hover, .reset-button:disabled:hover, .danger-button:disabled:hover, .secondary-button:disabled:hover {
            background-color: #cccccc; /* Prevent hover effect */
            border-color: #cccccc;
            color: #666666;
         }
        /* --- End Disabled Button Style --- */

        .main-actions-container { margin-bottom: 25px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .data-actions-container { margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        /* Forms & Inputs */
        .form-group, .settings-group { margin-bottom: 15px; text-align: left; }
        .form-group label, .settings-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group-inline { display: flex; align-items: center; text-align: left; margin-bottom: 15px;}
        .form-group-inline input[type="checkbox"] { width: auto; margin-right: 8px; height: 1em; margin-bottom: 0;}
        .form-group-inline label { font-weight: normal; margin-bottom: 0; }
        fieldset { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
        legend { font-weight: bold; padding: 0 5px; color: #555; }
        input[type="text"], input[type="password"], input[type="time"], input[type="number"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 1em; font-family: inherit; }
        #add-curtailment-form > button, #manual-fleet-form > button,
        #settings-form fieldset button, .settings-group button,
        .data-actions-container .action-group button,
        #manage-curtailments-section button {
             width: auto; display: inline-block; margin: 10px 10px 0 0;
        }
        /* Section/Form Styles */
        #add-curtailment-form, #manual-fleet-form, #settings-form, #data-actions, #manage-curtailments-section {
             margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; text-align: left; margin-bottom: 20px;
        }
        #add-curtailment-form h3, #manual-fleet-form h3, #settings-form h2, #data-actions h3, #manage-curtailments-section h3 { margin-top: 0; text-align: center; margin-bottom: 15px; border: none; padding: 0; }
        /* User Management Table */
        #user-management-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; table-layout: auto; }
        #user-management-table th, #user-management-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        #user-management-table th { background-color: #f2f2f2; white-space: nowrap; }
        #user-management-table td { word-break: break-word; }
        #user-management-table th:nth-child(2), #user-management-table td:nth-child(2) { width: 110px; } /* Role */
        #user-management-table th:nth-child(3), #user-management-table td:nth-child(3) { width: 100px; text-align: center;} /* Status */
        #user-management-table th:nth-child(4), #user-management-table td:nth-child(4) { width: 130px; } /* New Password */
        #user-management-table th:nth-child(5), #user-management-table td:nth-child(5) { width: 150px; } /* Permissions */
        #user-management-table th:nth-child(6), #user-management-table td:nth-child(6) { width: 200px; white-space: nowrap; } /* Actions */
        #user-management-table select, #user-management-table input[type="password"] { padding: 5px 8px; font-size: 0.9em; margin: 0; width: 100%; max-width: none; box-sizing: border-box; }
        #user-management-table button { padding: 5px 8px; font-size: 0.9em; margin: 2px 5px 2px 0; width: auto; }
        #user-management-table .delete-user-btn { background-color: #dc3545; color: white; border: none; } #user-management-table .delete-user-btn:hover { background-color: #c82333; }
        #user-management-table .suspend-user-btn { background-color: #ffc107; color: black; border: none; } #user-management-table .suspend-user-btn:hover { background-color: #e0a800; }
        #user-management-table .unsuspend-user-btn { background-color: #28a745; color: white; border: none; } #user-management-table .unsuspend-user-btn:hover { background-color: #218838; }
        .status-active { color: green; font-weight: bold; } .status-suspended { color: orange; font-weight: bold; } .status-blocked { color: red; font-weight: bold; }
        #user-management-table th.permissions-header {} #user-management-table td.permissions-cell { vertical-align: top; } #user-management-table td.permissions-cell div { margin-bottom: 4px; font-size: 0.9em; white-space: nowrap; } #user-management-table td.permissions-cell label { margin-left: 5px; font-weight: normal; cursor: pointer; } #user-management-table td.permissions-cell input[type="checkbox"] { vertical-align: middle; }
        /* Manual Fleet Specific */
        .revert-section, .reset-all-section { margin-top: 25px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center; }
        #manual-assignments-display { text-align: left; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: white; font-size: 0.9em; line-height: 1.4; margin-bottom: 20px; }
        #manual-assignments-display div { padding: 2px 0; } #manual-assignments-display strong { display: inline-block; min-width: 80px; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); text-align: left; width: 90%; max-width: 800px; max-height: 80%; display: flex; flex-direction: column; overflow: hidden; }
        .modal-box h3 { margin-top: 0; text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .modal-content { flex-grow: 1; overflow-y: auto; font-size: 0.9em; margin-bottom: 15px; }
        .modal-content div { border-bottom: 1px dotted #eee; padding: 8px 4px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .modal-content span { line-height: 1.4; } .modal-content strong { margin-right: 4px; color: #555; }
        .modal-buttons { text-align: right; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; flex-shrink: 0; }
        .modal-buttons button { margin-left: 10px; } .modal-buttons .cancel-button { background-color: #6c757d; } .modal-buttons .cancel-button:hover { background-color: #5a6268; }
        /* Utility */
        .hidden { display: none; } #app-container > div:has(#logout-button) { text-align: center; } #manual-fleet-form div > .description-text { margin-top: 5px; }
        /* Backup/Restore */
        .action-group { text-align: center; margin-bottom: 20px; border-top: 1px solid #eee; padding-top: 15px; } .action-group:first-of-type { border-top: none; padding-top: 0; } .action-group h4 { margin-top: 0; margin-bottom: 10px; padding: 0; border: none; color: #555; font-size: 1.1em; } .action-group p.description-text { margin-top: 8px; margin-bottom: 0; }
        /* Manage Curtailments Table */
        #manage-curtailments-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; } #manage-curtailments-table th, #manage-curtailments-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; } #manage-curtailments-table th { background-color: #f2f2f2; } #manage-curtailments-table th:first-child, #manage-curtailments-table td:first-child { text-align: center; width: 40px; } #manage-curtailments-table input[type="checkbox"] { cursor: pointer; } .delete-selected-container { text-align: center; margin-top: 20px; }
        /* Audit Log Styles */
        #admin-audit-log { margin-top: 20px; } #audit-log-display { max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #fff; font-family: monospace; font-size: 0.85em; text-align: left; line-height: 1.4; } #audit-log-display div { border-bottom: 1px dotted #f0f0f0; padding: 4px 2px; } #audit-log-display div:last-child { border-bottom: none; } #audit-log-display .log-timestamp { color: #6c757d; display: inline-block; min-width: 150px;} #audit-log-display .log-user { color: #007bff; font-weight: bold; margin: 0 5px;} #audit-log-display .log-action { color: #28a745; } #audit-log-display .log-details { color: #555; margin-left: 10px; font-size: 0.9em; white-space: pre-wrap; word-break: break-all; } #audit-log-controls { text-align: right; margin-bottom: 10px; } #clear-audit-log-btn { font-size: 0.8em; padding: 4px 8px; }
    </style>
</head>
<body>
    <div id="login-container" class="login-container">
        <h2>Live Tracker Tools Login</h2>
        <form onsubmit="login(); return false;" autocomplete="off">
             <div class="form-group"> <label for="username">Username:</label> <input type="text" id="username" name="username" required autocomplete="off"> </div>
             <div class="form-group"> <label for="password">Password:</label> <input type="password" id="password" name="password" required autocomplete="off"> </div>
             <div class="form-group-inline"> <input type="checkbox" id="stayLoggedInCheckbox" name="stayLoggedIn"> <label for="stayLoggedInCheckbox">Stay logged in</label> </div>
             <div class="form-group" style="text-align: center;"> <button type="submit" class="blue-button">Login</button> <p id="login-error" style="color: red; margin-top: 10px; min-height: 1em;"></p> </div>
        </form>
    </div>

    <div id="app-container" class="app-container hidden">
        <h1>Live Tracker Tools</h1>
        <p id="welcome-message" class="welcome-message"></p>
        <div id="export-reminder" class="export-reminder-message"></div>

        <div id="main-actions-container" class="main-actions-container">
            <button id="toggle-add-curtailment" onclick="showSection('add-curtailment-form')" class="blue-button hidden">Add New Curtailment</button>
            <button id="toggle-manual-fleet" onclick="showSection('manual-fleet-form')" class="blue-button hidden">Assign / View Manual Fleet</button>
             <button id="view-all-curtailments-btn" onclick="showSection('manage-curtailments-section')" class="blue-button hidden">View / Manage All Curtailments</button>
             <button id="toggle-backup-restore" onclick="showSection('data-actions')" class="blue-button hidden">Backup &amp; Restore</button>
            <button id="toggle-settings" onclick="showSection('settings-form')" class="blue-button hidden">Settings</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
             <button id="go-back-button" class="blue-button secondary-button hidden" onclick="goBackToMainView()">‚Üê Go Back to Menu</button>
        </div>

        <div id="add-curtailment-form" class="add-curtailment-form hidden">
            <h3>Add New Curtailment</h3>
            <div class="form-group"> <label for="route">Route Number:</label> <input type="text" id="route" required placeholder="e.g., 184" autocomplete="off"></div>
            <div class="form-group"> <label for="regNumber">Bus Registration:</label> <input type="text" id="regNumber" required placeholder="e.g., AB12CDE" autocomplete="off"></div>
            <div class="form-group"> <label for="curtailedDestination">Curtailed Destination:</label> <input type="text" id="curtailedDestination" required placeholder="e.g., Arnos Grove Station" autocomplete="off"></div>
            <div class="form-group"> <label for="curtailmentTimeInput">Time Logged (HH:MM):</label> <input type="time" id="curtailmentTimeInput" required autocomplete="off"></div>
            <button type="button" onclick="addCurtailment()" class="blue-button">Add Curtailment</button> <p id="add-curtailment-message" class="status-message" style="color: green;"></p>
       </div>
       <div id="manual-fleet-form" class="manual-fleet-form hidden">
            <h3>Assign / View Manual Fleet Number</h3>
            <div class="form-group"> <label for="manualRegNumber">Bus Registration:</label> <input type="text" id="manualRegNumber" placeholder="e.g., AB12CDE" autocomplete="off"></div>
            <div class="form-group"> <label for="manualFleetNumber">Real Fleet Number:</label> <input type="text" id="manualFleetNumber" placeholder="e.g., VH45161, 9001" autocomplete="off"></div>
            <button type="button" onclick="assignManualFleetNumber()" class="blue-button">Assign Fleet Number</button> <p id="assign-status" class="status-message" style="color: green;"></p>
            <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;"> <button id="view-auto-tmp-btn" type="button" onclick="showAutoTmpModal()" class="blue-button">View Auto-Generated TMPs</button> <p class="description-text">View a list of registrations with system-assigned TMP / ERR numbers.</p> </div>
            <h4>Current Manual Assignments</h4>
            <div id="manual-assignments-display">Loading...</div>
            <div class="revert-section hidden"> <label for="revertRegNumber">Registration to Revert:</label> <input type="text" id="revertRegNumber" placeholder="e.g., AB12CDE" autocomplete="off"> <button type="button" onclick="revertToTMP()" class="danger-button">Revert to Auto TMP</button> <p id="revert-status" class="status-message"></p> </div>
            <div class="reset-all-section hidden"> <h4>Reset All Assignments (Admin Only)</h4> <button type="button" id="reset-tmp-button" onclick="resetTMPMap()" class="reset-button">Reset ALL TMP Assignments</button> <p class="description-text">Clears the stored Registration -> TMP map. Requires password.</p> </div>
       </div>
       <div id="settings-form" class="settings-form hidden">
            <h2>Settings</h2>
            <fieldset id="change-my-password-section"> <legend>Change My Password</legend> <div class="settings-group"> <label for="current-password">Current Password:</label> <input type="password" id="current-password" required autocomplete="new-password"> </div> <div class="settings-group"> <label for="new-password">New Password:</label> <input type="password" id="new-password" required autocomplete="new-password"> </div> <div class="settings-group"> <label for="confirm-new-password">Confirm New Password:</label> <input type="password" id="confirm-new-password" required autocomplete="new-password"> </div> <button type="button" onclick="changeMyPassword()" class="blue-button">Change Password</button> <p id="change-password-message" class="status-message"></p> </fieldset>
            <fieldset id="tracker-settings-section" class="hidden"> <legend>Tracker Settings (Admin Only)</legend> <div class="settings-group"> <label for="setting-debounce">Curtailment Debounce Time (minutes):</label> <input type="number" id="setting-debounce" min="0" step="1" placeholder="e.g., 60" autocomplete="off"> <p class="description-text" style="text-align: left;">...</p> </div> <div class="settings-group"> <label for="setting-timeout">Bus Timeout Threshold (minutes):</label> <input type="number" id="setting-timeout" min="1" step="1" placeholder="e.g., 30" autocomplete="off"> <p class="description-text" style="text-align: left;">...</p> </div> <div class="settings-group"> <label for="setting-auto-logout">Auto Logout Time (minutes):</label> <input type="number" id="setting-auto-logout" min="0" step="1" placeholder="e.g., 30" autocomplete="off"> <p class="description-text" style="text-align: left;">...</p> </div> <button type="button" onclick="saveTrackerSettings()" class="blue-button">Save Tracker Settings</button> <p id="tracker-settings-message" class="status-message"></p> </fieldset>
            <fieldset id="admin-user-management" class="hidden"> <legend>User Management (Admin Only)</legend> <h4>Add New User</h4> <div class="settings-group"> <label for="add-username">New Username:</label> <input type="text" id="add-username" autocomplete="off"> </div> <div class="settings-group"> <label for="add-user-password">Password:</label> <input type="password" id="add-user-password" autocomplete="new-password"> </div> <div class="settings-group"> <label for="add-user-role">Role:</label> <select id="add-user-role"><option value="user">User</option><option value="moderator">Moderator</option><option value="admin">Admin</option></select> </div> <button type="button" onclick="addUser()" class="blue-button">Add User</button> <p id="add-user-message" class="status-message"></p> <h4 style="margin-top: 30px;">Manage Existing Users</h4> <div id="user-list-container" style="overflow-x: auto;"> <table id="user-management-table"> <thead> <tr> <th>Username</th> <th>Role</th> <th>Status</th> <th>New Password</th> <th class="permissions-header">Permissions</th> <th>Actions</th> </tr> </thead> <tbody id="user-management-tbody"></tbody> </table> </div> <p id="user-management-message" class="status-message"></p> </fieldset>
            <fieldset id="admin-audit-log" class="hidden"> <legend>Admin Audit Log</legend> <div id="audit-log-controls" style="text-align: right; margin-bottom: 10px;"> <button type="button" id="clear-audit-log-btn" class="danger-button secondary-button">Clear Log</button> </div> <div id="audit-log-display"><p>Loading audit log...</p></div> <p id="audit-log-message" class="status-message"></p> </fieldset>
       </div>
       <div id="data-actions" class="data-actions-container hidden">
             <h3>Backup &amp; Restore</h3>
             <div class="action-group"> <h4>Curtailments</h4> <button type="button" id="export-curtailments-button" onclick="exportCurtailments()" class="blue-button">Export ALL</button> <button type="button" id="import-curtailments-button" onclick="document.getElementById('import-file-curtailments').click()" class="blue-button">Import ALL</button> <input type="file" id="import-file-curtailments" accept=".json" class="hidden"> <p class="description-text">...</p> <p id="curtailments-backup-status" class="status-message"></p> </div>
             <div class="action-group"> <h4>Fleet / TMP</h4> <button type="button" id="export-tmp-button" onclick="exportTmpMap()" class="blue-button">Export ALL</button> <button type="button" id="import-tmp-button" onclick="document.getElementById('import-file-tmp').click()" class="blue-button">Import ALL</button> <input type="file" id="import-file-tmp" accept=".json" class="hidden"> <p class="description-text">...</p> <p id="tmp-backup-status" class="status-message"></p> </div>
             <div class="action-group"> <h4>Sequence Headings</h4> <button type="button" id="export-seq-headings-button" onclick="exportSequenceHeadings()" class="blue-button">Export All</button> <button type="button" id="import-seq-headings-button" onclick="document.getElementById('import-file-seq-headings').click()" class="blue-button">Import All</button> <input type="file" id="import-file-seq-headings" accept=".json" class="hidden"> <p class="description-text">...</p> <p id="seq-headings-backup-status" class="status-message"></p> </div>
             <div class="action-group"> <h4>Final Destinations</h4> <button type="button" id="export-final-dest-button" onclick="exportFinalDestinations()" class="blue-button">Export</button> <button type="button" id="import-final-dest-button" onclick="document.getElementById('import-file-final-dest').click()" class="blue-button">Import</button> <input type="file" id="import-file-final-dest" accept=".json" class="hidden"> <p class="description-text">...</p> <p id="final-dest-backup-status" class="status-message"></p> </div>
       </div>
       <div id="manage-curtailments-section" class="manage-curtailments-section hidden">
             <h3>View / Manage All Curtailments</h3>
             <p class="description-text" style="text-align: left;">...</p>
             <div style="max-height: 500px; overflow-y: auto; margin-bottom: 15px;"> <table id="manage-curtailments-table"> <thead> <tr> <th><input type="checkbox" id="select-all-curtailments-checkbox" title="Select All"></th> <th>Route</th> <th>Fleet No.</th> <th>Registration</th> <th>Curtailed To</th> <th>Time Logged</th> </tr> </thead> <tbody id="manage-curtailments-tbody"></tbody> </table> </div>
             <div class="delete-selected-container"> <button type="button" id="delete-selected-curtailments-btn" class="danger-button hidden" onclick="deleteSelectedCurtailments()">Delete Selected</button> <p id="manage-curtailments-message" class="status-message"></p> </div>
       </div>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; text-align: center;">
            <button type="button" id="logout-button" onclick="logout()" class="blue-button" style="background-color: #6c757d;">Logout</button>
        </div>
    </div> <div id="password-modal" class="modal-overlay hidden"> <div class="modal-box"> <h3>Confirm Action</h3> <label for="confirm-password">Please enter your password to confirm TMP reset:</label> <input type="password" id="confirm-password" name="confirm-password" required autocomplete="new-password"> <p id="password-modal-error" style="color: red; min-height: 1em; margin-top: 5px;"></p> <div class="modal-buttons"> <button type="button" onclick="cancelPasswordReset()" class="blue-button cancel-button">Cancel</button> <button type="button" onclick="handlePasswordConfirm()" class="blue-button">Confirm Reset</button> </div> </div> </div>
    <div id="auto-tmp-modal" class="modal-overlay hidden"> <div class="modal-box"> <h3>Auto-Generated TMP Assignments</h3> <p class="description-text" style="text-align:left; margin-top:0;">...</p> <div id="auto-tmp-list" class="modal-content" style="font-size: 0.95em;"> <p>Loading...</p> </div> <div class="modal-buttons"> <button type="button" onclick="hideAutoTmpModal()" class="blue-button cancel-button">Close</button> </div> </div> </div>
<script>
         // --- Start of JavaScript ---
         console.log("DEBUG: Script execution started. FULL VERSION v13 SetTimeout Test.");

         // --- Constants ---
         const usersStorageKey = 'liveTrackerUsers';
         const tmpMapKey = "tmpRegistrationMap";
         const settingsKey = "trackerGlobalSettings";
         const defaultSettings = { debounceMinutes: 60, timeoutMinutes: 30, autoLogoutMinutes: 30 };
         const lastExportKey = 'lastCurtailmentExportTimestamp';
         const tmpGenerationInfoKey = "tmpGenerationInfo"; // Note: Linter flagged as unused
         const sequenceHeadingOverrideBaseKey = 'sequenceHeadingOverrides_'; // Note: Linter flagged as unused
         const routeDestinationSettingsKey = 'routeDestinationSettings'; // Note: Linter flagged as unused
         const auditLogKey = 'actionAuditLog';
         const MAX_AUDIT_LOG_ENTRIES = 500;

         // --- Global Variables ---
         let users = {};
         let isLoggedIn = false;
         let currentUsername = null;
         let sessionTimerId = null;

         // --- Declare variables for DOM Elements globally ---
         // (These will be assigned in DOMContentLoaded)
         let loginContainer = null, appContainer = null, loginError = null, mainActionsContainer = null, goBackButton = null;
         let addCurtailmentForm = null, manualFleetForm = null, settingsForm = null, dataActionsSection = null, manageCurtailmentsSection = null;
         let toggleAddCurtailmentButton = null, toggleManualFleetButton = null, viewAllCurtailmentsButton = null, toggleBackupRestoreButton = null, toggleSettingsButton = null;
         let manageCurtailmentsTableBody = null, selectAllCheckbox = null, deleteSelectedButton = null, manageCurtailmentsMessage = null, deleteSelectedContainer = null;
         let addCurtailmentMessage = null;
         let manualRegNumberInput = null, manualFleetNumberInput = null, assignStatusElement = null, manualAssignmentsDisplay = null;
         let revertRegNumberInput = null, revertStatusElement = null, revertSection = null, resetTmpButton = null, resetAllSection = null;
         let autoTmpModal = null, autoTmpList = null, viewAutoTmpBtn = null;
         let changeMyPasswordSection = null, trackerSettingsSection = null, settingsDebounceInput = null, settingsTimeoutInput = null, settingsAutoLogoutInput = null, trackerSettingsMessage = null;
         let currentPasswordInput = null, newPasswordInput = null, confirmNewPasswordInput = null, changePasswordMessage = null;
         let adminUserManagementSection = null, addUsernameInput = null, addUserPasswordInput = null, addUserRoleSelect = null, addUserMessage = null;
         let userManagementTbody = null, userManagementMessage = null;
         let welcomeMessageElement = null, passwordModal = null, passwordModalInput = null, passwordModalError = null;
         let importCurtailmentsButton = null, importTmpButton = null, importSeqHeadingsButton = null, importFinalDestButton = null;
         let importCurtailmentsInput = null, curtailmentsBackupStatus = null, importTmpInput = null, tmpBackupStatus = null;
         let importSeqHeadingsInput = null, seqHeadingsBackupStatus = null, importFinalDestInput = null, finalDestBackupStatus = null;
         let logoutButton = null;
         let adminAuditLogSection = null, auditLogDisplay = null, auditLogMessage = null, clearAuditLogButton = null;

         // --- FUNCTION DEFINITIONS ---

         // --- Storage Helpers ---
         function loadFromStorage(key, defaultValue = {}) { console.log(`DEBUG: loadFromStorage: ${key}`); try { const d=localStorage.getItem(key); if(d){ const p=JSON.parse(d); if(key===auditLogKey&&!Array.isArray(p)){console.warn(`Audit log ${key} not array.`); return defaultValue;} if(typeof p===typeof defaultValue&&p!==null){return p;} if(key!==auditLogKey){console.warn(`Type mismatch ${key}.`);} return defaultValue;} return defaultValue;} catch(e){ console.error(`DEBUG: Error loading ${key}:`,e); if(key===auditLogKey&&defaultValue===[]){return [];} return defaultValue;}}
         function saveToStorage(key, data) { console.log(`DEBUG: saveToStorage: ${key}`); try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`DEBUG: Error saving ${key}:`, e); if (key !== auditLogKey) { alert(`Error saving ${key}.`); } else { console.error("Err saving audit log."); } } }
         // --- Audit Log Function ---
         function logAdminAction(action, details = {}) { console.log(`DEBUG: logAdminAction called - Action: ${action}`); if (!isLoggedIn || !currentUsername || !users[currentUsername]) { console.warn("DEBUG: logAdminAction - Not logged in."); return; } const userRole = users[currentUsername].role; if (!['admin', 'moderator'].includes(userRole)) return; try { const timestamp = Date.now(); const logEntry = { timestamp, user: currentUsername, action, details }; let log = loadFromStorage(auditLogKey, []); if (!Array.isArray(log)) { console.warn("Audit log reset."); log = []; } log.unshift(logEntry); if (log.length > MAX_AUDIT_LOG_ENTRIES) { log = log.slice(0, MAX_AUDIT_LOG_ENTRIES); } saveToStorage(auditLogKey, log); console.log(`AUDIT: User '${currentUsername}' - Action: '${action}'`, details); } catch (error) { console.error("Error writing audit log:", error); } } // Removed confusing HTML span from original console log
         // --- Auth, Timer, Basic UI ---
         function loadUsers() { console.log("DEBUG: loadUsers function called."); try { const d = localStorage.getItem(usersStorageKey); if (d) { users = JSON.parse(d); if (!users.Ryan?.pass) { console.warn("DEBUG: Resetting users."); setDefaultUsers(); } else { let updated = false; Object.keys(users).forEach(username => { if (typeof users[username] !== 'object' || users[username] === null) { delete users[username]; updated = true; } else { if (users[username].permissions === undefined) { users[username].permissions = {}; updated = true; } if (users[username].isSuspended === undefined) { users[username].isSuspended = false; updated = true; } } }); if (updated) saveToStorage(usersStorageKey, users); } } else { setDefaultUsers(); } } catch (e) { console.error("DEBUG: Error loading users, resetting:", e); setDefaultUsers(); } console.log("DEBUG: loadUsers finished."); }
         function setDefaultUsers() { console.log("DEBUG: setDefaultUsers called."); users = {'Ryan': {pass: 'password', role: 'admin', permissions: {}, isSuspended: false }}; saveToStorage(usersStorageKey, users); /* <-- FIX Applied Here */ }
         function checkLogin() { console.log("DEBUG: --- checkLogin function called ---"); loadUsers(); try { const storedUser = localStorage.getItem('loggedInUser'); const storedLoggedInStatus = localStorage.getItem('isLoggedIn') === 'true'; console.log(`DEBUG: checkLogin - Stored User: ${storedUser}, Status: ${storedLoggedInStatus}`); let userIsValid = storedLoggedInStatus && storedUser && users && users[storedUser]; console.log(`DEBUG: checkLogin - Validation result: ${userIsValid}`); if (userIsValid) { console.log("DEBUG: checkLogin - Proceeding to showApp."); isLoggedIn = true; currentUsername = storedUser; showApp(); } else { console.log("DEBUG: checkLogin - Showing login."); isLoggedIn = false; currentUsername = null; localStorage.removeItem('isLoggedIn'); localStorage.removeItem('loggedInUser'); sessionStorage.removeItem('bypassAutoLogout'); showLogin(); } } catch (e) { console.error("DEBUG: Error during checkLogin:", e); isLoggedIn = false; currentUsername = null; showLogin(); } console.log("DEBUG: --- checkLogin finished ---"); }
         function login() { console.log("DEBUG: --- login function called ---"); const u=document.getElementById('username'), p=document.getElementById('password'), c=document.getElementById('stayLoggedInCheckbox'), l=loginError; if(!u||!p){return;} const usernameInput=u.value, passwordInput=p.value, stayLoggedInChecked=c?c.checked:false; if(l)l.textContent=''; if(!users||Object.keys(users).length===0){console.warn("Users not loaded. Reloading."); loadUsers(); if(!users||Object.keys(users).length===0){console.error("Failed load users."); if(l)l.textContent='Login service error.'; return;}} console.log(`Attempting login: ${usernameInput}`); if(!users.hasOwnProperty(usernameInput)){console.log(`User DNE.`); if(l)l.textContent='Invalid username or password.'; return;} if(users[usernameInput].pass===passwordInput){console.log("Password match."); const userData=users[usernameInput], userRole=userData.role; console.log(`Suspended: ${userData.isSuspended}`); if(userData.isSuspended){console.warn(`User suspended.`); logAdminAction("Login Failed (Suspended)",{targetUser:usernameInput}); if(l)l.textContent='Account suspended.'; return;} console.log(`Login OK: ${usernameInput}, Role: ${userRole}`); const isIbusPage=window.location.pathname.includes('ibusdest.html'); if(isIbusPage&&userRole==='user'){console.warn(`No privileges for ibusdest.`); if(l)l.textContent='No privileges for this page.'; sessionStorage.removeItem('bypassAutoLogout'); return;} console.log("Setting login status."); localStorage.setItem('isLoggedIn','true'); localStorage.setItem('loggedInUser',usernameInput); if(stayLoggedInChecked){sessionStorage.setItem('bypassAutoLogout','true');}else{sessionStorage.removeItem('bypassAutoLogout');} isLoggedIn=true; currentUsername=usernameInput; logAdminAction("Login Success"); /* <-- FIX: Moved logAdminAction Call Here */ showApp();} else {console.log(`Incorrect password.`); logAdminAction("Login Failed (Password)",{targetUser:usernameInput}); if(l)l.textContent='Invalid username or password.'; isLoggedIn=false; currentUsername=null; sessionStorage.removeItem('bypassAutoLogout');} console.log("--- login finished ---");}
         function logout() { console.log("DEBUG: --- logout function called ---"); if (isLoggedIn && currentUsername) { logAdminAction("Logout"); } if (sessionTimerId) { clearTimeout(sessionTimerId); sessionTimerId = null; } localStorage.setItem('isLoggedIn', 'false'); localStorage.removeItem('loggedInUser'); sessionStorage.removeItem('bypassAutoLogout'); isLoggedIn = false; currentUsername = null; showLogin(); console.log("DEBUG: --- logout finished ---"); }
         function logoutAfterSession() { console.log("DEBUG: logoutAfterSession called."); if(isLoggedIn){const s=loadFromStorage(settingsKey,defaultSettings),l=s.autoLogoutMinutes||0; alert(`Session expired after ${l} minutes.`); logout();} }
         function startSessionTimer() { console.log("DEBUG: startSessionTimer called."); if(sessionTimerId){clearTimeout(sessionTimerId); sessionTimerId=null;} if(!isLoggedIn)return; const bypass=sessionStorage.getItem('bypassAutoLogout')==='true'; if(bypass)return; const s=loadFromStorage(settingsKey,defaultSettings); const logoutMinutes=(typeof s.autoLogoutMinutes==='number'&&s.autoLogoutMinutes>=0)?s.autoLogoutMinutes:defaultSettings.autoLogoutMinutes; if(logoutMinutes<=0){console.log("DEBUG: Timer not started - time <= 0.");return;} const logoutMillis = logoutMinutes*60*1000; console.log(`Starting session timer: ${logoutMinutes} mins`); sessionTimerId=setTimeout(logoutAfterSession, logoutMillis);}
         function showApp() { console.log("DEBUG: --- showApp function called ---"); try { if (!isLoggedIn || !currentUsername || !users || !users[currentUsername]) { console.error("showApp - Invalid state. Logging out."); logout(); return;} const userRole = users[currentUsername].role; console.log(`DEBUG: showApp - Proceeding for User: ${currentUsername}, Role: ${userRole}`); if (loginContainer) loginContainer.classList.add('hidden'); else console.error("showApp: loginContainer ref missing!"); if (appContainer) appContainer.classList.remove('hidden'); else console.error("showApp: appContainer ref missing!"); if (welcomeMessageElement) welcomeMessageElement.textContent = `Welcome, ${currentUsername}!`; else console.warn("showApp: welcomeMessageElement ref missing."); const reminderElement = document.getElementById('export-reminder'); if(reminderElement){ try{const lastExportTimeStr=localStorage.getItem(lastExportKey);const sevenDaysInMillis=7*24*60*60*1000;const now=Date.now();let message='',showBox=false;if(lastExportTimeStr){const lastExportTime=parseInt(lastExportTimeStr,10);if(!isNaN(lastExportTime)){const diff=now-lastExportTime;if(diff>sevenDaysInMillis){const daysSinceExport=Math.floor(diff/(1000*60*60*24));message=`Reminder: ${daysSinceExport} days since last export.`;showBox=true;}}}else{message="Reminder: Consider initial backup.";showBox=true;}reminderElement.textContent=message;reminderElement.style.display=showBox?'block':'none';}catch(e){console.error("Error check export time:",e);if(reminderElement)reminderElement.style.display='none';} } console.log("DEBUG: showApp - Resetting UI."); if (mainActionsContainer) mainActionsContainer.classList.remove('hidden'); if (goBackButton) goBackButton.classList.add('hidden'); if (addCurtailmentForm) addCurtailmentForm.classList.add('hidden'); if (manualFleetForm) manualFleetForm.classList.add('hidden'); if (settingsForm) settingsForm.classList.add('hidden'); if (dataActionsSection) dataActionsSection.classList.add('hidden'); if (manageCurtailmentsSection) manageCurtailmentsSection.classList.add('hidden'); if(addCurtailmentMessage)addCurtailmentMessage.textContent='';if(assignStatusElement)assignStatusElement.textContent='';if(revertStatusElement)revertStatusElement.textContent='';if(trackerSettingsMessage)trackerSettingsMessage.textContent='';if(changePasswordMessage)changePasswordMessage.textContent='';if(addUserMessage)addUserMessage.textContent='';if(userManagementMessage)userManagementMessage.textContent='';if(manageCurtailmentsMessage)manageCurtailmentsMessage.textContent='';if(curtailmentsBackupStatus)curtailmentsBackupStatus.textContent='';if(tmpBackupStatus)tmpBackupStatus.textContent='';if(seqHeadingsBackupStatus)seqHeadingsBackupStatus.textContent='';if(finalDestBackupStatus)finalDestBackupStatus.textContent='';if(auditLogMessage)auditLogMessage.textContent=''; console.log("DEBUG: showApp - Setting button visibility."); const isModOrAdmin = ['admin', 'moderator'].includes(userRole); const isAdmin = userRole === 'admin'; if (toggleAddCurtailmentButton) toggleAddCurtailmentButton.classList.toggle('hidden', !isModOrAdmin); if (toggleManualFleetButton) toggleManualFleetButton.classList.toggle('hidden', !isModOrAdmin); if (toggleBackupRestoreButton) toggleBackupRestoreButton.classList.toggle('hidden', !isModOrAdmin); if (toggleSettingsButton) toggleSettingsButton.classList.remove('hidden'); if (viewAllCurtailmentsButton) { viewAllCurtailmentsButton.classList.remove('hidden'); if (userRole === 'user') viewAllCurtailmentsButton.textContent = 'View All Curtailments'; else viewAllCurtailmentsButton.textContent = 'View / Manage All Curtailments'; } loadTrackerSettings(); /* Defined below but empty */ startSessionTimer(); } catch (e) { console.error("DEBUG: Error in showApp:", e); if (welcomeMessageElement) welcomeMessageElement.textContent = 'Error loading application.'; if (!isLoggedIn) logout(); } console.log("DEBUG: --- showApp finished ---"); }
         function showLogin() { console.log("DEBUG: --- showLogin function called ---"); try { if (sessionTimerId) { clearTimeout(sessionTimerId); sessionTimerId = null; } sessionStorage.removeItem('bypassAutoLogout'); if (loginContainer) loginContainer.classList.remove('hidden'); else console.error("showLogin: loginContainer ref missing!"); if (appContainer) appContainer.classList.add('hidden'); else console.error("showLogin: appContainer ref missing!"); if (loginError) loginError.textContent=''; const u=document.getElementById('username'); if(u)u.value=''; const p=document.getElementById('password'); if(p)p.value=''; const c=document.getElementById('stayLoggedInCheckbox'); if(c)c.checked=false; if(passwordModal)passwordModal.classList.add('hidden'); if(autoTmpModal)autoTmpModal.classList.add('hidden'); const r=document.getElementById('export-reminder'); if(r)r.style.display='none'; if(addCurtailmentForm)addCurtailmentForm.classList.add('hidden'); if(manualFleetForm)manualFleetForm.classList.add('hidden'); if(settingsForm)settingsForm.classList.add('hidden'); if(dataActionsSection)dataActionsSection.classList.add('hidden'); if(manageCurtailmentsSection)manageCurtailmentsSection.classList.add('hidden'); if(goBackButton)goBackButton.classList.add('hidden'); } catch (e) { console.error("DEBUG: Error in showLogin:", e); } console.log("DEBUG: --- showLogin finished ---"); }

         // --- Section Navigation ---
         function showSection(sectionId) {
             console.log(`DEBUG: --- showSection called for sectionId: ${sectionId} ---`);
             if (!isLoggedIn || !currentUsername || !users || !users[currentUsername]) { alert('Not logged in.'); return; }
             const userRole = users[currentUsername].role; const isModOrAdmin = ['admin', 'moderator'].includes(userRole); const isAdmin = userRole === 'admin';
             console.log(`DEBUG: showSection - User: ${currentUsername}, Role: ${userRole}`);
             const sectionElement = document.getElementById(sectionId); if (!sectionElement) { console.error(`DEBUG: Section ${sectionId} not found.`); return; }
             let canAccess = false; switch (sectionId) { case 'manage-curtailments-section': canAccess = true; break; case 'add-curtailment-form': case 'manual-fleet-form': case 'data-actions': canAccess = isModOrAdmin; break; case 'settings-form': canAccess = true; break; default: return; }
             console.log(`DEBUG: showSection - Access check for ${sectionId}: ${canAccess}`); if (!canAccess) { alert('Access Denied.'); return; }
             console.log("DEBUG: showSection - Hiding/Showing sections."); if (mainActionsContainer) mainActionsContainer.classList.add('hidden'); if (addCurtailmentForm) addCurtailmentForm.classList.add('hidden'); if (manualFleetForm) manualFleetForm.classList.add('hidden'); if (settingsForm) settingsForm.classList.add('hidden'); if (dataActionsSection) dataActionsSection.classList.add('hidden'); if (manageCurtailmentsSection) manageCurtailmentsSection.classList.add('hidden');
             sectionElement.classList.remove('hidden');
             console.log(`DEBUG: showSection - Checking goBackButton ref: ${goBackButton ? 'Found' : 'NOT FOUND'}`); if (goBackButton) goBackButton.classList.remove('hidden'); else console.error("Cannot show Back button - ref is null");
             console.log(`DEBUG: showSection - Initialising section ${sectionId}.`);

             // Clear common status messages when showing section
             if(addCurtailmentMessage) addCurtailmentMessage.textContent = ''; if(assignStatusElement) assignStatusElement.textContent = ''; if(revertStatusElement) revertStatusElement.textContent = ''; if(trackerSettingsMessage) trackerSettingsMessage.textContent = ''; if(changePasswordMessage) changePasswordMessage.textContent = ''; if(addUserMessage) addUserMessage.textContent = ''; if(userManagementMessage) userManagementMessage.textContent = ''; if(manageCurtailmentsMessage) manageCurtailmentsMessage.textContent = ''; if(curtailmentsBackupStatus) curtailmentsBackupStatus.textContent = ''; if(tmpBackupStatus) tmpBackupStatus.textContent = ''; if(seqHeadingsBackupStatus) seqHeadingsBackupStatus.textContent = ''; if(finalDestBackupStatus) finalDestBackupStatus.textContent = ''; if(auditLogMessage) auditLogMessage.textContent = '';

             // Section specific initialisation - WITH setTimeout for data loading
             if (sectionId === 'settings-form') {
                 if (changeMyPasswordSection) changeMyPasswordSection.classList.remove('hidden'); else console.warn("Ref missing: changeMyPasswordSection");
                 if (trackerSettingsSection) trackerSettingsSection.classList.toggle('hidden', !isAdmin); else console.warn("Ref missing: trackerSettingsSection");
                 if (adminUserManagementSection) adminUserManagementSection.classList.toggle('hidden', !isAdmin); else console.warn("Ref missing: adminUserManagementSection");
                 if (adminAuditLogSection) adminAuditLogSection.classList.toggle('hidden', !isAdmin); else console.warn("Ref missing: adminAuditLogSection");
                 if (isAdmin) { console.log("Loading admin settings content (delayed)..."); loadTrackerSettings(); setTimeout(() => { displayUserManagement(); displayAuditLog(); }, 10); }
             } else if (sectionId === 'data-actions') {
                  if (importCurtailmentsButton) importCurtailmentsButton.disabled = !isAdmin; if (importTmpButton) importTmpButton.disabled = !isAdmin; if (importSeqHeadingsButton) importSeqHeadingsButton.disabled = !isAdmin; if (importFinalDestButton) importFinalDestButton.disabled = !isAdmin;
             } else if (sectionId === 'manage-curtailments-section'){
                  if (selectAllCheckbox) selectAllCheckbox.checked = false;
                  console.log("DEBUG: Scheduling populateManageCurtailmentsTable");
                  setTimeout(() => populateManageCurtailmentsTable(), 10); // Delay data loading
             } else if (sectionId === 'add-curtailment-form') {
                  const routeInput = document.getElementById('route'); if(routeInput) routeInput.focus();
             } else if (sectionId === 'manual-fleet-form') {
                  if (revertSection) revertSection.classList.toggle('hidden', !isAdmin); if (resetAllSection) resetAllSection.classList.toggle('hidden', !isAdmin);
                  console.log("DEBUG: Scheduling displayManualAssignments");
                  setTimeout(() => displayManualAssignments(), 10); // Delay data loading
             }
             console.log(`DEBUG: --- showSection for ${sectionId} finished ---`);
         }
         function goBackToMainView() { console.log("DEBUG: --- goBackToMainView called ---"); console.log("DEBUG: Hiding sections, showing main menu."); if (addCurtailmentForm) addCurtailmentForm.classList.add('hidden'); else console.warn("goBack: addCurtailmentForm ref missing"); if (manualFleetForm) manualFleetForm.classList.add('hidden'); else console.warn("goBack: manualFleetForm ref missing"); if (settingsForm) settingsForm.classList.add('hidden'); else console.warn("goBack: settingsForm ref missing"); if (dataActionsSection) dataActionsSection.classList.add('hidden'); else console.warn("goBack: dataActionsSection ref missing"); if (manageCurtailmentsSection) manageCurtailmentsSection.classList.add('hidden'); else console.warn("goBack: manageCurtailmentsSection ref missing"); if (goBackButton) goBackButton.classList.add('hidden'); else console.warn("goBack: goBackButton ref missing"); if (mainActionsContainer) mainActionsContainer.classList.remove('hidden'); else console.warn("goBack: mainActionsContainer ref missing"); /* Clear statuses can be done in showSection */ console.log("DEBUG: --- goBackToMainView finished ---"); }

         // --- Feature Functions (Stubs) ---
         function addCurtailment() { /* ... implementation ... */ alert("Add Curtailment - Not implemented"); }
         function populateManageCurtailmentsTable() { console.log("DEBUG: populateManageCurtailmentsTable called."); const tableBody = document.getElementById('manage-curtailments-tbody'); console.log("DEBUG: manageCurtailmentsTableBody ref (inside func):", tableBody); if (!isLoggedIn || !tableBody) { console.warn("DEBUG: populateManage... - Preconditions failed. tableBody is:", tableBody); if(manageCurtailmentsMessage) manageCurtailmentsMessage.textContent = "Error: Display area not found."; return; } try { tableBody.innerHTML='<tr><td colspan="6">Loading Curtailments... (Not implemented)</td></tr>'; /* ... rest of logic ... */ } catch (e) { console.error("Error rendering curtailments:", e); if(tableBody) tableBody.innerHTML='<tr><td colspan="6">Error displaying data.</td></tr>'; } }
         function handleSelectAllCurtailments() { console.log("DEBUG: handleSelectAllCurtailments called."); const check = selectAllCheckbox; const body = manageCurtailmentsTableBody; if (!check || !body || check.disabled) { console.warn("DEBUG: handleSelectAllCurtailments - Preconditions failed."); return; } const isChecked = check.checked; const checkboxes = body.querySelectorAll('.curtailment-checkbox'); checkboxes.forEach(cb => { cb.checked = isChecked; }); console.log(`Set ${checkboxes.length} checkboxes.`); }
         function deleteSelectedCurtailments() { /* ... implementation ... */ alert("Delete Selected Curtailments - Not implemented");}
         function displayManualAssignments() { console.log("DEBUG: displayManualAssignments called."); const displayDiv = document.getElementById('manual-assignments-display'); console.log("DEBUG: manualAssignmentsDisplay ref (inside func):", displayDiv); if (!isLoggedIn || !displayDiv) { console.warn("DEBUG: displayManual... - Preconditions failed. displayDiv is:", displayDiv); if(assignStatusElement) assignStatusElement.textContent = "Error: Display area not found."; return; } try { const tmpMap=loadFromStorage(tmpMapKey,{}); displayDiv.innerHTML=''; const manualEntries=[]; if(typeof tmpMap==='object'&&tmpMap!==null){for(const r in tmpMap){if(tmpMap.hasOwnProperty(r)){const f=tmpMap[r]; if(typeof f==='string'&&!f.startsWith('TMP')&&!f.startsWith('ERR'))manualEntries.push({reg:r,fleet:f});}}} manualEntries.sort((a,b)=>a.reg.localeCompare(b.reg)); if(manualEntries.length===0){displayDiv.innerHTML='<em>No manual assignments.</em>';} else {manualEntries.forEach(e=>{const d=document.createElement('div'); d.innerHTML=`<strong>${e.reg}:</strong> ${e.fleet}`; displayDiv.appendChild(d);});} } catch (e) { console.error("Error rendering manual assignments:", e); if(displayDiv) displayDiv.innerHTML='<em style="color:red;">Error display.</em>'; } }
         function assignManualFleetNumber() { /* ... implementation ... */ alert("Assign Manual Fleet - Not implemented"); }
         function isTMPValueUsed(map, tmpValue, currentReg) { /* ... implementation ... */ return false; } // Placeholder
         function getTMPForRegistration(registration) { /* ... implementation ... */ return null; } // Placeholder
         function generateTMPNumber(reg) { /* ... implementation ... */ return 'TMP' + Date.now().toString().slice(-4); } // Placeholder TMP generator
         function revertToTMP() { /* ... implementation ... */ alert("Revert to TMP - Not implemented"); }
         function showAutoTmpModal() { /* ... implementation ... */ alert("Show Auto TMP Modal - Not implemented"); }
         function hideAutoTmpModal() { /* ... implementation ... */ if (autoTmpModal) autoTmpModal.classList.add('hidden'); }
         function resetTMPMap() { /* ... implementation ... */ alert("Reset TMP Map - Not implemented. Requires Password Prompt."); }
         function handlePasswordConfirm() { /* ... implementation ... */ alert("Handle Password Confirm - Not implemented"); }
         function cancelPasswordReset() { /* ... implementation ... */ if(passwordModal) passwordModal.classList.add('hidden'); }
         function loadTrackerSettings() { /* ... implementation ... */ console.log("DEBUG: loadTrackerSettings called (currently empty)");}
         function saveTrackerSettings() { /* ... implementation ... */ alert("Save Tracker Settings - Not implemented"); }
         function changeMyPassword() { /* ... implementation ... */ alert("Change My Password - Not implemented"); }
         function toggleUserSuspension(usernameToToggle) { /* ... implementation ... */ alert(`Toggle Suspension for ${usernameToToggle} - Not implemented`); }
         function displayUserManagement() { console.log("DEBUG: displayUserManagement called."); const tableBody = document.getElementById('user-management-tbody'); console.log("DEBUG: userManagementTbody ref (inside func):", tableBody); if(!isLoggedIn||users[currentUsername]?.role!=='admin'||!tableBody){ console.warn("DEBUG: displayUserManagement - Preconditions failed. tableBody is:", tableBody); return; } try { tableBody.innerHTML='<tr><td colspan="6">Loading Users... (Not implemented)</td></tr>'; userManagementMessage.textContent=''; console.log("DEBUG: Populating user management table."); Object.keys(users).sort().forEach(username=>{ /* ... table row creation logic needed here ... */ }); console.log("DEBUG: Finished populating user management table."); } catch(e) { console.error("Error rendering user management:", e); if(tableBody) tableBody.innerHTML = '<tr><td colspan="6">Error displaying users.</td></tr>';}}
         function addUser() { /* ... implementation ... */ alert("Add User - Not implemented"); }
         function changeUserRole(username, newRole){ /* ... implementation ... */ alert(`Change Role for ${username} to ${newRole} - Not implemented`); }
         function changeOtherUserPassword(username){ /* ... implementation ... */ alert(`Change Password for ${username} - Not implemented`); }
         function deleteUser(username){ /* ... implementation ... */ alert(`Delete User ${username} - Not implemented`); }
         function updateUserPermission(username, permKey, isChecked) { /* ... placeholder ... */ alert(`Update permission ${permKey} for ${username} to ${isChecked} - Not implemented`); }
         function displayAuditLog() { console.log("DEBUG: displayAuditLog called."); const displayDiv = document.getElementById('audit-log-display'); console.log("DEBUG: auditLogDisplay ref (inside func):", displayDiv); if(!isLoggedIn||users[currentUsername]?.role!=='admin'||!displayDiv) { console.warn("DEBUG: displayAuditLog - Preconditions failed. displayDiv is:", displayDiv); return; } try { displayDiv.innerHTML=''; const log=loadFromStorage(auditLogKey,[]); console.log(`DEBUG: Loaded ${log.length} audit log entries.`); if(log.length===0){displayDiv.innerHTML='<p>Audit log is empty.</p>'; return;} log.forEach(entry=>{ const logDiv = document.createElement('div'); const date = new Date(entry.timestamp).toLocaleString(); const detailsString = Object.keys(entry.details).length > 0 ? JSON.stringify(entry.details) : ''; logDiv.innerHTML = `<span class="log-timestamp">${date}</span> User: <span class="log-user">${entry.user}</span> Action: <span class="log-action">${entry.action}</span><span class="log-details">${detailsString}</span>`; displayDiv.appendChild(logDiv); }); } catch(e) { console.error("Error rendering audit log:", e); if(displayDiv) displayDiv.innerHTML='<p>Error displaying log.</p>'; } }
         function clearAuditLog() { console.log('--- clearAuditLog function CALLED ---'); /* <-- Test Log */ /* ... implementation ... */ alert("Clear Audit Log - Not implemented"); }
         function triggerDownload(jsonData, filename, statusElement) { /* ... implementation ... */ alert(`Trigger Download for ${filename} - Not implemented`); }
         function exportCurtailments() { console.log('--- exportCurtailments function CALLED ---'); /* <-- Test Log */ /* ... implementation ... */ alert("Export Curtailments - Not implemented"); }
         function exportTmpMap() { /* ... implementation ... */ alert("Export TMP Map - Not implemented"); }
         function exportSequenceHeadings() { /* ... implementation ... */ alert("Export Sequence Headings - Not implemented"); }
         function exportFinalDestinations() { /* ... implementation ... */ alert("Export Final Destinations - Not implemented"); }
         function handleCurtailmentImport(file) { /* ... implementation ... */ alert(`Handle Curtailment Import for ${file.name} - Not implemented`); }
         function handleTmpImport(file) { /* ... implementation ... */ alert(`Handle TMP Import for ${file.name} - Not implemented`); }
         function handleSequenceHeadingsImport(file) { /* ... implementation ... */ alert(`Handle Sequence Headings Import for ${file.name} - Not implemented`); }
         function handleFinalDestinationsImport(file) { /* ... implementation ... */ alert(`Handle Final Destinations Import for ${file.name} - Not implemented`); }

         // --- END OF FUNCTION DEFINITIONS ---


         // --- Initialisation Code ---
         document.addEventListener('DOMContentLoaded', () => {
             console.log("DEBUG: DOMContentLoaded event fired.");
             console.log(`DEBUG: DOM Ready state: ${document.readyState}`);

             // Assign DOM elements to global vars HERE
             console.log("DEBUG: DOMContentLoaded - Assigning DOM element references...");
             try {
                 loginContainer = document.getElementById('login-container');
                 appContainer = document.getElementById('app-container');
                 loginError = document.getElementById('login-error');
                 mainActionsContainer = document.getElementById('main-actions-container');
                 goBackButton = document.getElementById('go-back-button');
                 addCurtailmentForm = document.getElementById('add-curtailment-form');
                 manualFleetForm = document.getElementById('manual-fleet-form');
                 settingsForm = document.getElementById('settings-form');
                 dataActionsSection = document.getElementById('data-actions');
                 manageCurtailmentsSection = document.getElementById('manage-curtailments-section');
                 toggleAddCurtailmentButton = document.getElementById('toggle-add-curtailment');
                 toggleManualFleetButton = document.getElementById('toggle-manual-fleet');
                 viewAllCurtailmentsButton = document.getElementById('view-all-curtailments-btn');
                 toggleBackupRestoreButton = document.getElementById('toggle-backup-restore');
                 toggleSettingsButton = document.getElementById('toggle-settings');
                 manageCurtailmentsTableBody = document.getElementById('manage-curtailments-tbody');
                 selectAllCheckbox = document.getElementById('select-all-curtailments-checkbox');
                 deleteSelectedButton = document.getElementById('delete-selected-curtailments-btn'); // Linter flagged as unused
                 manageCurtailmentsMessage = document.getElementById('manage-curtailments-message');
                 deleteSelectedContainer = document.querySelector('.delete-selected-container'); // Linter flagged as unused
                 addCurtailmentMessage = document.getElementById('add-curtailment-message');
                 manualRegNumberInput = document.getElementById('manualRegNumber'); // Linter flagged as unused
                 manualFleetNumberInput = document.getElementById('manualFleetNumber'); // Linter flagged as unused
                 assignStatusElement = document.getElementById('assign-status');
                 manualAssignmentsDisplay = document.getElementById('manual-assignments-display');
                 revertRegNumberInput = document.getElementById('revertRegNumber'); // Linter flagged as unused
                 revertStatusElement = document.getElementById('revert-status');
                 revertSection = document.querySelector('.revert-section');
                 resetTmpButton = document.getElementById('reset-tmp-button'); // Linter flagged as unused
                 resetAllSection = document.querySelector('.reset-all-section');
                 autoTmpModal = document.getElementById('auto-tmp-modal');
                 autoTmpList = document.getElementById('auto-tmp-list'); // Linter flagged as unused
                 viewAutoTmpBtn = document.getElementById('view-auto-tmp-btn'); // Linter flagged as unused
                 changeMyPasswordSection = document.getElementById('change-my-password-section');
                 trackerSettingsSection = document.getElementById('tracker-settings-section');
                 settingsDebounceInput = document.getElementById('setting-debounce'); // Linter flagged as unused
                 settingsTimeoutInput = document.getElementById('setting-timeout'); // Linter flagged as unused
                 settingsAutoLogoutInput = document.getElementById('setting-auto-logout'); // Linter flagged as unused
                 trackerSettingsMessage = document.getElementById('tracker-settings-message');
                 currentPasswordInput = document.getElementById('current-password'); // Linter flagged as unused
                 newPasswordInput = document.getElementById('new-password'); // Linter flagged as unused
                 confirmNewPasswordInput = document.getElementById('confirm-new-password'); // Linter flagged as unused
                 changePasswordMessage = document.getElementById('change-password-message');
                 adminUserManagementSection = document.getElementById('admin-user-management');
                 addUsernameInput = document.getElementById('add-username'); // Linter flagged as unused
                 addUserPasswordInput = document.getElementById('add-user-password'); // Linter flagged as unused
                 addUserRoleSelect = document.getElementById('add-user-role'); // Linter flagged as unused
                 addUserMessage = document.getElementById('add-user-message');
                 userManagementTbody = document.getElementById('user-management-tbody');
                 userManagementMessage = document.getElementById('user-management-message');
                 welcomeMessageElement = document.getElementById('welcome-message');
                 passwordModal = document.getElementById('password-modal');
                 passwordModalInput = document.getElementById('confirm-password');
                 passwordModalError = document.getElementById('password-modal-error'); // Linter flagged as unused
                 importCurtailmentsButton = document.getElementById('import-curtailments-button');
                 importTmpButton = document.getElementById('import-tmp-button');
                 importSeqHeadingsButton = document.getElementById('import-seq-headings-button');
                 importFinalDestButton = document.getElementById('import-final-dest-button');
                 importCurtailmentsInput = document.getElementById('import-file-curtailments');
                 curtailmentsBackupStatus = document.getElementById('curtailments-backup-status');
                 importTmpInput = document.getElementById('import-file-tmp');
                 tmpBackupStatus = document.getElementById('tmp-backup-status');
                 importSeqHeadingsInput = document.getElementById('import-file-seq-headings');
                 seqHeadingsBackupStatus = document.getElementById('seq-headings-backup-status');
                 importFinalDestInput = document.getElementById('import-file-final-dest');
                 finalDestBackupStatus = document.getElementById('final-dest-backup-status');
                 logoutButton = document.getElementById('logout-button');
                 adminAuditLogSection = document.getElementById('admin-audit-log');
                 auditLogDisplay = document.getElementById('audit-log-display');
                 auditLogMessage = document.getElementById('audit-log-message');
                 clearAuditLogButton = document.getElementById('clear-audit-log-btn');
                 console.log("DEBUG: DOMContentLoaded - DOM element reference assignment block finished.");
             } catch (err) { console.error("DEBUG: ERROR occurred during DOM element assignment:", err); return; }

             // Log critical refs AFTER assignment attempt
             console.log("DEBUG: loginContainer value:", loginContainer ? 'FOUND' : 'NULL');
             console.log("DEBUG: appContainer value:", appContainer ? 'FOUND' : 'NULL');
             console.log("DEBUG: manageCurtailmentsTableBody value:", manageCurtailmentsTableBody ? 'FOUND' : 'NULL');
             console.log("DEBUG: userManagementTbody value:", userManagementTbody ? 'FOUND' : 'NULL');
             console.log("DEBUG: auditLogDisplay value:", auditLogDisplay ? 'FOUND' : 'NULL');
             console.log("DEBUG: goBackButton value:", goBackButton ? 'FOUND' : 'NULL');
             console.log("DEBUG: manualAssignmentsDisplay value:", manualAssignmentsDisplay ? 'FOUND' : 'NULL');

              // Add Event Listeners HERE (Check if element exists before adding listener)
              console.log("DEBUG: DOMContentLoaded - Adding event listeners.");
              // Helper to add listener safely
              const addSafeListener = (element, event, handler, name) => {
                  // console.log(`DEBUG: Attempting to add listener for: ${name}`); // Verbose logging removed
                   if (element && typeof element.addEventListener === 'function') {
                       element.addEventListener(event, handler);
                       // console.log(`DEBUG: Listener ADDED for: ${name}`); // Verbose logging removed
                   } else {
                       console.warn(`Listener skipped - Element '${name}' not found or invalid (value: ${element}).`);
                   }
              };

              addSafeListener(importCurtailmentsInput, 'change', function(){ if(this.files?.length>0) handleCurtailmentImport(this.files[0]);}, 'importCurtailmentsInput');
              addSafeListener(importTmpInput, 'change', function(){ if(this.files?.length>0) handleTmpImport(this.files[0]); }, 'importTmpInput');
              addSafeListener(importSeqHeadingsInput, 'change', function(){ if(this.files?.length>0) handleSequenceHeadingsImport(this.files[0]); }, 'importSeqHeadingsInput');
              addSafeListener(importFinalDestInput, 'change', function(){ if(this.files?.length>0) handleFinalDestinationsImport(this.files[0]); }, 'importFinalDestInput');
              addSafeListener(passwordModalInput, 'keydown', function(e){ if(e.key==='Enter'){e.preventDefault(); handlePasswordConfirm();} }, 'passwordModalInput');
              addSafeListener(selectAllCheckbox, 'change', handleSelectAllCurtailments, 'selectAllCheckbox');
              addSafeListener(clearAuditLogButton, 'click', clearAuditLog, 'clearAuditLogButton');
              addSafeListener(logoutButton, 'click', logout, 'logoutButton');
              console.log("DEBUG: DOMContentLoaded - Event listeners added (or attempted).");

             // Check for essential containers again before checkLogin
              if (!loginContainer || !appContainer ) { console.error("CRITICAL ERROR: loginContainer or appContainer is null!"); document.body.innerHTML = '<p>Page loading error.</p>'; return; }

             console.log("DEBUG: DOMContentLoaded - Calling checkLogin...");
             checkLogin();
             console.log("DEBUG: DOMContentLoaded - checkLogin finished.");
         });

         console.log('--- DEBUG: SCRIPT END REACHED (Tools.html - Full Code v13 SetTimeout) ---');
    </script>
    </body>
</html>
