<!DOCTYPE html>
<html>
<head>
    <title>Live Tracker (Tools)</title>
    <style>
        /* Basic Reset & Font */
        body, html { margin: 0; padding: 0; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: Arial, sans-serif; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; flex-direction: column; }
        /* Containers */
        .login-container, .app-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); text-align: center; margin: 20px auto; width: 90%; max-width: 800px; }
        .login-container { min-width: 300px; max-width: 400px; }
        /* Headings and Text */
        h1, h2, h3, h4 { margin-top: 0; color: #333; }
        h1 { margin-bottom: 20px; } h2 { margin-bottom: 20px; } h3 { margin-bottom: 15px; }
        h4 { margin-top: 25px; border-top: 1px solid #ccc; padding-top: 15px; margin-bottom: 10px; text-align: center; }
        .welcome-message { font-size: 1.2em; color: #555; margin-bottom: 20px; }
        .description-text { font-size: 0.9em; color: #666; margin-top: -5px; margin-bottom: 15px; text-align: center; }
        .status-message { margin-top: 10px; text-align: center; min-height: 1em; font-weight: bold; }
        .export-reminder-message { display: none; padding: 10px 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #ffeeba; background-color: #fff3cd; color: #856404; font-weight: bold; text-align: center; }
        .security-warning { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px 15px; margin: 15px 0; border-radius: 4px; font-size: 0.9em; text-align: left; }
        /* Button Styles & Grouping */
        .blue-button, .reset-button, .danger-button { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 10px; margin-bottom: 10px; display: inline-block; transition: background-color 0.2s ease; }
        .blue-button { background-color: #007bff; } .blue-button:hover { background-color: #0056b3; }
        .reset-button { background-color: #ffc107; color: black; border: 1px solid #d39e00; } .reset-button:hover { background-color: #e0a800; }
        .danger-button { background-color: #dc3545; } .danger-button:hover { background-color: #c82333; }
        .blue-button:last-of-type, .reset-button:last-of-type, .danger-button:last-of-type { margin-right: 0; }
        .main-actions-container { margin-bottom: 25px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .data-actions-container { margin-bottom: 25px; padding-top: 20px; border-top: 1px solid #eee; }
        .other-actions-container { padding-top: 20px; border-top: 1px solid #eee; }
        /* Forms & Inputs */
        .form-group, .settings-group { margin-bottom: 15px; text-align: left; }
        .form-group-inline { display: flex; align-items: center; text-align: left; margin-bottom: 15px;}
        .form-group-inline input[type="checkbox"] { width: auto; margin-right: 8px; height: 1em; margin-bottom: 0;}
        .form-group-inline label { font-weight: normal; margin-bottom: 0; }
        .settings-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        fieldset { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
        legend { font-weight: bold; padding: 0 5px; color: #555; }
        input[type="text"], input[type="password"], input[type="time"], input[type="number"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 1em; font-family: inherit; }
        #add-curtailment-form button, #manual-fleet-form button, #settings-form button, .settings-group button { width: auto; display: inline-block; margin: 10px 10px 0 0; }
        /* Toggleable Forms */
        #add-curtailment-form, #manual-fleet-form, #settings-form { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; text-align: left; margin-bottom: 20px; }
        #add-curtailment-form h3, #manual-fleet-form h3 { margin-top: 0; text-align: center; margin-bottom: 15px; }
        /* User Management Table */
        #user-management-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        #user-management-table th, #user-management-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #user-management-table th { background-color: #f2f2f2; }
        #user-management-table select, #user-management-table input[type="password"] { padding: 5px 8px; font-size: 0.9em; margin: 0; width: auto; max-width: 150px; }
        #user-management-table button { padding: 5px 8px; font-size: 0.9em; margin: 0 5px 0 0; width: auto; }
        #user-management-table .delete-user-btn { background-color: #dc3545; color: white; border: none; }
        #user-management-table .delete-user-btn:hover { background-color: #c82333; }
        /* Manual Fleet Specific */
        .revert-section { margin-top: 25px; border-top: 1px dashed #ccc; padding-top: 20px; }
        #manual-assignments-display { text-align: left; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: white; font-size: 0.9em; line-height: 1.4; margin-bottom: 20px; }
        #manual-assignments-display div { padding: 2px 0; }
        #manual-assignments-display strong { display: inline-block; min-width: 80px; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); text-align: left; width: 90%; max-width: 800px; max-height: 80%; display: flex; flex-direction: column; overflow: hidden; }
        .modal-box h3 { margin-top: 0; text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .modal-content { flex-grow: 1; overflow-y: auto; font-size: 0.9em; margin-bottom: 15px; }
        .modal-content div { border-bottom: 1px dotted #eee; padding: 8px 4px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .modal-content span { line-height: 1.4; }
        .modal-content strong { margin-right: 4px; color: #555; }
        .modal-content .delete-curtailment-btn { padding: 3px 8px; font-size: 0.85em; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: auto; transition: background-color 0.2s ease; }
        .modal-content .delete-curtailment-btn:hover { background-color: #c82333; }
        .modal-buttons { text-align: right; margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; flex-shrink: 0; }
        .modal-buttons button { margin-left: 10px; }
        .modal-buttons .cancel-button { background-color: #6c757d; }
        .modal-buttons .cancel-button:hover { background-color: #5a6268; }
        /* Utility */
        .hidden { display: none; }
        /* Centering Lower Sections Fix */
        #data-actions, #other-actions, #app-container > div:has(#logout-button) { text-align: center; }
        /* Description Text Margin Fix */
        #manual-fleet-form div > .description-text { margin-top: 5px; }
        /* Style for destination editor route sections */
        .dest-route-section { border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 15px; background-color: #fefefe; }
        .dest-route-section h4 { margin-top: 0; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        .dest-route-section h4 span { font-size: 1.1em; }
        .dest-route-section .remove-route-btn { font-size: 0.85em; padding: 3px 8px; }
    </style>
</head>
<body>
    <div id="login-container" class="login-container">
        <h2>Live Tracker Tools Login</h2>
        <form onsubmit="login(); return false;">
             <div class="form-group"> <label for="username">Username:</label> <input type="text" id="username" name="username" required> </div>
             <div class="form-group"> <label for="password">Password:</label> <input type="password" id="password" name="password" required> </div>
             <div class="form-group-inline"> <input type="checkbox" id="stayLoggedInCheckbox" name="stayLoggedIn"> <label for="stayLoggedInCheckbox">Stay logged in (disables auto-logout this session)</label> </div>
             <div class="form-group" style="text-align: center;"> <button type="submit" class="blue-button">Login</button> <p id="login-error" style="color: red; margin-top: 10px; min-height: 1em;"></p> </div>
        </form>
    </div>

    <div id="app-container" class="app-container hidden">
        <h1>Live Tracker Tools</h1>
        <p id="welcome-message" class="welcome-message"></p>
        <div id="export-reminder" class="export-reminder-message"></div>

        <div class="main-actions-container">
            <button id="toggle-add-curtailment" onclick="toggleAddCurtailmentForm()" class="blue-button hidden">Add New Curtailment</button>
            <button id="toggle-manual-fleet" onclick="toggleManualFleetForm()" class="blue-button hidden">Assign / View Manual Fleet</button>
            <button id="view-all-curtailments-btn" onclick="showAllCurtailmentsModal()" class="blue-button hidden">View / Manage All Curtailments</button>
            <button id="toggle-settings" onclick="toggleSettingsForm()" class="blue-button hidden">Settings</button>
            </div>

        <div id="add-curtailment-form" class="add-curtailment-form hidden">
            <h3>Add New Curtailment</h3>
             <label for="route">Route Number:</label> <input type="text" id="route" required placeholder="e.g., 184"><br>
             <label for="regNumber">Bus Registration:</label> <input type="text" id="regNumber" required placeholder="e.g., AB12CDE"><br>
             <label for="curtailedDestination">Curtailed Destination:</label> <input type="text" id="curtailedDestination" required placeholder="e.g., Arnos Grove Station"><br>
             <label for="curtailmentTimeInput">Time Logged (HH:MM):</label> <input type="time" id="curtailmentTimeInput" required><br>
             <button onclick="addCurtailment()" class="blue-button">Add Curtailment</button> <p id="add-curtailment-message" class="status-message" style="color: green;"></p>
        </div>

        <div id="manual-fleet-form" class="manual-fleet-form hidden">
            <h3>Assign Manual Fleet Number</h3>
            <label for="manualRegNumber">Bus Registration:</label> <input type="text" id="manualRegNumber" placeholder="e.g., AB12CDE">
            <label for="manualFleetNumber">Real Fleet Number:</label> <input type="text" id="manualFleetNumber" placeholder="e.g., VH45161, 9001">
            <button onclick="assignManualFleetNumber()" class="blue-button">Assign Fleet Number</button> <p id="assign-status" class="status-message" style="color: green;"></p>
            <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee;">
                <button id="view-auto-tmp-btn" onclick="showAutoTmpModal()" class="blue-button">View Auto-Generated TMPs</button>
                <p class="description-text">View a list of registrations with system-assigned TMP/ERR numbers.</p>
            </div>
            <h4>Current Manual Assignments</h4> <div id="manual-assignments-display">Loading...</div>
            <div class="revert-section hidden"> <label for="revertRegNumber">Registration to Revert:</label> <input type="text" id="revertRegNumber" placeholder="e.g., AB12CDE"> <button onclick="revertToTMP()" class="blue-button reset-button">Revert to Auto TMP</button> <p id="revert-status" class="status-message" style="color: green;"></p> </div>
        </div>

        <div id="settings-form" class="settings-form hidden">
             <fieldset> <legend>Tracker Settings</legend> <div class="settings-group"> <label for="setting-debounce">Curtailment Debounce Time (minutes):</label> <input type="number" id="setting-debounce" min="0" step="1" placeholder="e.g., 60"> <p class="description-text">Time before logging the same curtailment again (used by auto-detect).</p> </div> <div class="settings-group"> <label for="setting-timeout">Bus Timeout Threshold (minutes):</label> <input type="number" id="setting-timeout" min="1" step="1" placeholder="e.g., 30"> <p class="description-text">Time a bus stays listed after disappearing from API feed.</p> </div> <div class="settings-group"> <label for="setting-auto-logout">Auto Logout Time (minutes):</label> <input type="number" id="setting-auto-logout" min="0" step="1" placeholder="e.g., 30"> <p class="description-text">Automatically log out after this many minutes from login. Set to 0 to disable.</p> </div> <button onclick="saveTrackerSettings()" class="blue-button">Save Tracker Settings</button> <p id="tracker-settings-message" class="status-message" style="color: green;"></p> </fieldset>
             <fieldset> <legend>Change My Password</legend> <div class="settings-group"> <label for="current-password">Current Password:</label> <input type="password" id="current-password" required> </div> <div class="settings-group"> <label for="new-password">New Password:</label> <input type="password" id="new-password" required> </div> <div class="settings-group"> <label for="confirm-new-password">Confirm New Password:</label> <input type="password" id="confirm-new-password" required> </div> <button onclick="changeMyPassword()" class="blue-button">Change Password</button> <p id="change-password-message" class="status-message" style="color: green;"></p> </fieldset>

             <fieldset>
                 <legend>Manage Final Destinations</legend>
                 <p class="description-text" style="text-align:left; margin-top:0; margin-bottom: 15px;">Define the official iBus terminus points for routes. Add a route ID and click 'Add Section', then enter one destination per line in the text area that appears. This ensures that the Curtailments section is displaying the correct curtailments, and not adding a route with a final destination to the list. Click 'Save All' when done.</p>
                 <div style="border-bottom: 1px solid #ddd; margin-bottom: 20px; padding-bottom: 15px; display:flex; gap: 10px; align-items: center;">
                      <label for="add-dest-route-id" style="margin-bottom:0; white-space: nowrap;">Route ID to Add:</label>
                      <input type="text" id="add-dest-route-id" placeholder="e.g., 184 or 42" style="margin-bottom:0; flex-grow: 1;">
                      <button type="button" onclick="addDestRouteSection()" class="blue-button" style="margin:0;">Add Section</button>
                 </div>
                 <div id="dest-editor-routes" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: white; margin-bottom: 15px;">
                     <p>Loading destination settings...</p>
                 </div>
                 <div style="text-align:center;"> <button onclick="saveAllFinalDestinations()" class="blue-button">Save All Final Destinations</button>
                      <p id="dest-editor-message" class="status-message" style="color: green;"></p>
                 </div>
             </fieldset>
             <fieldset id="admin-user-management" class="hidden"> <legend>User Management (Admin)</legend> <h4>Add New User</h4> <div class="settings-group"> <label for="add-username">New Username:</label> <input type="text" id="add-username"> </div> <div class="settings-group"> <label for="add-user-password">Password:</label> <input type="password" id="add-user-password"> </div> <div class="settings-group"> <label for="add-user-role">Role:</label> <select id="add-user-role"><option value="user">User</option><option value="moderator">Moderator</option><option value="admin">Admin</option></select> </div> <button onclick="addUser()" class="blue-button">Add User</button> <p id="add-user-message" class="status-message" style="color: green;"></p> <h4 style="margin-top: 30px;">Manage Existing Users</h4> <div id="user-list-container" style="max-height: 300px; overflow-y: auto;"> <table id="user-management-table"> <thead> <tr><th>Username</th><th>Role</th><th>New Password</th><th>Actions</th></tr> </thead> <tbody id="user-management-tbody"></tbody> </table> </div> <p id="user-management-message" class="status-message" style="color: green;"></p> </fieldset>
        </div>
        <div id="data-actions" class="data-actions-container hidden"> <h3>Backup & Restore</h3> <button id="export-button" onclick="exportCurtailments()" class="blue-button">Export ALL Curtailments</button> <button id="import-button" onclick="document.getElementById('import-file-curtailments').click()" class="blue-button">Import ALL Curtailments</button> <input type="file" id="import-file-curtailments" accept=".json" class="hidden"> <p class="description-text">Save or load all curtailment entries to/from a JSON file.</p> </div>
        <div id="other-actions" class="other-actions-container hidden"> <h3>Other Actions</h3> <button id="reset-tmp-button" onclick="resetTMPMap()" class="reset-button">Reset ALL TMP Assignments</button> <p class="description-text">Clears the stored Registration -> TMP map. Requires password.</p> </div>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;"> <button id="logout-button" onclick="logout()" class="blue-button" style="background-color: #6c757d;">Logout</button> </div>

    </div>

    <div id="password-modal" class="modal-overlay hidden"> <div class="modal-box"> <h3>Confirm Action</h3> <label for="confirm-password">Please enter your password to confirm TMP reset:</label> <input type="password" id="confirm-password" name="confirm-password" required> <p id="password-modal-error" style="color: red; min-height: 1em; margin-top: 5px;"></p> <div class="modal-buttons"> <button onclick="cancelPasswordReset()" class="blue-button cancel-button">Cancel</button> <button onclick="handlePasswordConfirm()" class="blue-button">Confirm Reset</button> </div> </div> </div>
     <div id="all-curtailments-modal" class="modal-overlay hidden"> <div class="modal-box"> <h3>All Stored Curtailments</h3> <div id="all-curtailments-list" class="modal-content"> <p>Loading...</p> </div> <div class="modal-buttons"> <button onclick="hideAllCurtailmentsModal()" class="blue-button cancel-button">Close</button> </div> </div> </div>
     <div id="auto-tmp-modal" class="modal-overlay hidden"> <div class="modal-box"> <h3>Auto-Generated TMP Assignments</h3> <p class="description-text" style="text-align:left; margin-top:0;">This list shows registrations currently assigned an automatic TMP or ERR number. Use the 'Assign / View Manual Fleet' section to assign their real fleet numbers.</p> <div id="auto-tmp-list" class="modal-content" style="font-size: 0.95em;"> <p>Loading...</p> </div> <div class="modal-buttons"> <button onclick="hideAutoTmpModal()" class="blue-button cancel-button">Close</button> </div> </div> </div>

<script>
    // --- User Authentication & Data ---
    const usersStorageKey = 'liveTrackerUsers';
    let users = {}; let isLoggedIn = false; let currentUsername = null;
    let isPasswordModalIntentionallyVisible = false;

    function loadUsers() { try { const storedUsers = localStorage.getItem(usersStorageKey); if (storedUsers) { users = JSON.parse(storedUsers); if (!users.admin || !users.admin.pass || !users.admin.role) { console.warn("Stored user data incomplete, resetting."); setDefaultUsers(); } } else { setDefaultUsers(); } } catch (e) { console.error("Error loading users, resetting:", e); setDefaultUsers(); } console.log("Users loaded:", users); }
    function setDefaultUsers() { users = { 'admin': { pass: 'password', role: 'admin' } }; saveUsersToStorage(); }
    function saveUsersToStorage() { try { localStorage.setItem(usersStorageKey, JSON.stringify(users)); console.log("Users saved."); } catch (e) { console.error("Error saving users:", e); alert("Error: Could not save user data."); } }

    // --- DOM Elements ---
    const loginContainer = document.getElementById('login-container'); const appContainer = document.getElementById('app-container'); const loginError = document.getElementById('login-error'); const addCurtailmentForm = document.getElementById('add-curtailment-form'); const addCurtailmentMessage = document.getElementById('add-curtailment-message'); const toggleAddCurtailmentButton = document.getElementById('toggle-add-curtailment'); const importCurtailmentsInput = document.getElementById('import-file-curtailments'); const manualFleetForm = document.getElementById('manual-fleet-form'); const toggleManualFleetButton = document.getElementById('toggle-manual-fleet'); const manualRegNumberInput = document.getElementById('manualRegNumber'); const manualFleetNumberInput = document.getElementById('manualFleetNumber'); const assignStatusElement = document.getElementById('assign-status'); const manualAssignmentsDisplay = document.getElementById('manual-assignments-display'); const revertRegNumberInput = document.getElementById('revertRegNumber'); const revertStatusElement = document.getElementById('revert-status'); const settingsForm = document.getElementById('settings-form'); const toggleSettingsButton = document.getElementById('toggle-settings'); const settingsDebounceInput = document.getElementById('setting-debounce'); const settingsTimeoutInput = document.getElementById('setting-timeout'); const settingsAutoLogoutInput = document.getElementById('setting-auto-logout'); const trackerSettingsMessage = document.getElementById('tracker-settings-message'); const currentPasswordInput = document.getElementById('current-password'); const newPasswordInput = document.getElementById('new-password'); const confirmNewPasswordInput = document.getElementById('confirm-new-password'); const changePasswordMessage = document.getElementById('change-password-message'); const adminUserManagementSection = document.getElementById('admin-user-management'); const addUsernameInput = document.getElementById('add-username'); const addUserPasswordInput = document.getElementById('add-user-password'); const addUserRoleSelect = document.getElementById('add-user-role'); const addUserMessage = document.getElementById('add-user-message'); const userManagementTbody = document.getElementById('user-management-tbody'); const userManagementMessage = document.getElementById('user-management-message'); const welcomeMessageElement = document.getElementById('welcome-message'); const passwordModal = document.getElementById('password-modal'); const passwordModalInput = document.getElementById('confirm-password'); const passwordModalError = document.getElementById('password-modal-error'); const allCurtailmentsModal = document.getElementById('all-curtailments-modal'); const allCurtailmentsList = document.getElementById('all-curtailments-list'); const viewAllCurtailmentsButton = document.getElementById('view-all-curtailments-btn'); const dataActionsSection = document.getElementById('data-actions'); const exportButton = document.getElementById('export-button'); const importButton = document.getElementById('import-button'); const otherActionsSection = document.getElementById('other-actions'); const resetTmpButton = document.getElementById('reset-tmp-button'); const logoutButton = document.getElementById('logout-button');
    const autoTmpModal = document.getElementById('auto-tmp-modal'); const autoTmpList = document.getElementById('auto-tmp-list'); const viewAutoTmpBtn = document.getElementById('view-auto-tmp-btn');
    // ** Elements for Dynamic Destination Editor **
    const addDestRouteIdInput = document.getElementById('add-dest-route-id');
    const destEditorRoutesContainer = document.getElementById('dest-editor-routes');
    const destEditorMessage = document.getElementById('dest-editor-message');

    // --- Constants ---
    const tmpMapKey = "tmpRegistrationMap"; const settingsKey = "trackerGlobalSettings"; const defaultSettings = { debounceMinutes: 60, timeoutMinutes: 30, autoLogoutMinutes: 30 }; const lastExportKey = 'lastCurtailmentExportTimestamp';
    const tmpGenerationInfoKey = "tmpGenerationInfo"; // For Auto TMP Viewer
    const routeDestinationSettingsKey = 'routeDestinationSettings'; // For Editable Destinations

    // --- Session Duration Timer ---
    let sessionTimerId = null;
    // --- Storage Helper Functions ---
    function loadFromStorage(key, defaultValue = {}) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error(`Error loading ${key}:`, e); return defaultValue; } }
    function saveToStorage(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`Error saving ${key}:`, e); alert(`Error saving ${key}. Storage might be full.`); } }

    // --- Auth Functions ---
    function checkLogin() { console.log("checkLogin started"); loadUsers(); try { const storedUser = localStorage.getItem('loggedInUser'); if (localStorage.getItem('isLoggedIn') === 'true' && storedUser && users[storedUser]) { isLoggedIn = true; currentUsername = storedUser; showApp(); } else { isLoggedIn = false; currentUsername = null; localStorage.removeItem('isLoggedIn'); localStorage.removeItem('loggedInUser'); showLogin(); } } catch (e) { console.error("Error in checkLogin:", e); isLoggedIn = false; currentUsername = null; showLogin(); } }
    // Using robust login check
    function login() { const usernameInput = document.getElementById('username'); const passwordInput = document.getElementById('password'); const stayLoggedInCheckbox = document.getElementById('stayLoggedInCheckbox'); if (!usernameInput || !passwordInput) { console.error("Login form elements not found (username or password input). Cannot proceed."); if(loginError) loginError.textContent = 'Login form error.'; return; } if (!stayLoggedInCheckbox) { console.warn("Stay logged in checkbox element (#stayLoggedInCheckbox) not found. Proceeding without it."); } const username = usernameInput.value; const password = passwordInput.value; const stayLoggedIn = stayLoggedInCheckbox ? stayLoggedInCheckbox.checked : false; if(loginError) loginError.textContent = ''; if (users.hasOwnProperty(username) && users[username].pass === password) { localStorage.setItem('isLoggedIn', 'true'); localStorage.setItem('loggedInUser', username); if (stayLoggedIn) { sessionStorage.setItem('bypassAutoLogout', 'true'); console.log("Bypassing auto-logout."); } else { sessionStorage.removeItem('bypassAutoLogout'); } isLoggedIn = true; currentUsername = username; showApp(); } else { if(loginError) loginError.textContent = 'Invalid username or password.'; isLoggedIn = false; currentUsername = null; sessionStorage.removeItem('bypassAutoLogout'); } }
    function logout() { if (sessionTimerId) { clearTimeout(sessionTimerId); sessionTimerId = null; console.log("Session timer cleared."); } localStorage.setItem('isLoggedIn', 'false'); localStorage.removeItem('loggedInUser'); sessionStorage.removeItem('bypassAutoLogout'); isLoggedIn = false; currentUsername = null; showLogin(); }

    // --- Timer Functions ---
     function logoutAfterSession() { if (isLoggedIn) { const settings = loadFromStorage(settingsKey, defaultSettings); const logoutMinutes = settings.autoLogoutMinutes || 0; console.log(`Logging out (${logoutMinutes} min timeout).`); alert(`Session expired after ${logoutMinutes} minutes.`); logout(); } }
     function startSessionTimer() { if (sessionTimerId) { clearTimeout(sessionTimerId); sessionTimerId = null; } if (!isLoggedIn) { return; } const bypass = sessionStorage.getItem('bypassAutoLogout') === 'true'; if (bypass) { console.log("Auto-logout bypassed."); return; } const settings = loadFromStorage(settingsKey, defaultSettings); const logoutMinutes = (typeof settings.autoLogoutMinutes === 'number' && settings.autoLogoutMinutes >= 0) ? settings.autoLogoutMinutes : defaultSettings.autoLogoutMinutes; if (logoutMinutes <= 0) { console.log("Session auto-logout disabled."); return; } const logoutMilliseconds = logoutMinutes * 60 * 1000; console.log(`Starting session timer: ${logoutMinutes} min.`); sessionTimerId = setTimeout(logoutAfterSession, logoutMilliseconds); }

    // --- UI Display Functions ---
    function showApp() { try { if (!isLoggedIn || !currentUsername || !users[currentUsername]) { logout(); return; } const userRole = users[currentUsername].role; if(loginContainer) loginContainer.classList.add('hidden'); if(appContainer) appContainer.classList.remove('hidden'); if(welcomeMessageElement) { if (currentUsername === 'admin') { welcomeMessageElement.textContent = `Welcome, Ryan!`; } else { welcomeMessageElement.textContent = `Welcome, ${currentUsername}!`; } } const reminderElement = document.getElementById('export-reminder'); if (reminderElement) { try { const lastExportTimeStr = localStorage.getItem(lastExportKey); const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000; const now = Date.now(); let message = ''; let showBox = false; if (lastExportTimeStr) { const lastExportTime = parseInt(lastExportTimeStr, 10); console.log(`Export Reminder Check: Found timestamp string "${lastExportTimeStr}", parsed as ${lastExportTime}`); if (!isNaN(lastExportTime)) { const diff = now - lastExportTime; if (diff > sevenDaysInMillis) { const daysSinceExport = Math.floor(diff / (1000 * 60 * 60 * 24)); message = `Reminder: It's been ${daysSinceExport} days since the last curtailment export. Consider backing up your data soon.`; showBox = true; console.log(`Export Reminder Check: Timestamp old (${daysSinceExport} days). Message set. Show box: true.`); } else { message = ''; showBox = false; console.log(`Export Reminder Check: Timestamp recent. Show box: false.`); } } else { console.warn(`Export Reminder Check: Found timestamp but failed to parse: "${lastExportTimeStr}". Treating as never exported.`); message = "Reminder: Could not read last export time. Consider making a backup."; showBox = true; } } else { message = "Reminder: You haven't exported curtailment data before. Consider making an initial backup."; showBox = true; console.log(`Export Reminder Check: No timestamp found. Message set. Show box: true.`); } reminderElement.textContent = message; reminderElement.style.display = showBox ? 'block' : 'none'; console.log(`Export Reminder Check: Final state -> Display: ${reminderElement.style.display}, Text: "${reminderElement.textContent}"`); } catch (e) { console.error("Error checking last export time:", e); if(reminderElement) reminderElement.style.display = 'none'; } } else { console.warn("Export reminder element not found."); }
            // Reset visibility based on role
            [toggleAddCurtailmentButton, toggleManualFleetButton, viewAllCurtailmentsButton, toggleSettingsButton, dataActionsSection, otherActionsSection].forEach(el => el?.classList.add('hidden'));
            if(settingsForm) settingsForm.classList.add('hidden');
            if(addCurtailmentForm) addCurtailmentForm.classList.add('hidden');
            if(manualFleetForm) manualFleetForm.classList.add('hidden');
            if (userRole === 'admin' || userRole === 'moderator') { toggleAddCurtailmentButton?.classList.remove('hidden'); toggleManualFleetButton?.classList.remove('hidden'); viewAllCurtailmentsButton?.classList.remove('hidden'); dataActionsSection?.classList.remove('hidden'); }
            if (userRole === 'admin') { toggleSettingsButton?.classList.remove('hidden'); otherActionsSection?.classList.remove('hidden'); }
            if (userRole === 'user') { viewAllCurtailmentsButton?.classList.remove('hidden'); }
            // Reset button text
            if(toggleAddCurtailmentButton) toggleAddCurtailmentButton.textContent = 'Add New Curtailment'; if(toggleManualFleetButton) toggleManualFleetButton.textContent = 'Assign / View Manual Fleet'; if(toggleSettingsButton) toggleSettingsButton.textContent = 'Settings';
            // Close modals
            if (passwordModal) { passwordModal.classList.add('hidden'); isPasswordModalIntentionallyVisible = false; } if (allCurtailmentsModal) { allCurtailmentsModal.classList.add('hidden'); } if (autoTmpModal) autoTmpModal.classList.add('hidden');
            loadTrackerSettings(); displayManualAssignments(); startSessionTimer();
             } catch(e) { console.error("Error in showApp:", e); } }
    function showLogin() { try { if (sessionTimerId) { clearTimeout(sessionTimerId); sessionTimerId = null; console.log("Session timer cleared."); } sessionStorage.removeItem('bypassAutoLogout'); if(loginContainer) loginContainer.classList.remove('hidden'); if(appContainer) appContainer.classList.add('hidden'); if(welcomeMessageElement) welcomeMessageElement.textContent = ''; if(loginError) loginError.textContent = ''; const usernameInput = document.getElementById('username'); if(usernameInput) usernameInput.value = ''; const passwordInput = document.getElementById('password'); if(passwordInput) passwordInput.value = ''; const stayLoggedInCheckbox = document.getElementById('stayLoggedInCheckbox'); if(stayLoggedInCheckbox) stayLoggedInCheckbox.checked = false; if (passwordModal) { passwordModal.classList.add('hidden'); isPasswordModalIntentionallyVisible = false;} if (allCurtailmentsModal) { allCurtailmentsModal.classList.add('hidden'); } if (autoTmpModal) autoTmpModal.classList.add('hidden'); const reminderElement = document.getElementById('export-reminder'); if (reminderElement) reminderElement.style.display = 'none'; } catch(e) { console.error("Error in showLogin:", e); } }

    // --- Curtailment Functions ---
    function toggleAddCurtailmentForm() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } if(addCurtailmentForm) { const isHidden = addCurtailmentForm.classList.toggle('hidden'); if(toggleAddCurtailmentButton) toggleAddCurtailmentButton.textContent = isHidden ? 'Add New Curtailment' : 'Hide Curtailment Form'; if(addCurtailmentMessage) addCurtailmentMessage.textContent = ''; } }
    function addCurtailment() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } const routeInput = document.getElementById('route'); const regNumberInput = document.getElementById('regNumber'); const curtailedDestinationInput = document.getElementById('curtailedDestination'); const timeInput = document.getElementById('curtailmentTimeInput'); if (!routeInput || !regNumberInput || !curtailedDestinationInput || !timeInput) { console.error("Missing curtailment form elements"); alert("Error: Form elements missing."); return; } const route = routeInput.value.trim(); const regNumber = regNumberInput.value.trim().toUpperCase(); const curtailedDestination = curtailedDestinationInput.value.trim(); const timeString = timeInput.value.trim(); if (route && regNumber && curtailedDestination && timeString) { const routeKey = `curtailedBusesArray_${route}`; let routeCurtailments = loadFromStorage(routeKey, []); if (!Array.isArray(routeCurtailments)) { console.error(`Data for key ${routeKey} is not an array. Resetting.`); alert(`Warning: Corrupted data found for route ${route}. Starting fresh list.`); routeCurtailments = []; } let logDate = new Date(); const timeParts = timeString.split(':'); if (timeParts.length === 2) { const hours = parseInt(timeParts[0], 10); const minutes = parseInt(timeParts[1], 10); if (!isNaN(hours) && !isNaN(minutes) && hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) { logDate.setHours(hours, minutes, 0, 0); } else { alert("Invalid time format entered. Please use HH:MM (24-hour format)."); timeInput.focus(); return; } } else { alert("Invalid time format entered. Please use HH:MM."); timeInput.focus(); return; } const newCurtailment = { route: route, regNumber: regNumber, curtailedDestination: curtailedDestination, curtailmentTime: logDate.toLocaleString('en-GB', { timeZone: 'Europe/London', dateStyle: 'short', timeStyle: 'short'}), timestamp: logDate.getTime() }; routeCurtailments.push(newCurtailment); saveToStorage(routeKey, routeCurtailments); routeInput.value = ""; regNumberInput.value = ""; curtailedDestinationInput.value = ""; timeInput.value = ""; if(addCurtailmentMessage){ addCurtailmentMessage.textContent = `Curtailment for route ${route} at ${timeString} added successfully!`; addCurtailmentMessage.style.color = 'green'; setTimeout(() => { if(addCurtailmentMessage) addCurtailmentMessage.textContent = ""; }, 3000); } routeInput.focus(); } else { alert("Please fill in all curtailment details (Route, Registration, Destination, Time)."); if (!route) routeInput.focus(); else if (!regNumber) regNumberInput.focus(); else if (!curtailedDestination) curtailedDestinationInput.focus(); else if (!timeString) timeInput.focus(); } }
    function exportCurtailments() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } const allData = {}; let keysFound = 0; try { for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key && key.startsWith("curtailedBusesArray_")) { const routeNum = key.replace("curtailedBusesArray_", ""); const routeData = loadFromStorage(key, []); if (Array.isArray(routeData)) { allData[routeNum] = routeData; keysFound++; } else { console.warn(`Skipping export for key ${key}: data is not an array.`); } } } } catch (e) { console.error("Error reading localStorage during export:", e); alert("An error occurred while gathering data for export."); return; } if (keysFound === 0) { alert("No curtailment data found in localStorage to export."); return; } try { const jsonString = JSON.stringify(allData, null, 2); const blob = new Blob([jsonString], { type: "application/json" }); const a = document.createElement("a"); const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); a.href = URL.createObjectURL(blob); a.download = `all_routes_curtailments_${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); alert("Curtailment data exported successfully!"); try { localStorage.setItem(lastExportKey, Date.now().toString()); console.log("Recorded last export timestamp."); const reminderElement = document.getElementById('export-reminder'); if (reminderElement) { reminderElement.style.display = 'none'; } } catch (e) { console.error("Could not save last export timestamp to localStorage", e); } } catch (e) { console.error("Error creating or downloading the export file:", e); alert("An error occurred during file creation or download."); } }
    // ** MODIFIED handleCurtailmentImport with DEBUG LOGGING **
    function handleCurtailmentImport(file) {
        console.log('handleCurtailmentImport started.'); // <-- DEBUG
        // Role check (slightly redundant but ok)
        if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) {
            alert('Access Denied.');
            if(importCurtailmentsInput) importCurtailmentsInput.value = '';
            console.log('handleCurtailmentImport aborted: Access Denied.'); // <-- DEBUG
            return;
        }

        if (!file) {
            alert("No file provided to import function.");
            console.log('handleCurtailmentImport aborted: No file object.'); // <-- DEBUG
            return;
        }
        console.log('File object received:', file.name); // <-- DEBUG

        // File type check (allow empty type or application/json)
        if (!file.name.toLowerCase().endsWith('.json')) {
             alert("Please select a valid JSON file (.json).");
             if(importCurtailmentsInput) importCurtailmentsInput.value = ''; // Reset
             console.log('handleCurtailmentImport aborted: Invalid file extension.'); // <-- DEBUG
             return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            console.log('FileReader onload triggered.'); // <-- DEBUG
            try {
                console.log('Attempting to parse JSON...'); // <-- DEBUG
                const fileContent = e.target.result;
                 if (!fileContent) {
                    throw new Error("File content is empty or could not be read.");
                 }
                const importedData = JSON.parse(fileContent);
                console.log('JSON parsed successfully.'); // <-- DEBUG

                if (typeof importedData !== 'object' || importedData === null) {
                    throw new Error("Imported file is not a valid JSON object.");
                }

                console.log('Asking for confirmation...'); // <-- DEBUG
                if (!confirm("Importing will REPLACE existing curtailment data for the routes found in the file. Are you sure you want to proceed?")) {
                    if(importCurtailmentsInput) importCurtailmentsInput.value = '';
                    console.log('Import cancelled by user confirmation.'); // <-- DEBUG
                    return; // Stop execution if user cancels
                }
                console.log('User confirmed import.'); // <-- DEBUG

                let importedCount = 0;
                let skippedRoutes = [];
                let skippedEntriesCount = 0;

                 for (const route in importedData) {
                     if (importedData.hasOwnProperty(route)) {
                         const routeKey = `curtailedBusesArray_${route}`;
                         const routeData = importedData[route];
                         if (Array.isArray(routeData)) {
                            console.log(`Processing route: ${route}`); // <-- DEBUG Log inside loop
                             // Filter for basic structure
                             const validData = routeData.filter(item =>
                                 item &&
                                 typeof item.route === 'string' && item.route.trim() !== '' &&
                                 typeof item.regNumber === 'string' && item.regNumber.trim() !== '' &&
                                 typeof item.curtailedDestination === 'string' && item.curtailedDestination.trim() !== '' &&
                                 (typeof item.curtailmentTime === 'string' || typeof item.timestamp === 'number')
                             );

                             if(validData.length !== routeData.length){
                                 const skipped = routeData.length - validData.length;
                                 skippedEntriesCount += skipped;
                                 console.warn(`Skipped ${skipped} invalid entries for route ${route}.`);
                             }

                             // Attempt to ensure timestamp exists
                             validData.forEach(item => {
                                 if (!item.timestamp && item.curtailmentTime) {
                                     try {
                                         // Try parsing DD/MM/YYYY, HH:MM format first
                                         const parts = item.curtailmentTime.match(/(\d{2})\/(\d{2})\/(\d{4}),? (\d{2}):(\d{2})/); // Made comma optional
                                         if(parts) {
                                             // Note: Month is 0-indexed in JS Date constructor
                                             // Use UTC to avoid timezone shifts during parsing
                                             item.timestamp = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], 0)).getTime();
                                             if (isNaN(item.timestamp)) item.timestamp = 0; // Check if parsing resulted in NaN
                                         } else {
                                             // Fallback to Date.parse (less reliable for specific formats)
                                             item.timestamp = Date.parse(item.curtailmentTime) || 0;
                                         }
                                     } catch { item.timestamp = 0; }
                                 } else if (!item.timestamp) {
                                     item.timestamp = 0; // Ensure timestamp is at least 0 if completely missing
                                 }
                             });

                             // Final filter for valid timestamp (must be a positive number)
                             const finalValidData = validData.filter(item => typeof item.timestamp === 'number' && item.timestamp > 0);

                             if (validData.length !== finalValidData.length) {
                                 const skipped = validData.length - finalValidData.length;
                                 skippedEntriesCount += skipped;
                                 console.warn(`Skipped ${skipped} entries for route ${route} due to timestamp parsing failure or invalid timestamp.`);
                             }

                             // Only save if there's valid data
                             if (finalValidData.length > 0) {
                                 saveToStorage(routeKey, finalValidData);
                                 importedCount++;
                                 console.log(`Saved ${finalValidData.length} valid entries for route ${route}.`);
                             } else {
                                console.warn(`No valid entries with timestamps found for route ${route}. Skipping save for this route.`);
                             }

                         } else {
                             skippedRoutes.push(route);
                             console.warn(`Skipping import for route ${route}: data is not an array.`);
                         }
                     }
                 } // end of processing loop

                let alertMessage = `${importedCount} route(s) curtailment data imported successfully! Data for these routes was replaced.\n`;
                if (skippedRoutes.length > 0) {
                    alertMessage += `Skipped invalid data structure for routes: ${skippedRoutes.join(', ')}\n`;
                }
                if (skippedEntriesCount > 0) {
                    alertMessage += `Skipped ${skippedEntriesCount} invalid/incomplete or timestamp-failed entries within imported routes.`;
                }
                alert(alertMessage);
                console.log('Import process finished.'); // <-- DEBUG

            } catch (error) {
                console.error("Error during import processing:", error); // <-- DEBUG Ensure error object is logged
                alert("Error importing curtailments: " + error.message + ". Check browser console for details.");
            } finally {
                console.log('FileReader onload finally block executing.'); // <-- DEBUG
                // Reset the input value to allow importing the same file again
                if(importCurtailmentsInput) importCurtailmentsInput.value = '';
            }
        }; // end reader.onload

        reader.onerror = function() {
            console.error('FileReader onerror triggered.'); // <-- DEBUG
            alert("Error reading the selected file.");
            if(importCurtailmentsInput) importCurtailmentsInput.value = '';
        };

        console.log('Calling reader.readAsText...'); // <-- DEBUG
        reader.readAsText(file); // Start reading

    } // end handleCurtailmentImport


    // --- Manual Fleet Functions ---
    function toggleManualFleetForm() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } if(manualFleetForm) { const isHidden = manualFleetForm.classList.toggle('hidden'); if(toggleManualFleetButton) toggleManualFleetButton.textContent = isHidden ? 'Assign / View Manual Fleet' : 'Hide Manual Fleet Form'; if(assignStatusElement) assignStatusElement.textContent = ''; if(revertStatusElement) revertStatusElement.textContent = ''; if (!isHidden) { displayManualAssignments(); const revertSection = document.querySelector('#manual-fleet-form .revert-section'); if (revertSection) { revertSection.classList.toggle('hidden', users[currentUsername]?.role !== 'admin'); } } } }
    function displayManualAssignments() { if (!isLoggedIn) { return; } const tmpMap = loadFromStorage(tmpMapKey, {}); if(!manualAssignmentsDisplay) return; manualAssignmentsDisplay.innerHTML = ''; const manualEntries = []; try { if (typeof tmpMap === 'object' && tmpMap !== null) { for (const reg in tmpMap) { if (tmpMap.hasOwnProperty(reg)) { const fleet = tmpMap[reg]; if (typeof fleet === 'string' && !fleet.startsWith('TMP') && !fleet.startsWith('ERR')) { manualEntries.push({ reg: reg, fleet: fleet }); } } } } else { console.warn("TMP Map data is not a valid object."); } } catch (e) { console.error("Error processing TMP Map for display:", e); manualAssignmentsDisplay.innerHTML = '<em style="color: red;">Error loading assignments.</em>'; return; } if (manualEntries.length === 0) { manualAssignmentsDisplay.innerHTML = '<em>No manual assignments found.</em>'; } else { manualEntries.sort((a, b) => a.reg.localeCompare(b.reg)); manualEntries.forEach(entry => { const div = document.createElement('div'); const regText = document.createTextNode(entry.reg); const fleetText = document.createTextNode(entry.fleet); const strong = document.createElement('strong'); strong.appendChild(regText); strong.appendChild(document.createTextNode(': ')); div.appendChild(strong); div.appendChild(fleetText); manualAssignmentsDisplay.appendChild(div); }); } }
    function assignManualFleetNumber() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } if (!manualRegNumberInput || !manualFleetNumberInput || !assignStatusElement) { console.error("Missing elements for manual assignment"); return; } const regNumber = manualRegNumberInput.value.trim().toUpperCase(); const realFleetNumber = manualFleetNumberInput.value.trim(); assignStatusElement.textContent = ''; if (!regNumber || !realFleetNumber) { alert('Please enter both Registration and Fleet Number.'); if (!regNumber) manualRegNumberInput.focus(); else manualFleetNumberInput.focus(); return; } if (realFleetNumber.startsWith('TMP') || realFleetNumber.startsWith('ERR')) { if (!confirm(`The entered fleet number "${realFleetNumber}" looks like an auto-generated/error code. Are you sure you want to assign this manually?`)) { manualFleetNumberInput.focus(); return; } } try { let tmpMap = loadFromStorage(tmpMapKey, {}); if (typeof tmpMap !== 'object' || tmpMap === null) { console.warn("TMP Map was not an object, resetting."); tmpMap = {}; } tmpMap[regNumber] = realFleetNumber; saveToStorage(tmpMapKey, tmpMap); assignStatusElement.textContent = `Assigned Fleet# ${realFleetNumber} to ${regNumber}.`; assignStatusElement.style.color = 'green'; console.log(`Manual Fleet Assign: ${regNumber} -> ${realFleetNumber}`); manualRegNumberInput.value = ''; manualFleetNumberInput.value = ''; displayManualAssignments(); manualRegNumberInput.focus(); setTimeout(() => { if(assignStatusElement) assignStatusElement.textContent = ''; }, 4000); } catch (error) { console.error("Error saving manual fleet assignment:", error); assignStatusElement.textContent = `Error saving assignment: ${error.message}`; assignStatusElement.style.color = 'red'; } }
    function revertToTMP() { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (!revertRegNumberInput || !revertStatusElement) { console.error("Missing elements for revert function"); return; } const regToRevert = revertRegNumberInput.value.trim().toUpperCase(); if(revertStatusElement) revertStatusElement.textContent = ''; if (!regToRevert) { alert("Please enter the Registration number to revert."); revertRegNumberInput.focus(); return; } let tmpMap = loadFromStorage(tmpMapKey, {}); if (typeof tmpMap !== 'object' || tmpMap === null) { console.warn("TMP Map is not an object, cannot revert."); tmpMap = {}; } if (!tmpMap.hasOwnProperty(regToRevert)) { if(revertStatusElement){ revertStatusElement.textContent = `Registration ${regToRevert} not found in map. No action needed.`; revertStatusElement.style.color = 'orange'; setTimeout(() => { if(revertStatusElement) { revertStatusElement.textContent = ''; revertStatusElement.style.color = 'green';} }, 4000); } return; } const currentValue = tmpMap[regToRevert]; if (typeof currentValue === 'string' && (currentValue.startsWith('TMP') || currentValue.startsWith('ERR'))) { if(revertStatusElement){ revertStatusElement.textContent = `${regToRevert} is already using an auto TMP/ERR code. No action needed.`; revertStatusElement.style.color = 'orange'; setTimeout(() => { if(revertStatusElement) {revertStatusElement.textContent = ''; revertStatusElement.style.color = 'green';} }, 4000); } return; } if (confirm(`Are you sure you want to remove the manual fleet number for "${regToRevert}"?\nThe system will attempt to assign an automatic TMP number later if the bus is detected.`)) { try { delete tmpMap[regToRevert]; saveToStorage(tmpMapKey, tmpMap); if(revertStatusElement){ revertStatusElement.textContent = `Manual assignment for ${regToRevert} removed.`; revertStatusElement.style.color = 'green'; } console.log(`Reverted ${regToRevert} to allow auto TMP assignment.`); if(revertRegNumberInput) revertRegNumberInput.value = ''; displayManualAssignments(); revertRegNumberInput.focus(); setTimeout(() => { if(revertStatusElement) revertStatusElement.textContent = ''; }, 4000); } catch (error) { console.error("Error reverting TMP assignment:", error); if(revertStatusElement){ revertStatusElement.textContent = `Error reverting assignment: ${error.message}`; revertStatusElement.style.color = 'red';} } } else { if(revertStatusElement){ revertStatusElement.textContent = `Revert cancelled for ${regToRevert}.`; revertStatusElement.style.color = 'grey'; setTimeout(() => { if(revertStatusElement) { revertStatusElement.textContent = ''; revertStatusElement.style.color = 'green';} }, 3000); } } }

    // --- Settings Functions ---
    function toggleSettingsForm() {
        if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; }
        if (settingsForm) {
             const isHidden = settingsForm.classList.toggle('hidden');
             // Clear status messages
             if(trackerSettingsMessage) trackerSettingsMessage.textContent = '';
             if(changePasswordMessage) changePasswordMessage.textContent = '';
             if(addUserMessage) addUserMessage.textContent = '';
             if(userManagementMessage) userManagementMessage.textContent = '';
             if(destEditorMessage) destEditorMessage.textContent = '';

             if (!isHidden) { // If opening settings form
                 loadTrackerSettings();
                 populateDestEditor(); // Load dynamic destinations
                 if (adminUserManagementSection) { adminUserManagementSection.classList.remove('hidden'); }
                 else { console.error("Admin user management section element not found!"); }
                 displayUserManagement(); // Populate User Mgmt
             } else { // If closing settings form
                 if (adminUserManagementSection) { adminUserManagementSection.classList.add('hidden'); } // Hide User Mgmt
             }
             // Ensure other forms are hidden if settings are toggled
             if (!addCurtailmentForm.classList.contains('hidden')) { addCurtailmentForm.classList.add('hidden'); if(toggleAddCurtailmentButton) toggleAddCurtailmentButton.textContent = 'Add New Curtailment'; }
             if (!manualFleetForm.classList.contains('hidden')) { manualFleetForm.classList.add('hidden'); if(toggleManualFleetButton) toggleManualFleetButton.textContent = 'Assign / View Manual Fleet'; }
        }
    }
    function loadTrackerSettings() { const savedSettings = loadFromStorage(settingsKey, defaultSettings); const debounce = Number.isFinite(savedSettings.debounceMinutes) ? savedSettings.debounceMinutes : defaultSettings.debounceMinutes; if(settingsDebounceInput) settingsDebounceInput.value = debounce; const timeout = Number.isFinite(savedSettings.timeoutMinutes) ? savedSettings.timeoutMinutes : defaultSettings.timeoutMinutes; if(settingsTimeoutInput) settingsTimeoutInput.value = timeout; const autoLogout = Number.isFinite(savedSettings.autoLogoutMinutes) ? savedSettings.autoLogoutMinutes : defaultSettings.autoLogoutMinutes; if(settingsAutoLogoutInput) settingsAutoLogoutInput.value = autoLogout; }
    function saveTrackerSettings() { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if(!settingsDebounceInput || !settingsTimeoutInput || !settingsAutoLogoutInput || !trackerSettingsMessage) { console.error("Tracker settings form elements missing"); return; } const newDebounce = parseInt(settingsDebounceInput.value, 10); const newTimeout = parseInt(settingsTimeoutInput.value, 10); const newAutoLogout = parseInt(settingsAutoLogoutInput.value, 10); trackerSettingsMessage.textContent = ''; if (isNaN(newDebounce) || newDebounce < 0) { alert("Invalid Debounce Time."); settingsDebounceInput.focus(); trackerSettingsMessage.textContent = "Invalid Debounce Time."; trackerSettingsMessage.style.color = "red"; return; } if (isNaN(newTimeout) || newTimeout < 1) { alert("Invalid Timeout Threshold."); settingsTimeoutInput.focus(); trackerSettingsMessage.textContent = "Invalid Timeout Threshold."; trackerSettingsMessage.style.color = "red"; return; } if (isNaN(newAutoLogout) || newAutoLogout < 0) { alert("Invalid Auto Logout Time."); settingsAutoLogoutInput.focus(); trackerSettingsMessage.textContent = "Invalid Auto Logout Time."; trackerSettingsMessage.style.color = "red"; return; } const newSettings = { debounceMinutes: newDebounce, timeoutMinutes: newTimeout, autoLogoutMinutes: newAutoLogout }; saveToStorage(settingsKey, newSettings); trackerSettingsMessage.textContent = "Tracker settings saved successfully!"; trackerSettingsMessage.style.color = "green"; console.log("Tracker settings saved:", newSettings); startSessionTimer(); setTimeout(() => { if(trackerSettingsMessage) trackerSettingsMessage.textContent = ""; }, 3000); }

    // --- Dynamic Final Destination Editor Functions ---
    function populateDestEditor() {
         if (!destEditorRoutesContainer) { console.error("Destination editor container not found."); return; }
         destEditorRoutesContainer.innerHTML = ''; // Clear existing
         // Define defaults within the function for clarity
         const defaultDests = {
             "184": ["Chesterfield Road", "Barnet, Chesterfield Road", "Turnpike Lane Station", "Turnpike Lane Bus Station", "Turnpike Lane, Station"],
             "N20": ["Barnet Hospital", "Trafalgar Square"]
         };
         const savedDestSettings = loadFromStorage(routeDestinationSettingsKey, defaultDests);
         // Ensure defaults are included if not present in saved data
         for (const defaultRouteId in defaultDests) {
             if (!savedDestSettings.hasOwnProperty(defaultRouteId)) {
                 savedDestSettings[defaultRouteId] = defaultDests[defaultRouteId];
             }
         }
         const routes = Object.keys(savedDestSettings).sort();
         if (routes.length === 0) {
             destEditorRoutesContainer.innerHTML = '<p>No routes configured yet. Add one above.</p>';
             return;
         }
         routes.forEach(routeId => {
             createRouteSectionElement(routeId, savedDestSettings[routeId] || []);
         });
    }
    function createRouteSectionElement(routeId, destinations = []) {
         if (!destEditorRoutesContainer) return;
         // Check if section already exists to prevent duplicates from bad calls
         if (destEditorRoutesContainer.querySelector(`[data-routeid="${routeId}"]`)) {
             console.warn(`Section for Route ${routeId} already exists. Skipping creation.`);
             return;
         }
         const sectionDiv = document.createElement('div');
         sectionDiv.className = 'dest-route-section';
         sectionDiv.dataset.routeid = routeId; // Store route ID for saving
         const heading = document.createElement('h4');
         const routeLabel = document.createElement('span');
         routeLabel.textContent = `Route ${routeId} Destinations:`;
         heading.appendChild(routeLabel);
         const removeBtn = document.createElement('button');
         removeBtn.textContent = 'Remove Route';
         removeBtn.className = 'danger-button remove-route-btn';
         removeBtn.type = 'button'; // Prevent form submission if inside a form
         removeBtn.onclick = () => removeDestRouteSection(routeId);
         heading.appendChild(removeBtn);
         const textarea = document.createElement('textarea');
         textarea.id = `dest-textarea-${routeId}`; // Unique ID
         textarea.rows = 4;
         textarea.value = destinations.join('\n');
         textarea.setAttribute('aria-label', `Final destinations for route ${routeId}`);
         sectionDiv.appendChild(heading);
         sectionDiv.appendChild(textarea);
         // Remove the initial "No routes/Loading" message if present
          const initialMsg = destEditorRoutesContainer.querySelector('p');
          if (initialMsg) {
                 initialMsg.remove();
          }
         destEditorRoutesContainer.appendChild(sectionDiv);
    }
    function addDestRouteSection() {
         if (!addDestRouteIdInput || !destEditorRoutesContainer) return;
         const routeId = addDestRouteIdInput.value.trim();
         if (!routeId) {
             alert('Please enter a Route ID.');
             addDestRouteIdInput.focus();
             return;
         }
         // Check if section already exists
         if (destEditorRoutesContainer.querySelector(`[data-routeid="${routeId}"]`)) {
             alert(`Section for Route ${routeId} already exists.`);
             return;
         }
         // Add the new section with an empty destinations array
         createRouteSectionElement(routeId, []);
         addDestRouteIdInput.value = ''; // Clear input field
    }
    function removeDestRouteSection(routeId) {
          if (!destEditorRoutesContainer) return;
          if (!confirm(`Are you sure you want to remove the destination section for Route ${routeId}? You still need to click 'Save All' to persist this change.`)) {
              return;
          }
          const section = destEditorRoutesContainer.querySelector(`[data-routeid="${routeId}"]`);
          if (section) {
              section.remove();
              // If no sections left, show the placeholder message
              if (!destEditorRoutesContainer.querySelector('.dest-route-section')) {
                   destEditorRoutesContainer.innerHTML = '<p>No routes configured yet. Add one above.</p>';
              }
          }
    }
    function saveAllFinalDestinations() {
         if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; }
         if (!destEditorRoutesContainer || !destEditorMessage) { console.error("Destination editor elements missing!"); return; }
         try {
             const routeSections = destEditorRoutesContainer.querySelectorAll('.dest-route-section');
             const newSettings = {};
             routeSections.forEach(section => {
                 const routeId = section.dataset.routeid;
                 const textarea = section.querySelector('textarea');
                 if (routeId && textarea) {
                     const destinations = textarea.value
                          .split('\n')
                          .map(line => line.trim())
                          .filter(line => line.length > 0);
                     newSettings[routeId] = destinations;
                 }
             });
             saveToStorage(routeDestinationSettingsKey, newSettings);
             destEditorMessage.textContent = "Final destinations saved successfully!";
             destEditorMessage.style.color = "green";
             console.log("Final destinations saved:", newSettings);
             setTimeout(() => { if(destEditorMessage) destEditorMessage.textContent = ""; }, 3000);
         } catch (e) {
             console.error("Error saving final destinations:", e);
             destEditorMessage.textContent = "Error saving destinations.";
             destEditorMessage.style.color = "red";
         }
    }
    // --- End Final Destination Editor Functions ---


    // --- Change Own Password ---
    function changeMyPassword() { if (!isLoggedIn || !currentUsername) { alert("Not logged in."); return; } if (!currentPasswordInput || !newPasswordInput || !confirmNewPasswordInput || !changePasswordMessage) { console.error("Change password elements missing"); return; } const currentPass = currentPasswordInput.value; const newPass = newPasswordInput.value; const confirmPass = confirmNewPasswordInput.value; changePasswordMessage.textContent = ''; if (!currentPass || !newPass || !confirmPass) { changePasswordMessage.textContent = "Please fill in all fields."; changePasswordMessage.style.color = "red"; return; } if (newPass.length < 6) { changePasswordMessage.textContent = "New password must be at least 6 characters long."; changePasswordMessage.style.color = "red"; newPasswordInput.focus(); return; } if (newPass !== confirmPass) { changePasswordMessage.textContent = "New passwords do not match."; changePasswordMessage.style.color = "red"; confirmNewPasswordInput.focus(); return; } if (users[currentUsername].pass !== currentPass) { changePasswordMessage.textContent = "Incorrect current password."; changePasswordMessage.style.color = "red"; currentPasswordInput.focus(); return; } if (newPass === currentPass) { changePasswordMessage.textContent = "New password cannot be the same as the old password."; changePasswordMessage.style.color = "red"; newPasswordInput.focus(); return; } users[currentUsername].pass = newPass; saveUsersToStorage(); changePasswordMessage.textContent = "Password changed successfully!"; changePasswordMessage.style.color = "green"; currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmNewPasswordInput.value = ''; setTimeout(() => { if (changePasswordMessage) changePasswordMessage.textContent = ''; }, 4000); }

    // --- User Management Functions (Admin Only) ---
    function displayUserManagement() { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') return; if (!userManagementTbody) { console.error("User management table body not found."); return; } userManagementTbody.innerHTML = ''; userManagementMessage.textContent = ''; console.log('Attempting to display users. Current users object:', JSON.stringify(users)); Object.keys(users).forEach(username => { const user = users[username]; const row = userManagementTbody.insertRow(); row.insertCell().textContent = username; const roleCell = row.insertCell(); if (username === 'admin') { roleCell.textContent = user.role; } else { const roleSelect = document.createElement('select'); roleSelect.id = `role-select-${username}`; roleSelect.innerHTML = `<option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option><option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>`; roleSelect.onchange = () => changeUserRole(username, roleSelect.value); roleCell.appendChild(roleSelect); } const passwordCell = row.insertCell(); if (username !== 'admin') { const passInput = document.createElement('input'); passInput.type = 'password'; passInput.id = `new-pass-${username}`; passInput.placeholder = "Enter new password"; passwordCell.appendChild(passInput); } else { passwordCell.textContent = 'N/A (Use above)'; } const actionsCell = row.insertCell(); if (username !== 'admin') { const changePassBtn = document.createElement('button'); changePassBtn.textContent = 'Set Pass'; changePassBtn.className = 'blue-button'; changePassBtn.onclick = () => changeOtherUserPassword(username); actionsCell.appendChild(changePassBtn); const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Delete'; deleteBtn.className = 'danger-button delete-user-btn'; deleteBtn.onclick = () => deleteUser(username); actionsCell.appendChild(deleteBtn); } }); console.log('Finished populating user management table.'); }
    function addUser() { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (!addUsernameInput || !addUserPasswordInput || !addUserRoleSelect || !addUserMessage) { return; } const newUsername = addUsernameInput.value.trim(); const newPassword = addUserPasswordInput.value; const newRole = addUserRoleSelect.value; addUserMessage.textContent = ''; if (!newUsername || !newPassword) { addUserMessage.textContent = "Username and password required."; addUserMessage.style.color = "red"; return; } if (newPassword.length < 6) { addUserMessage.textContent = "Password must be >= 6 chars."; addUserMessage.style.color = "red"; return; } if (users.hasOwnProperty(newUsername)) { addUserMessage.textContent = "Username exists."; addUserMessage.style.color = "red"; addUsernameInput.focus(); return; } if (!['user', 'admin', 'moderator'].includes(newRole)) { addUserMessage.textContent = "Invalid role."; addUserMessage.style.color = "red"; return; } users[newUsername] = { pass: newPassword, role: newRole }; saveUsersToStorage(); addUserMessage.textContent = `User "${newUsername}" added.`; addUserMessage.style.color = "green"; addUsernameInput.value = ''; addUserPasswordInput.value = ''; addUserRoleSelect.value = 'user'; displayUserManagement(); setTimeout(() => { if(addUserMessage) addUserMessage.textContent = ''; }, 4000); }
    function changeUserRole(usernameToChange, newRole) { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (usernameToChange === 'admin') { alert("Cannot change admin role."); displayUserManagement(); return; } if (!users.hasOwnProperty(usernameToChange)) { alert(`User "${usernameToChange}" not found.`); return; } if (!['user', 'admin', 'moderator'].includes(newRole)) { alert("Invalid role."); return; } if (confirm(`Change role for "${usernameToChange}" to "${newRole}"?`)) { users[usernameToChange].role = newRole; saveUsersToStorage(); userManagementMessage.textContent = `Role for "${usernameToChange}" updated.`; userManagementMessage.style.color = "green"; displayUserManagement(); setTimeout(() => { if(userManagementMessage) userManagementMessage.textContent = ''; }, 4000); } else { displayUserManagement(); } }
    function changeOtherUserPassword(usernameToChange) { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (usernameToChange === 'admin') { return; } if (!users.hasOwnProperty(usernameToChange)) { alert(`User "${usernameToChange}" not found.`); return; } const passwordInput = document.getElementById(`new-pass-${usernameToChange}`); if (!passwordInput) { return; } const newPassword = passwordInput.value; userManagementMessage.textContent = ''; if (!newPassword) { userManagementMessage.textContent = `Enter password for ${usernameToChange}.`; userManagementMessage.style.color = "red"; passwordInput.focus(); return; } if (newPassword.length < 6) { userManagementMessage.textContent = "Password >= 6 chars."; userManagementMessage.style.color = "red"; passwordInput.focus(); return; } if (confirm(`Set new password for "${usernameToChange}"?`)) { users[usernameToChange].pass = newPassword; saveUsersToStorage(); userManagementMessage.textContent = `Password for "${usernameToChange}" updated.`; userManagementMessage.style.color = "green"; passwordInput.value = ''; setTimeout(() => { if(userManagementMessage) userManagementMessage.textContent = ''; }, 4000); } }
    function deleteUser(usernameToDelete) { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (usernameToDelete === 'admin') { alert("Cannot delete admin."); return; } if (!users.hasOwnProperty(usernameToDelete)) { alert(`User "${usernameToDelete}" not found.`); return; } if (confirm(`DELETE user "${usernameToDelete}"? Cannot undo.`)) { delete users[usernameToDelete]; saveUsersToStorage(); userManagementMessage.textContent = `User "${usernameToDelete}" deleted.`; userManagementMessage.style.color = "green"; displayUserManagement(); setTimeout(() => { if(userManagementMessage) userManagementMessage.textContent = ''; }, 4000); } }

    // --- Function to Reset TMP Map ---
    function resetTMPMap() { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (confirm('DANGER: Reset ALL TMP assignments? Cannot undo.')) { if (!passwordModal || !passwordModalInput || !passwordModalError) { console.error("Password modal elements missing"); alert("Error: Cannot show password dialog."); return; } isPasswordModalIntentionallyVisible = true; passwordModalInput.value = ''; passwordModalError.textContent = ''; passwordModal.classList.remove('hidden'); passwordModalInput.focus(); } else { alert("TMP Reset cancelled."); } }
    function handlePasswordConfirm() { if (!isLoggedIn || !currentUsername || !users[currentUsername]) { if(passwordModalError) passwordModalError.textContent = 'Error: Cannot verify current user.'; return; } if (!passwordModalInput || !passwordModalError || !passwordModal) { console.error("Password modal elements missing"); return; } const enteredPassword = passwordModalInput.value; const correctPassword = users[currentUsername].pass; if (enteredPassword === correctPassword) { try { localStorage.removeItem(tmpMapKey); localStorage.removeItem(tmpGenerationInfoKey); /* Also remove generation info */ if (localStorage.getItem(tmpMapKey) === null) { alert('TMP assignment map cleared.'); console.log("SUCCESS: TMP Map cleared by user:", currentUsername); } else { alert('ERROR: Failed to verify map clearance!'); console.error("ERROR: localStorage.removeItem failed for", tmpMapKey); } displayManualAssignments(); passwordModal.classList.add('hidden'); isPasswordModalIntentionallyVisible = false; } catch (e) { console.error("Error removing TMP map:", e); if(passwordModalError) passwordModalError.textContent = "Error clearing data."; } } else { passwordModalError.textContent = 'Incorrect password.'; passwordModalInput.focus(); passwordModalInput.select(); } }
    function cancelPasswordReset() { if(passwordModal) passwordModal.classList.add('hidden'); isPasswordModalIntentionallyVisible = false; }

    // --- All Curtailments Modal Functions ---
    function showAllCurtailmentsModal() { if (!isLoggedIn) { alert('You must be logged in.'); return; } if (!allCurtailmentsModal || !allCurtailmentsList) { console.error("All Curtailments Modal elements missing"); return; } allCurtailmentsList.innerHTML = '<p>Loading...</p>'; allCurtailmentsModal.classList.remove('hidden'); setTimeout(() => { try { let allCurtailmentsHTML = ''; let foundAny = false; let curtailmentEntries = []; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key && key.startsWith("curtailedBusesArray_")) { const routeCurtailments = loadFromStorage(key, []); if (Array.isArray(routeCurtailments) && routeCurtailments.length > 0) { routeCurtailments.forEach(item => { let timestamp = item.timestamp; if (!timestamp && item.curtailmentTime) { try { const parts = item.curtailmentTime.match(/(\d{2})\/(\d{2})\/(\d{4}),? (\d{2}):(\d{2})/); if(parts) { timestamp = new Date(Date.UTC(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], 0)).getTime(); } else { timestamp = Date.parse(item.curtailmentTime) || 0; } } catch { timestamp = 0; } } else if (!timestamp) { timestamp = 0; } if(timestamp > 0) { curtailmentEntries.push({ ...item, timestamp: timestamp, originalKey: key }); foundAny = true; } }); } } } curtailmentEntries.sort((a, b) => b.timestamp - a.timestamp); if (!foundAny) { allCurtailmentsHTML = '<p>No curtailments found.</p>'; } else { const currentUserRole = users[currentUsername]?.role; curtailmentEntries.forEach(item => { const displayTime = new Date(item.timestamp).toLocaleString('en-GB', { timeZone: 'Europe/London', dateStyle: 'short', timeStyle: 'short' }); let deleteButtonHTML = ''; if (currentUserRole === 'admin') { deleteButtonHTML = `<button class="delete-curtailment-btn" onclick="deleteCurtailmentEntry('${item.originalKey}', ${item.timestamp})">Delete</button>`; } allCurtailmentsHTML += `<div> <span><strong>Route:</strong> ${item.route || 'N/A'}</span> <span><strong>Reg:</strong> ${item.regNumber || 'N/A'}</span> <span><strong>Destination:</strong> ${item.curtailedDestination || 'N/A'}</span> <span><strong>Logged:</strong> ${displayTime}</span> ${deleteButtonHTML} </div>`; }); } allCurtailmentsList.innerHTML = allCurtailmentsHTML; } catch (e) { console.error("Error loading curtailments modal:", e); allCurtailmentsList.innerHTML = '<p style="color: red;">Error loading data.</p>'; } }, 10); }
    function hideAllCurtailmentsModal() { if(allCurtailmentsModal) { allCurtailmentsModal.classList.add('hidden'); } }
    function deleteCurtailmentEntry(routeKey, timestampToDelete) { if (!isLoggedIn || users[currentUsername]?.role !== 'admin') { alert('Admin Access Denied.'); return; } if (!routeKey || !timestampToDelete) { console.error("Missing key/timestamp for deletion."); alert("Error: Cannot identify entry."); return; } let itemDetails = `Entry @ ${timestampToDelete}`; try { const allCurtailments = loadFromStorage(routeKey, []); const itemToDelete = allCurtailments.find(item => (item.timestamp || new Date(item.curtailmentTime).getTime()) === timestampToDelete); if (itemToDelete) { itemDetails = `Route: ${itemToDelete.route}, Reg: ${itemToDelete.regNumber}, Dest: ${itemToDelete.curtailedDestination}, Time: ${new Date(timestampToDelete).toLocaleString('en-GB')}`; } } catch (e) { console.warn("Could not get details", e); } if (confirm(`DELETE curtailment?\n\n${itemDetails}`)) { try { let routeCurtailments = loadFromStorage(routeKey, []); if (!Array.isArray(routeCurtailments)) { alert("Error loading data."); return; } let initialLength = routeCurtailments.length; const updatedCurtailments = routeCurtailments.filter(item => { const itemTimestamp = item.timestamp || new Date(item.curtailmentTime).getTime(); return itemTimestamp !== timestampToDelete; }); if (updatedCurtailments.length < initialLength) { saveToStorage(routeKey, updatedCurtailments); alert("Entry deleted."); showAllCurtailmentsModal(); } else { alert("Entry not found. Refreshing."); showAllCurtailmentsModal(); } } catch (e) { console.error("Error deleting entry:", e); alert("Error deleting entry."); } } }

    // --- Auto TMP Modal Functions ---
    function showAutoTmpModal() { if (!isLoggedIn || !['admin', 'moderator'].includes(users[currentUsername]?.role)) { alert('Access Denied.'); return; } if (!autoTmpModal || !autoTmpList) { console.error("Auto TMP Modal elements not found!"); return; } autoTmpList.innerHTML = '<p>Loading...</p>'; autoTmpModal.classList.remove('hidden'); try { const tmpMap = loadFromStorage(tmpMapKey, {}); const genInfo = loadFromStorage(tmpGenerationInfoKey, {}); let autoTmpEntries = []; for (const reg in tmpMap) { if (tmpMap.hasOwnProperty(reg)) { const tmpValue = tmpMap[reg]; if (typeof tmpValue === 'string' && (tmpValue.startsWith('TMP') || tmpValue.startsWith('ERR'))) { const info = genInfo[reg]; autoTmpEntries.push({ registration: reg, tmp: tmpValue, route: info?.route || 'N/A', timestamp: info?.timestamp || 0 }); } } } autoTmpEntries.sort((a, b) => a.registration.localeCompare(b.registration)); let listHTML = ''; if (autoTmpEntries.length === 0) { listHTML = '<p>No auto-generated TMP/ERR assignments found.</p>'; } else { autoTmpEntries.forEach(entry => { const timeString = entry.timestamp ? new Date(entry.timestamp).toLocaleString('en-GB', { timeZone: 'Europe/London', dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; listHTML += `<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 5px 15px;"> <span><strong>Reg:</strong> ${entry.registration}</span> <span><strong>Assigned:</strong> ${entry.tmp}</span> <span><strong>Route Seen:</strong> ${entry.route}</span> <span><strong>Time:</strong> ${timeString}</span> </div>`; }); } autoTmpList.innerHTML = listHTML; } catch (e) { console.error("Error loading auto TMP data:", e); autoTmpList.innerHTML = '<p style="color: red;">Error loading data.</p>'; } }
    function hideAutoTmpModal() { if (autoTmpModal) { autoTmpModal.classList.add('hidden'); } }


    // --- Event Listeners ---
    // ** MODIFIED File Input Listener with DEBUG LOGGING **
    if(importCurtailmentsInput) {
        importCurtailmentsInput.addEventListener('change', function() {
            console.log('File input "change" event triggered.'); // <-- DEBUG
            if (!isLoggedIn) {
                alert('Login required.');
                this.value = ''; // Reset input
                console.log('Change listener aborted: Not logged in.'); // <-- DEBUG
                return;
            }
            const currentUserRole = users[currentUsername]?.role; // Get role safely
            if(!['admin','moderator'].includes(currentUserRole)) {
                alert('Access Denied.');
                this.value=''; // Reset input
                console.log('Change listener aborted: Insufficient role (' + currentUserRole + ').'); // <-- DEBUG
                return;
            }

            if (this.files && this.files.length > 0) {
                const selectedFile = this.files[0]; // Get file reference
                console.log('File selected:', selectedFile.name, 'Type:', selectedFile.type, 'Size:', selectedFile.size); // <-- DEBUG
                console.log('Calling handleCurtailmentImport...'); // <-- DEBUG
                handleCurtailmentImport(selectedFile); // Pass the file object
            } else {
                console.log('No file selected or file list empty.'); // <-- DEBUG
                this.value = ''; // Reset input if no file selected (e.g., user cancels dialog)
            }
        });
    } else {
         console.error("Could not find importCurtailmentsInput element to attach listener."); // <-- DEBUG Check
    }

    if (passwordModalInput) {
        passwordModalInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handlePasswordConfirm();
            }
        });
    } else { console.error("Password modal input not found."); }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
         // Need to get refs *after* DOM is loaded if not already global
          const loginContainerRef = document.getElementById('login-container');
          const appContainerRef = document.getElementById('app-container');
          const passwordModalRef = document.getElementById('password-modal');
          const allCurtailmentsModalRef = document.getElementById('all-curtailments-modal');
          const autoTmpModalRef = document.getElementById('auto-tmp-modal');
          if (!loginContainerRef || !appContainerRef || !passwordModalRef || !allCurtailmentsModalRef || !autoTmpModalRef) { console.error("CRITICAL ERROR: Containers missing."); document.body.innerHTML = '<p style="color: red;">Page loading error.</p>'; return; }
          checkLogin();
    });

</script>
</body>
</html>