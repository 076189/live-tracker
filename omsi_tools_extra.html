<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMSI Tools - Extra Modules</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="manifest" href="/live-tracker/manifest-omsi.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OMSI Extra Tools">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="/live-tracker/assets/icons/apple-touch-icon-180x180.png">

    <style>
        /* Copied CSS from your omsi_tools.html - Ensure this is complete and correct */
        @font-face {
            font-family: 'NJFont Medium Web';
            src: url('fonts/NJFont-Medium.ttf') format('truetype');
            font-weight: normal;font-style: normal;font-display: swap;
        }
        body {
            font-family: 'NJFont Medium Web', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            margin:0;
        }
        .page-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        #top-menu-bar_extra {
            background-color: rgba(0,0,0,0.25); padding: 0.75rem; border-radius: 0.5rem;
            margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center; display: none;
        }
        .menu-button {
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin: 0.25rem;
        }
        .menu-button:hover { background-color: #2980b9; }
        .tool-content-section {
            display: none; background-color: rgba(0,0,0,0.15); padding: 1.5rem;
            border-radius: 0.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #auth-section {
             margin-bottom: 1.5rem; background-color: rgba(0,0,0,0.15); padding: 1.5rem;
             border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #current-profile-display-container {
            text-align: center; margin-bottom: 1.5rem; padding: 0.75rem;
            background-color: rgba(255,255,255,0.05); border-radius: 0.25rem; display: none;
        }
        #current-profile-display { font-size: 0.9rem; opacity: 0.9; font-style: italic;}
        h1 { font-size: 2rem; margin-bottom: 1.5rem; font-weight: normal; text-align: center; color: #ffffff; }
        h2 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: normal; border-bottom: 1px solid #7f8c8d; padding-bottom: 0.25rem;}
        h3.subsection-title { font-size: 1.25rem; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: normal; color: #e0e0e0; border-bottom: 1px solid rgba(127,140,141,0.5); padding-bottom: 0.2rem;}
        .subsection {
            background-color: rgba(0,0,0,0.1); padding: 1rem; border-radius: 0.375rem;
            margin-top: 1rem; margin-bottom: 1rem; border: 1px solid rgba(127,140,141,0.2);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;}
        .form-field-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #bdc3c7; }
        input[type="text"], input[type="email"], input[type="password"], input[type="time"],
        input[type="color"], input[type="number"], input[type="date"], select {
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e; color: #ecf0f1; font-size:0.9rem; box-sizing: border-box;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        select option { background-color: #34495e; color: #ecf0f1; }
        .button {
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin-right: 0.5rem; margin-top:0.5rem;
        }
        .button:hover { background-color: #2980b9; }
        .button.secondary { background-color: #e74c3c; }
        .button.secondary:hover { background-color: #c0392b; }
        .button.save { background-color: #27ae60; } 
        .button.save:hover { background-color: #229954; }
        .button.tertiary { background-color: #f39c12; }
        .button.tertiary:hover { background-color: #e67e22; }
        .button.neutral { background-color: #7f8c8d; }
        .button.neutral:hover { background-color: #95a5a6; color: #2c3e50; }
         .button.small-action { padding: 0.2rem 0.4rem; font-size: 0.8rem; margin: 0 0.15rem; line-height: 1; min-width: 20px; text-align:center;}


        .schedule-generator-input { /* Re-using class for consistent input styling */
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e; color: #ecf0f1; font-size: 0.9rem;
        }
        /* Styles for Stop Management Master List */
        #masterStopListUL_extra li {
            padding: 0.75rem 0.5rem; border-bottom: 1px solid #34495e;
            transition: background-color 0.15s ease-in-out;
        }
        #masterStopListUL_extra li:last-child { border-bottom: none; }
        #masterStopListUL_extra li .stop-name-master { font-weight: bold; color: #ecf0f1; font-size: 1.05em; }
        #masterStopListUL_extra li .stop-direction-master { font-style: italic; font-size: 0.85em; color: #95a5a6; margin-bottom: 0.3rem; }
        #masterStopListUL_extra li .stop-id-master { font-weight: normal; color: #bdc3c7; font-size: 0.95em; }
        #masterStopListUL_extra li .stop-details-grid {
            display: grid; grid-template-columns: auto 1fr; gap: 0.2rem 0.5rem;
            font-size: 0.85em; margin-top: 0.4rem;
        }
        #masterStopListUL_extra li .detail-label { font-weight: normal; color: #bdc3c7; opacity: 0.8; }
        #masterStopListUL_extra li .detail-value { color: #ecf0f1; }
        #masterStopListUL_extra li .detail-value.status-closed { color: #e74c3c; font-weight: bold; }
        #masterStopListUL_extra li .detail-value.status-open { color: #2ecc71; }
        #masterStopListUL_extra li .serving-routes-container { margin-top: 0.4rem; margin-bottom: 0.2rem; display: flex; flex-wrap: wrap; gap: 0.3em; padding: 0.25rem 0;}
        #masterStopListUL_extra li .stop-actions { margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px dashed rgba(127,140,141,0.3); display: flex; gap: 0.5rem; flex-wrap: wrap;}
        .route-tile-tools-list { /* Copied from original for master list route tiles */
            display: inline-block; padding: 0.2em 0.55em; margin-right: 0.3em; margin-bottom: 0.3em;
            border-radius: 0.25rem; font-size: 0.8em; font-weight: bold; color: white;
            text-align: center; line-height: 1.3; min-width: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25); vertical-align: middle;
        }
        #newStopIdAvailability_extra { font-size: 0.8em; min-height: 1.1em; margin-top: 0.25rem; }

    </style>
</head>
<body>
    <div class="page-container">
        <h1>OMSI Tools - Extra Modules</h1>

        <div id="auth-section" class="section"> 
            <h2>Admin Login</h2>
            <div id="login-form-container_extra"> 
                <form id="adminLoginForm_extra"> 
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div><label for="inputEmail_extra">Email</label><input type="email" id="inputEmail_extra" autocomplete="email"></div>
                        <div><label for="inputPassword_extra">Password</label><input type="password" id="inputPassword_extra" autocomplete="current-password"></div>
                    </div>
                    <button id="loginButton_extra" type="submit" class="button">Login</button>
                </form>
                <p id="auth-status_extra" style="margin-top: 0.5em; color: #f1c40f;"></p>
            </div>
            <div id="logout-container_extra" style="display:none;">
                <p>Logged in as: <span id="loggedInUserEmail_extra"></span></p>
                <button id="logoutButton_extra" class="button secondary">Logout</button>
            </div>
        </div>

        <div id="current-profile-display-container" style="display:none;">
            <p id="current-profile-display">Today's Auto Profile: (determining...)</p>
        </div>

        <div id="top-menu-bar_extra" style="display:none;"> 
            <div id="main-menu-buttons_extra"> 
                <button class="menu-button" data-section="day-profile-override-section_extra">Day Profile Override</button>
                <button class="menu-button" data-section="stop-manager-tool-section_extra">Stop Management & Creation</button> <button class="menu-button" data-section="global-route-deletion-section_extra">Global Route Deletion</button> </div>
        </div>

        <div id="tool-sections-wrapper_extra"> 
            <div id="day-profile-override-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Operational Day Profile Override</h2>
                <p style="font-size:0.9em; margin-bottom:1.5em; opacity: 0.8;">
                    Use this tool to manually set a specific operating profile for an upcoming date, overriding the automatic calculation. Changes are saved immediately when you click "Set Override" or "Clear Override".
                </p>
                <div class="subsection">
                    <h3 class="subsection-title">Select Date and Override Profile</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 2fr 1fr; align-items: end; gap: 1rem;">
                        <div>
                            <label for="overrideDate_extra">Select Date:</label>
                            <input type="date" id="overrideDate_extra" class="schedule-generator-input">
                        </div>
                        <div>
                            <label for="overrideProfile_extra">Override Profile String:</label>
                            <input type="text" id="overrideProfile_extra" class="schedule-generator-input" placeholder="e.g., Su, MFSch, CustomHoliday">
                        </div>
                        <div>
                            <button id="setOverrideButton_extra" class="button save">Set Override</button>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <p style="font-size: 0.85em;">Normally for <span id="selectedDateDisplay_extra" style="font-weight:bold;">(select a date)</span>, the auto-profile would be: <strong id="autoProfileForSelectedDate_extra">(calculating...)</strong></p>
                        <p style="font-size: 0.85em;">Current override for selected date: <strong id="currentOverrideForSelectedDate_extra">(none)</strong></p>
                        <button id="clearOverrideButton_extra" class="button secondary" style="display:none; margin-top:0.5em;">Clear Override for This Date</button>
                    </div>
                    <p id="overrideStatusMessage_extra" style="min-height:1.2em; margin-top: 1rem; font-weight:bold;"></p>
                </div>
                <div class="subsection" style="margin-top: 2rem;">
                    <h3 class="subsection-title">Currently Active Overrides (Next 30 Days)</h3>
                    <div id="activeOverridesList_extra" style="max-height: 200px; overflow-y: auto; background-color: rgba(0,0,0,0.05); padding: 0.5rem; border-radius: 0.25rem;">
                        <p>Loading active overrides...</p>
                    </div>
                </div>
            </div>

            <div id="stop-manager-tool-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Stop Management & Creation</h2>
                
                <div class="subsection"> <h3 class="subsection-title">Add New Stop Details</h3>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">
                        Define a new stop. A placeholder schedule entry will be added to make it available in selectors. The Stop ID must be unique. Changes are saved directly to Firebase.
                    </p>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div> <label for="selectNewStopIdFormat_extra">Stop ID Format/Prefix</label>
                            <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                                <select id="selectNewStopIdFormat_extra" class="schedule-generator-input" style="flex-grow: 1;">
                                    <option value="NUM">Numeric (e.g., 101-99999)</option>
                                    <option value="BP">BP Prefix (e.g., BP1-BP99999)</option>
                                    <option value="LE">LE Prefix (e.g., LE1-LE99999)</option>
                                    <option value="RO">RO Prefix (e.g., RO1-RO99999)</option>
                                </select>
                                <button id="buttonSuggestStopId_extra" class="button neutral" style="padding: 0.5rem 0.8rem; margin-bottom: 0px; height: calc(0.5rem * 2 + 0.9rem + 2px); line-height: 0.9rem;">Suggest ID</button>
                            </div>
                        </div>
                        <div> <label for="inputNewStopId_extra">New Stop ID (type or use suggest)</label>
                            <input type="text" id="inputNewStopId_extra" class="schedule-generator-input" placeholder="e.g., NEWSTOP123" autocomplete="off">
                            <p id="newStopIdAvailability_extra" style="font-size: 0.8em; min-height: 1.1em; margin-top: 0.25rem;"></p>
                        </div>
                        <div>
                            <label for="inputNewStopName_extra">New Stop Name</label>
                            <input type="text" id="inputNewStopName_extra" class="schedule-generator-input" placeholder="e.g., Main Street Library" autocomplete="off">
                        </div>
                        <div>
                            <label for="inputNewStopDirection_extra">New Stop Direction (Towards)</label>
                            <input type="text" id="inputNewStopDirection_extra" class="schedule-generator-input" placeholder="e.g., Town Centre" autocomplete="off">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button id="buttonAddNewStop_extra" class="button save">Add New Stop Details (Live)</button>
                    </div>
                    <p id="addNewStopStatus_extra" style="min-height:1.2em; margin-top: 0.75rem;"></p>
                </div>

                <div class="subsection"> <h3 class="subsection-title">Master List of Unique Stops</h3>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:0.75rem;">
                        This list is generated from the unique Stop IDs in the current working schedule. Actions here modify live data or settings directly.
                    </p>
                    <div class="form-grid" style="grid-template-columns: 1fr auto; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <input type="text" id="masterStopListFilterInput_extra" class="schedule-generator-input" placeholder="Filter by Stop ID, Name, Route, Status...">
                        <button id="refreshMasterStopListButton_extra" class="button neutral">Refresh List</button>
                    </div>
                    <div id="masterStopListContainer_extra" class="subsection" style="max-height: 600px; overflow-y: auto; padding: 0.5rem; background-color: rgba(0,0,0,0.05); margin-top:0;">
                        <ul id="masterStopListUL_extra" style="list-style: none; padding: 0;">
                        </ul>
                    </div>
                    <p id="masterStopListStatus_extra" style="text-align: center; margin-top: 0.5rem; min-height: 1.2em;">Click "Refresh List" to load stops.</p>
                </div>

                <div class="subsection"> <h3 class="subsection-title">Find and Replace Stop IDs in Schedule (Live)</h3>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:0.75rem;">
                        Modifies the live schedule. Changes all occurrences of an old Stop ID to a new Stop ID.
                    </p>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 0.75rem;">
                        <div><label for="findStopIdScheduleInput_extra">Stop ID to Find</label><input type="text" id="findStopIdScheduleInput_extra" class="schedule-generator-input" placeholder="e.g., OLDSTOPID"></div>
                        <div><label for="replaceStopIdScheduleInput_extra">Replace with New Stop ID</label><input type="text" id="replaceStopIdScheduleInput_extra" class="schedule-generator-input" placeholder="e.g., NEWSTOPID"></div>
                        <div style="padding-bottom:0.05rem;"><button id="findReplaceStopIdScheduleButton_extra" class="button tertiary">Execute Find & Replace (Live)</button></div>
                    </div>
                    <p id="findReplaceStatusMessage_extra" style="min-height: 1.2em; margin-top: 0.5rem;">-</p>
                </div>

                <div class="subsection"> <h3 class="subsection-title">Remove Stop & All Its Schedule Entries (Live)</h3>
                    <div class="form-field-group">
                        <label for="selectStopToRemove_extra">Select Stop to Remove:</label>
                        <select id="selectStopToRemove_extra" class="schedule-generator-input"> <option value="">-- Select Stop --</option>
                        </select>
                    </div>
                    <button id="buttonRemoveStop_extra" class="button secondary">Remove Selected Stop & Its Entries (Live)</button>
                    <p id="removeStopStatus_extra" style="min-height:1.2em; margin-top: 0.75rem;"></p>
                </div>
            </div>

            <div id="global-route-deletion-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Global Route Deletion (Live)</h2>
                <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">
                    Select a route to remove ALL of its schedule entries from ALL stops in the live schedule.
                    This will also remove its global custom colour and any stop-specific colour overrides.
                    <strong>This action is highly destructive and directly modifies live data.</strong>
                </p>
                <div class="form-field-group">
                    <label for="selectGlobalRouteToDelete_extra">Select Route to Delete Globally:</label>
                    <select id="selectGlobalRouteToDelete_extra" class="schedule-generator-input">
                        <option value="">-- Select Route --</option>
                    </select>
                </div>
                <button id="deleteEntireRouteButton_extra" class="button secondary" style="margin-top: 0.5rem;">Delete Entire Selected Route (Live)</button>
                <p id="deleteEntireRouteStatusMessage_extra" style="min-height:1.2em; margin-top:0.75rem;"></p>
            </div>

            </div>
    </div>

    <script type="module">
      // Firebase Initialization (Identical to your original omsi_tools.html)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getDatabase, ref, set, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDePDF-kZahjzh9ij6tkuApIhoGePwVQ2s", // Replace with your actual Firebase API Key
        authDomain: "omsi-c5505.firebaseapp.com", // Replace with your actual Firebase Auth Domain
        databaseURL: "https://omsi-c5505-default-rtdb.europe-west1.firebasedatabase.app", // Replace with your actual Firebase Database URL
        projectId: "omsi-c5505", // Replace with your actual Firebase Project ID
        storageBucket: "omsi-c5505.appspot.com", // Replace with your actual Firebase Storage Bucket
        messagingSenderId: "503595375440", // Replace with your actual Firebase Messaging Sender ID
        appId: "1:503595375440:web:356be6684b77ff5909ea55", // Replace with your actual Firebase App ID
        measurementId: "G-VN7X65V3F9" // Replace with your actual Firebase Measurement ID
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      window.firebaseOMSI_Extra = { 
          database: database, auth: auth,
          dbRef: ref, dbSet: set, dbOnValue: onValue, dbGet: get,
          dbChild: child, dbUpdate: update, dbRemove: remove,
          authOnAuthStateChanged: onAuthStateChanged,
          authSignInWithEmailAndPassword: signInWithEmailAndPassword,
          authSignOut: signOut
      };
      console.log("Firebase Initialized for OMSI Tools - Extra Modules Page.");
      document.dispatchEvent(new CustomEvent('firebaseReady_Extra', { detail: window.firebaseOMSI_Extra }));
    </script>

    <script>
        // --- Global State Variables for this 'omsi_tools_extra.html' page ---
        let currentUser_extra = null;
        let pageSpecificSettings = {}; // For any general settings unique to this page's tools
        let ukBankHolidaysData_extra = { dates: [], titles: {} }; 
        const schoolHolidayDateRanges_extra = []; 
        
        // These will be loaded from Firebase and represent the "live" data this page operates on
        let currentWorkingSchedule_extra = []; 
        let closedStopIDs_extra = [];         
        let globalCustomRouteColours_extra = {}; 
        let stopSpecificRouteColours_extra = {}; 
        let uniqueStopsMasterList_extra = []; // For the master stop list on this page

        // --- Firebase Path Constants (MUST BE IDENTICAL to omsi_tools.html for shared data) ---
        const FB_PATH_PAGE_EXTRA_SETTINGS = '/settings/extraModulesPageSettings'; 
        const FB_PATH_OPERATIONAL_OVERRIDES = '/operationalOverrides';
        const FB_PATH_LIVE_SCHEDULE_DATA = '/liveSchedule/allScheduledBusData';
        const FB_PATH_LIVE_UNIQUE_STOPS = '/liveSchedule/uniqueBusStops';
        // const FB_PATH_PENDING_SCHEDULE_DATA = '/pendingSchedule/allScheduledBusData'; // Not used if direct saving
        const FB_PATH_APPSTATE_STATUS = '/appState/scheduleStatus';
        const FB_PATH_APPSTATE_LAST_UPDATED = '/appState/scheduleLastUpdated';
        const FB_PATH_APPSTATE_CLOSED_STOPS = '/appState/closedStopIDs';
        const FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS = '/settings/customRouteColours';
        const FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS = '/settings/stopSpecificRouteColours';

        // --- DOM Elements ---
        // Auth
        const authSection_el_extra = document.getElementById('auth-section');
        const loginFormContainer_el_extra = document.getElementById('login-form-container_extra');
        const adminLoginForm_el_extra = document.getElementById('adminLoginForm_extra');
        const inputEmail_el_extra = document.getElementById('inputEmail_extra');
        const inputPassword_el_extra = document.getElementById('inputPassword_extra');
        const authStatus_el_extra = document.getElementById('auth-status_extra');
        const logoutContainer_el_extra = document.getElementById('logout-container_extra');
        const loggedInUserEmailDisplay_el_extra = document.getElementById('loggedInUserEmail_extra');
        // Layout
        const topMenuBar_el_extra = document.getElementById('top-menu-bar_extra');
        const toolSectionsWrapper_el_extra = document.getElementById('tool-sections-wrapper_extra');
        const currentProfileDisplayContainer_el = document.getElementById('current-profile-display-container');
        const currentProfileDisplayElement_el = document.getElementById('current-profile-display');
        // Day Profile Override Tool
        const overrideDateInput_el_extra = document.getElementById('overrideDate_extra');
        const overrideProfileInput_el_extra = document.getElementById('overrideProfile_extra');
        const setOverrideButton_el_extra = document.getElementById('setOverrideButton_extra');
        const clearOverrideButton_el_extra = document.getElementById('clearOverrideButton_extra');
        const overrideStatusMessage_el_extra = document.getElementById('overrideStatusMessage_extra');
        const selectedDateDisplay_el_extra = document.getElementById('selectedDateDisplay_extra');
        const autoProfileForSelectedDate_el_extra = document.getElementById('autoProfileForSelectedDate_extra');
        const currentOverrideForSelectedDate_el_extra = document.getElementById('currentOverrideForSelectedDate_extra');
        const activeOverridesList_el_extra = document.getElementById('activeOverridesList_extra');
        // Merged Stop Management & Creation Tool DOM Elements
        const selectNewStopIdFormat_el_extra = document.getElementById('selectNewStopIdFormat_extra');
        const buttonSuggestStopId_el_extra = document.getElementById('buttonSuggestStopId_extra');
        const inputNewStopId_el_extra = document.getElementById('inputNewStopId_extra');
        const newStopIdAvailability_el_extra = document.getElementById('newStopIdAvailability_extra');
        const inputNewStopName_el_extra = document.getElementById('inputNewStopName_extra');
        const inputNewStopDirection_el_extra = document.getElementById('inputNewStopDirection_extra');
        const buttonAddNewStop_el_extra = document.getElementById('buttonAddNewStop_extra');
        const addNewStopStatus_el_extra = document.getElementById('addNewStopStatus_extra');
        const masterStopListFilterInput_el_extra = document.getElementById('masterStopListFilterInput_extra');
        const refreshMasterStopListButton_el_extra = document.getElementById('refreshMasterStopListButton_extra');
        const masterStopListUL_el_extra = document.getElementById('masterStopListUL_extra');
        const masterStopListStatus_el_extra = document.getElementById('masterStopListStatus_extra');
        const findStopIdScheduleInput_el_extra = document.getElementById('findStopIdScheduleInput_extra');
        const replaceStopIdScheduleInput_el_extra = document.getElementById('replaceStopIdScheduleInput_extra');
        const findReplaceStopIdScheduleButton_el_extra = document.getElementById('findReplaceStopIdScheduleButton_extra');
        const findReplaceStatusMessage_el_extra = document.getElementById('findReplaceStatusMessage_extra');
        const selectStopToRemove_el_extra = document.getElementById('selectStopToRemove_extra');
        const buttonRemoveStop_el_extra = document.getElementById('buttonRemoveStop_extra');
        const removeStopStatus_el_extra = document.getElementById('removeStopStatus_extra');
        // Global Route Deletion DOM Elements
        const selectGlobalRouteToDelete_el_extra = document.getElementById('selectGlobalRouteToDelete_extra');
        const deleteEntireRouteButton_el_extra = document.getElementById('deleteEntireRouteButton_extra');
        const deleteEntireRouteStatusMessage_el_extra = document.getElementById('deleteEntireRouteStatusMessage_extra');


        // --- Profile Display Functions (Adapted for this page) ---
        // (fetchBankHolidays_ExtraPage, isSchoolHolidayPeriod_ExtraPage, getOperatingCodesForDate_ExtraPage, updateCurrentProfileDisplay_ExtraPage)
        // ... These are the same as provided in the previous response ...
        async function fetchBankHolidays_ExtraPage() {
            if (!window.firebaseOMSI_Extra) {
                if (currentProfileDisplayElement_el) currentProfileDisplayElement_el.textContent = "Today's Auto Profile: (Firebase N/A)";
                updateCurrentProfileDisplay_ExtraPage(); 
                return;
            }
            try {
                const response = await fetch('https://www.gov.uk/bank-holidays.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data['england-and-wales'] && data['england-and-wales'].events) {
                    const events = data['england-and-wales'].events;
                    ukBankHolidaysData_extra = {
                        dates: events.map(event => event.date),
                        titles: events.reduce((acc, event) => { acc[event.date] = event.title; return acc; }, {})
                    };
                } else {
                    console.warn("Extra Page: Bank holiday data format issue.");
                    ukBankHolidaysData_extra = { dates: [], titles: {} };
                }
            } catch (error) {
                console.error("Extra Page: Failed to fetch UK bank holidays:", error);
                ukBankHolidaysData_extra = { dates: [], titles: {} };
                if (currentProfileDisplayElement_el) currentProfileDisplayElement_el.textContent = "Today's Auto Profile: (Bank Hol. check failed)";
            } finally {
                updateCurrentProfileDisplay_ExtraPage(); 
                if (overrideDateInput_el_extra && overrideDateInput_el_extra.value && document.getElementById('day-profile-override-section_extra')?.style.display === 'block') {
                    displayAutoCalculatedProfileForDate_ExtraPage(overrideDateInput_el_extra.value);
                }
            }
        }
        function isSchoolHolidayPeriod_ExtraPage(dateObject) {
            if (!schoolHolidayDateRanges_extra || schoolHolidayDateRanges_extra.length === 0) return false;
            const checkTime = dateObject.getTime();
            for (const range of schoolHolidayDateRanges_extra) {
                try {
                    const startTime = new Date(range.start + "T00:00:00").getTime();
                    const endTime = new Date(range.end + "T23:59:59").getTime();
                    if (checkTime >= startTime && checkTime <= endTime) return true;
                } catch (e) { console.error("Invalid date in schoolHolidayDateRanges_extra:", range, e); }
            }
            return false;
        }
        function getOperatingCodesForDate_ExtraPage(dateObject) {
            const n = dateObject; 
            const dOW = n.getDay();
            const targetDateString = `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
            let dateCodes = new Set(); let isBankHolidayToday = false;
            if (ukBankHolidaysData_extra.dates && ukBankHolidaysData_extra.dates.includes(targetDateString)) {
                const holidayTitle = ukBankHolidaysData_extra.titles[targetDateString] || "";
                isBankHolidayToday = true;
                if (holidayTitle.toLowerCase().includes("good friday")) dateCodes.add("Sa");
                else dateCodes.add("Su");
            }
            if (!isBankHolidayToday) {
                const isSchHol = isSchoolHolidayPeriod_ExtraPage(n);
                const schoolSuffix = isSchHol ? "NSD" : "Sch";
                let dayCode = "";
                switch (dOW) {
                    case 0: dayCode = "Su"; break; case 1: dayCode = "Mo"; break;
                    case 2: dayCode = "Tu"; break; case 3: dayCode = "We"; break;
                    case 4: dayCode = "Th"; break; case 5: dayCode = "Fr"; break;
                    case 6: dayCode = "Sa"; break;
                }
                if (dayCode) dateCodes.add(dayCode);
                if (dOW >= 1 && dOW <= 5) {
                    if (dayCode) dateCodes.add(dayCode + schoolSuffix); 
                    dateCodes.add("MF" + schoolSuffix);
                    dateCodes.add("Mo-Fr"); dateCodes.add("MF");
                }
                if ((dOW === 6 || dOW === 0) && isSchHol) { if(dayCode) dateCodes.add(dayCode + "NSD");}
                if (isSchHol) dateCodes.add("SchoolHoliday");
            } else {
                const isSchHolOnBH = isSchoolHolidayPeriod_ExtraPage(n);
                if (isSchHolOnBH) {
                    dateCodes.add("SchoolHoliday");
                    if (dateCodes.has("Sa")) dateCodes.add("SaNSD");
                    if (dateCodes.has("Su") && !dateCodes.has("Sa")) dateCodes.add("SuNSD");
                }
            }
            return Array.from(dateCodes);
        }
        function updateCurrentProfileDisplay_ExtraPage() { 
            const operatingCodes = getOperatingCodesForDate_ExtraPage(new Date());
            const now = new Date(); const dayOfWeek = now.getDay();
            const todayDateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            let profileDisplayText = ""; let isBankHol = false; let serviceTypeDisplay = "";
            if (ukBankHolidaysData_extra.dates && ukBankHolidaysData_extra.dates.includes(todayDateString)) {
                const holidayTitle = ukBankHolidaysData_extra.titles[todayDateString] || "Bank Holiday";
                isBankHol = true;
                if (holidayTitle.toLowerCase().includes("good friday")) { profileDisplayText = "Good Friday"; serviceTypeDisplay = "(Sat Service)"; }
                else { profileDisplayText = holidayTitle; serviceTypeDisplay = "(Sun Service)"; }
            }
            let dayName = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dayOfWeek];
            if (!isBankHol) {
                profileDisplayText = dayName;
                if (isSchoolHolidayPeriod_ExtraPage(now)) profileDisplayText += " (School Hol)";
            } else {
                profileDisplayText += ` ${serviceTypeDisplay} - Observed on a ${dayName}`;
                if (isSchoolHolidayPeriod_ExtraPage(now)) profileDisplayText += " (School Hol Period)";
            }
            if (currentProfileDisplayElement_el) {
                currentProfileDisplayElement_el.textContent = `Today's Auto Profile: ${profileDisplayText} [Codes: ${operatingCodes.join(', ')}]`;
            }
        }
        
        // --- Core Functions for this 'omsi_tools_extra.html' page ---
        function updateAuthUI_ExtraPage(user) {
            currentUser_extra = user;
            const allToolSectionsOnThisPage = toolSectionsWrapper_el_extra.querySelectorAll('.tool-content-section');
            allToolSectionsOnThisPage.forEach(section => section.style.display = 'none');

            if (user) {
                if (authSection_el_extra) authSection_el_extra.style.display = 'none';
                if (topMenuBar_el_extra) topMenuBar_el_extra.style.display = 'block';
                if (logoutContainer_el_extra) logoutContainer_el_extra.style.display = 'block';
                if (loginFormContainer_el_extra) loginFormContainer_el_extra.style.display = 'none';
                if (authStatus_el_extra) authStatus_el_extra.textContent = '';
                if (loggedInUserEmailDisplay_el_extra) loggedInUserEmailDisplay_el_extra.textContent = user.email;
                
                if (currentProfileDisplayContainer_el) currentProfileDisplayContainer_el.style.display = 'block';
                fetchBankHolidays_ExtraPage(); 

                loadPageSpecificSettings_ExtraPage(); 
                loadInitialData_ExtraPage(); // Load core data like schedule, stops, colors
            } else {
                // ... (logout UI updates as before) ...
                if (authSection_el_extra) authSection_el_extra.style.display = 'block';
                if (topMenuBar_el_extra) topMenuBar_el_extra.style.display = 'none';
                if (logoutContainer_el_extra) logoutContainer_el_extra.style.display = 'none';
                if (loginFormContainer_el_extra) loginFormContainer_el_extra.style.display = 'block';
                if (authStatus_el_extra) authStatus_el_extra.textContent = 'Please log in to use these extra modules.';
                if (loggedInUserEmailDisplay_el_extra) loggedInUserEmailDisplay_el_extra.textContent = '';
                if (currentProfileDisplayContainer_el) currentProfileDisplayContainer_el.style.display = 'none';
                if (currentProfileDisplayElement_el) currentProfileDisplayElement_el.textContent = "Today's Auto Profile: (determining...)";
                pageSpecificSettings = {}; 
                currentWorkingSchedule_extra = [];
                closedStopIDs_extra = [];
                globalCustomRouteColours_extra = {};
                stopSpecificRouteColours_extra = {};
            }
        }

        async function loadInitialData_ExtraPage() {
            if (!currentUser_extra || !window.firebaseOMSI_Extra) return;
            console.log("Extra Modules Page: Loading initial shared data (schedule, stops, colors)...");
            const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI_Extra;
            try {
                // Fetch live schedule data
                const scheduleSnap = await dbGet(dbChild(dbRef(database), FB_PATH_LIVE_SCHEDULE_DATA));
                if (scheduleSnap.exists()) {
                    const scheduleData = scheduleSnap.val();
                    currentWorkingSchedule_extra = Array.isArray(scheduleData) ? scheduleData.filter(e => e != null) : (scheduleData ? Object.values(scheduleData).filter(e => e != null) : []);
                    currentWorkingSchedule_extra = currentWorkingSchedule_extra.map((e, i) => ({ ...e, internalId: e.internalId || `${(e.stopID||'s')}_${(e.lineName||'l')}_${(e.scheduledTime||"").replace(':','')}_${i}_fbload_extra` }));
                } else { currentWorkingSchedule_extra = []; }

                // Fetch closed stop IDs
                const closedSnap = await dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_CLOSED_STOPS));
                if (closedSnap.exists()) {
                    const fbClosed = closedSnap.val();
                    closedStopIDs_extra = [];
                    for(const id in fbClosed) { if(fbClosed[id]===true) closedStopIDs_extra.push(id.toUpperCase());}
                } else { closedStopIDs_extra = []; }

                // Fetch global custom route colours
                const globalColoursSnap = await dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS));
                globalCustomRouteColours_extra = globalColoursSnap.exists() ? globalColoursSnap.val() || {} : {};

                // Fetch stop-specific route colours
                const stopSpecificColoursSnap = await dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS));
                stopSpecificRouteColours_extra = stopSpecificColoursSnap.exists() ? stopSpecificColoursSnap.val() || {} : {};

                console.log(`Extra Modules Page: Shared data loaded. Schedule: ${currentWorkingSchedule_extra.length} entries. Closed: ${closedStopIDs_extra.length}.`);
                renderUIDependentElements_ExtraPage(); // Refresh UI elements that use this loaded data
            } catch (error) {
                console.error("Extra Modules Page: Error loading initial shared data:", error);
            }
        }
        
        function renderUIDependentElements_ExtraPage() {
            // This function will populate dropdowns and lists for the newly added tools
            console.log("Extra Page: Rendering UI dependent elements.");
            if(currentUser_extra) {
                populateStopSelectors_ExtraPage(); // For Add/Remove Stop (dropdown) and Master List
                populateGlobalRouteToDeleteSelector_ExtraPage();
                // Call populateMasterStopList_ExtraPage directly if a filter is not immediately applied
                // or let it be called when its section is shown / refresh button clicked.
            }
        }
        
        function populateStopSelectors_ExtraPage() {
            // Populates 'selectStopToRemove_extra' and is used by Master List logic
            const uniqueStops = getUniqueStopsFromSchedule_ExtraPage();
            if (selectStopToRemove_el_extra) {
                const currentVal = selectStopToRemove_el_extra.value;
                selectStopToRemove_el_extra.innerHTML = '<option value="">-- Select Stop --</option>';
                uniqueStops.forEach(stop => {
                    const opt = document.createElement('option');
                    opt.value = stop.stopID;
                    opt.textContent = `${stop.stopName} (${stop.stopID})`;
                    selectStopToRemove_el_extra.appendChild(opt);
                });
                if (uniqueStops.find(s => s.stopID === currentVal)) {
                    selectStopToRemove_el_extra.value = currentVal;
                }
            }
        }


        async function loadPageSpecificSettings_ExtraPage() { /* ... as previously defined ... */ }
        // Removed handleSavePageSpecificData_ExtraPage as there's no general save button

        // This function would be called by event listeners on individual inputs of new tools
        // that manage data within the 'pageSpecificSettings' object.
        async function autoSavePageSpecificSettings_ExtraPage() {
            if (!currentUser_extra || !window.firebaseOMSI_Extra) { /* ... */ return; }
            // TODO: Update pageSpecificSettings from UI elements of OTHER new tools
            console.log("Auto-saving pageSpecificSettings:", pageSpecificSettings);
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra;
            try {
                await dbSet(dbRef(database, FB_PATH_PAGE_EXTRA_SETTINGS), pageSpecificSettings);
                console.log("Extra Modules Page: Page-specific settings auto-saved.");
            } catch (error) {
                console.error("Extra Modules Page: Firebase Auto-Save Error for page-specific settings: ", error);
            }
        }
        
        function showExtraPageSection(sectionId) {
            const allToolSectionsOnThisPage = toolSectionsWrapper_el_extra.querySelectorAll('.tool-content-section');
            allToolSectionsOnThisPage.forEach(section => { section.style.display = 'none'; });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.style.display = 'block';
                if (sectionId === 'day-profile-override-section_extra') {
                    loadAndDisplayActiveOverrides_ExtraPage(); 
                    if (overrideDateInput_el_extra && !overrideDateInput_el_extra.value) { 
                        const today = new Date();
                        overrideDateInput_el_extra.value = getYYYYMMDD_ExtraPage(today);
                    }
                    if (overrideDateInput_el_extra && overrideDateInput_el_extra.value) {
                         handleOverrideDateChange_ExtraPage();
                    }
                } else if (sectionId === 'stop-manager-tool-section_extra') {
                    populateMasterStopList_ExtraPage();
                    populateStopSelectors_ExtraPage(); // For the "Remove Stop (Bulk)" dropdown
                     if(newStopIdAvailability_el_extra) newStopIdAvailability_el_extra.textContent = ''; // Clear availability message
                } else if (sectionId === 'global-route-deletion-section_extra') {
                    populateGlobalRouteToDeleteSelector_ExtraPage();
                }
            } else { console.warn("Section ID not found on extra page:", sectionId); }
        }

        // --- Functions for Day Profile Override Tool ---
        // (formatDateToDDMonthYYYY_ExtraPage, displayAutoCalculatedProfileForDate_ExtraPage, 
        //  handleOverrideDateChange_ExtraPage, loadAndDisplayActiveOverrides_ExtraPage,
        //  handleSetProfileOverride_ExtraPage, handleClearProfileOverride_ExtraPage)
        // ... These are the same as provided in the previous response ...
        function formatDateToDDMonthYYYY_ExtraPage(dateStringYYYYMMDD) {
            if (!dateStringYYYYMMDD || !dateStringYYYYMMDD.match(/^\d{4}-\d{2}-\d{2}$/)) { return "(select a date)"; }
            try {
                const parts = dateStringYYYYMMDD.split('-');
                const year = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const day = parseInt(parts[2], 10);
                const dateObj = new Date(Date.UTC(year, month, day));
                if (isNaN(dateObj.getTime())) return dateStringYYYYMMDD; 
                const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
                return dateObj.toLocaleDateString('en-GB', options);
            } catch (e) { return dateStringYYYYMMDD; }
        }
        let isFetchingProfileForDate = false; 
        async function displayAutoCalculatedProfileForDate_ExtraPage(dateString) {
            if (!dateString || isFetchingProfileForDate) {
                if(!dateString && autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = "(select a date)";
                return;
            }
            isFetchingProfileForDate = true;
            if(autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = "(calculating...)";
            if ((!ukBankHolidaysData_extra.dates || ukBankHolidaysData_extra.dates.length === 0) && !fetchBankHolidays_ExtraPage.isRunning) {
                fetchBankHolidays_ExtraPage.isRunning = true; 
                await fetchBankHolidays_ExtraPage();
                fetchBankHolidays_ExtraPage.isRunning = false;
            }
            const dateObj = new Date(dateString + "T00:00:00Z"); 
            if (isNaN(dateObj.getTime())) {
                if(autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = "(invalid date)";
                isFetchingProfileForDate = false; return;
            }
            const codes = getOperatingCodesForDate_ExtraPage(dateObj); 
            if(autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = codes.length > 0 ? codes.join(', ') : "None";
            isFetchingProfileForDate = false;
        }
        fetchBankHolidays_ExtraPage.isRunning = false;
        async function handleOverrideDateChange_ExtraPage() {
            if (!overrideDateInput_el_extra || !window.firebaseOMSI_Extra) return;
            const selectedDateStr = overrideDateInput_el_extra.value; 
            const formattedDateForDisplay = formatDateToDDMonthYYYY_ExtraPage(selectedDateStr);
            if (selectedDateDisplay_el_extra) { selectedDateDisplay_el_extra.textContent = formattedDateForDisplay; }
            if (autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = "(calculating...)";
            if (currentOverrideForSelectedDate_el_extra) currentOverrideForSelectedDate_el_extra.textContent = "(checking...)";
            if (clearOverrideButton_el_extra) clearOverrideButton_el_extra.style.display = 'none';
            if (overrideProfileInput_el_extra) overrideProfileInput_el_extra.value = ''; 
            if (!selectedDateStr) { 
                 if (autoProfileForSelectedDate_el_extra) autoProfileForSelectedDate_el_extra.textContent = "(select a date)";
                 if (currentOverrideForSelectedDate_el_extra) currentOverrideForSelectedDate_el_extra.textContent = "(select a date)";
                return;
            }
            await displayAutoCalculatedProfileForDate_ExtraPage(selectedDateStr);
            const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI_Extra;
            const overridePath = `${FB_PATH_OPERATIONAL_OVERRIDES}/${selectedDateStr}/profile`;
            try {
                const snapshot = await dbGet(dbChild(dbRef(database), overridePath));
                if (snapshot.exists()) {
                    const existingOverride = snapshot.val();
                    if(currentOverrideForSelectedDate_el_extra) currentOverrideForSelectedDate_el_extra.textContent = existingOverride;
                    if(overrideProfileInput_el_extra) overrideProfileInput_el_extra.value = existingOverride; 
                    if(clearOverrideButton_el_extra) clearOverrideButton_el_extra.style.display = 'inline-block';
                } else {
                    if(currentOverrideForSelectedDate_el_extra) currentOverrideForSelectedDate_el_extra.textContent = "(none)";
                    if(clearOverrideButton_el_extra) clearOverrideButton_el_extra.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching existing override:", error);
                if(currentOverrideForSelectedDate_el_extra) currentOverrideForSelectedDate_el_extra.textContent = "(error checking)";
                if (overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Error checking override."; overrideStatusMessage_el_extra.style.color = "#e74c3c"; }
            }
        }
        async function loadAndDisplayActiveOverrides_ExtraPage() {
            if (!activeOverridesList_el_extra || !window.firebaseOMSI_Extra) return;
            activeOverridesList_el_extra.innerHTML = '<p>Loading active overrides...</p>';
            const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI_Extra;
            try {
                const snapshot = await dbGet(dbChild(dbRef(database), FB_PATH_OPERATIONAL_OVERRIDES));
                if (snapshot.exists()) {
                    const allOverrides = snapshot.val(); let html = '';
                    const todayForCompare = new Date(); todayForCompare.setHours(0,0,0,0); 
                    const thirtyDaysFromNow = new Date(todayForCompare.getTime() + 30 * 24 * 60 * 60 * 1000);
                    const relevantOverrides = [];
                    for(const dateStr in allOverrides) {
                        if (allOverrides[dateStr] && allOverrides[dateStr].profile) {
                            const overrideDate = new Date(dateStr + "T00:00:00Z");
                             if (isNaN(overrideDate.getTime())) continue; 
                            if (overrideDate >= todayForCompare && overrideDate <= thirtyDaysFromNow) {
                                relevantOverrides.push({ date: dateStr, profile: allOverrides[dateStr].profile });
                            }
                        }
                    }
                    relevantOverrides.sort((a,b) => a.date.localeCompare(b.date)); 
                    if (relevantOverrides.length === 0) { html = '<p>No active profile overrides for today or next 30 days.</p>'; }
                    else {
                        html += '<ul style="list-style-type: none; padding-left:0;">';
                        relevantOverrides.forEach(item => {
                            const formattedDisplayDate = formatDateToDDMonthYYYY_ExtraPage(item.date);
                            html += `<li style="padding:0.2rem 0;border-bottom:1px solid rgba(255,255,255,0.1);"><strong style="min-width:150px;display:inline-block;">${formattedDisplayDate}:</strong> ${item.profile}</li>`;
                        });
                        html += '</ul>';
                    }
                    activeOverridesList_el_extra.innerHTML = html;
                } else { activeOverridesList_el_extra.innerHTML = '<p>No profile overrides currently set.</p>'; }
            } catch (error) { console.error("Error loading overrides:", error); activeOverridesList_el_extra.innerHTML = '<p>Error loading overrides.</p>';}
        }
        function handleSetProfileOverride_ExtraPage() {
            if (!currentUser_extra || !window.firebaseOMSI_Extra) { alert("Please log in."); return; }
            const dateStr = overrideDateInput_el_extra.value; const profileStr = overrideProfileInput_el_extra.value.trim();
            if (!dateStr) { if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Select date."; overrideStatusMessage_el_extra.style.color = "#f1c40f"; } return; }
            if (!profileStr) { if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Enter override profile."; overrideStatusMessage_el_extra.style.color = "#f1c40f"; } return; }
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra;
            const overridePath = `${FB_PATH_OPERATIONAL_OVERRIDES}/${dateStr}/profile`;
            if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Setting..."; overrideStatusMessage_el_extra.style.color = "#f1c40f"; }
            dbSet(dbRef(database, overridePath), profileStr)
                .then(() => {
                    if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = `Override set for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)} to "${profileStr}".`; overrideStatusMessage_el_extra.style.color = "#2ecc71"; }
                    handleOverrideDateChange_ExtraPage(); loadAndDisplayActiveOverrides_ExtraPage(); 
                }).catch(error => { if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Error setting."; overrideStatusMessage_el_extra.style.color = "#e74c3c"; }});
        }
        function handleClearProfileOverride_ExtraPage() {
            if (!currentUser_extra || !window.firebaseOMSI_Extra) { alert("Please log in."); return; }
            const dateStr = overrideDateInput_el_extra.value;
            if (!dateStr) { if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Select date."; overrideStatusMessage_el_extra.style.color = "#f1c40f"; } return; }
            if (!confirm(`Clear override for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)}?`)) return;
            const { database, dbRemove, dbRef } = window.firebaseOMSI_Extra;
            const profileOverridePath = `${FB_PATH_OPERATIONAL_OVERRIDES}/${dateStr}/profile`; 
            if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Clearing..."; overrideStatusMessage_el_extra.style.color = "#f1c40f"; }
            dbRemove(dbRef(database, profileOverridePath)) 
                .then(() => {
                    if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = `Override cleared for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)}.`; overrideStatusMessage_el_extra.style.color = "#2ecc71"; }
                    if(overrideProfileInput_el_extra) overrideProfileInput_el_extra.value = ''; 
                    handleOverrideDateChange_ExtraPage(); loadAndDisplayActiveOverrides_ExtraPage(); 
                }).catch(error => {if(overrideStatusMessage_el_extra) { overrideStatusMessage_el_extra.textContent = "Error clearing."; overrideStatusMessage_el_extra.style.color = "#e74c3c"; }});
        }

        // --- START: Merged Stop Management & Add/Remove Stop ---
        // Helper: Get unique stops (adapted for this page's variables)
        function getUniqueStopsFromSchedule_ExtraPage() {
            if (!currentWorkingSchedule_extra || currentWorkingSchedule_extra.length === 0) return [];
            const stopsMap = new Map();
            currentWorkingSchedule_extra.forEach(entry => {
                if (entry.stopID && !stopsMap.has(entry.stopID.toUpperCase())) {
                    stopsMap.set(entry.stopID.toUpperCase(), {
                        stopID: entry.stopID,
                        stopName: entry.stopName || "Unknown Name",
                        direction: entry.direction || "No Direction"
                    });
                }
            });
            return Array.from(stopsMap.values()).sort((a,b)=>(String(a.stopName||"").toLowerCase()).localeCompare(String(b.stopName||"").toLowerCase()));
        }
        // Helper: Compare line names (copied from original tools for consistency if needed by route tiles)
        function parseLineName_ExtraPage(lineNameStr) { const name = String(lineNameStr || "").toUpperCase().trim(); const numPrefixRegex = /^(\d+)([A-Z]*)$/; const alphaNumRegex = /^([A-Z]+)(\d+)?([A-Z]*)$/; const numMatch = name.match(numPrefixRegex); if (numMatch) return { type: 'numeric', num: parseInt(numMatch[1],10), suf: numMatch[2] || '' }; const alphaMatch = name.match(alphaNumRegex); if (alphaMatch) return { type: 'alpha', pre: alphaMatch[1], num: alphaMatch[2]?parseInt(alphaMatch[2],10):null, suf: alphaMatch[3] || ''}; return { type: 'other', ori: name}; }
        function compareLineNames_ExtraPage(a, b) { const pA = parseLineName_ExtraPage(a); const pB = parseLineName_ExtraPage(b); if(pA.type==='numeric'&&pB.type==='alpha') return -1; if(pA.type==='alpha'&&pB.type==='numeric') return 1; if(pA.type==='numeric'&&pB.type==='numeric'){if(pA.num!==pB.num)return pA.num-pB.num; return pA.suf.localeCompare(pB.suf);} if(pA.type==='alpha'&&pB.type==='alpha'){if(pA.pre!==pB.pre)return pA.pre.localeCompare(pB.pre); if(pA.num!==pB.num)return (pA.num||0)-(pB.num||0); return pA.suf.localeCompare(pB.suf);} return (pA.ori||"").localeCompare(pB.ori||"");}
        // Helper: Get Route Tile Colour (adapted)
        function getRouteTileColour_ExtraPage(lineName, stopID = null) {
            const upName = String(lineName || "").toUpperCase();
            if (stopID && stopSpecificRouteColours_extra[stopID.toUpperCase()] && stopSpecificRouteColours_extra[stopID.toUpperCase()][upName]) {
                return stopSpecificRouteColours_extra[stopID.toUpperCase()][upName];
            }
            if (globalCustomRouteColours_extra[upName]) return globalCustomRouteColours_extra[upName];
            // Add your initialRouteColourMap logic here if you have one for this page, or use a simpler default
            const NIGHT_BUS_BLUE_COLOR = "#4CDBE6"; const DEFAULT_ROUTE_COLOUR = "#73809C";
            if (upName.startsWith("N")) return globalCustomRouteColours_extra["NIGHT_DEFAULT"] || NIGHT_BUS_BLUE_COLOR;
            if (upName.startsWith("SL")) return globalCustomRouteColours_extra["SL_DEFAULT"] || "#D32F2F";
            return DEFAULT_ROUTE_COLOUR;
        }
        function getTextColourForBackground_ExtraPage(hex) { if(!hex || hex.length < 7) return '#FFFFFF'; const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return((0.299*r + 0.587*g + 0.114*b)/255)>0.5?'#000000':'#FFFFFF';}

        // Add New Stop Logic (Adapted)
        function generateUniqueStopId_ExtraPage(format) {
            const existingStopIDs = new Set(currentWorkingSchedule_extra.map(entry => entry.stopID.toUpperCase()));
            let nextId = ""; let currentNum = 0; let attempts = 0; const maxAttempts = 100000; 
            if (format === "NUM") { 
                let maxNumeric = 100; 
                existingStopIDs.forEach(id => { if (/^\d+$/.test(id)) { const num = parseInt(id, 10); if (num >= 101 && num > maxNumeric) maxNumeric = num; }});
                currentNum = maxNumeric + 1;
                while (attempts < maxAttempts) { nextId = String(currentNum); if (!existingStopIDs.has(nextId)) return nextId; currentNum++; attempts++; if (currentNum > 99999) break; }
            } else if (["BP", "LE", "RO"].includes(format)) { 
                const prefix = format; let maxPrefixNum = 0;
                existingStopIDs.forEach(id => { if (id.startsWith(prefix)) { const numPart = id.substring(prefix.length); if (/^\d+$/.test(numPart)) { const num = parseInt(numPart, 10); if (num > maxPrefixNum) maxPrefixNum = num;}}});
                currentNum = maxPrefixNum + 1;
                while (attempts < maxAttempts) { nextId = prefix + currentNum; if (!existingStopIDs.has(nextId.toUpperCase())) return nextId; currentNum++; attempts++; if (currentNum > 99999) break; }
            }
            return (format || "ID_EXTRA_") + String(Date.now()).slice(-5) + String(Math.floor(Math.random()*90)+10);
        }
        function handleSuggestStopId_ExtraPage() {
            if (!currentUser_extra || !selectNewStopIdFormat_el_extra || !inputNewStopId_el_extra) return;
            const selectedFormat = selectNewStopIdFormat_el_extra.value;
            inputNewStopId_el_extra.value = generateUniqueStopId_ExtraPage(selectedFormat);
            inputNewStopId_el_extra.dispatchEvent(new Event('input', {bubbles:true, cancelable:true}));
        }
        async function handleAddStopDetails_ExtraPage() {
            // ... (Logic for adding a stop, similar to handleAddStop_ARS from original omsi_tools.html)
            // IMPORTANT: This function will need to add the placeholder to currentWorkingSchedule_extra
            // AND then call a function to save the updated currentWorkingSchedule_extra and unique stops to Firebase LIVE.
            // Example: await saveScheduleToFirebase_ExtraPage(currentWorkingSchedule_extra);
            // Also refresh dependent UI: renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            const newStopID = inputNewStopId_el_extra.value.trim().toUpperCase();
            const newStopName = inputNewStopName_el_extra.value.trim();
            const newStopDirection = inputNewStopDirection_el_extra.value.trim();

            if (!newStopID) { addNewStopStatus_el_extra.textContent = "New Stop ID is required."; addNewStopStatus_el_extra.style.color = '#e74c3c'; inputNewStopId_el_extra.focus(); return; }
            if (!/^[A-Z0-9]+$/.test(newStopID)) { addNewStopStatus_el_extra.textContent = "Stop ID: uppercase letters & numbers only."; addNewStopStatus_el_extra.style.color = '#e74c3c'; inputNewStopId_el_extra.focus(); return; }
            if (!newStopName) { addNewStopStatus_el_extra.textContent = "New Stop Name is required."; addNewStopStatus_el_extra.style.color = '#e74c3c'; inputNewStopName_el_extra.focus(); return; }

            const existingStopIDs = new Set(currentWorkingSchedule_extra.map(e => e.stopID.toUpperCase()));
            if (existingStopIDs.has(newStopID)) {
                addNewStopStatus_el_extra.textContent = `Stop ID "${newStopID}" already exists.`;
                if(newStopIdAvailability_el_extra) { newStopIdAvailability_el_extra.textContent = 'This Stop ID already exists.'; newStopIdAvailability_el_extra.style.color = '#e74c3c';}
                inputNewStopId_el_extra.focus(); return;
            }
            const placeholderEntry = { /* ... create placeholder ... */ internalId: `${newStopID}_placeholder_${Date.now()}`, stopID: newStopID, stopName: newStopName, direction: newStopDirection, lineName: "INFO_ONLY", destinationName: "Stop Definition Placeholder", scheduledTime: "00:00", OperatingProfile: "AllDays", DayOffset: "0" };
            currentWorkingSchedule_extra.push(placeholderEntry);
            
            try {
                await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra); // Save directly
                addNewStopStatus_el_extra.textContent = `Stop "${newStopID}" added (live).`; addNewStopStatus_el_extra.style.color = '#2ecc71';
                inputNewStopId_el_extra.value = ''; inputNewStopName_el_extra.value = ''; inputNewStopDirection_el_extra.value = '';
                if(newStopIdAvailability_el_extra) newStopIdAvailability_el_extra.textContent = '';
                if(selectNewStopIdFormat_el_extra) selectNewStopIdFormat_el_extra.selectedIndex = 0;
                renderUIDependentElements_ExtraPage();
            } catch (error) {
                console.error("Error saving new stop:", error);
                addNewStopStatus_el_extra.textContent = "Error saving new stop."; addNewStopStatus_el_extra.style.color = '#e74c3c';
                currentWorkingSchedule_extra.pop(); // Revert optimistic update
            }
        }

        // Master List Logic (Adapted)
        function populateMasterStopList_ExtraPage() {
            // ... (Logic similar to populateMasterStopList_SM from original omsi_tools.html)
            // This will use currentWorkingSchedule_extra, closedStopIDs_extra, globalCustomRouteColours_extra, stopSpecificRouteColours_extra
            // It will create li elements with edit/delete/toggle status buttons.
            // Delete button calls: handleDeleteStopFromMasterList_ExtraPage(stopId)
            // Edit button calls: handleEditStopFromMasterList_ExtraPage(stopId, name, dir)
            // Toggle button calls: handleToggleStopStatusFromMasterList_ExtraPage(stopId)
            if (!masterStopListUL_el_extra || !masterStopListStatus_el_extra) return;
            uniqueStopsMasterList_extra = getUniqueStopsFromSchedule_ExtraPage(); 
            const filterText = masterStopListFilterInput_el_extra.value.toLowerCase().trim();
            masterStopListUL_el_extra.innerHTML = ''; let displayedCount = 0;

            if (uniqueStopsMasterList_extra.length === 0) { masterStopListStatus_el_extra.textContent = 'No stops in current data.'; return; }

            uniqueStopsMasterList_extra.forEach(stop => {
                if (!stop || !stop.stopID) return;
                const servingRoutesData = new Map(); let hasNightBusService=false; let hasDayBusService=false;
                currentWorkingSchedule_extra.forEach(entry => {
                    if (entry.stopID === stop.stopID && entry.lineName) {
                        if(!servingRoutesData.has(entry.lineName)) servingRoutesData.set(entry.lineName,{});
                        const tileColor = getRouteTileColour_ExtraPage(entry.lineName, stop.stopID).toUpperCase();
                        if(tileColor === (globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6").toUpperCase()) hasNightBusService=true;
                        if(tileColor !== (globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6").toUpperCase()) hasDayBusService=true;
                    }
                });
                const sortedServingRouteNames = Array.from(servingRoutesData.keys()).sort(compareLineNames_ExtraPage);
                const isClosed = closedStopIDs_extra.includes(stop.stopID.toUpperCase());
                const closureStatus = isClosed ? "Closed" : "Open";
                const is24HourStop = hasNightBusService && hasDayBusService;

                const matchesFilter = !filterText || stop.stopID.toLowerCase().includes(filterText) || (stop.stopName||"").toLowerCase().includes(filterText) || (stop.direction||"").toLowerCase().includes(filterText) || sortedServingRouteNames.some(rn=>rn.toLowerCase().includes(filterText)) || closureStatus.toLowerCase().includes(filterText) || (is24HourStop && "24 hours".includes(filterText));

                if (matchesFilter) {
                    displayedCount++; const li = document.createElement('li'); li.dataset.stopid = stop.stopID;
                    let content = `<span class="stop-name-master">${stop.stopName}</span><br><span class="stop-direction-master">Towards: ${stop.direction}</span><br><span class="stop-id-master">Stop ID: ${stop.stopID}</span><br>`;
                    if (sortedServingRouteNames.length > 0) { content += `<div class="serving-routes-container">`; sortedServingRouteNames.forEach(ln => { const bg=getRouteTileColour_ExtraPage(ln,stop.stopID); const tc=getTextColourForBackground_ExtraPage(bg); content += `<span class="route-tile-tools-list" style="background-color:${bg};color:${tc};">${ln}</span>`; }); content += `</div>`; }
                    content += `<div class="stop-details-grid"><span class="detail-label">Status:</span> <span class="detail-value status-${closureStatus.toLowerCase()}">${closureStatus}</span>`;
                    if (is24HourStop) content += `<span class="detail-label">Service:</span> <span class="detail-value" style="color:${(globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6")};font-weight:bold;">24 Hours</span>`;
                    content += `</div>`; li.innerHTML = content;
                    const actionsDiv = document.createElement('div'); actionsDiv.className = 'stop-actions';
                    const editBtn = document.createElement('button'); editBtn.className = 'button small-action'; editBtn.textContent = 'Edit'; editBtn.addEventListener('click', () => handleEditStopFromMasterList_ExtraPage(stop.stopID, stop.stopName, stop.direction)); actionsDiv.appendChild(editBtn);
                    const deleteBtn = document.createElement('button'); deleteBtn.className = 'button small-action secondary'; deleteBtn.textContent = 'Del'; deleteBtn.addEventListener('click', () => handleDeleteStopFromMasterList_ExtraPage(stop.stopID)); actionsDiv.appendChild(deleteBtn);
                    const toggleBtn = document.createElement('button'); toggleBtn.className = `button small-action ${isClosed ? "tertiary" : "secondary"}`; toggleBtn.textContent = isClosed ? "Open" : "Close"; toggleBtn.addEventListener('click', () => handleToggleStopStatusFromMasterList_ExtraPage(stop.stopID)); actionsDiv.appendChild(toggleBtn);
                    li.appendChild(actionsDiv); masterStopListUL_el_extra.appendChild(li);
                }
            });
             masterStopListStatus_el_extra.textContent = `Showing ${displayedCount} of ${uniqueStopsMasterList_extra.length} stops.`;
        }
        async function handleEditStopFromMasterList_ExtraPage(stopID, currentName, currentDirection) {
            // ... (Logic to prompt for new name/direction, update currentWorkingSchedule_extra, then save to Firebase LIVE)
            // Example: await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);
            // renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            const newStopName = prompt(`Editing Stop: ${stopID}\nNew Name (current: "${currentName}"):`, currentName); if (newStopName === null) return;
            const newDirection = prompt(`Editing Stop: ${stopID}\nNew "Towards" (current: "${currentDirection}"):`, currentDirection); if (newDirection === null) return;
            if (newStopName.trim() === currentName.trim() && newDirection.trim() === currentDirection.trim()) { masterStopListStatus_el_extra.textContent = "No changes made."; return; }
            let updatedCount = 0;
            currentWorkingSchedule_extra.forEach(e => { if(e.stopID === stopID){ e.stopName = newStopName.trim(); e.direction = newDirection.trim(); updatedCount++; }});
            if(updatedCount > 0) {
                try { await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra); masterStopListStatus_el_extra.textContent = `${updatedCount} entries for ${stopID} updated (live).`; renderUIDependentElements_ExtraPage(); }
                catch(err) { masterStopListStatus_el_extra.textContent = "Error saving edits."; console.error(err);}
            } else { masterStopListStatus_el_extra.textContent = `No entries for ${stopID} found to edit.`;}

        }
        async function handleDeleteStopFromMasterList_ExtraPage(stopIdToRemove) {
            // ... (Logic to confirm, remove from currentWorkingSchedule_extra, update closedStopIDs_extra, stopSpecificRouteColours_extra, then save ALL these to Firebase LIVE)
            // Example: await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);
            //          await saveClosedStopsToFirebase_ExtraPage();
            // renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            if(!confirm(`ARE YOU SURE you want to remove stop ID "${stopIdToRemove}" and ALL its schedule entries (LIVE)?`)) return;
            const initialLength = currentWorkingSchedule_extra.length;
            currentWorkingSchedule_extra = currentWorkingSchedule_extra.filter(e => e.stopID.toUpperCase() !== stopIdToRemove.toUpperCase());
            const removedCount = initialLength - currentWorkingSchedule_extra.length;
            if (closedStopIDs_extra.includes(stopIdToRemove.toUpperCase())) closedStopIDs_extra = closedStopIDs_extra.filter(id => id !== stopIdToRemove.toUpperCase());
            if (stopSpecificRouteColours_extra[stopIdToRemove.toUpperCase()]) delete stopSpecificRouteColours_extra[stopIdToRemove.toUpperCase()];
            try {
                await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);
                await saveClosedStopsToFirebase_ExtraPage();
                await saveStopSpecificColoursToFirebase_ExtraPage(); // Assuming this saves stopSpecificRouteColours_extra
                 masterStopListStatus_el_extra.textContent = `Stop "${stopIdToRemove}" and ${removedCount} entries removed (live).`; renderUIDependentElements_ExtraPage();
            } catch(err) {masterStopListStatus_el_extra.textContent = "Error deleting stop."; console.error(err); }

        }
        async function handleToggleStopStatusFromMasterList_ExtraPage(stopID) {
            // ... (Logic to toggle in closedStopIDs_extra, then save to Firebase LIVE)
            // Example: await saveClosedStopsToFirebase_ExtraPage();
            // populateMasterStopList_ExtraPage(); // Just refresh this list
             if (!currentUser_extra) { alert("Log in."); return; }
            const stopIdUpper = stopID.toUpperCase(); const idx = closedStopIDs_extra.indexOf(stopIdUpper);
            if (idx === -1) closedStopIDs_extra.push(stopIdUpper); else closedStopIDs_extra.splice(idx, 1);
            try { await saveClosedStopsToFirebase_ExtraPage(); populateMasterStopList_ExtraPage(); }
            catch(err) { masterStopListStatus_el_extra.textContent = "Error toggling stop status."; console.error(err); }
        }

        // Find and Replace Logic (Adapted)
        async function handleFindReplaceStopIdInSchedule_ExtraPage() {
            // ... (Logic similar to handleFindReplaceStopIdSchedule_SM from original)
            // IMPORTANT: Modifies currentWorkingSchedule_extra, then calls saveScheduleAndStopsToFirebase_ExtraPage
            // renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            const findID = findStopIdScheduleInput_el_extra.value.trim().toUpperCase();
            const replaceID = replaceStopIdScheduleInput_el_extra.value.trim().toUpperCase();
            if(!findID || !replaceID) { findReplaceStatusMessage_el_extra.textContent="Both IDs required."; return; }
            if(findID === replaceID) { findReplaceStatusMessage_el_extra.textContent="IDs cannot be same."; return; }
            let newName = "", newDir = ""; let foundNewDetails = false;
            const existingNewEntry = currentWorkingSchedule_extra.find(e => e.stopID.toUpperCase() === replaceID);
            if(existingNewEntry){ newName=existingNewEntry.stopName; newDir=existingNewEntry.direction; foundNewDetails=true;}
            else { const oldEntry = currentWorkingSchedule_extra.find(e => e.stopID.toUpperCase() === findID); if(oldEntry){newName=oldEntry.stopName; newDir=oldEntry.direction;}}
            if(!confirm(`Replace ALL "${findID}" with "${replaceID}" (LIVE)? Name/Dir will be based on "${replaceID}" if it exists, else from "${findID}".`)) return;
            let count = 0;
            currentWorkingSchedule_extra.forEach(e => {if(e.stopID.toUpperCase() === findID){e.stopID=replaceID; e.stopName=newName; e.direction=newDir; count++;}});
            if(count > 0){
                try { await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra); findReplaceStatusMessage_el_extra.textContent = `Replaced ${count} occurrences (live).`; renderUIDependentElements_ExtraPage();}
                catch(err) { findReplaceStatusMessage_el_extra.textContent = "Error saving find/replace."; console.error(err);}
            } else {findReplaceStatusMessage_el_extra.textContent = `No "${findID}" found.`;}
        }

        // Remove Stop (Bulk/Dropdown) Logic (Adapted)
        async function handleRemoveStop_ExtraPage() {
            // ... (Logic similar to handleRemoveStop_ARS from original)
            // Modifies currentWorkingSchedule_extra, closedStopIDs_extra, stopSpecificRouteColours_extra
            // Then calls functions to save all these to Firebase LIVE.
            // renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            const stopIdToRemove = selectStopToRemove_el_extra.value;
            if(!stopIdToRemove) { removeStopStatus_el_extra.textContent = "Select stop to remove."; return; }
            if(!confirm(`ARE YOU SURE to remove stop ID "${stopIdToRemove}" and ALL its schedule entries (LIVE)?`)) return;
            // This function is identical to handleDeleteStopFromMasterList_ExtraPage in effect
            // Just using a different UI trigger. We can call that.
            await handleDeleteStopFromMasterList_ExtraPage(stopIdToRemove);
            selectStopToRemove_el_extra.value = ""; // Reset dropdown
            if(removeStopStatus_el_extra) removeStopStatus_el_extra.textContent = `Stop "${stopIdToRemove}" and its data removed (live). Check Master List status for details.`;

        }
        
        // Global Route Deletion Logic (Adapted)
        function populateGlobalRouteToDeleteSelector_ExtraPage() {
            // ... (Populates selectGlobalRouteToDelete_el_extra from currentWorkingSchedule_extra)
            if (!selectGlobalRouteToDelete_el_extra) return;
            const currentVal = selectGlobalRouteToDelete_el_extra.value;
            selectGlobalRouteToDelete_el_extra.innerHTML = '<option value="">-- Select Route --</option>';
            if (!currentWorkingSchedule_extra || currentWorkingSchedule_extra.length === 0) { selectGlobalRouteToDelete_el_extra.innerHTML = '<option value="">-- No Routes Loaded --</option>'; return; }
            const uniqueRoutes = [...new Set(currentWorkingSchedule_extra.map(e => e.lineName).filter(Boolean))].sort(compareLineNames_ExtraPage);
            uniqueRoutes.forEach(ln => { const opt=document.createElement('option'); opt.value=ln; opt.textContent=ln; selectGlobalRouteToDelete_el_extra.appendChild(opt); });
            if (uniqueRoutes.includes(currentVal)) selectGlobalRouteToDelete_el_extra.value = currentVal;
        }
        async function handleDeleteEntireRouteGlobally_ExtraPage() {
            // ... (Logic similar to handleDeleteEntireRouteGlobally from original)
            // Modifies currentWorkingSchedule_extra, globalCustomRouteColours_extra, stopSpecificRouteColours_extra
            // Then calls functions to save all these to Firebase LIVE.
            // renderUIDependentElements_ExtraPage();
            if (!currentUser_extra) { alert("Log in."); return; }
            const lineNameToDelete = selectGlobalRouteToDelete_el_extra.value;
            if(!lineToDelete) { deleteEntireRouteStatusMessage_el_extra.textContent = "Select route."; return; }
            if(!confirm(`EXTREME CAUTION! Delete ALL data for route "${lineToDelete}" GLOBALLY (LIVE)? Cannot be undone easily.`)) return;
            
            currentWorkingSchedule_extra = currentWorkingSchedule_extra.filter(e => !(e.lineName && e.lineName.toUpperCase() === lineNameToDelete.toUpperCase()));
            let globalColourRemoved = false; let specificColoursRemovedCount = 0; let specificColoursNeedSave = false;
            if (globalCustomRouteColours_extra[lineToDelete.toUpperCase()]) { delete globalCustomRouteColours_extra[lineToDelete.toUpperCase()]; globalColourRemoved=true; }
            Object.keys(stopSpecificRouteColours_extra).forEach(stopID => { if (stopSpecificRouteColours_extra[stopID] && stopSpecificRouteColours_extra[stopID][lineToDelete.toUpperCase()]) { delete stopSpecificRouteColours_extra[stopID][lineToDelete.toUpperCase()]; specificColoursRemovedCount++; if(Object.keys(stopSpecificRouteColours_extra[stopID]).length===0) delete stopSpecificRouteColours_extra[stopID]; specificColoursNeedSave=true; }});

            try {
                await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);
                if(globalColourRemoved) await saveGlobalColoursToFirebase_ExtraPage();
                if(specificColoursNeedSave) await saveStopSpecificColoursToFirebase_ExtraPage();
                deleteEntireRouteStatusMessage_el_extra.textContent = `Route "${lineToDelete}" deleted globally (live).`;
                renderUIDependentElements_ExtraPage();
            } catch(err) { deleteEntireRouteStatusMessage_el_extra.textContent = "Error deleting route."; console.error(err); }
        }

        // Helper function to save the main schedule and unique stops to Firebase (LIVE)
        async function saveScheduleAndStopsToFirebase_ExtraPage(scheduleArray) {
            if (!window.firebaseOMSI_Extra || !currentUser_extra) throw new Error("Not logged in or Firebase not ready.");
            const { database, dbUpdate, dbRef } = window.firebaseOMSI_Extra;
            const updates = {};
            
            const finalScheduleData = scheduleArray.map((entry, index) => ({
                ...entry,
                internalId: entry.internalId || `${(entry.stopID||'s').toUpperCase()}_${(entry.lineName||'l').toUpperCase()}_${(entry.scheduledTime||"").replace(':','')}_${index}_extra_directsave`
            }));
            updates[FB_PATH_LIVE_SCHEDULE_DATA] = finalScheduleData;

            const stopsMap = new Map();
            finalScheduleData.forEach(row => {
                if (row.stopID && !stopsMap.has(row.stopID.toUpperCase())) {
                    stopsMap.set(row.stopID.toUpperCase(), { stopID: row.stopID, stopName: row.stopName, direction: row.direction });
                }
            });
            const finalUniqueStops = Array.from(stopsMap.values()).sort((a,b)=>(a.stopName||"").localeCompare(b.stopName||""));
            updates[FB_PATH_LIVE_UNIQUE_STOPS] = finalUniqueStops;
            updates[FB_PATH_APPSTATE_LAST_UPDATED] = new Date().toISOString(); // Also update last updated time

            await dbUpdate(dbRef(database), updates);
            console.log("Extra Page: Live schedule and unique stops updated in Firebase.");
        }

        // Helper functions to save settings directly (LIVE)
        async function saveClosedStopsToFirebase_ExtraPage() {
            if (!window.firebaseOMSI_Extra || !currentUser_extra) throw new Error("Not logged in or Firebase not ready.");
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra;
            const fbClosedObject = {}; 
            closedStopIDs_extra.forEach(id => fbClosedObject[id.toUpperCase()] = true);
            await dbSet(dbRef(database, FB_PATH_APPSTATE_CLOSED_STOPS), fbClosedObject);
            console.log("Extra Page: Closed stops updated in Firebase.");
        }
        async function saveGlobalColoursToFirebase_ExtraPage() {
            if (!window.firebaseOMSI_Extra || !currentUser_extra) throw new Error("Not logged in or Firebase not ready.");
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra;
            await dbSet(dbRef(database, FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS), globalCustomRouteColours_extra);
            console.log("Extra Page: Global route colours updated in Firebase.");
        }
        async function saveStopSpecificColoursToFirebase_ExtraPage() {
            if (!window.firebaseOMSI_Extra || !currentUser_extra) throw new Error("Not logged in or Firebase not ready.");
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra;
            await dbSet(dbRef(database, FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS), stopSpecificRouteColours_extra);
            console.log("Extra Page: Stop-specific route colours updated in Firebase.");
        }

        // --- END: Merged Stop Management & Add/Remove Stop ---
        
        // Utility function for YYYY-MM-DD (if not already defined)
        function getYYYYMMDD_ExtraPage(dateSource) {
            let dateObj;
            if (dateSource instanceof Date) { dateObj = dateSource; }
            else if (typeof dateSource === 'string' && dateSource.match(/^\d{4}-\d{2}-\d{2}$/)) { dateObj = new Date(dateSource + "T00:00:00Z"); } 
            else if (dateSource && dateSource.value && typeof dateSource.value === 'string') { 
                if (!dateSource.value) return null; 
                dateObj = new Date(dateSource.value + "T00:00:00Z"); 
            } else { return null; }
            if (isNaN(dateObj.getTime())) return null;
            const year = dateObj.getUTCFullYear(); 
            const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // --- DOMContentLoaded listener ---
        document.addEventListener('DOMContentLoaded', () => {
            function initializeExtraPageAppLogic() {
                console.log("Firebase ready (Extra Page), initializing Extra Modules app logic.");
                if (!window.firebaseOMSI_Extra || !window.firebaseOMSI_Extra.auth) {
                    console.error("CRITICAL: firebaseOMSI_Extra.auth not available on firebaseReady_Extra event!");
                    if (authStatus_el_extra) authStatus_el_extra.textContent = 'Firebase auth error!';
                    return;
                }
                const { auth, authOnAuthStateChanged, authSignInWithEmailAndPassword, authSignOut } = window.firebaseOMSI_Extra;
                
                authOnAuthStateChanged(auth, updateAuthUI_ExtraPage);

                if (adminLoginForm_el_extra) {
                    adminLoginForm_el_extra.addEventListener('submit', (event) => {
                        event.preventDefault();
                        const email = inputEmail_el_extra.value;
                        const password = inputPassword_el_extra.value;
                        if(authStatus_el_extra) authStatus_el_extra.textContent = 'Logging in...';
                        authSignInWithEmailAndPassword(auth, email, password)
                            .catch((error) => {
                                console.error("Extra Page Login Error:", error);
                                if(authStatus_el_extra) authStatus_el_extra.textContent = `Login Error: ${error.message}`;
                            });
                    });
                }
                
                const logoutButton_el_extra_listener = document.getElementById('logoutButton_extra');
                if (logoutButton_el_extra_listener) {
                    logoutButton_el_extra_listener.addEventListener('click', () => {
                        authSignOut(auth).catch((e) => console.error("Extra Page Sign-out Error:", e));
                    });
                }

                const menuButtonsOnThisPage = document.querySelectorAll('#main-menu-buttons_extra .menu-button');
                menuButtonsOnThisPage.forEach(button => {
                    button.addEventListener('click', () => {
                        const sectionId = button.getAttribute('data-section');
                        if (currentUser_extra && sectionId) { 
                            showExtraPageSection(sectionId);
                        } else if (!currentUser_extra) {
                            alert("Please log in to access this section.");
                        }
                    });
                });

                // Event listeners for Day Profile Override Tool
                if(overrideDateInput_el_extra) overrideDateInput_el_extra.addEventListener('change', handleOverrideDateChange_ExtraPage);
                if(setOverrideButton_el_extra) setOverrideButton_el_extra.addEventListener('click', handleSetProfileOverride_ExtraPage);
                if(clearOverrideButton_el_extra) clearOverrideButton_el_extra.addEventListener('click', handleClearProfileOverride_ExtraPage);

                // Event listeners for Merged Stop Management & Creation Tool
                if(buttonSuggestStopId_el_extra) buttonSuggestStopId_el_extra.addEventListener('click', handleSuggestStopId_ExtraPage);
                if(buttonAddNewStop_el_extra) buttonAddNewStop_el_extra.addEventListener('click', handleAddStopDetails_ExtraPage);
                if(selectNewStopIdFormat_el_extra) selectNewStopIdFormat_el_extra.addEventListener('change', handleSuggestStopId_ExtraPage);
                if(inputNewStopId_el_extra && newStopIdAvailability_el_extra) {
                    inputNewStopId_el_extra.addEventListener('input', () => {
                        const newStopId = inputNewStopId_el_extra.value.trim().toUpperCase();
                        if(!newStopId){newStopIdAvailability_el_extra.textContent='';return;}
                        if(!/^[A-Z0-9]+$/.test(newStopId)){newStopIdAvailability_el_extra.textContent='ID: Alphanumeric uppercase.';newStopIdAvailability_el_extra.style.color='#e74c3c';return;}
                        const existing = currentWorkingSchedule_extra.some(e=>e.stopID.toUpperCase() === newStopId);
                        if(existing){newStopIdAvailability_el_extra.textContent='ID already exists.';newStopIdAvailability_el_extra.style.color='#e74c3c';}
                        else{newStopIdAvailability_el_extra.textContent='ID available.';newStopIdAvailability_el_extra.style.color='#2ecc71';}
                    });
                }
                if(refreshMasterStopListButton_el_extra) refreshMasterStopListButton_el_extra.addEventListener('click', populateMasterStopList_ExtraPage);
                if(masterStopListFilterInput_el_extra) masterStopListFilterInput_el_extra.addEventListener('input', populateMasterStopList_ExtraPage);
                if(findReplaceStopIdScheduleButton_el_extra) findReplaceStopIdScheduleButton_el_extra.addEventListener('click', handleFindReplaceStopIdInSchedule_ExtraPage);
                if(buttonRemoveStop_el_extra) buttonRemoveStop_el_extra.addEventListener('click', handleRemoveStop_ExtraPage);

                // Event listener for Global Route Deletion Tool
                if(deleteEntireRouteButton_el_extra) deleteEntireRouteButton_el_extra.addEventListener('click', handleDeleteEntireRouteGlobally_ExtraPage);

            }

            if (window.firebaseOMSI_Extra && window.firebaseOMSI_Extra.auth) {
                initializeExtraPageAppLogic();
            } else {
                document.addEventListener('firebaseReady_Extra', initializeExtraPageAppLogic, { once: true });
            }
        });
    </script>
</body>
</html>