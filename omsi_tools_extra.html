<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMSI Tools - Extra Modules</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="manifest" href="/live-tracker/manifest-omsi.json"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OMSI Extra Tools">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="/live-tracker/assets/icons/apple-touch-icon-180x180.png"> <style>
        /* Copied CSS from your omsi_tools.html - Ensure this is complete and correct */
        @font-face {
            font-family: 'NJFont Medium Web';
            src: url('fonts/NJFont-Medium.ttf') format('truetype'); /* Relative path */
            font-weight: normal;font-style: normal;font-display: swap;
        }
        body {
            font-family: 'NJFont Medium Web', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            margin:0;
        }
        .page-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        #top-menu-bar_extra {
            background-color: rgba(0,0,0,0.25); padding: 0.75rem; border-radius: 0.5rem;
            margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center; display: none;
        }
        .menu-button {
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin: 0.25rem;
        }
        .menu-button:hover { background-color: #2980b9; }
        .tool-content-section {
            display: none; background-color: rgba(0,0,0,0.15); padding: 1.5rem;
            border-radius: 0.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #auth-section {
             margin-bottom: 1.5rem; background-color: rgba(0,0,0,0.15); padding: 1.5rem;
             border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #current-profile-display-container {
            text-align: center; margin-bottom: 1.5rem; padding: 0.75rem;
            background-color: rgba(255,255,255,0.05); border-radius: 0.25rem; display: none;
        }
        #current-profile-display { font-size: 0.9rem; opacity: 0.9; font-style: italic;}
        h1 { font-size: 2rem; margin-bottom: 1.5rem; font-weight: normal; text-align: center; color: #ffffff; }
        h2 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: normal; border-bottom: 1px solid #7f8c8d; padding-bottom: 0.25rem;}
        h3.subsection-title { font-size: 1.25rem; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: normal; color: #e0e0e0; border-bottom: 1px solid rgba(127,140,141,0.5); padding-bottom: 0.2rem;}
        .subsection {
            background-color: rgba(0,0,0,0.1); padding: 1rem; border-radius: 0.375rem;
            margin-top: 1rem; margin-bottom: 1rem; border: 1px solid rgba(127,140,141,0.2);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;}
        .form-field-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #bdc3c7; }
        input[type="text"], input[type="email"], input[type="password"], input[type="time"],
        input[type="color"], input[type="number"], input[type="date"], select {
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e; color: #ecf0f1; font-size:0.9rem; box-sizing: border-box;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        select option { background-color: #34495e; color: #ecf0f1; }
        .button {
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin-right: 0.5rem; margin-top:0.5rem;
        }
        .button:hover { background-color: #2980b9; }
        .button.secondary { background-color: #e74c3c; }
        .button.secondary:hover { background-color: #c0392b; }
        .button.save { background-color: #27ae60; }
        .button.save:hover { background-color: #229954; }
        .button.tertiary { background-color: #f39c12; }
        .button.tertiary:hover { background-color: #e67e22; }
        .button.neutral { background-color: #7f8c8d; }
        .button.neutral:hover { background-color: #95a5a6; color: #2c3e50; }
         .button.small-action { padding: 0.2rem 0.4rem; font-size: 0.8rem; margin: 0 0.15rem; line-height: 1; min-width: 20px; text-align:center; font-weight: bold;}
        .schedule-generator-input {
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e; color: #ecf0f1; font-size: 0.9rem;
        }

        /* Master Stop List Styles */
        #masterStopListUL_extra li.master-stop-list-item {
            display: grid;
            grid-template-columns: 2.5fr 1.5fr 1fr; 
            gap: 1rem; padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #34495e;
            transition: background-color 0.15s ease-in-out; align-items: start;
        }
        #masterStopListUL_extra li.master-stop-list-item:last-child { border-bottom: none; }
        .master-stop-original-info .stop-name-master { font-weight: bold; color: #ecf0f1; font-size: 1.05em; }
        .master-stop-original-info .stop-direction-master { /*font-style: italic;*/ font-size: 0.85em; color: #95a5a6; margin-bottom: 0.3rem; }
        .master-stop-original-info .stop-id-master { font-weight: normal; color: #bdc3c7; font-size: 0.95em; }
        .master-stop-original-info .stop-details-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.2rem 0.8rem; font-size: 0.85em; margin-top: 0.4rem; }
        .master-stop-original-info .detail-label { font-weight: normal; color: #bdc3c7; opacity: 0.8; }
        .master-stop-original-info .detail-value { color: #ecf0f1; }
        .master-stop-original-info .detail-value.status-closed { color: #e74c3c; font-weight: bold; }
        .master-stop-original-info .detail-value.status-open { color: #2ecc71; }
        .master-stop-original-info .serving-routes-container { margin-top: 0.4rem; margin-bottom: 0.2rem; display: flex; flex-wrap: wrap; gap: 0.3em; padding: 0.25rem 0;}
        .master-stop-new-id-section label { font-size: 0.8em; display: block; margin-bottom: 0.2em; color: #bdc3c7; }
        .master-list-new-id-input { margin-bottom: 0.25rem; }
        .master-list-row-warning { font-size: 0.8em; color: #f39c12; min-height: 1.2em; margin-top: 0.25rem; }
        .master-stop-actions { margin-top: 0rem; padding-top: 0rem; border-top: none; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start; }
        .master-stop-actions .button.small-action { width: 100%; margin: 0; }
        .route-tile-tools-list { 
            display: inline-block; padding: 0.2em 0.55em; margin-right: 0.3em; margin-bottom: 0.3em;
            border-radius: 0.25rem; font-size: 0.8em; font-weight: bold; color: white;
            text-align: center; line-height: 1.3; min-width: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25); vertical-align: middle;
        }
        #newStopIdAvailability_extra { font-size: 0.8em; min-height: 1.1em; margin-top: 0.25rem; }

        /* Selectable Route Tiles for Global Deletion */
        .selectable-route-tile-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem; 
            padding: 0.25rem 0; 
        }
        .selectable-route-tile {
            display: inline-block;
            padding: 0.4em 0.8em; 
            border-radius: 0.25rem;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
            min-width: 40px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
            border: 2px solid transparent; 
            transition: border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .selectable-route-tile:hover {
            transform: translateY(-1px); 
        }
        .selectable-route-tile.selected {
            border-color: #f1c40f; 
            box-shadow: 0 0 6px 1px #f1c40f; 
        }
    </style>
</head>
<body>
    <div class="page-container">
        <h1>OMSI Tools - Extra Modules</h1>

        <div id="auth-section" class="section">
            <h2>Admin Login</h2>
            <div id="login-form-container_extra">
                <form id="adminLoginForm_extra">
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div><label for="inputEmail_extra">Email</label><input type="email" id="inputEmail_extra" autocomplete="email"></div>
                        <div><label for="inputPassword_extra">Password</label><input type="password" id="inputPassword_extra" autocomplete="current-password"></div>
                    </div>
                    <button id="loginButton_extra" type="submit" class="button">Login</button>
                </form>
                <p id="auth-status_extra" style="margin-top: 0.5em; color: #f1c40f;"></p>
            </div>
            <div id="logout-container_extra" style="display:none;">
                <p>Logged in as: <span id="loggedInUserEmail_extra"></span></p>
                <button id="logoutButton_extra" class="button secondary">Logout</button>
            </div>
        </div>

        <div id="current-profile-display-container" style="display:none;">
            <p id="current-profile-display">Today's Auto Profile: (determining...)</p>
        </div>

        <div id="top-menu-bar_extra" style="display:none;">
            <div id="main-menu-buttons_extra">
                <button class="menu-button" data-section="day-profile-override-section_extra">Day Profile Override</button>
                <button class="menu-button" data-section="stop-manager-tool-section_extra">Stop Management & Creation</button>
                <button class="menu-button" data-section="global-route-deletion-section_extra">Global Route Deletion</button>
            </div>
        </div>

        <div id="tool-sections-wrapper_extra">
            <div id="day-profile-override-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Operational Day Profile Override</h2>
                <p style="font-size:0.9em; margin-bottom:1.5em; opacity: 0.8;">
                    Use this tool to manually set a specific operating profile for an upcoming date, overriding the automatic calculation. Changes are saved immediately.
                </p>
                <div class="subsection">
                    <h3 class="subsection-title">Select Date and Override Profile</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 2fr 1fr; align-items: end; gap: 1rem;">
                        <div>
                            <label for="overrideDate_extra">Select Date:</label>
                            <input type="date" id="overrideDate_extra" class="schedule-generator-input">
                        </div>
                        <div>
                            <label for="overrideProfile_extra">Override Profile String:</label>
                            <input type="text" id="overrideProfile_extra" class="schedule-generator-input" placeholder="e.g., Su, MFSch, CustomHoliday">
                        </div>
                        <div>
                            <button id="setOverrideButton_extra" class="button save">Set Override</button>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <p style="font-size: 0.85em;">Normally for <span id="selectedDateDisplay_extra" style="font-weight:bold;">(select a date)</span>, the auto-profile would be: <strong id="autoProfileForSelectedDate_extra">(calculating...)</strong></p>
                        <p style="font-size: 0.85em;">Current override for selected date: <strong id="currentOverrideForSelectedDate_extra">(none)</strong></p>
                        <button id="clearOverrideButton_extra" class="button secondary" style="display:none; margin-top:0.5em;">Clear Override for This Date</button>
                    </div>
                    <p id="overrideStatusMessage_extra" style="min-height:1.2em; margin-top: 1rem; font-weight:bold;"></p>
                </div>
                <div class="subsection" style="margin-top: 2rem;">
                    <h3 class="subsection-title">Currently Active Overrides (Next 30 Days)</h3>
                    <div id="activeOverridesList_extra" style="max-height: 200px; overflow-y: auto; background-color: rgba(0,0,0,0.05); padding: 0.5rem; border-radius: 0.25rem;">
                        <p>Loading active overrides...</p>
                    </div>
                </div>
            </div>

            <div id="stop-manager-tool-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Stop Management & Creation (Live Updates)</h2>
                <div class="subsection">
                    <h3 class="subsection-title">Add New Stop Details</h3>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">
                        Define a new stop. The Stop ID will be auto-suggested based on format and name, but you can edit it.
                        A placeholder schedule entry will be added to make it available in selectors. The Stop ID must be unique. Changes are saved directly to Firebase.
                    </p>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div> <label for="selectNewStopIdFormat_extra">Stop ID Format/Prefix</label>
                            <select id="selectNewStopIdFormat_extra" class="schedule-generator-input">
                                <option value="NUM">Numeric (e.g., 101-99999)</option>
                                <option value="BP">BP Prefix (e.g., BP1-BP99999)</option>
                                <option value="LE">LE Prefix (e.g., LE1-LE99999)</option>
                                <option value="RO">RO Prefix (e.g., RO1-RO99999)</option>
                            </select>
                        </div>
                        <div> <label for="inputNewStopId_extra">New Stop ID (auto-suggested, editable)</label>
                            <input type="text" id="inputNewStopId_extra" class="schedule-generator-input" placeholder="e.g., NEWSTOP123" autocomplete="off">
                            <p id="newStopIdAvailability_extra"></p>
                        </div>
                        <div>
                            <label for="inputNewStopName_extra">New Stop Name (influences ID suggestion)</label>
                            <input type="text" id="inputNewStopName_extra" class="schedule-generator-input" placeholder="e.g., Main Street Library" autocomplete="off">
                        </div>
                        <div>
                            <label for="inputNewStopDirection_extra">New Stop Direction (Towards)</label>
                            <input type="text" id="inputNewStopDirection_extra" class="schedule-generator-input" placeholder="e.g., Town Centre" autocomplete="off">
                        </div>
                    </div>
                     <p id="addNewStopStatus_extra" style="min-height:1.2em; margin-top: 0.75rem;"></p>
                    <div style="margin-top: 1rem;">
                        <button id="buttonAddNewStop_extra" class="button save">Add New Stop Details (Live)</button>
                    </div>
                </div>
                <div class="subsection">
                    <h3 class="subsection-title">Master List of Unique Stops (with ID Change Capability)</h3>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:0.75rem;">
                        View and edit stop details. You can also propose new Stop IDs for existing stops.
                        All proposed Stop ID changes are applied in bulk using the button at the bottom of this list.
                        Other actions (Edit Name / Direction, Delete, Open / Close) are immediate for that specific stop.
                    </p>
                    <div class="form-grid" style="grid-template-columns: 1fr auto; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <input type="text" id="masterStopListFilterInput_extra" class="schedule-generator-input" placeholder="Filter by Stop ID, Name, Route, Status...">
                        <button id="refreshMasterStopListButton_extra" class="button neutral">Refresh List</button>
                    </div>
                    <div id="masterStopListContainer_extra" class="subsection" style="padding: 0.5rem; background-color: rgba(0,0,0,0.05); margin-top:0;">
                        <ul id="masterStopListUL_extra" style="list-style: none; padding: 0;"></ul>
                    </div>
                    <p id="masterStopListStatus_extra" style="text-align: center; margin-top: 0.5rem; min-height: 1.2em;">Click "Refresh List" to load stops.</p>

                    <div class="subsection" style="margin-top: 1.5rem; text-align: center;">
                        <button id="applyMasterListStopIdChangesButton_extra" class="button save" style="padding: 0.8rem 1.5rem;">Apply All Stop ID Changes from List (Live)</button>
                        <p id="masterListApplyChangesStatus_extra" style="min-height:1.2em; margin-top: 1rem; font-weight:bold;"></p>
                    </div>
                </div>
            </div>

            <div id="global-route-deletion-section_extra" class="tool-content-section section" style="display:none;">
                <h2>Global Route Deletion (Live)</h2>
                <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">
                    Click on route tiles below to select them for deletion. This will remove ALL of their schedule entries from ALL stops in the live schedule.
                    It will also remove their global custom colour and any stop-specific colour overrides for the selected routes.
                    <strong>This action is highly destructive and directly modifies live data.</strong>
                </p>
                <div class="form-field-group">
                    <label>Select Route(s) to Delete Globally by clicking tiles:</label>
                    <div id="globalRouteDeletionListContainer_el_extra" class="subsection" style="max-height: 300px; overflow-y: auto; background-color: rgba(0,0,0,0.05); padding: 0.75rem; border-radius: 0.25rem; border: 1px solid rgba(127,140,141,0.2);">
                        <p>Loading routes...</p> 
                    </div>
                </div>
                <button id="deleteEntireRouteButton_el_extra" class="button secondary" style="margin-top: 0.5rem;">Delete Selected Route(s) (Live)</button>
                <p id="deleteEntireRouteStatusMessage_el_extra" style="min-height:1.2em; margin-top:0.75rem;"></p>
            </div>
        </div>
    </div>

    <script type="module">
      // Firebase Initialization
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getDatabase, ref, set, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDePDF-kZahjzh9ij6tkuApIhoGePwVQ2s", // Replace with your actual Firebase API Key
        authDomain: "omsi-c5505.firebaseapp.com", // Replace with your actual Firebase Auth Domain
        databaseURL: "https://omsi-c5505-default-rtdb.europe-west1.firebasedatabase.app", // Replace with your actual Firebase Database URL
        projectId: "omsi-c5505", // Replace with your actual Firebase Project ID
        storageBucket: "omsi-c5505.appspot.com", // Replace with your actual Firebase Storage Bucket
        messagingSenderId: "503595375440", // Replace with your actual Firebase Messaging Sender ID
        appId: "1:503595375440:web:356be6684b77ff5909ea55", // Replace with your actual Firebase App ID
        measurementId: "G-VN7X65V3F9" // Replace with your actual Firebase Measurement ID
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      window.firebaseOMSI_Extra = {
          database: database, auth: auth,
          dbRef: ref, dbSet: set, dbOnValue: onValue, dbGet: get,
          dbChild: child, dbUpdate: update, dbRemove: remove,
          authOnAuthStateChanged: onAuthStateChanged,
          authSignInWithEmailAndPassword: signInWithEmailAndPassword,
          authSignOut: signOut
      };
      console.log("Firebase Initialized for OMSI Tools - Extra Modules Page.");
      document.dispatchEvent(new CustomEvent('firebaseReady_Extra', { detail: window.firebaseOMSI_Extra }));
    </script>

    <script>
        // --- Global State Variables ---
        let currentUser_extra = null;
        let pageSpecificSettings = {};
        let ukBankHolidaysData_extra = { dates: [], titles: {} };
        const schoolHolidayDateRanges_extra = []; // Example: [{start: "YYYY-MM-DD", end: "YYYY-MM-DD", name: "Summer Holiday"}]
        let currentWorkingSchedule_extra = [];
        let closedStopIDs_extra = [];
        let globalCustomRouteColours_extra = {};
        let stopSpecificRouteColours_extra = {};
        let uniqueStopsMasterList_extra = [];

        // --- Firebase Path Constants ---
        const FB_PATH_PAGE_EXTRA_SETTINGS = '/settings/extraModulesPageSettings';
        const FB_PATH_OPERATIONAL_OVERRIDES = '/operationalOverrides';
        const FB_PATH_LIVE_SCHEDULE_DATA = '/liveSchedule/allScheduledBusData';
        const FB_PATH_LIVE_UNIQUE_STOPS = '/liveSchedule/uniqueBusStops';
        const FB_PATH_APPSTATE_LAST_UPDATED = '/appState/scheduleLastUpdated';
        const FB_PATH_APPSTATE_CLOSED_STOPS = '/appState/closedStopIDs';
        const FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS = '/settings/customRouteColours';
        const FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS = '/settings/stopSpecificRouteColours';

        // --- DOM Elements ---
        const authSection_el_extra = document.getElementById('auth-section');
        const loginFormContainer_el_extra = document.getElementById('login-form-container_extra');
        const adminLoginForm_el_extra = document.getElementById('adminLoginForm_extra');
        const inputEmail_el_extra = document.getElementById('inputEmail_extra');
        const inputPassword_el_extra = document.getElementById('inputPassword_extra');
        const authStatus_el_extra = document.getElementById('auth-status_extra');
        const logoutContainer_el_extra = document.getElementById('logout-container_extra');
        const loggedInUserEmailDisplay_el_extra = document.getElementById('loggedInUserEmail_extra');
        const topMenuBar_el_extra = document.getElementById('top-menu-bar_extra');
        const toolSectionsWrapper_el_extra = document.getElementById('tool-sections-wrapper_extra');
        const currentProfileDisplayContainer_el = document.getElementById('current-profile-display-container');
        const currentProfileDisplayElement_el = document.getElementById('current-profile-display');
        // Day Profile Override
        const overrideDateInput_el_extra = document.getElementById('overrideDate_extra');
        const overrideProfileInput_el_extra = document.getElementById('overrideProfile_extra');
        const setOverrideButton_el_extra = document.getElementById('setOverrideButton_extra');
        const clearOverrideButton_el_extra = document.getElementById('clearOverrideButton_extra');
        const overrideStatusMessage_el_extra = document.getElementById('overrideStatusMessage_extra');
        const selectedDateDisplay_el_extra = document.getElementById('selectedDateDisplay_extra');
        const autoProfileForSelectedDate_el_extra = document.getElementById('autoProfileForSelectedDate_extra');
        const currentOverrideForSelectedDate_el_extra = document.getElementById('currentOverrideForSelectedDate_extra');
        const activeOverridesList_el_extra = document.getElementById('activeOverridesList_extra');
        // Stop Management & Creation
        const selectNewStopIdFormat_el_extra = document.getElementById('selectNewStopIdFormat_extra');
        // const buttonSuggestStopId_el_extra = document.getElementById('buttonSuggestStopId_extra'); // REMOVED
        const inputNewStopId_el_extra = document.getElementById('inputNewStopId_extra');
        const newStopIdAvailability_el_extra = document.getElementById('newStopIdAvailability_extra');
        const inputNewStopName_el_extra = document.getElementById('inputNewStopName_extra');
        const inputNewStopDirection_el_extra = document.getElementById('inputNewStopDirection_extra');
        const buttonAddNewStop_el_extra = document.getElementById('buttonAddNewStop_extra');
        const addNewStopStatus_el_extra = document.getElementById('addNewStopStatus_extra');
        const masterStopListFilterInput_el_extra = document.getElementById('masterStopListFilterInput_extra');
        const refreshMasterStopListButton_el_extra = document.getElementById('refreshMasterStopListButton_extra');
        const masterStopListUL_el_extra = document.getElementById('masterStopListUL_extra');
        const masterStopListStatus_el_extra = document.getElementById('masterStopListStatus_extra');
        const applyMasterListStopIdChangesButton_el_extra = document.getElementById('applyMasterListStopIdChangesButton_extra');
        const masterListApplyChangesStatus_el_extra = document.getElementById('masterListApplyChangesStatus_extra');
        // Global Route Deletion
        const globalRouteDeletionListContainer_el_extra = document.getElementById('globalRouteDeletionListContainer_el_extra'); 
        const deleteEntireRouteButton_el_extra = document.getElementById('deleteEntireRouteButton_el_extra'); 
        const deleteEntireRouteStatusMessage_el_extra = document.getElementById('deleteEntireRouteStatusMessage_el_extra');

        // --- Profile Display Functions ---
        async function fetchBankHolidays_ExtraPage() { 
            if(!window.firebaseOMSI_Extra){if(currentProfileDisplayElement_el)currentProfileDisplayElement_el.textContent="Today's Profile: (Firebase N/A)";updateCurrentProfileDisplay_ExtraPage();return;}
            try { const response=await fetch('https://www.gov.uk/bank-holidays.json');if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);
                const data=await response.json();if(data['england-and-wales']&&data['england-and-wales'].events){const events=data['england-and-wales'].events;ukBankHolidaysData_extra={dates:events.map(event=>event.date),titles:events.reduce((acc,event)=>{acc[event.date]=event.title;return acc;},{})};}else{ukBankHolidaysData_extra={dates:[],titles:{}};}
            }catch(error){console.error("Extra Page: Failed to fetch bank hols:",error);ukBankHolidaysData_extra={dates:[],titles:{}};if(currentProfileDisplayElement_el)currentProfileDisplayElement_el.textContent="Today's Profile: (Bank Hol. Error)";}
            finally{updateCurrentProfileDisplay_ExtraPage();if(overrideDateInput_el_extra&&overrideDateInput_el_extra.value&&document.getElementById('day-profile-override-section_extra')?.style.display==='block'){displayAutoCalculatedProfileForDate_ExtraPage(overrideDateInput_el_extra.value);}}
        }
        function isSchoolHolidayPeriod_ExtraPage(dateObject) { 
            if(!schoolHolidayDateRanges_extra||schoolHolidayDateRanges_extra.length===0)return false;const checkTime=dateObject.getTime();
            for(const range of schoolHolidayDateRanges_extra){try{const startTime=new Date(range.start+"T00:00:00").getTime();const endTime=new Date(range.end+"T23:59:59").getTime();if(checkTime>=startTime&&checkTime<=endTime)return true;}catch(e){console.error("Error in school holiday date range:",range,e);}}
            return false;
        }
        function getOperatingCodesForDate_ExtraPage(dateObject) { 
            const n=dateObject;const dOW=n.getDay();const targetDateString=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
            let dateCodes=new Set();let isBankHolidayToday=false;
            if(ukBankHolidaysData_extra.dates&&ukBankHolidaysData_extra.dates.includes(targetDateString)){const holidayTitle=ukBankHolidaysData_extra.titles[targetDateString]||"";isBankHolidayToday=true;if(holidayTitle.toLowerCase().includes("good friday"))dateCodes.add("Sa");else dateCodes.add("Su");}
            if(!isBankHolidayToday){const isSchHol=isSchoolHolidayPeriod_ExtraPage(n);const schoolSuffix=isSchHol?"NSD":"Sch";let dayCode="";
            switch(dOW){case 0:dayCode="Su";break;case 1:dayCode="Mo";break;case 2:dayCode="Tu";break;case 3:dayCode="We";break;case 4:dayCode="Th";break;case 5:dayCode="Fr";break;case 6:dayCode="Sa";break;}
            if(dayCode)dateCodes.add(dayCode);if(dOW>=1&&dOW<=5){if(dayCode)dateCodes.add(dayCode+schoolSuffix);dateCodes.add("MF"+schoolSuffix);dateCodes.add("MF");}
            if((dOW===6||dOW===0)&&isSchHol){if(dayCode)dateCodes.add(dayCode+"NSD");}if(isSchHol)dateCodes.add("SchoolHoliday");
            }else{const isSchHolOnBH=isSchoolHolidayPeriod_ExtraPage(n);if(isSchHolOnBH){dateCodes.add("SchoolHoliday");if(dateCodes.has("Sa"))dateCodes.add("SaNSD");if(dateCodes.has("Su")&&!dateCodes.has("Sa"))dateCodes.add("SuNSD");}}
            return Array.from(dateCodes);
        }
        function updateCurrentProfileDisplay_ExtraPage() { 
            const operatingCodes=getOperatingCodesForDate_ExtraPage(new Date());const now=new Date();const dayOfWeek=now.getDay();
            const todayDateString=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            let profileDisplayText="";let isBankHol=false;let serviceTypeDisplay="";
            if(ukBankHolidaysData_extra.dates&&ukBankHolidaysData_extra.dates.includes(todayDateString)){const holidayTitle=ukBankHolidaysData_extra.titles[todayDateString]||"Bank Holiday";isBankHol=true;if(holidayTitle.toLowerCase().includes("good friday")){profileDisplayText="Good Friday";serviceTypeDisplay="(Sat Service)";}else{profileDisplayText=holidayTitle;serviceTypeDisplay="(Sun Service)";}}
            let dayName=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dayOfWeek];
            if(!isBankHol){profileDisplayText=dayName;if(isSchoolHolidayPeriod_ExtraPage(now))profileDisplayText+=" (School Hol)";}
            else{profileDisplayText+=` ${serviceTypeDisplay} - Observed on a ${dayName}`;if(isSchoolHolidayPeriod_ExtraPage(now))profileDisplayText+=" (School Hol Period)";}
            if(currentProfileDisplayElement_el)currentProfileDisplayElement_el.textContent=`Today's Auto Profile: ${profileDisplayText} [Codes: ${operatingCodes.join(', ')}]`;
        }

        // --- Core Auth & UI Functions ---
        function updateAuthUI_ExtraPage(user) {
            currentUser_extra = user;
            const allToolSectionsOnThisPage = toolSectionsWrapper_el_extra.querySelectorAll('.tool-content-section');
            allToolSectionsOnThisPage.forEach(section => section.style.display = 'none'); 

            if (user) {
                if(authSection_el_extra) authSection_el_extra.style.display = 'none';
                if(topMenuBar_el_extra) topMenuBar_el_extra.style.display = 'block';
                if(logoutContainer_el_extra) logoutContainer_el_extra.style.display = 'block';
                if(authStatus_el_extra) authStatus_el_extra.textContent = '';
                if(loggedInUserEmailDisplay_el_extra) loggedInUserEmailDisplay_el_extra.textContent = user.email;
                if(currentProfileDisplayContainer_el) currentProfileDisplayContainer_el.style.display = 'block';
                
                fetchBankHolidays_ExtraPage();
                loadPageSpecificSettings_ExtraPage();
                // Load initial data, then attempt to restore last active section
                loadInitialData_ExtraPage().then(() => {
                    const lastSectionId = localStorage.getItem('lastActiveExtraSectionId_omsi');
                    if (lastSectionId) {
                        const sectionElement = document.getElementById(lastSectionId);
                        // Check if the element exists and is a valid tool content section
                        if (sectionElement && sectionElement.classList.contains('tool-content-section')) {
                            console.log("Restoring last active section:", lastSectionId);
                            showExtraPageSection(lastSectionId);
                        } else {
                            console.warn("Stored last active section ID is invalid or element not found:", lastSectionId);
                            localStorage.removeItem('lastActiveExtraSectionId_omsi'); // Clean up invalid ID
                        }
                    }
                    // If no last section or invalid, the page remains with just the top menu bar visible
                });
            } else { // User is logged out
                if(authSection_el_extra) authSection_el_extra.style.display = 'block';
                if(loginFormContainer_el_extra) loginFormContainer_el_extra.style.display = 'block';
                if(inputEmail_el_extra) inputEmail_el_extra.value = '';
                if(inputPassword_el_extra) inputPassword_el_extra.value = '';
                if(topMenuBar_el_extra) topMenuBar_el_extra.style.display = 'none';
                if(logoutContainer_el_extra) logoutContainer_el_extra.style.display = 'none';
                if(authStatus_el_extra) authStatus_el_extra.textContent = 'Please log in.';
                if(loggedInUserEmailDisplay_el_extra) loggedInUserEmailDisplay_el_extra.textContent = '';
                if(currentProfileDisplayContainer_el) currentProfileDisplayContainer_el.style.display = 'none';
                if(currentProfileDisplayElement_el) currentProfileDisplayElement_el.textContent = "Today's Auto Profile: (determining...)";
                pageSpecificSettings = {}; currentWorkingSchedule_extra = []; closedStopIDs_extra = []; 
                globalCustomRouteColours_extra = {}; stopSpecificRouteColours_extra = {};
                localStorage.removeItem('lastActiveExtraSectionId_omsi'); // Clear last section on logout
            }
        }
        async function loadInitialData_ExtraPage() { 
            if (!currentUser_extra || !window.firebaseOMSI_Extra) return; 
            console.log("Extra Page: Loading initial shared data...");
            const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI_Extra;
            try {
                const [scheduleSnap, closedSnap, globalColoursSnap, stopSpecificColoursSnap] = await Promise.all([
                    dbGet(dbChild(dbRef(database), FB_PATH_LIVE_SCHEDULE_DATA)), dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_CLOSED_STOPS)),
                    dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS)), dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS))]);
                if(scheduleSnap.exists()){ const data = scheduleSnap.val(); currentWorkingSchedule_extra = Array.isArray(data)?data.filter(e=>e!=null):(data?Object.values(data).filter(e=>e!=null):[]); currentWorkingSchedule_extra = currentWorkingSchedule_extra.map((e,i)=>({...e, internalId: e.internalId || `${(e.stopID||'s')}_${(e.lineName||'l')}_${(e.scheduledTime||"").replace(':','')}_${i}_xtra`}));} else {currentWorkingSchedule_extra=[];}
                if(closedSnap.exists()){ const fbClosed=closedSnap.val(); closedStopIDs_extra=[]; for(const id in fbClosed){if(fbClosed[id]===true)closedStopIDs_extra.push(id.toUpperCase());}} else {closedStopIDs_extra=[];}
                globalCustomRouteColours_extra = globalColoursSnap.exists() ? globalColoursSnap.val() || {} : {};
                stopSpecificRouteColours_extra = stopSpecificColoursSnap.exists() ? stopSpecificColoursSnap.val() || {} : {};
                console.log(`Extra Page: Shared data loaded. Schedule: ${currentWorkingSchedule_extra.length}.`);
                renderUIDependentElements_ExtraPage();
            } catch (error) { console.error("Extra Page: Error loading initial shared data:", error); }
        }

        function renderUIDependentElements_ExtraPage() {
            console.log("Extra Page: Rendering UI dependent on loaded data.");
            if(currentUser_extra) {
                // populateGlobalRouteToDeleteList_ExtraPage(); // Moved to showExtraPageSection for its specific section
                const visibleSection = toolSectionsWrapper_el_extra.querySelector('.tool-content-section[style*="display: block"]');
                if (visibleSection) { 
                    // If a section is already visible (e.g. due to localStorage restoration or direct click),
                    // ensure its content is up-to-date.
                    showExtraPageSection(visibleSection.id); 
                }
            }
        }

        async function loadPageSpecificSettings_ExtraPage() { 
             if (!currentUser_extra || !window.firebaseOMSI_Extra) return; const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI_Extra;
            try { const snapshot = await dbGet(dbChild(dbRef(database), FB_PATH_PAGE_EXTRA_SETTINGS)); if (snapshot.exists()) { pageSpecificSettings = snapshot.val(); } else { pageSpecificSettings = { /* Defaults */}; }
                console.log("Extra Page: Page-specific settings loaded/reset.", pageSpecificSettings);
            } catch (error) { console.error("Extra Page: Error loading page-specific settings:", error); }
        }
        async function autoSavePageSpecificSettings_ExtraPage() { 
            if (!currentUser_extra || !window.firebaseOMSI_Extra) { console.warn("Cannot auto-save: Not logged in or Firebase not ready."); return;}
            console.log("Auto-saving pageSpecificSettings:", pageSpecificSettings);
            const { database, dbSet, dbRef } = window.firebaseOMSI_Extra; try { await dbSet(dbRef(database, FB_PATH_PAGE_EXTRA_SETTINGS), pageSpecificSettings); console.log("Extra Page: Page-specific settings auto-saved.");} catch (error) { console.error("Extra Page: Firebase Auto-Save Error for page-specific settings: ", error); }
        }

        function showExtraPageSection(sectionId) {
            const allToolSectionsOnThisPage = toolSectionsWrapper_el_extra.querySelectorAll('.tool-content-section');
            allToolSectionsOnThisPage.forEach(section => { section.style.display = 'none'; });
            const sectionToShow = document.getElementById(sectionId);

            if (sectionToShow) {
                sectionToShow.style.display = 'block';
                if (currentUser_extra) { 
                    localStorage.setItem('lastActiveExtraSectionId_omsi', sectionId);
                }
                // Section specific initializations
                if (sectionId === 'day-profile-override-section_extra') { 
                    loadAndDisplayActiveOverrides_ExtraPage(); 
                    if (overrideDateInput_el_extra && !overrideDateInput_el_extra.value) { 
                        const today = new Date(); 
                        overrideDateInput_el_extra.value = getYYYYMMDD_ExtraPage(today); 
                    } 
                    if (overrideDateInput_el_extra && overrideDateInput_el_extra.value) { 
                        handleOverrideDateChange_ExtraPage(); 
                    }
                } else if (sectionId === 'stop-manager-tool-section_extra') {
                    populateMasterStopList_ExtraPage();
                    if(newStopIdAvailability_el_extra) newStopIdAvailability_el_extra.textContent='';
                    if(addNewStopStatus_el_extra) addNewStopStatus_el_extra.textContent='Select format/name to auto-suggest ID.'; // Default message
                    if(masterStopListStatus_el_extra && masterStopListUL_el_extra.children.length===0) masterStopListStatus_el_extra.textContent='Click "Refresh List" or filter.';
                    if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.textContent = '';
                    // Auto-suggest ID when section is shown, if a format is selected
                    if (selectNewStopIdFormat_el_extra && selectNewStopIdFormat_el_extra.value && inputNewStopId_el_extra) {
                        autoGenerateAndSetNewStopId_ExtraPage();
                    }
                } else if (sectionId === 'global-route-deletion-section_extra') { 
                    populateGlobalRouteToDeleteList_ExtraPage(); 
                    if(deleteEntireRouteStatusMessage_el_extra) deleteEntireRouteStatusMessage_el_extra.textContent = 'Select route tiles to delete.'; 
                }
            } else { 
                console.warn("Section ID not found on extra page:", sectionId);
                if (currentUser_extra) { 
                    localStorage.removeItem('lastActiveExtraSectionId_omsi');
                }
            }
        }

        // --- Helper Functions (Copied/Adapted) ---
        function getYYYYMMDD_ExtraPage(dateSource) {  let dateObj; if (dateSource instanceof Date){dateObj=dateSource;} else if(typeof dateSource === 'string' && dateSource.match(/^\d{4}-\d{2}-\d{2}$/)){dateObj=new Date(dateSource+"T00:00:00Z");} else if(dateSource && dateSource.value && typeof dateSource.value === 'string'){if(!dateSource.value)return null; dateObj=new Date(dateSource.value+"T00:00:00Z");} else {return null;} if(isNaN(dateObj.getTime()))return null; const year = dateObj.getUTCFullYear(); const month = String(dateObj.getUTCMonth()+1).padStart(2,'0'); const day = String(dateObj.getUTCDate()).padStart(2,'0'); return `${year}-${month}-${day}`; }
        function formatDateToDDMonthYYYY_ExtraPage(dateStringYYYYMMDD) { if(!dateStringYYYYMMDD || !dateStringYYYYMMDD.match(/^\d{4}-\d{2}-\d{2}$/)){return"(select a date)";}try{const parts=dateStringYYYYMMDD.split('-');const year=parseInt(parts[0],10);const month=parseInt(parts[1],10)-1;const day=parseInt(parts[2],10);const dateObj=new Date(Date.UTC(year,month,day));if(isNaN(dateObj.getTime()))return dateStringYYYYMMDD;const options={day:'numeric',month:'long',year:'numeric',timeZone:'UTC'};return dateObj.toLocaleDateString('en-GB',options);}catch(e){return dateStringYYYYMMDD;}}
        function getUniqueStopsFromSchedule_ExtraPage() { if(!currentWorkingSchedule_extra || currentWorkingSchedule_extra.length === 0) return []; const stopsMap = new Map(); currentWorkingSchedule_extra.forEach(entry => { if (entry.stopID && !stopsMap.has(entry.stopID.toUpperCase())) { stopsMap.set(entry.stopID.toUpperCase(), {stopID: entry.stopID, stopName: entry.stopName || "Unknown", direction: entry.direction || "" });}}); return Array.from(stopsMap.values()).sort((a,b)=>(String(a.stopName||"").toLowerCase()).localeCompare(String(b.stopName||"").toLowerCase()));}
        function parseLineName_ExtraPage(lineNameStr) { const name=String(lineNameStr||"").toUpperCase().trim(); const numPrefixRegex=/^(\d+)([A-Z]*)$/; const alphaNumRegex=/^([A-Z]+)(\d+)?([A-Z]*)$/; const numMatch=name.match(numPrefixRegex); if(numMatch)return{type:'numeric',num:parseInt(numMatch[1],10),suf:numMatch[2]||'',original:name}; const alphaMatch=name.match(alphaNumRegex); if(alphaMatch)return{type:'alpha',pre:alphaMatch[1],num:alphaMatch[2]?parseInt(alphaMatch[2],10):null,suf:alphaMatch[3]||'',original:name}; return{type:'other',original:name};}
        function compareLineNames_ExtraPage(a,b) { const pA=parseLineName_ExtraPage(a);const pB=parseLineName_ExtraPage(b);if(pA.type==='numeric'&&pB.type==='alpha')return -1;if(pA.type==='alpha'&&pB.type==='numeric')return 1;if(pA.type==='numeric'&&pB.type==='numeric'){if(pA.num!==pB.num)return pA.num-pB.num;return pA.suf.localeCompare(pB.suf);}if(pA.type==='alpha'&&pB.type==='alpha'){if(pA.pre!==pB.pre)return pA.pre.localeCompare(pB.pre);if(pA.num!==pB.num)return(pA.num||0)-(pB.num||0);return pA.suf.localeCompare(pB.suf);}return(pA.original||"").localeCompare(pB.original||"");}
        function getRouteTileColour_ExtraPage(lineName, stopID = null) { const upName=String(lineName||"").toUpperCase();if(stopID&&stopSpecificRouteColours_extra[stopID.toUpperCase()]&&stopSpecificRouteColours_extra[stopID.toUpperCase()][upName]){return stopSpecificRouteColours_extra[stopID.toUpperCase()][upName];} if(globalCustomRouteColours_extra[upName])return globalCustomRouteColours_extra[upName]; const NIGHT_BUS_BLUE_COLOR="#4CDBE6";const DEFAULT_ROUTE_COLOUR="#73809C"; const SCHOOL_BUS_COLOR="#AC5099"; if(upName.startsWith("N"))return globalCustomRouteColours_extra["NIGHT_DEFAULT"]||NIGHT_BUS_BLUE_COLOR; if(upName.includes("SCH"))return globalCustomRouteColours_extra["SCHOOL_DEFAULT"]||SCHOOL_BUS_COLOR; if(upName.startsWith("SL"))return globalCustomRouteColours_extra["SL_DEFAULT"]||"#D32F2F"; return DEFAULT_ROUTE_COLOUR;}
        function getTextColourForBackground_ExtraPage(hex) { if(!hex||hex.length<7)return'#FFFFFF';const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return((0.299*r+0.587*g+0.114*b)/255)>0.5?'#000000':'#FFFFFF';}

        // --- Functions for Day Profile Override Tool ---
        let isFetchingProfileForDate_el_extra = false;
        async function displayAutoCalculatedProfileForDate_ExtraPage(dateString) { if(!dateString||isFetchingProfileForDate_el_extra){if(!dateString&&autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent="(select a date)";return;} isFetchingProfileForDate_el_extra=true; if(autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent="(calculating...)"; if((!ukBankHolidaysData_extra.dates||ukBankHolidaysData_extra.dates.length===0)&&!fetchBankHolidays_ExtraPage.isRunning){fetchBankHolidays_ExtraPage.isRunning=true;await fetchBankHolidays_ExtraPage();fetchBankHolidays_ExtraPage.isRunning=false;} const dateObj=new Date(dateString+"T00:00:00Z"); if(isNaN(dateObj.getTime())){if(autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent="(invalid date)";isFetchingProfileForDate_el_extra=false;return;} const codes=getOperatingCodesForDate_ExtraPage(dateObj); if(autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent=codes.length>0?codes.join(', '):"None"; isFetchingProfileForDate_el_extra=false;}
        fetchBankHolidays_ExtraPage.isRunning = false;
        async function handleOverrideDateChange_ExtraPage() { if(!overrideDateInput_el_extra||!window.firebaseOMSI_Extra)return; const selectedDateStr=overrideDateInput_el_extra.value; const formattedDateForDisplay=formatDateToDDMonthYYYY_ExtraPage(selectedDateStr); if(selectedDateDisplay_el_extra){selectedDateDisplay_el_extra.textContent=formattedDateForDisplay;} if(autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent="(calculating...)"; if(currentOverrideForSelectedDate_el_extra)currentOverrideForSelectedDate_el_extra.textContent="(checking...)"; if(clearOverrideButton_el_extra)clearOverrideButton_el_extra.style.display='none'; if(overrideProfileInput_el_extra)overrideProfileInput_el_extra.value=''; if(!selectedDateStr){if(autoProfileForSelectedDate_el_extra)autoProfileForSelectedDate_el_extra.textContent="(select a date)"; if(currentOverrideForSelectedDate_el_extra)currentOverrideForSelectedDate_el_extra.textContent="(select a date)"; return;} await displayAutoCalculatedProfileForDate_ExtraPage(selectedDateStr); const{database,dbGet,dbRef,dbChild}=window.firebaseOMSI_Extra; const overridePath=`${FB_PATH_OPERATIONAL_OVERRIDES}/${selectedDateStr}/profile`; try{const snapshot=await dbGet(dbChild(dbRef(database),overridePath)); if(snapshot.exists()){const existingOverride=snapshot.val(); if(currentOverrideForSelectedDate_el_extra)currentOverrideForSelectedDate_el_extra.textContent=existingOverride; if(overrideProfileInput_el_extra)overrideProfileInput_el_extra.value=existingOverride; if(clearOverrideButton_el_extra)clearOverrideButton_el_extra.style.display='inline-block';}else{if(currentOverrideForSelectedDate_el_extra)currentOverrideForSelectedDate_el_extra.textContent="(none)"; if(clearOverrideButton_el_extra)clearOverrideButton_el_extra.style.display='none';}}catch(error){console.error("Error fetching override:",error); if(currentOverrideForSelectedDate_el_extra)currentOverrideForSelectedDate_el_extra.textContent="(error)"; if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Error checking override.";overrideStatusMessage_el_extra.style.color="#e74c3c";}}}
        async function loadAndDisplayActiveOverrides_ExtraPage() { if(!activeOverridesList_el_extra||!window.firebaseOMSI_Extra)return; activeOverridesList_el_extra.innerHTML='<p>Loading...</p>'; const{database,dbGet,dbRef,dbChild}=window.firebaseOMSI_Extra; try{const snapshot=await dbGet(dbChild(dbRef(database),FB_PATH_OPERATIONAL_OVERRIDES)); if(snapshot.exists()){const allOverrides=snapshot.val();let html='';const todayForCompare=new Date();todayForCompare.setHours(0,0,0,0);const thirtyDaysFromNow=new Date(todayForCompare.getTime()+30*24*60*60*1000);const relevantOverrides=[];for(const dateStr in allOverrides){if(allOverrides[dateStr]&&allOverrides[dateStr].profile){const overrideDate=new Date(dateStr+"T00:00:00Z");if(isNaN(overrideDate.getTime()))continue;if(overrideDate>=todayForCompare&&overrideDate<=thirtyDaysFromNow){relevantOverrides.push({date:dateStr,profile:allOverrides[dateStr].profile});}}} relevantOverrides.sort((a,b)=>a.date.localeCompare(b.date));if(relevantOverrides.length===0){html='<p>No active overrides (today or next 30 days).</p>';}else{html+='<ul style="list-style-type: none; padding-left:0;">';relevantOverrides.forEach(item=>{const formattedDisplayDate=formatDateToDDMonthYYYY_ExtraPage(item.date);html+=`<li style="padding:0.2rem 0;border-bottom:1px solid rgba(255,255,255,0.1);"><strong style="min-width:150px;display:inline-block;">${formattedDisplayDate}:</strong> ${item.profile}</li>`;});html+='</ul>';} activeOverridesList_el_extra.innerHTML=html;}else{activeOverridesList_el_extra.innerHTML='<p>No overrides set.</p>';}}catch(error){console.error("Error loading overrides:",error);activeOverridesList_el_extra.innerHTML='<p>Error loading.</p>';}}
        function handleSetProfileOverride_ExtraPage() { if(!currentUser_extra||!window.firebaseOMSI_Extra){alert("Please log in.");return;} const dateStr=overrideDateInput_el_extra.value;const profileStr=overrideProfileInput_el_extra.value.trim(); if(!dateStr){if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Select date.";overrideStatusMessage_el_extra.style.color="#f1c40f";}return;} if(!profileStr){if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Enter profile.";overrideStatusMessage_el_extra.style.color="#f1c40f";}return;} const{database,dbSet,dbRef}=window.firebaseOMSI_Extra; const overridePath=`${FB_PATH_OPERATIONAL_OVERRIDES}/${dateStr}/profile`; if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Setting...";overrideStatusMessage_el_extra.style.color="#f1c40f";} dbSet(dbRef(database,overridePath),profileStr).then(()=>{if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent=`Override set for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)} to "${profileStr}".`;overrideStatusMessage_el_extra.style.color="#2ecc71";} handleOverrideDateChange_ExtraPage();loadAndDisplayActiveOverrides_ExtraPage();}).catch(error=>{if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Error setting.";overrideStatusMessage_el_extra.style.color="#e74c3c";}}); }
        function handleClearProfileOverride_ExtraPage() { if(!currentUser_extra||!window.firebaseOMSI_Extra){alert("Please log in.");return;} const dateStr=overrideDateInput_el_extra.value; if(!dateStr){if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Select date.";overrideStatusMessage_el_extra.style.color="#f1c40f";}return;} if(!confirm(`Clear override for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)}?`))return; const{database,dbRemove,dbRef}=window.firebaseOMSI_Extra; const profileOverridePath=`${FB_PATH_OPERATIONAL_OVERRIDES}/${dateStr}/profile`; if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Clearing...";overrideStatusMessage_el_extra.style.color="#f1c40f";} dbRemove(dbRef(database,profileOverridePath)).then(()=>{if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent=`Override cleared for ${formatDateToDDMonthYYYY_ExtraPage(dateStr)}.`;overrideStatusMessage_el_extra.style.color="#2ecc71";} if(overrideProfileInput_el_extra)overrideProfileInput_el_extra.value=''; handleOverrideDateChange_ExtraPage();loadAndDisplayActiveOverrides_ExtraPage();}).catch(error=>{if(overrideStatusMessage_el_extra){overrideStatusMessage_el_extra.textContent="Error clearing.";overrideStatusMessage_el_extra.style.color="#e74c3c";}}); }

        // --- START: Merged Stop Management & Add/Remove Stop ---
        function generateUniqueStopId_ExtraPage(format, stopName = "") { 
            if (!currentWorkingSchedule_extra) { console.warn("Suggest ID: CW_extra not available."); const tempPrefix = (format && format !== "NUM") ? format : "ID"; return tempPrefix + String(Date.now()).slice(-5); }
            const allExistingStopIDsUpper = new Set(currentWorkingSchedule_extra.map(entry => entry.stopID.toUpperCase()));
            const targetBaseName = getBaseStopName_ExtraPage(stopName).toUpperCase(); 

            let prefix = ""; let numericRegex; let baseStartNumber = 1;
            switch (format) { case "NUM": prefix = ""; numericRegex = /^(\d+)$/; baseStartNumber = 101; break; case "BP": prefix = "BP"; numericRegex = /^BP(\d+)$/; break; case "LE": prefix = "LE"; numericRegex = /^LE(\d+)$/; break; case "RO": prefix = "RO"; numericRegex = /^RO(\d+)$/; break; default: if (/^[A-Z]+$/.test(format)) { prefix = format.toUpperCase(); numericRegex = new RegExp(`^${prefix}(\\d+)$`); } else { prefix = ""; numericRegex = /^(\d+)$/; baseStartNumber = 101; } break; }
            
            let highestNumInNameSequence = 0; let nameSpecificSequenceFound = false;
            if (targetBaseName) {
                currentWorkingSchedule_extra.forEach(entry => {
                    if (entry.stopName) {
                        const existingEntryBaseName = getBaseStopName_ExtraPage(entry.stopName).toUpperCase();
                        if (existingEntryBaseName === targetBaseName) {
                            const match = entry.stopID.toUpperCase().match(numericRegex);
                            if (match && match[1]) { const numPart = parseInt(match[1], 10); if (!isNaN(numPart) && numPart > highestNumInNameSequence) highestNumInNameSequence = numPart; nameSpecificSequenceFound = true; }
                        }
                    }
                });
            }
            let nextNumInSequence;
            if (nameSpecificSequenceFound) { nextNumInSequence = highestNumInNameSequence + 1; } 
            else {
                let highestGlobalNumForPrefix = 0;
                allExistingStopIDsUpper.forEach(id => { const match = id.match(numericRegex); if (match && match[1]) { const numPart = parseInt(match[1], 10); if (!isNaN(numPart) && numPart > highestGlobalNumForPrefix) highestGlobalNumForPrefix = numPart; }});
                nextNumInSequence = (highestGlobalNumForPrefix > 0) ? highestGlobalNumForPrefix + 1 : baseStartNumber;
                if (nextNumInSequence < baseStartNumber) nextNumInSequence = baseStartNumber;
            }
            let attempts = 0; const maxAttempts = 200000; let candidateId = "";
            while (attempts < maxAttempts) {
                candidateId = prefix + nextNumInSequence; if (!allExistingStopIDsUpper.has(candidateId.toUpperCase())) return candidateId;
                nextNumInSequence++; attempts++;
                if (nextNumInSequence > baseStartNumber + maxAttempts -10 && attempts > maxAttempts - 20) { console.warn("Suggest ID: High iteration count for", format, stopName, nextNumInSequence); }
            }
            console.warn(`Could not generate unique Stop ID for format: ${format}, name: ${stopName}. Fallback.`);
            return prefix + String(Date.now()).slice(-4) + String(Math.floor(Math.random() * 90) + 10);
        }
        function getBaseStopName_ExtraPage(fullStopName) {
            if (!fullStopName || typeof fullStopName !== 'string') return "";
            return fullStopName.replace(/\s*\([^)]*\)\s*$/, '').trim();
        }
        
        function autoGenerateAndSetNewStopId_ExtraPage() {
            if (!currentUser_extra || !selectNewStopIdFormat_el_extra || !inputNewStopId_el_extra || !inputNewStopName_el_extra) {
                return;
            }
            const selectedFormat = selectNewStopIdFormat_el_extra.value;
            const currentStopName = inputNewStopName_el_extra.value.trim();

            if (!selectedFormat) { return; }

            const suggestedId = generateUniqueStopId_ExtraPage(selectedFormat, currentStopName);
            inputNewStopId_el_extra.value = suggestedId;
            inputNewStopId_el_extra.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));

            if (addNewStopStatus_el_extra) {
                let message = `Auto-suggested ID. Format: "${selectedFormat}"`;
                if (currentStopName) {
                    message += `, Name: "${currentStopName.substring(0,15)}${currentStopName.length > 15 ? '...' : ''}".`;
                } else {
                    message += ".";
                }
                message += " You can edit this ID."
                addNewStopStatus_el_extra.textContent = message;
                addNewStopStatus_el_extra.style.color = '#bdc3c7';
            }
        }

        async function handleAddStopDetails_ExtraPage() { 
            if(!currentUser_extra){alert("Log in.");return;} 
            const newStopID=inputNewStopId_el_extra.value.trim().toUpperCase(); 
            const newStopName=inputNewStopName_el_extra.value.trim(); 
            const newStopDirection=inputNewStopDirection_el_extra.value.trim(); 
            if(!newStopID){addNewStopStatus_el_extra.textContent="New Stop ID is required.";addNewStopStatus_el_extra.style.color='#e74c3c';return;} 
            if(!/^[A-Z0-9]+$/.test(newStopID)){addNewStopStatus_el_extra.textContent="New Stop ID can only contain A-Z and 0-9.";addNewStopStatus_el_extra.style.color='#e74c3c';return;} 
            if(!newStopName){addNewStopStatus_el_extra.textContent="New Stop Name is required.";addNewStopStatus_el_extra.style.color='#e74c3c';return;} 
            if(currentWorkingSchedule_extra.some(e=>e.stopID.toUpperCase()===newStopID)){
                addNewStopStatus_el_extra.textContent=`Stop ID "${newStopID}" already exists. Please choose a unique ID.`; 
                addNewStopStatus_el_extra.style.color='#e74c3c';
                if(newStopIdAvailability_el_extra){newStopIdAvailability_el_extra.textContent='ID exists.';newStopIdAvailability_el_extra.style.color='#e74c3c';} 
                return;
            } 
            const placeholderEntry={internalId:`${newStopID}_placeholder_${Date.now()}`,stopID:newStopID,stopName:newStopName,direction:newStopDirection,lineName:"INFO_ONLY",destinationName:"Stop Definition Placeholder",scheduledTime:"00:00",OperatingProfile:"AllDays",DayOffset:"0"}; 
            currentWorkingSchedule_extra.push(placeholderEntry); 
            try {
                await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);
                addNewStopStatus_el_extra.textContent=`Stop "${newStopID}" added successfully (live).`;
                addNewStopStatus_el_extra.style.color='#2ecc71';
                inputNewStopId_el_extra.value='';inputNewStopName_el_extra.value='';inputNewStopDirection_el_extra.value='';
                if(newStopIdAvailability_el_extra)newStopIdAvailability_el_extra.textContent='';
                if(selectNewStopIdFormat_el_extra)selectNewStopIdFormat_el_extra.selectedIndex=0; // Reset format dropdown
                autoGenerateAndSetNewStopId_ExtraPage(); // Suggest ID for the next stop
                renderUIDependentElements_ExtraPage(); // Refresh lists
            } catch(error) {
                addNewStopStatus_el_extra.textContent="Error saving new stop to database.";
                addNewStopStatus_el_extra.style.color='#e74c3c';
                currentWorkingSchedule_extra=currentWorkingSchedule_extra.filter(e=>e.internalId!==placeholderEntry.internalId); // Rollback
                console.error("Error adding new stop:", error);
            }
        }
        
        function populateMasterStopList_ExtraPage() {
            if (!masterStopListUL_el_extra || !masterStopListStatus_el_extra) return;
            uniqueStopsMasterList_extra = getUniqueStopsFromSchedule_ExtraPage();
            const filterText = masterStopListFilterInput_el_extra.value.toLowerCase().trim();
            masterStopListUL_el_extra.innerHTML = '';
            let displayedCount = 0;

            if (uniqueStopsMasterList_extra.length === 0) {
                masterStopListStatus_el_extra.textContent = 'No stops loaded in current data.';
                return;
            }

            uniqueStopsMasterList_extra.forEach(stop => {
                if (!stop || !stop.stopID) return;

                const servingRoutesData = new Map();
                let hasNightBusService = false;
                let hasDayBusService = false;
                const stopTimes = [];

                currentWorkingSchedule_extra.forEach(entry => {
                    if (entry.stopID === stop.stopID && entry.lineName) {
                        if (entry.lineName !== "INFO_ONLY") {
                           if (entry.scheduledTime) stopTimes.push(entry.scheduledTime);
                        }
                        if (!servingRoutesData.has(entry.lineName)) servingRoutesData.set(entry.lineName, {});
                        const tileColor = getRouteTileColour_ExtraPage(entry.lineName, stop.stopID).toUpperCase();
                        if (tileColor === (globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6").toUpperCase()) hasNightBusService = true;
                        if (tileColor !== (globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6").toUpperCase()) hasDayBusService = true;
                    }
                });

                let firstBusTimeStr = 'N/A';
                let lastBusTimeStr = 'N/A';
                if (stopTimes.length > 0) {
                    stopTimes.sort(); 
                    firstBusTimeStr = stopTimes[0];
                    lastBusTimeStr = stopTimes[stopTimes.length - 1];
                }

                const sortedServingRouteNames = Array.from(servingRoutesData.keys()).sort(compareLineNames_ExtraPage);
                const isClosed = closedStopIDs_extra.includes(stop.stopID.toUpperCase());
                const closureStatus = isClosed ? "Closed" : "Open";
                const is24HourStop = hasNightBusService && hasDayBusService;

                const matchesFilter = !filterText ||
                    stop.stopID.toLowerCase().includes(filterText) ||
                    (stop.stopName || "").toLowerCase().includes(filterText) ||
                    (stop.direction || "").toLowerCase().includes(filterText) ||
                    sortedServingRouteNames.some(rn => rn.toLowerCase().includes(filterText)) ||
                    closureStatus.toLowerCase().includes(filterText) ||
                    (!is24HourStop && (firstBusTimeStr.toLowerCase().includes(filterText) || lastBusTimeStr.toLowerCase().includes(filterText))) || 
                    (is24HourStop && "24 hours".includes(filterText));

                if (matchesFilter) {
                    displayedCount++;
                    const li = document.createElement('li');
                    li.className = 'master-stop-list-item';
                    li.dataset.stopid = stop.stopID;

                    const originalInfoDiv = document.createElement('div');
                    originalInfoDiv.className = 'master-stop-original-info';
                    let originalInfoContent = `<span class="stop-name-master">${stop.stopName}</span><br>
                                           <span class="stop-direction-master">towards ${stop.direction}</span><br>
                                           <span class="stop-id-master">Stop ID: ${stop.stopID}</span><br>`;
                    if (sortedServingRouteNames.length > 0) {
                        originalInfoContent += `<div class="serving-routes-container">`;
                        sortedServingRouteNames.forEach(ln => {
                            const bg = getRouteTileColour_ExtraPage(ln, stop.stopID);
                            const tc = getTextColourForBackground_ExtraPage(bg);
                            originalInfoContent += `<span class="route-tile-tools-list" style="background-color:${bg};color:${tc};">${ln}</span>`;
                        });
                        originalInfoContent += `</div>`;
                    }
                    originalInfoContent += `<div class="stop-details-grid">
                                               <span class="detail-label">Status:</span> <span class="detail-value status-${closureStatus.toLowerCase()}">${closureStatus}</span>`;
                    if (is24HourStop) {
                        originalInfoContent += `<span class="detail-label">Service:</span> <span class="detail-value" style="color:${(globalCustomRouteColours_extra["NIGHT_DEFAULT"] || "#4CDBE6")};font-weight:bold;">24 Hours</span>`;
                    } else {
                        originalInfoContent += `<span class="detail-label">First Bus:</span> <span class="detail-value">${firstBusTimeStr}</span>`;
                        originalInfoContent += `<span class="detail-label">Last Bus:</span> <span class="detail-value">${lastBusTimeStr}</span>`;
                    }
                    originalInfoContent += `</div>`;
                    originalInfoDiv.innerHTML = originalInfoContent;

                    const newIdSectionDiv = document.createElement('div');
                    newIdSectionDiv.className = 'master-stop-new-id-section';
                    const newIdLabel = document.createElement('label');
                    newIdLabel.htmlFor = `masterNewId_${stop.stopID}`;
                    newIdLabel.textContent = 'New Stop ID:';
                    const newIdInput = document.createElement('input');
                    newIdInput.type = 'text';
                    newIdInput.id = `masterNewId_${stop.stopID}`;
                    newIdInput.className = 'schedule-generator-input master-list-new-id-input';
                    newIdInput.value = stop.stopID;
                    newIdInput.dataset.originalId = stop.stopID;
                    newIdInput.dataset.originalName = stop.stopName || "Unknown";
                    newIdInput.dataset.originalDirection = stop.direction || "";
                    newIdInput.placeholder = "Enter new ID or leave as is";
                    newIdInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                        const warningDiv = e.target.nextElementSibling;
                        if (e.target.value && !/^[A-Z0-9]+$/.test(e.target.value)) {
                            warningDiv.textContent = "Invalid format (A-Z, 0-9 only).";
                        } else {
                            warningDiv.textContent = "";
                        }
                    });
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'master-list-row-warning';

                    newIdSectionDiv.appendChild(newIdLabel);
                    newIdSectionDiv.appendChild(newIdInput);
                    newIdSectionDiv.appendChild(warningDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'master-stop-actions';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'button small-action'; editBtn.textContent = 'Edit Name / Direction';
                    editBtn.addEventListener('click', () => handleEditStopFromMasterList_ExtraPage(stop.stopID, stop.stopName, stop.direction));
                    actionsDiv.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'button small-action secondary'; deleteBtn.textContent = 'Delete Stop';
                    deleteBtn.addEventListener('click', () => handleDeleteStopFromMasterList_ExtraPage(stop.stopID));
                    actionsDiv.appendChild(deleteBtn);

                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = `button small-action ${isClosed ? "tertiary" : "secondary"}`;
                    toggleBtn.textContent = isClosed ? "Re-Open Stop" : "Close Stop";
                    toggleBtn.addEventListener('click', () => handleToggleStopStatusFromMasterList_ExtraPage(stop.stopID));
                    actionsDiv.appendChild(toggleBtn);

                    li.appendChild(originalInfoDiv);
                    li.appendChild(newIdSectionDiv);
                    li.appendChild(actionsDiv);
                    masterStopListUL_el_extra.appendChild(li);
                }
            });
            masterStopListStatus_el_extra.textContent = `Showing ${displayedCount} of ${uniqueStopsMasterList_extra.length} stops. Filter: ${filterText ? filterText : 'none'}`;
        }
        async function handleEditStopFromMasterList_ExtraPage(stopID, currentName, currentDirection) { if(!currentUser_extra){alert("Log in.");return;} const newStopName=prompt(`Editing Stop: ${stopID}\nNew Name (current: "${currentName}"):`,currentName);if(newStopName===null)return; const newDirection=prompt(`Editing Stop: ${stopID}\nNew "Towards" (current: "${currentDirection}"):`,currentDirection);if(newDirection===null)return; if(newStopName.trim()===currentName.trim()&&newDirection.trim()===currentDirection.trim()){if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent="No changes made.";return;} let updatedCount=0;currentWorkingSchedule_extra.forEach(e=>{if(e.stopID===stopID){e.stopName=newStopName.trim();e.direction=newDirection.trim();updatedCount++;}}); if(updatedCount>0){try{await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent=`${updatedCount} entries for ${stopID} updated (live).`;renderUIDependentElements_ExtraPage();}catch(err){if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent="Error saving edits.";console.error(err);}}else{if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent=`No entries for ${stopID} found.`;}}
        async function handleDeleteStopFromMasterList_ExtraPage(stopIdToRemove) { if(!currentUser_extra){alert("Log in.");return;} const stopDetails=uniqueStopsMasterList_extra.find(s=>s.stopID===stopIdToRemove); const stopNameToConfirm=stopDetails?`${stopDetails.stopName} (${stopIdToRemove})`:stopIdToRemove; if(!confirm(`ARE YOU SURE to remove stop "${stopNameToConfirm}" and ALL schedule entries (LIVE)?`))return; const initialLength=currentWorkingSchedule_extra.length; currentWorkingSchedule_extra=currentWorkingSchedule_extra.filter(e=>e.stopID.toUpperCase()!==stopIdToRemove.toUpperCase()); const removedCount=initialLength-currentWorkingSchedule_extra.length; if(closedStopIDs_extra.includes(stopIdToRemove.toUpperCase()))closedStopIDs_extra=closedStopIDs_extra.filter(id=>id!==stopIdToRemove.toUpperCase()); if(stopSpecificRouteColours_extra[stopIdToRemove.toUpperCase()])delete stopSpecificRouteColours_extra[stopIdToRemove.toUpperCase()]; try{await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra); await saveClosedStopsToFirebase_ExtraPage(); await saveStopSpecificColoursToFirebase_ExtraPage(); if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent=`Stop "${stopNameToConfirm}" & ${removedCount} entries removed (live).`; renderUIDependentElements_ExtraPage();}catch(err){if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent="Error deleting stop.";console.error(err);}}
        async function handleToggleStopStatusFromMasterList_ExtraPage(stopID) { if(!currentUser_extra){alert("Log in.");return;} const stopIdUpper=stopID.toUpperCase();const idx=closedStopIDs_extra.indexOf(stopIdUpper); if(idx===-1)closedStopIDs_extra.push(stopIdUpper);else closedStopIDs_extra.splice(idx,1); try{await saveClosedStopsToFirebase_ExtraPage();populateMasterStopList_ExtraPage();}catch(err){if(masterStopListStatus_el_extra)masterStopListStatus_el_extra.textContent="Error toggling status.";console.error(err);}}

        // Global Route Deletion
        function populateGlobalRouteToDeleteList_ExtraPage() {
            if (!globalRouteDeletionListContainer_el_extra) return;
            globalRouteDeletionListContainer_el_extra.innerHTML = ''; 

            if (!currentWorkingSchedule_extra || currentWorkingSchedule_extra.length === 0) {
                globalRouteDeletionListContainer_el_extra.innerHTML = '<p>-- No Routes Available in Schedule --</p>';
                return;
            }

            const uniqueRoutes = [...new Set(currentWorkingSchedule_extra.map(e => e.lineName).filter(Boolean))].sort(compareLineNames_ExtraPage);

            if (uniqueRoutes.length === 0) {
                globalRouteDeletionListContainer_el_extra.innerHTML = '<p>-- No Routes Found --</p>';
                return;
            }

            const tileContainer = document.createElement('div');
            tileContainer.className = 'selectable-route-tile-container';

            uniqueRoutes.forEach(lineName => {
                const tile = document.createElement('span'); 
                tile.className = 'selectable-route-tile';
                tile.textContent = lineName;
                tile.dataset.routeName = lineName;

                const bgColor = getRouteTileColour_ExtraPage(lineName);
                const textColor = getTextColourForBackground_ExtraPage(bgColor);
                tile.style.backgroundColor = bgColor;
                tile.style.color = textColor;
                
                tile.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const selectedCount = globalRouteDeletionListContainer_el_extra.querySelectorAll('.selectable-route-tile.selected').length;
                    if (deleteEntireRouteStatusMessage_el_extra) { 
                        if (selectedCount > 0) {
                            deleteEntireRouteStatusMessage_el_extra.textContent = `${selectedCount} route(s) selected.`;
                            deleteEntireRouteStatusMessage_el_extra.style.color = '#bdc3c7'; 
                        } else {
                            deleteEntireRouteStatusMessage_el_extra.textContent = 'Select route tiles to delete.';
                        }
                    }
                });
                tileContainer.appendChild(tile);
            });
            globalRouteDeletionListContainer_el_extra.appendChild(tileContainer);
        }
        async function handleDeleteEntireRouteGlobally_ExtraPage() {
            if (!currentUser_extra) { alert("Log in."); return; }

            const selectedTiles = globalRouteDeletionListContainer_el_extra.querySelectorAll('.selectable-route-tile.selected');
            const lineNamesToDelete = Array.from(selectedTiles).map(tile => tile.dataset.routeName);

            if (lineNamesToDelete.length === 0) {
                if (deleteEntireRouteStatusMessage_el_extra) {
                    deleteEntireRouteStatusMessage_el_extra.textContent = "No routes selected for deletion.";
                    deleteEntireRouteStatusMessage_el_extra.style.color = "#f1c40f"; 
                }
                return;
            }

            if (!confirm(`EXTREME CAUTION! You are about to delete ALL data for the following ${lineNamesToDelete.length} route(s) GLOBALLY (LIVE):\n\n${lineNamesToDelete.join('\n')}\n\nThis action CANNOT BE UNDONE. Proceed?`)) {
                if (deleteEntireRouteStatusMessage_el_extra) {
                    deleteEntireRouteStatusMessage_el_extra.textContent = "Global route deletion cancelled.";
                    deleteEntireRouteStatusMessage_el_extra.style.color = "#7f8c8d";
                }
                return;
            }

            if (deleteEntireRouteStatusMessage_el_extra) {
                deleteEntireRouteStatusMessage_el_extra.textContent = "Processing deletions...";
                deleteEntireRouteStatusMessage_el_extra.style.color = "#f1c40f";
            }

            let globalColourModified = false;
            let specificColoursModified = false;
            const lineNamesToDeleteUpper = lineNamesToDelete.map(name => name.toUpperCase());

            currentWorkingSchedule_extra = currentWorkingSchedule_extra.filter(entry =>
                !(entry.lineName && lineNamesToDeleteUpper.includes(entry.lineName.toUpperCase()))
            );

            lineNamesToDeleteUpper.forEach(lineToDeleteUpper => {
                if (globalCustomRouteColours_extra[lineToDeleteUpper]) {
                    delete globalCustomRouteColours_extra[lineToDeleteUpper];
                    globalColourModified = true;
                }
            });

            Object.keys(stopSpecificRouteColours_extra).forEach(stopID => {
                let modifiedForThisStop = false;
                lineNamesToDeleteUpper.forEach(lineToDeleteUpper => {
                    if (stopSpecificRouteColours_extra[stopID] && stopSpecificRouteColours_extra[stopID][lineToDeleteUpper]) {
                        delete stopSpecificRouteColours_extra[stopID][lineToDeleteUpper];
                        modifiedForThisStop = true;
                    }
                });
                if (modifiedForThisStop && Object.keys(stopSpecificRouteColours_extra[stopID]).length === 0) {
                    delete stopSpecificRouteColours_extra[stopID];
                }
                if (modifiedForThisStop) {
                    specificColoursModified = true;
                }
            });

            try {
                await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra); 
                if (globalColourModified) await saveGlobalColoursToFirebase_ExtraPage();
                if (specificColoursModified) await saveStopSpecificColoursToFirebase_ExtraPage();

                if (deleteEntireRouteStatusMessage_el_extra) {
                    deleteEntireRouteStatusMessage_el_extra.textContent = `Route(s) "${lineNamesToDelete.join(', ')}" deleted globally (live).`;
                    deleteEntireRouteStatusMessage_el_extra.style.color = "#2ecc71";
                }
                renderUIDependentElements_ExtraPage(); 
            } catch (err) {
                if (deleteEntireRouteStatusMessage_el_extra) {
                    deleteEntireRouteStatusMessage_el_extra.textContent = "Error deleting route(s). Data might be inconsistent.";
                    deleteEntireRouteStatusMessage_el_extra.style.color = "#e74c3c";
                }
                console.error("Error deleting route(s) globally:", err);
            }
        }

        // Helper functions to save to Firebase
        async function saveScheduleAndStopsToFirebase_ExtraPage(scheduleArray) { if(!window.firebaseOMSI_Extra||!currentUser_extra)throw new Error("Not auth/Firebase."); const{database,dbUpdate,dbRef}=window.firebaseOMSI_Extra;const updates={};const finalScheduleData=scheduleArray.map((entry,index)=>({...entry,internalId:entry.internalId||`${(entry.stopID||'s')}_${(entry.lineName||'l')}_${(entry.scheduledTime||"").replace(':','')}_${index}_xtraLive`}));updates[FB_PATH_LIVE_SCHEDULE_DATA]=finalScheduleData;const stopsMap=new Map();finalScheduleData.forEach(r=>{if(r.stopID&&!stopsMap.has(r.stopID.toUpperCase()))stopsMap.set(r.stopID.toUpperCase(),{stopID:r.stopID,stopName:r.stopName,direction:r.direction});});updates[FB_PATH_LIVE_UNIQUE_STOPS]=Array.from(stopsMap.values()).sort((a,b)=>(a.stopName||"").localeCompare(b.stopName||""));updates[FB_PATH_APPSTATE_LAST_UPDATED]=new Date().toISOString();await dbUpdate(dbRef(database),updates);console.log("Extra: Live schedule & stops updated.");}
        async function saveClosedStopsToFirebase_ExtraPage() { if(!window.firebaseOMSI_Extra||!currentUser_extra)throw new Error("Not auth/Firebase.");const{database,dbSet,dbRef}=window.firebaseOMSI_Extra;const fbClosed={};closedStopIDs_extra.forEach(id=>fbClosed[id.toUpperCase()]=true);await dbSet(dbRef(database,FB_PATH_APPSTATE_CLOSED_STOPS),fbClosed);console.log("Extra: Closed stops updated.");}
        async function saveGlobalColoursToFirebase_ExtraPage() { if(!window.firebaseOMSI_Extra||!currentUser_extra)throw new Error("Not auth/Firebase.");const{database,dbSet,dbRef}=window.firebaseOMSI_Extra;await dbSet(dbRef(database,FB_PATH_SETTINGS_GLOBAL_CUSTOM_COLOURS),globalCustomRouteColours_extra);console.log("Extra: Global colours updated.");}
        async function saveStopSpecificColoursToFirebase_ExtraPage() { if(!window.firebaseOMSI_Extra||!currentUser_extra)throw new Error("Not auth/Firebase.");const{database,dbSet,dbRef}=window.firebaseOMSI_Extra;await dbSet(dbRef(database,FB_PATH_SETTINGS_STOP_SPECIFIC_COLOURS),stopSpecificRouteColours_extra);console.log("Extra: Stop specific colours updated.");}

        // Batch Stop ID Changer Functions from Master List
        async function handleApplyMasterListStopIdChanges_ExtraPage() {
            if (!currentUser_extra || !window.firebaseOMSI_Extra) {
                alert("Please log in.");
                if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.textContent = "Not logged in.";
                return;
            }

            const newIdInputs = masterStopListUL_el_extra.querySelectorAll('.master-list-new-id-input');
            if (newIdInputs.length === 0) {
                if(masterListApplyChangesStatus_el_extra) {
                    masterListApplyChangesStatus_el_extra.textContent = "No stops listed to change.";
                    masterListApplyChangesStatus_el_extra.style.color = "#f1c40f";
                }
                return;
            }

            const changesToApply = [];
            let validationError = false;
            const newIdsInThisBatch = new Set();
            const originalIdsInThisBatch = new Set();

            newIdInputs.forEach((inputField, index) => {
                if (validationError) return;

                const originalId = inputField.dataset.originalId;
                const originalName = inputField.dataset.originalName;
                const originalDirection = inputField.dataset.originalDirection;
                const newId = inputField.value.trim().toUpperCase();
                const warningElement = inputField.nextElementSibling;
                if (warningElement) warningElement.textContent = '';

                originalIdsInThisBatch.add(originalId.toUpperCase());

                if (newId !== originalId.toUpperCase()) {
                    if (!newId) {
                        if(warningElement) warningElement.textContent = 'New ID cannot be empty.';
                        if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.textContent = `Stop "${originalId}": New Stop ID cannot be empty if changed.`;
                        validationError = true; return;
                    }
                    if (!/^[A-Z0-9]+$/.test(newId)) {
                        if(warningElement) warningElement.textContent = 'Invalid format (A-Z, 0-9).';
                        if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.textContent = `Stop "${originalId}" (New ID ${newId}): Invalid format. A-Z, 0-9 only.`;
                        validationError = true; return;
                    }
                    if (newIdsInThisBatch.has(newId)) {
                        if(warningElement) warningElement.textContent = 'This New ID is duplicated in this batch.';
                        if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.textContent = `Stop "${originalId}": New Stop ID "${newId}" is duplicated within this batch.`;
                        validationError = true; return;
                    }
                    changesToApply.push({ originalId: originalId, newId: newId, originalName: originalName, originalDirection: originalDirection });
                    newIdsInThisBatch.add(newId);
                }
            });

            if (validationError) {
                if(masterListApplyChangesStatus_el_extra) masterListApplyChangesStatus_el_extra.style.color = "#e74c3c";
                return;
            }

            if (changesToApply.length === 0) {
                if(masterListApplyChangesStatus_el_extra) {
                    masterListApplyChangesStatus_el_extra.textContent = "No actual ID changes detected.";
                    masterListApplyChangesStatus_el_extra.style.color = "#f1c40f";
                }
                return;
            }

            const allCurrentlyExistingStopIds = new Set(getUniqueStopsFromSchedule_ExtraPage().map(s => s.stopID.toUpperCase()));
            for (const change of changesToApply) {
                if (allCurrentlyExistingStopIds.has(change.newId) && !originalIdsInThisBatch.has(change.newId)) {
                    const problemInput = Array.from(newIdInputs).find(inp => inp.dataset.originalId === change.originalId);
                    const warningElement = problemInput ? problemInput.nextElementSibling : null;
                    if(warningElement) warningElement.textContent = `New ID ${change.newId} exists for another stop.`;
                    if(masterListApplyChangesStatus_el_extra) {
                        masterListApplyChangesStatus_el_extra.textContent = `Error: New ID "${change.newId}" for original "${change.originalId}" already exists as a different stop not being changed in this batch.`;
                        masterListApplyChangesStatus_el_extra.style.color = "#e74c3c";
                    }
                    return;
                }
            }

            if (!confirm(`Apply ${changesToApply.length} Stop ID change(s) to the LIVE schedule? This action CANNOT BE UNDONE easily.`)) {
                if(masterListApplyChangesStatus_el_extra) {
                    masterListApplyChangesStatus_el_extra.textContent = "Bulk ID change operation cancelled.";
                    masterListApplyChangesStatus_el_extra.style.color = "#7f8c8d";
                }
                return;
            }
            if(masterListApplyChangesStatus_el_extra) {
                masterListApplyChangesStatus_el_extra.textContent = "Processing bulk Stop ID changes...";
                masterListApplyChangesStatus_el_extra.style.color = "#f1c40f";
            }

            const effectiveNewDetails = new Map();
            changesToApply.forEach(change => {
                let nameToUse = change.originalName;
                let dirToUse = change.originalDirection;
                const existingStopWithNewId = currentWorkingSchedule_extra.find(e =>
                    e.stopID.toUpperCase() === change.newId.toUpperCase() &&
                    !originalIdsInThisBatch.has(e.stopID.toUpperCase())
                );
                if (existingStopWithNewId) {
                    nameToUse = existingStopWithNewId.stopName;
                    dirToUse = existingStopWithNewId.direction;
                }
                effectiveNewDetails.set(change.newId.toUpperCase(), { name: nameToUse, direction: dirToUse });
            });

            let modifiedEntryCount = 0;
            const tempSchedule = JSON.parse(JSON.stringify(currentWorkingSchedule_extra));

            changesToApply.forEach(change => {
                const originalIdUpper = change.originalId.toUpperCase();
                tempSchedule.forEach(entry => {
                    if (entry.stopID && entry.stopID.toUpperCase() === originalIdUpper) {
                        entry.stopID = change.newId;
                        const details = effectiveNewDetails.get(change.newId.toUpperCase());
                        if (details) {
                            entry.stopName = details.name;
                            entry.direction = details.direction;
                        }
                        modifiedEntryCount++;
                    }
                });
            });

            tempSchedule.forEach(entry => {
                const entryStopIdUpper = entry.stopID.toUpperCase();
                if (effectiveNewDetails.has(entryStopIdUpper)) {
                    const details = effectiveNewDetails.get(entryStopIdUpper);
                    entry.stopName = details.name;
                    entry.direction = details.direction;
                }
            });

            if (modifiedEntryCount > 0 || changesToApply.length > 0) {
                try {
                    currentWorkingSchedule_extra = tempSchedule;
                    await saveScheduleAndStopsToFirebase_ExtraPage(currentWorkingSchedule_extra);

                    let closedStopsModified = false;
                    let stopSpecificColoursModified = false;
                    changesToApply.forEach(change => {
                        const originalIdUpper = change.originalId.toUpperCase();
                        const newIdUpper = change.newId.toUpperCase();
                        if (originalIdUpper !== newIdUpper) {
                            const closedIndex = closedStopIDs_extra.indexOf(originalIdUpper);
                            if (closedIndex > -1) {
                                closedStopIDs_extra.splice(closedIndex, 1);
                                if (!closedStopIDs_extra.includes(newIdUpper)) {
                                    closedStopIDs_extra.push(newIdUpper);
                                }
                                closedStopsModified = true;
                            }
                            if (stopSpecificRouteColours_extra[originalIdUpper]) {
                                if (!stopSpecificRouteColours_extra[newIdUpper]) {
                                    stopSpecificRouteColours_extra[newIdUpper] = stopSpecificRouteColours_extra[originalIdUpper];
                                }
                                delete stopSpecificRouteColours_extra[originalIdUpper];
                                stopSpecificColoursModified = true;
                            }
                        }
                    });

                    if (closedStopsModified) await saveClosedStopsToFirebase_ExtraPage();
                    if (stopSpecificColoursModified) await saveStopSpecificColoursToFirebase_ExtraPage();

                    if(masterListApplyChangesStatus_el_extra) {
                        masterListApplyChangesStatus_el_extra.textContent = `Bulk Stop ID changes applied. ${modifiedEntryCount} schedule entries updated across ${changesToApply.length} stops.`;
                        masterListApplyChangesStatus_el_extra.style.color = "#2ecc71";
                    }
                    renderUIDependentElements_ExtraPage();
                } catch (error) {
                    console.error("Error saving bulk Stop ID changes:", error);
                    if(masterListApplyChangesStatus_el_extra) {
                        masterListApplyChangesStatus_el_extra.textContent = "Error saving changes. Data might be inconsistent. Reload recommended.";
                        masterListApplyChangesStatus_el_extra.style.color = "#e74c3c";
                    }
                }
            } else {
                if(masterListApplyChangesStatus_el_extra) {
                    masterListApplyChangesStatus_el_extra.textContent = "No entries matched for actual ID changes, or no changes made.";
                    masterListApplyChangesStatus_el_extra.style.color = "#f1c40f";
                }
            }
        }
        
        // --- DOMContentLoaded listener ---
        document.addEventListener('DOMContentLoaded', () => {
            const menuButtonsOnThisPage = document.querySelectorAll('#main-menu-buttons_extra .menu-button');

            function initializeExtraPageAppLogic() {
                console.log("Firebase ready (Extra Page), initializing Extra Modules app logic.");
                if(!window.firebaseOMSI_Extra||!window.firebaseOMSI_Extra.auth){console.error("CRITICAL: firebaseOMSI_Extra.auth not available!");if(authStatus_el_extra)authStatus_el_extra.textContent='Firebase auth error!';return;}
                const{auth,authOnAuthStateChanged,authSignInWithEmailAndPassword,authSignOut}=window.firebaseOMSI_Extra;
                
                authOnAuthStateChanged(auth, (user) => {
                    updateAuthUI_ExtraPage(user); // This now handles restoring the section
                });

                if(adminLoginForm_el_extra){adminLoginForm_el_extra.addEventListener('submit',(event)=>{event.preventDefault();const email=inputEmail_el_extra.value;const password=inputPassword_el_extra.value;if(authStatus_el_extra)authStatus_el_extra.textContent='Logging in...';authSignInWithEmailAndPassword(auth,email,password).catch((error)=>{if(authStatus_el_extra)authStatus_el_extra.textContent=`Login Error: ${error.message}`;});});}
                const logoutButton_el_extra_listener=document.getElementById('logoutButton_extra');
                if(logoutButton_el_extra_listener){logoutButton_el_extra_listener.addEventListener('click',()=>{authSignOut(auth).catch((e)=>console.error("Sign-out Error:",e));});}
                
                menuButtonsOnThisPage.forEach(button=>{button.addEventListener('click',()=>{const sectionId=button.getAttribute('data-section');if(currentUser_extra&&sectionId)showExtraPageSection(sectionId);else if(!currentUser_extra)alert("Please log in.");});});
                
                if(overrideDateInput_el_extra)overrideDateInput_el_extra.addEventListener('change',handleOverrideDateChange_ExtraPage);
                if(setOverrideButton_el_extra)setOverrideButton_el_extra.addEventListener('click',handleSetProfileOverride_ExtraPage);
                if(clearOverrideButton_el_extra)clearOverrideButton_el_extra.addEventListener('click',handleClearProfileOverride_ExtraPage);
                
                // Event listeners for auto-generating stop ID
                if (selectNewStopIdFormat_el_extra) {
                    selectNewStopIdFormat_el_extra.addEventListener('change', autoGenerateAndSetNewStopId_ExtraPage);
                }
                if (inputNewStopName_el_extra) {
                    inputNewStopName_el_extra.addEventListener('input', autoGenerateAndSetNewStopId_ExtraPage);
                }

                if(buttonAddNewStop_el_extra)buttonAddNewStop_el_extra.addEventListener('click',handleAddStopDetails_ExtraPage);
                if(inputNewStopId_el_extra&&newStopIdAvailability_el_extra){inputNewStopId_el_extra.addEventListener('input',()=>{const newStopId=inputNewStopId_el_extra.value.trim().toUpperCase();if(!newStopId){newStopIdAvailability_el_extra.textContent='';return;}if(!/^[A-Z0-9]+$/.test(newStopId)){newStopIdAvailability_el_extra.textContent='ID: A-Z, 0-9.';newStopIdAvailability_el_extra.style.color='#e74c3c';return;}const existing=currentWorkingSchedule_extra.some(e=>e.stopID.toUpperCase()===newStopId);if(existing){newStopIdAvailability_el_extra.textContent='ID exists.';newStopIdAvailability_el_extra.style.color='#e74c3c';}else{newStopIdAvailability_el_extra.textContent='ID available.';newStopIdAvailability_el_extra.style.color='#2ecc71';}}); }
                if(refreshMasterStopListButton_el_extra)refreshMasterStopListButton_el_extra.addEventListener('click',populateMasterStopList_ExtraPage);
                if(masterStopListFilterInput_el_extra)masterStopListFilterInput_el_extra.addEventListener('input',populateMasterStopList_ExtraPage);
                if(deleteEntireRouteButton_el_extra)deleteEntireRouteButton_el_extra.addEventListener('click',handleDeleteEntireRouteGlobally_ExtraPage); 
                if(applyMasterListStopIdChangesButton_el_extra) applyMasterListStopIdChangesButton_el_extra.addEventListener('click', handleApplyMasterListStopIdChanges_ExtraPage);
            }

            if (window.firebaseOMSI_Extra && window.firebaseOMSI_Extra.auth) { initializeExtraPageAppLogic(); }
            else { document.addEventListener('firebaseReady_Extra', initializeExtraPageAppLogic, { once: true }); }
        });
    </script>
</body>
</html>
