<!DOCTYPE html>
<html>
<head>
    <title>Bus Route Information Input</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { width: 85%; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        h2 { color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 15px;}
        .input-section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9;}
        .input-section label { display: block; margin-bottom: 6px; font-weight: bold; color: #555; }
        .input-section input[type="text"],
        .input-section input[type="date"],
        .input-section input[type="checkbox"],
        .input-section textarea { 
            padding: 10px; 
            margin-bottom: 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 14px;
        }
        .input-section input[type="text"], 
        .input-section input[type="date"],
        .input-section textarea {
             width: 100%; 
        }
        .input-section input[type="checkbox"] { 
            width: auto; 
            margin-right: 5px;
            vertical-align: middle;
        }
        .input-section .inline-label { 
            font-weight: normal;
            display: inline;
            margin-bottom: 0;
        }

        .input-section textarea { min-height: 70px; }
        .label-container { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .label-container label { margin-bottom: 0; flex-shrink: 0; }
        .label-container input[type="text"] { width: auto; flex-grow: 1; margin-bottom: 0; }
        
        #routeDestinationsContainer input[type="text"] { margin-bottom: 0; } 
        #routeDestinationsContainer > div { margin-bottom: 12px; }


        .garage-journeys-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .garage-journeys-table th, .garage-journeys-table td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        .garage-journeys-table th { background-color: #e9e9e9; color: #333; }
        .garage-journeys-table td input[type="text"], .garage-journeys-table td textarea { margin-bottom: 0; }

        .add-row-btn { 
            padding: 9px 15px; 
            background-color: #28a745; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            border-radius: 4px;
            margin-top: 5px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .add-row-btn:hover { background-color: #218838; }
        
        .remove-item-btn { 
            padding: 8px 12px; 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 13px; 
            border-radius: 4px;
            margin-top: 10px;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .remove-item-btn:hover { background-color: #c82333; }
        
        button#generatePdfBtn { 
            display: block;
            width: 200px;
            padding: 12px 20px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            border-radius: 4px;
            margin: 30px auto 10px auto;
            transition: background-color 0.2s;
        }
        button#generatePdfBtn:hover { background-color: #0056b3; }
        
        .availability-grid-options {
            display: grid;
            grid-template-columns: max-content 1fr; 
            gap: 8px 12px; 
            align-items: center; 
            margin-bottom: 15px;
        }
        .availability-grid-options .checkbox-label-group {
            display: flex; 
            align-items: center;
            gap: 6px; 
        }
        .availability-grid-options input[type="checkbox"].toggle-field,
        .availability-grid-options input[type="checkbox"].format-bold-checkbox { 
            margin: 0; 
            height: 16px;
            width: 16px;
            flex-shrink: 0; 
        }
        .availability-grid-options .format-bold-checkbox {
             margin-left: 10px; 
        }
        .availability-grid-options .checkbox-label-group label[for*="boldOpRestrictions"] {
            font-weight: normal;
            font-size: 0.9em;
        }
        .availability-grid-options .bold-label { 
            font-weight: bold;
            margin-bottom: 0; 
        }
        .availability-grid-options .input-wrapper { }
        .availability-grid-options .input-wrapper input[type="text"] {
            width: 100%; 
            margin-bottom: 0; 
        }
        .hidden-field { display: none !important; }


        .bold-label { font-weight: bold; } 
        .italic-note { font-style: italic; margin-bottom: 15px; display: block; color: #666; font-size: 0.9em; }
        
        .dynamic-section { 
            border: 1px solid #e0e0e0;
            background-color: #fff;
            padding: 15px; 
            margin-bottom:15px; 
            border-radius: 4px;
        }
        .dynamic-section:last-of-type { margin-bottom: 0; }
        
        .curtailment-options { margin-top: 15px; margin-bottom: 10px; }
        .curtailment-options > div { margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        .curtailment-options input[type="radio"] { margin-right: 4px; width:auto; } 
        .curtailment-options label { font-weight: normal; }


        .curtailment-directions-container { margin-top: 10px; margin-bottom: 10px; }
        .curtailment-direction-block {
            border: 1px dashed #b0b0b0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #fdfdfd;
        }
        .curtailment-direction-block label { font-size: 0.95em; color: #444;}

        hr.section-separator { margin-top: 20px; margin-bottom: 20px; border: 0; border-top: 1px dashed #ccc;}

    </style>
</head>
<body>
    <div class="container">
        <h1>Enter Bus Route Information</h1>

        <div class="input-section">
            <h2>Route Description</h2>
            <label for="routeNumberInput">Route Number:</label>
            <input type="text" id="routeNumberInput" placeholder="e.g., 6 or 10A" value="6">

            <div style="margin-top: 15px; margin-bottom: 0px;">
                <label class="bold-label" style="margin-bottom: 5px;">Route Details:</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="isCircularRouteCheckbox" onchange="updateRouteDetailsInputs()">
                    <label for="isCircularRouteCheckbox" class="inline-label">Is this a circular route?</label>
                </div>
            </div>
            <div id="routeDestinationsContainer">
                </div>

            <label for="structuralChangeDate">Date of Structural Change:</label>
            <input type="date" id="structuralChangeDate" value="2023-11-18">
            <label for="serviceChangeDate">Date of Service Change:</label>
            <input type="date" id="serviceChangeDate" value="2024-02-10">
            <label for="reasonForIssue">Reason for Issue:</label>
            <input type="text" id="reasonForIssue" value="New Issue">
        </div>

        <div class="input-section">
            <h2>Streets Traversed</h2>
            <div id="streetsTraversedContainer">
                <div class="dynamic-section street-section" data-index="0">
                    <div class="label-container">
                        <label for="streetsTraversedDestination_0">Towards:</label>
                        <input type="text" id="streetsTraversedDestination_0" class="street-destination" placeholder="Enter Destination" value="Scunthorpe, Bus Station">
                    </div>
                    <label for="streetsTraversedDetails_0">Streets traversed towards the destination above:</label>
                    <textarea id="streetsTraversedDetails_0" class="street-details" rows="4" placeholder="Enter streets...">Bus Station Approach Road, Fenton Street, Cole Street, Mary Street, Frances Street, High Street, Oswald Road, Ashby Road, Ashby High Street, Grange Lane South, Derwent Road, Manifold Road, Grange Lane South, Everest Road, Ashby High Street, Ashby Road, Oswald Road, Mary Street, Cole Street, Fenton Street, Bus Station Approach Road.</textarea>
                    <button type="button" class="remove-item-btn" onclick="removeStreetSection(this)">Remove This Section</button>
                </div>
            </div>
            <button type="button" class="add-row-btn" onclick="addStreetSection()" style="margin-top:15px;">Add Another Streets Traversed Section</button>
        </div>

        <div class="input-section">
            <h2>Garage Journeys</h2>
            <button type="button" class="add-row-btn" onclick="addGarageJourneyRow()">Add Garage Journey</button>
            <table id="garageJourneysTable" class="garage-journeys-table">
                <thead> <tr><th>From</th><th>To</th><th>Roads</th><th>Action</th></tr> </thead>
                <tbody>
                    <tr>
                        <td><input type="text" class="garage-from" value="Brumby Garage"></td>
                        <td><input type="text" class="garage-to" value="Scunthorpe, Bus Station"></td>
                        <td><textarea class="garage-roads" rows="2">Brumby Bus Garage Forecourt, Cottage Beck Road, Rowland Road, 3rd Exit Ashby Road, Oswald Road, Mary Street, Cole Street, Fenton Street, Bus Station Stand B.</textarea></td>
                        <td><button type="button" class="remove-item-btn" onclick="removeTableRow(this)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="input-section">
            <h2>Authorised Stands, Curtailment Points, & Blind Descriptions</h2>
            <p class="italic-note">Please note that only stands, curtailment points, & blind descriptions as detailed in this contractual document may be used.</p>
            <div id="authorisedStandsContainer">
                <div class="dynamic-section location-section" data-index="0">
                    <label for="locationStandName_L0">Stand/Point Name (e.g., SCUNTHORPE BUS STATION):</label>
                    <input type="text" id="locationStandName_L0" class="location-stand-name" placeholder="Enter the name of the stand or point" value="SCUNTHORPE, BUS STATION">
                    
                    <div class="curtailment-options" id="curtailmentOptions_L0">
                        <label class="bold-label" style="margin-bottom: 8px;">Procedure Type:</label>
                        <div>
                            <input type="radio" id="curtailmentTypeOne_L0" name="curtailmentType_L0" value="one" checked onchange="handleCurtailmentTypeChange(this)">
                            <label for="curtailmentTypeOne_L0" class="inline-label">One Direction Procedure</label>
                        </div>
                        <div>
                            <input type="radio" id="curtailmentTypeTwo_L0" name="curtailmentType_L0" value="two" onchange="handleCurtailmentTypeChange(this)">
                            <label for="curtailmentTypeTwo_L0" class="inline-label">Two Direction Procedures</label>
                        </div>
                    </div>
                    <div class="curtailment-directions-container" id="curtailmentDirectionsContainer_L0">
                        </div>
                    <hr class="section-separator">

                    <div class="availability-grid-options">
                        <div class="checkbox-label-group">
                            <input type="checkbox" id="toggleAvailability_L0" class="toggle-field" data-target-input-id="locationAvailability_L0" checked onchange="toggleFieldVisibility(this)">
                            <label class="bold-label" for="toggleAvailability_L0">AVAILABILITY:</label>
                        </div>
                        <div class="input-wrapper">
                           <input type="text" id="locationAvailability_L0" class="location-availability" value="At any time.">
                        </div>

                        <div class="checkbox-label-group">
                            <input type="checkbox" id="toggleOpRestrictions_L0" class="toggle-field" data-target-input-id="locationOperatingRestrictions_L0" checked onchange="toggleFieldVisibility(this)">
                            <label class="bold-label" for="toggleOpRestrictions_L0">OPERATING RESTRICTIONS:</label>
                            <input type="checkbox" id="boldOpRestrictions_L0" class="format-bold-checkbox">
                            <label for="boldOpRestrictions_L0" class="inline-label">Bold in PDF</label>
                        </div>
                        <div class="input-wrapper">
                            <input type="text" id="locationOperatingRestrictions_L0" class="location-operating-restrictions" value="No more than 1 bus on Route 6 should be scheduled to stand at any one time.">
                        </div>
                        
                        <div class="checkbox-label-group">
                            <input type="checkbox" id="toggleMealReliefs_L0" class="toggle-field" data-target-input-id="locationMealReliefs_L0" checked onchange="toggleFieldVisibility(this)">
                            <label class="bold-label" for="toggleMealReliefs_L0">MEAL RELIEFS:</label>
                        </div>
                        <div class="input-wrapper">
                           <input type="text" id="locationMealReliefs_L0" class="location-meal-reliefs" value="No meal relief vehicles to stand at any time.">
                        </div>

                        <div class="checkbox-label-group">
                            <input type="checkbox" id="toggleFerryVehicles_L0" class="toggle-field" data-target-input-id="locationFerryVehicles_L0" checked onchange="toggleFieldVisibility(this)">
                            <label class="bold-label" for="toggleFerryVehicles_L0">FERRY VEHICLES:</label>
                        </div>
                        <div class="input-wrapper">
                            <input type="text" id="locationFerryVehicles_L0" class="location-ferry-vehicles" value="No ferry vehicles to park on stand at any time.">
                        </div>

                        <div class="checkbox-label-group">
                            <input type="checkbox" id="toggleBlindDisplay_L0" class="toggle-field" data-target-input-id="locationBlindDisplay_L0" checked onchange="toggleFieldVisibility(this)">
                            <label class="bold-label" for="toggleBlindDisplay_L0">BLIND DISPLAY:</label>
                        </div>
                        <div class="input-wrapper">
                           <input type="text" id="locationBlindDisplay_L0" class="location-blind-display" value="Ashby & Scunthorpe via Manifold Road.">
                        </div>
                    </div>
                    <button type="button" class="remove-item-btn" onclick="removeLocationSection(this)">Remove This Stand/Point</button>
                </div>
            </div>
            <button type="button" class="add-row-btn" onclick="addLocationSection()" style="margin-top:15px;">Add Another Stand/Point</button>
        </div>

        <button id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <script>
        // ****** START: pdfMake Font Configuration ******
        pdfMake.fonts = {
            Arial: {
                normal: 'https://076189.github.io/live-tracker/fonts/arial.ttf',
                bold: 'https://076189.github.io/live-tracker/fonts/arialbd.ttf',
                italics: 'https://076189.github.io/live-tracker/fonts/ariali.ttf',
                bolditalics: 'https://076189.github.io/live-tracker/fonts/arialbi.ttf'
            }
        };
        // ****** END: pdfMake Font Configuration ******

        let locationSectionCounter = 1; 
        let streetSectionCounter = 1;
        let uniqueCurtailmentIdCounter = 0;

        function updateRouteDetailsInputs() {
            const isCircular = document.getElementById('isCircularRouteCheckbox').checked;
            const container = document.getElementById('routeDestinationsContainer');
            container.innerHTML = ''; 

            if (isCircular) {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = 'routeCircularDestination';
                label.textContent = 'Main Destination / Via:';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'routeCircularDestination';
                input.placeholder = 'e.g., Town Centre via Hospital';
                
                div.appendChild(label);
                div.appendChild(input);
                container.appendChild(div);
            } else {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px'; 

                const inputFrom = document.createElement('input');
                inputFrom.type = 'text';
                inputFrom.id = 'routeDestinationFrom';
                inputFrom.placeholder = 'Start Destination';
                inputFrom.style.flex = '1';

                const hyphen = document.createElement('span');
                hyphen.textContent = '-';
                hyphen.style.fontWeight = 'bold';
                hyphen.style.padding = '0 5px';

                const inputTo = document.createElement('input');
                inputTo.type = 'text';
                inputTo.id = 'routeDestinationTo';
                inputTo.placeholder = 'End Destination';
                inputTo.style.flex = '1';

                div.appendChild(inputFrom);
                div.appendChild(hyphen);
                div.appendChild(inputTo);
                container.appendChild(div);
            }
        }

        function toggleFieldVisibility(checkboxElement) {
            const targetInputId = checkboxElement.dataset.targetInputId;
            const targetInputElement = document.getElementById(targetInputId);
            if (targetInputElement) {
                if (checkboxElement.checked) {
                    targetInputElement.classList.remove('hidden-field');
                } else {
                    targetInputElement.classList.add('hidden-field');
                }
            }
        }
        
        function initializeFieldVisibility(sectionElement) {
            sectionElement.querySelectorAll('.toggle-field').forEach(checkbox => {
                toggleFieldVisibility(checkbox);
            });
        }
        
        function initializeCurtailmentForLocation(locationSection) {
            const defaultCurtailmentRadio = locationSection.querySelector('input[name^="curtailmentType"]:checked');
            if(defaultCurtailmentRadio) {
                handleCurtailmentTypeChange(defaultCurtailmentRadio);
            } else { 
                const oneWayRadio = locationSection.querySelector('input[name^="curtailmentType"][value="one"]');
                if(oneWayRadio){
                    oneWayRadio.checked = true;
                    handleCurtailmentTypeChange(oneWayRadio);
                }
            }
        }

        function addCurtailmentBlockToContainer(container, blockNumber, type) {
            uniqueCurtailmentIdCounter++; 
            const newDirectionDiv = document.createElement('div');
            newDirectionDiv.className = 'curtailment-direction-block';
            
            let blockHTML = '';

            if (type === "one") {
                blockHTML = `
                    <label for="curtailmentDetails_UID${uniqueCurtailmentIdCounter}">Procedure / Details:</label>
                    <textarea id="curtailmentDetails_UID${uniqueCurtailmentIdCounter}" class="curtailment-details-text" rows="4" placeholder="Describe the procedure for this stand/point..."></textarea>
                    <button type="button" class="remove-item-btn" onclick="removeCurtailmentDirection(this)">Remove Procedure</button> 
                `;
            } else { // type === "two"
                let destinationPlaceholder = "e.g., Towards Town Centre";
                if (blockNumber === 1) { 
                     destinationPlaceholder = "e.g., Towards Outskirts";
                }
                blockHTML = `
                    <label for="curtailmentDestination_UID${uniqueCurtailmentIdCounter}">Destination (Direction ${blockNumber + 1}):</label>
                    <input type="text" id="curtailmentDestination_UID${uniqueCurtailmentIdCounter}" class="curtailment-destination" placeholder="${destinationPlaceholder}">
                    <label for="curtailmentDetails_UID${uniqueCurtailmentIdCounter}">Procedure (Details for Direction ${blockNumber + 1}):</label>
                    <textarea id="curtailmentDetails_UID${uniqueCurtailmentIdCounter}" class="curtailment-details-text" rows="3" placeholder="Describe procedure for this direction..."></textarea>
                    <button type="button" class="remove-item-btn" onclick="removeCurtailmentDirection(this)">Remove This Direction</button>
                `;
            }
            newDirectionDiv.innerHTML = blockHTML;
            container.appendChild(newDirectionDiv);
        }

        function handleCurtailmentTypeChange(radioElement) {
            const locationSection = radioElement.closest('.location-section');
            const container = locationSection.querySelector('.curtailment-directions-container');
            container.innerHTML = ''; 

            const type = radioElement.value; 
            if (type === "one") {
                addCurtailmentBlockToContainer(container, 0, "one");
            } else if (type === "two") {
                addCurtailmentBlockToContainer(container, 0, "two"); 
                addCurtailmentBlockToContainer(container, 1, "two"); 
            }
        }

        function removeCurtailmentDirection(buttonElement) {
            const curtailmentBlock = buttonElement.closest('.curtailment-direction-block');
            const container = curtailmentBlock.parentElement;
            const locationSection = container.closest('.location-section');
            
            curtailmentBlock.remove();

            const remainingBlocks = container.children.length;
            const oneWayRadio = locationSection.querySelector('input[name^="curtailmentType"][value="one"]');
            const twoWayRadio = locationSection.querySelector('input[name^="curtailmentType"][value="two"]');

            if (remainingBlocks === 0) {
                if (oneWayRadio) oneWayRadio.checked = false;
                if (twoWayRadio) twoWayRadio.checked = false;
            } else if (remainingBlocks === 1) {
                if (oneWayRadio) oneWayRadio.checked = true;
                if (twoWayRadio) twoWayRadio.checked = false;
                
                // Check if the remaining block needs relabeling for "One Direction" type
                const remainingBlockEl = container.querySelector('.curtailment-direction-block');
                if(remainingBlockEl && oneWayRadio.checked) { // Only relabel if it's now truly a "one" type
                    const destInput = remainingBlockEl.querySelector('.curtailment-destination');
                    const destLabelForInput = remainingBlockEl.querySelector('label[for^="curtailmentDestination_"]');
                    const detailsLabel = remainingBlockEl.querySelector('label[for^="curtailmentDetails_"]');

                    if(destInput) destInput.remove(); // Remove destination input for "one" type
                    if(destLabelForInput) destLabelForInput.remove(); // Remove its label
                    if(detailsLabel) detailsLabel.textContent = "Procedure / Details:"; // Relabel details
                }
            }
        }

        function addStreetSection() { /* ... same as previous full code ... */ 
            const container = document.getElementById('streetsTraversedContainer');
            let templateSection = container.querySelector('.street-section'); 
            if (!templateSection && container.children.length > 0) { templateSection = container.children[0]; }
            if (!templateSection) { alert("Error: No template street section found."); return; }

            const newSection = templateSection.cloneNode(true);
            const newStreetIndex = streetSectionCounter;
            newSection.dataset.index = newStreetIndex;
            newSection.querySelectorAll('input[type="text"], textarea').forEach(input => input.value = '');

            const newDestInput = newSection.querySelector('.street-destination');
            if (newDestInput) {
                const newId = `streetsTraversedDestination_${newStreetIndex}`;
                const oldLabelFor = templateSection.querySelector('.street-destination').id;
                const label = newSection.querySelector(`label[for="${oldLabelFor}"]`);
                newDestInput.id = newId;
                if (label) label.setAttribute('for', newId);
            }
            const newDetailsTextarea = newSection.querySelector('.street-details');
            if (newDetailsTextarea) {
                const newId = `streetsTraversedDetails_${newStreetIndex}`;
                const oldLabelFor = templateSection.querySelector('.street-details').id;
                const label = newSection.querySelector(`label[for="${oldLabelFor}"]`);
                newDetailsTextarea.id = newId;
                if (label) label.setAttribute('for', newId);
            }
            container.appendChild(newSection);
            streetSectionCounter++;
        }
        function removeStreetSection(button) { /* ... same as previous full code ... */ 
            const sectionToRemove = button.closest('.street-section');
            if (document.querySelectorAll('#streetsTraversedContainer .street-section').length > 1) {
                sectionToRemove.remove();
            } else {
                alert("At least one Streets Traversed section is required.");
            }
        }

        function addLocationSection() {
            const container = document.getElementById('authorisedStandsContainer');
            let templateSection = container.querySelector('.location-section');
            if (!templateSection && container.children.length > 0) { templateSection = container.children[0]; }
            if (!templateSection) { alert("Error: No template location section found."); return; }

            const newSection = templateSection.cloneNode(true);
            const newLocationIndex = locationSectionCounter; 
            const newLocationIdPrefix = `L${newLocationIndex}`;
            newSection.dataset.index = newLocationIndex;

            const standNameInput = newSection.querySelector('.location-stand-name');
            if(standNameInput) {
                standNameInput.value = '';
                const newStandNameId = `locationStandName_${newLocationIdPrefix}`;
                const templateStandNameId = templateSection.querySelector('.location-stand-name').id;
                const label = newSection.querySelector(`label[for="${templateStandNameId}"]`);
                standNameInput.id = newStandNameId;
                if(label) label.setAttribute('for', newStandNameId);
            }
            
            const curtailmentOptionsDiv = newSection.querySelector('.curtailment-options');
            if(curtailmentOptionsDiv) {
                curtailmentOptionsDiv.id = `curtailmentOptions_${newLocationIdPrefix}`;
                curtailmentOptionsDiv.querySelectorAll('input[type="radio"]').forEach((radio) => {
                    const originalRadioId = radio.id; 
                    const valuePart = radio.value.charAt(0).toUpperCase() + radio.value.slice(1);
                    const newRadioId = `curtailmentType${valuePart}_${newLocationIdPrefix}`;

                    radio.name = `curtailmentType_${newLocationIdPrefix}`;
                    radio.id = newRadioId;
                    radio.checked = (radio.value === "one"); 
                    
                    const label = curtailmentOptionsDiv.querySelector(`label[for="${originalRadioId}"]`);
                    if (label) label.setAttribute('for', newRadioId);
                });
            }

            const curtailmentContainer = newSection.querySelector('.curtailment-directions-container');
            if (curtailmentContainer) {
                curtailmentContainer.innerHTML = ''; 
                curtailmentContainer.id = `curtailmentDirectionsContainer_${newLocationIdPrefix}`;
            }

            const availabilityFields = [ 
                { toggleBase: 'toggleAvailability', inputBase: 'locationAvailability', boldCheckboxBase: null },
                { toggleBase: 'toggleOpRestrictions', inputBase: 'locationOperatingRestrictions', boldCheckboxBase: 'boldOpRestrictions' },
                { toggleBase: 'toggleMealReliefs', inputBase: 'locationMealReliefs', boldCheckboxBase: null },
                { toggleBase: 'toggleFerryVehicles', inputBase: 'locationFerryVehicles', boldCheckboxBase: null },
                { toggleBase: 'toggleBlindDisplay', inputBase: 'locationBlindDisplay', boldCheckboxBase: null }
            ];

            availabilityFields.forEach(field => {
                const templateCheckbox = templateSection.querySelector(`input[id^="${field.toggleBase}_L"]`);
                const templateInput = templateSection.querySelector(`input[id^="${field.inputBase}_L"]`);
                const templateBoldCheckbox = field.boldCheckboxBase ? templateSection.querySelector(`input[id^="${field.boldCheckboxBase}_L"]`) : null;

                const checkbox = newSection.querySelector(`input[id="${templateCheckbox.id}"]`); 
                const inputField = newSection.querySelector(`input[id="${templateInput.id}"]`);
                const labelForCheckbox = newSection.querySelector(`label[for="${templateCheckbox.id}"]`);
                const boldCheckbox = field.boldCheckboxBase && templateBoldCheckbox ? newSection.querySelector(`input[id="${templateBoldCheckbox.id}"]`) : null;
                const labelForBoldCheckbox = field.boldCheckboxBase && templateBoldCheckbox && boldCheckbox ? newSection.querySelector(`label[for="${templateBoldCheckbox.id}"]`) : null;
                
                if (checkbox && inputField) {
                    const newCheckboxId = `${field.toggleBase}_${newLocationIdPrefix}`;
                    const newInputId = `${field.inputBase}_${newLocationIdPrefix}`;
                    
                    checkbox.id = newCheckboxId;
                    checkbox.dataset.targetInputId = newInputId; 
                    checkbox.checked = true; 
                    if(labelForCheckbox) labelForCheckbox.setAttribute('for', newCheckboxId);
                    
                    inputField.id = newInputId;
                    inputField.value = ''; 
                    inputField.classList.remove('hidden-field');

                    if (boldCheckbox) {
                        const newBoldCheckboxId = `${field.boldCheckboxBase}_${newLocationIdPrefix}`;
                        boldCheckbox.id = newBoldCheckboxId;
                        boldCheckbox.checked = false; 
                        if (labelForBoldCheckbox) labelForBoldCheckbox.setAttribute('for', newBoldCheckboxId);
                    }
                }
            });
            
            container.appendChild(newSection);
            initializeFieldVisibility(newSection); 
            initializeCurtailmentForLocation(newSection);
            locationSectionCounter++;
        }

        function removeLocationSection(button) { 
            const sectionToRemove = button.closest('.location-section');
            if (document.querySelectorAll('#authorisedStandsContainer .location-section').length > 1) {
                sectionToRemove.remove();
            } else {
                alert("At least one Stand/Point section is required.");
            }
        }
        function addGarageJourneyRow() { 
            const table = document.getElementById("garageJourneysTable").getElementsByTagName('tbody')[0];
            const newRow = table.insertRow(table.rows.length);
            newRow.insertCell(0).innerHTML = '<input type="text" class="garage-from">';
            newRow.insertCell(1).innerHTML = '<input type="text" class="garage-to">';
            newRow.insertCell(2).innerHTML = '<textarea class="garage-roads" rows="2"></textarea>';
            newRow.insertCell(3).innerHTML = '<button type="button" class="remove-item-btn" onclick="removeTableRow(this)">Remove</button>';
        }
        function removeTableRow(button) { 
             button.closest('tr').remove();
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateRouteDetailsInputs(); 
            document.querySelectorAll('.location-section').forEach(section => {
                initializeFieldVisibility(section);
                initializeCurtailmentForLocation(section);
            });
        });

        function generatePDF() {
            const routeNum = document.getElementById("routeNumberInput").value.trim();
            const isCircular = document.getElementById('isCircularRouteCheckbox').checked;
            let routeDetailsText = "";
            if (isCircular) {
                const circularDest = document.getElementById('routeCircularDestination')?.value.trim();
                routeDetailsText = circularDest ? `${circularDest} (circular)` : "[Circular destination not specified] (circular)";
            } else {
                const destFrom = document.getElementById('routeDestinationFrom')?.value.trim();
                const destTo = document.getElementById('routeDestinationTo')?.value.trim();
                if (destFrom || destTo) { 
                    routeDetailsText = `${destFrom || '[Start not specified]'} - ${destTo || '[End not specified]'}`;
                } else {
                    routeDetailsText = "[Route destinations not specified]";
                }
            }
            const fullRoutePdfString = `ROUTE ${routeNum || '[Num]'}: ${routeDetailsText}`;

            const structuralChangeDate = document.getElementById("structuralChangeDate").value;
            const serviceChangeDate = document.getElementById("serviceChangeDate").value;
            const reasonForIssue = document.getElementById("reasonForIssue").value.trim();

            const streetsTraversedPdfElements = [];
            const streetSections = document.querySelectorAll('#streetsTraversedContainer .street-section');
            let hasAddedStreetsTraversedHeader = false;
            streetSections.forEach((section, index) => {
                const destination = section.querySelector('.street-destination').value.trim();
                const details = section.querySelector('.street-details').value.trim();
                if (details) {
                    if (!hasAddedStreetsTraversedHeader) { hasAddedStreetsTraversedHeader = true; }
                    const topMargin = streetsTraversedPdfElements.length > 0 ? 10 : 0;
                    streetsTraversedPdfElements.push({ text: `Towards ${destination || '[Destination not specified]'}:`, style: 'towardsLabel', margin: [0, topMargin, 0, 2] });
                    streetsTraversedPdfElements.push({text: details, style: 'arial12'});
                }
            });

            const garageTable = document.getElementById("garageJourneysTable").getElementsByTagName('tbody')[0];
            const garageJourneysContent = [];
            for (let i = 0; i < garageTable.rows.length; i++) {
                const from = garageTable.rows[i].cells[0].querySelector('.garage-from').value.trim();
                const to = garageTable.rows[i].cells[1].querySelector('.garage-to').value.trim();
                const roads = garageTable.rows[i].cells[2].querySelector('.garage-roads').value.trim();
                if (from || to || roads) {
                    garageJourneysContent.push(
                        { text: `From ${from} to ${to}`, style: 'garageJourneyLocationStyle', margin: [0, (garageJourneysContent.length > 0 ? 5: 0) , 0, 2] },
                        { text: roads, style: 'garageJourneyRoadsStyle' }
                    );
                }
            }

            const authorisedStandsPdfElements = [];
            const locationSections = document.querySelectorAll('#authorisedStandsContainer .location-section');
            let hasAddedAuthStandsMainHeader = false;

            locationSections.forEach((section) => {
                const locationIndex = section.dataset.index;
                const locationIdPrefix = `L${locationIndex}`; 
                
                const standNameInput = document.getElementById(`locationStandName_${locationIdPrefix}`);
                const locationDisplayName = standNameInput ? standNameInput.value.trim().toUpperCase() : "UNTITLED STAND/POINT";
                                
                let sectionHasContentForPDF = !!(locationDisplayName && locationDisplayName !== "UNTITLED STAND/POINT");
                const currentSectionPdfBlock = [];

                if (locationDisplayName && locationDisplayName !== "UNTITLED STAND/POINT") {
                     if (authorisedStandsPdfElements.length > 0) { 
                         authorisedStandsPdfElements.push({ text: '', margin: [0, 15, 0, 0] }); 
                    }
                    currentSectionPdfBlock.push({ text: locationDisplayName, style: 'locationHeader', margin: [0, 0, 0, 5] });
                }
                
                const curtailmentBlocks = section.querySelectorAll('.curtailment-direction-block');
                const selectedCurtailmentTypeRadio = section.querySelector(`input[name="curtailmentType_${locationIdPrefix}"]:checked`);
                const curtailmentType = selectedCurtailmentTypeRadio ? selectedCurtailmentTypeRadio.value : null;

                if (curtailmentType === "one" && curtailmentBlocks.length > 0) {
                    const detailsTextarea = curtailmentBlocks[0].querySelector('.curtailment-details-text');
                    const details = detailsTextarea ? detailsTextarea.value.trim() : "";
                    if (details) {
                        sectionHasContentForPDF = true;
                        if (currentSectionPdfBlock.length === 0 && (locationDisplayName === "UNTITLED STAND/POINT" || !locationDisplayName)) {
                             if (authorisedStandsPdfElements.length > 0) { authorisedStandsPdfElements.push({ text: '', margin: [0, 15, 0, 0] }); }
                             currentSectionPdfBlock.push({ text: "STAND PROCEDURE", style: 'locationHeader', margin: [0, 0, 0, 5] });
                        }
                        currentSectionPdfBlock.push({ text: details, style: 'curtailmentDetailsStyle', margin: [0, 0, 0, 10] });
                    }
                } else if (curtailmentType === "two") {
                    curtailmentBlocks.forEach((block, index) => {
                        const destinationInput = block.querySelector('.curtailment-destination');
                        const detailsTextarea = block.querySelector('.curtailment-details-text');
                        const destination = destinationInput ? destinationInput.value.trim() : "";
                        const details = detailsTextarea ? detailsTextarea.value.trim() : "";

                        if (destination || details) {
                            sectionHasContentForPDF = true;
                            let topMarginForFrom = (index === 0 && currentSectionPdfBlock.length > 0 && currentSectionPdfBlock[0].style === 'locationHeader') ? 5 : 0;
                             if (index > 0 || (index === 0 && !(currentSectionPdfBlock.length > 0 && currentSectionPdfBlock[0].style === 'locationHeader'))) {
                                topMarginForFrom = 5;
                             }
                            currentSectionPdfBlock.push({ text: `From ${destination || '[Destination not specified]'}`, style: 'curtailmentFromStyle', margin: [0, topMarginForFrom, 0, 2] });
                            if (details) {
                                currentSectionPdfBlock.push({ text: details, style: 'curtailmentDetailsStyle', margin: [0, 0, 0, 5] });
                            }
                        }
                    });
                }
                
                const availabilityBody = [];
                const fieldDefinitions = [ 
                    { checkboxIdBase: 'toggleAvailability', inputIdBase: 'locationAvailability', label: 'AVAILABILITY:', boldCheckboxIdBase: null },
                    { checkboxIdBase: 'toggleOpRestrictions', inputIdBase: 'locationOperatingRestrictions', label: 'OPERATING RESTRICTIONS:', boldCheckboxIdBase: 'boldOpRestrictions' },
                    { checkboxIdBase: 'toggleMealReliefs', inputIdBase: 'locationMealReliefs', label: 'MEAL RELIEFS:', boldCheckboxIdBase: null },
                    { checkboxIdBase: 'toggleFerryVehicles', inputIdBase: 'locationFerryVehicles', label: 'FERRY VEHICLES:', boldCheckboxIdBase: null },
                    { checkboxIdBase: 'toggleBlindDisplay', inputIdBase: 'locationBlindDisplay', label: 'BLIND DISPLAY:', boldCheckboxIdBase: null }
                ];
                
                fieldDefinitions.forEach(def => {
                    const checkbox = document.getElementById(`${def.checkboxIdBase}_${locationIdPrefix}`);
                    const inputWrapper = document.getElementById(`${def.inputIdBase}_${locationIdPrefix}`)?.parentElement;
                    const inputField = inputWrapper ? inputWrapper.querySelector('input[type="text"]') : null;

                    if (checkbox && checkbox.checked && inputField) {
                        let value = inputField.value.trim();
                        let isValueBold = false;

                        if (def.inputIdBase === 'locationOperatingRestrictions') { 
                            value = value.replace(/\n+/g, ' '); 
                            const boldCheckbox = document.getElementById(`${def.boldCheckboxIdBase}_${locationIdPrefix}`);
                            if (boldCheckbox) { isValueBold = boldCheckbox.checked; }
                        }
                        if (value) { 
                           availabilityBody.push([
                               {text: def.label, font: 'Arial', fontSize: 12, bold: true }, 
                               {text: value, bold: isValueBold, font: 'Arial', fontSize: 12}
                            ]);
                           sectionHasContentForPDF = true; 
                        }
                    }
                });

                if (availabilityBody.length > 0) {
                    sectionHasContentForPDF = true; 
                    if (currentSectionPdfBlock.length === 0 && (!locationDisplayName || locationDisplayName === "UNTITLED STAND/POINT")) {
                        if (authorisedStandsPdfElements.length > 0) { authorisedStandsPdfElements.push({ text: '', margin: [0, 15, 0, 0] }); }
                        currentSectionPdfBlock.push({ text: "STAND DETAILS (NO NAME PROVIDED)", style: 'locationHeader', margin: [0, 0, 0, 5] });
                    } else if (currentSectionPdfBlock.length > 0) {
                         if(!currentSectionPdfBlock.find(el => el.style === 'availabilityGridStyle')) { 
                            currentSectionPdfBlock.push({text: '', margin: [0,10,0,0]}); 
                         }
                    }
                    currentSectionPdfBlock.push({
                        style: 'availabilityGridStyle', 
                        table: { widths: ['auto', '*'], body: availabilityBody },
                        layout: 'noBorders'
                    });
                }
                
                if(sectionHasContentForPDF){
                    if (!hasAddedAuthStandsMainHeader) { hasAddedAuthStandsMainHeader = true; }
                    authorisedStandsPdfElements.push(...currentSectionPdfBlock);
                }
            });

            const contentArray = [ 
                { text: 'OMSI BUSES - ROUTE DESCRIPTION', style: 'header', alignment: 'center' },
                { text: fullRoutePdfString, style: 'subheader', alignment: 'center', margin: [0, 10, 0, 20] }, 
                { text: [ {text: 'Date of Structural Change: ', style: 'infoLabel'}, {text: structuralChangeDate ? new Date(structuralChangeDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A', style: 'infoValue'} ], margin: [0, 0, 0, 5] },
                { text: [ {text: 'Date of Service Change:  ', style: 'infoLabel'}, {text: serviceChangeDate ? new Date(serviceChangeDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A', style: 'infoValue'} ], margin: [0, 0, 0, 5] },
                { text: [ {text: 'Reason for Issue: ', style: 'infoLabel'}, {text: reasonForIssue || "N/A", style: 'infoValue'} ], margin: [0, 0, 0, 15] },
            ];

            if (hasAddedStreetsTraversedHeader) {
                 contentArray.push({ text: 'STREETS TRAVERSED', style: 'customSectionHeader13', margin: [0, 0, 0, 5] });
                 contentArray.push(...streetsTraversedPdfElements);
            }
            if (garageJourneysContent.length > 0) {
                contentArray.push({ text: 'GARAGE JOURNEYS', style: 'customSectionHeader16', margin: [0, 15, 0, 5], pageBreak: (hasAddedStreetsTraversedHeader) ? 'before' : undefined });
                contentArray.push(...garageJourneysContent);
            }
            if (hasAddedAuthStandsMainHeader) {
                 contentArray.push({ text: 'AUTHORISED STANDS, CURTAILMENT POINTS, & BLIND DESCRIPTIONS', style: 'customSectionHeader16', margin: [0, 15, 0, 5], pageBreak: (garageJourneysContent.length > 0 || hasAddedStreetsTraversedHeader) ? 'before' : undefined });
                 contentArray.push({ text: 'Please note that only stands, curtailment points, & blind descriptions as detailed in this contractual document may be used.', style: 'explanatoryNote', margin: [0, 0, 0, 10] });
                 contentArray.push(...authorisedStandsPdfElements);
            }

            const docDefinition = { 
                content: contentArray,
                defaultStyle: { 
                    font: 'Arial',
                    fontSize: 10 
                },
                styles: {
                    header: { font: 'Arial', fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
                    subheader: { font: 'Arial', fontSize: 13, bold: true, italics: false }, 
                    infoLabel: { font: 'Arial', fontSize: 12, bold: true },
                    infoValue: { font: 'Arial', fontSize: 12 },
                    customSectionHeader13: { font: 'Arial', fontSize: 13, bold: true, margin: [0, 10, 0, 5] },
                    customSectionHeader16: { font: 'Arial', fontSize: 16, bold: true, margin: [0, 10, 0, 5] },
                    towardsLabel: { font: 'Arial', fontSize: 12, bold: true, decoration: 'underline' },
                    arial12: {font: 'Arial', fontSize: 12}, 
                    garageJourneyLocationStyle: { font: 'Arial', fontSize: 13, bold: true, italics: false },
                    garageJourneyRoadsStyle: { font: 'Arial', fontSize: 12 },
                    explanatoryNote: { font: 'Arial', fontSize: 12, italics: false },
                    locationHeader: { font: 'Arial', fontSize: 13, bold: true }, 
                    curtailmentFromStyle: {font: 'Arial', fontSize: 12, decoration: 'underline', bold: false }, 
                    curtailmentDetailsStyle: {font: 'Arial', fontSize: 12}, 
                    availabilityGridStyle: { margin: [0, 5, 0, 10] }
                },
                pageMargins: [ 40, 60, 40, 60 ]
            };
            
            let pdfFileNamePart = "details";
             if (routeNum) { 
                pdfFileNamePart = routeNum.replace(/[^a-zA-Z0-9]/g, '_').trim() || "route";
                if (pdfFileNamePart === "") pdfFileNamePart = "route";
            }
            pdfMake.createPdf(docDefinition).download(`bus_route_${pdfFileNamePart}_info.pdf`);
        }
    </script>
</body>
</html>