<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMSI Countdown - Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @font-face {
            font-family: 'NJFont Medium Web';
            src: url('fonts/NJFont-Medium.ttf') format('truetype');
            font-weight: normal;font-style: normal;font-display: swap;
        }
        body {
            font-family: 'NJFont Medium Web', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            margin:0;
        }
        .page-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        #top-menu-bar {
            background-color: rgba(0,0,0,0.25);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center;
            display: none; /* Hidden by default, shown after login */
        }
        .menu-button {
            cursor: pointer; 
            background-color: #3498db; 
            color: white;
            padding: 0.6rem 1.2rem; 
            border-radius: 0.25rem; 
            font-size: 0.9rem;
            transition: background-color 0.2s; 
            border: none; 
            margin: 0.25rem;
        }
        .menu-button:hover { 
            background-color: #2980b9; 
        }

        .tool-content-section {
            display: none; /* All tool sections hidden by default */
        }

        #auth-section { 
             margin-bottom: 1.5rem;
        }
        #current-profile-display-container {
            text-align: center; 
            margin-bottom: 1.5rem; 
            padding: 0.75rem; 
            background-color: rgba(255,255,255,0.05); 
            border-radius: 0.25rem;
            display: none; /* Hidden by default, shown after login */
        }
        #current-profile-display { font-size: 0.9rem; opacity: 0.9; font-style: italic;}


        h1 { font-size: 2rem; margin-bottom: 1.5rem; font-weight: normal; text-align: center; color: #ffffff; }
        h2 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: normal; border-bottom: 1px solid #7f8c8d; padding-bottom: 0.25rem;}
        h3.subsection-title { font-size: 1.25rem; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: normal; color: #e0e0e0; border-bottom: 1px solid rgba(127,140,141,0.5); padding-bottom: 0.2rem;}


        .section {
            background-color: rgba(0,0,0,0.15);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .subsection { /* For subsections within a tool-content-section */
            background-color: rgba(0,0,0,0.1);
            padding: 1rem;
            border-radius: 0.375rem; /* slightly smaller radius */
            margin-top: 1rem;
            margin-bottom: 1rem;
             border: 1px solid rgba(127,140,141,0.2);
        }


        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;}
        .form-section div { margin-bottom: 0.75rem; }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            color: #bdc3c7;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="time"],
        input[type="color"],
        select {
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #7f8c8d;
            background-color: #34495e;
            color: #ecf0f1;
            font-size:0.9rem;
        }
        input[type="color"] { height: 2.75rem; padding: 0.25rem; }
        #inputOperatingProfile, #analyticsOperatingProfileSelect { max-width: 100%;}
        #selectDayOffset, #selectRouteNameColour, #selectStopForDeparturesView { max-width: 100%; }
        #editMasterStopIdSelect, #routesForStopSelect_StopManagement { max-width: 100%; }
        #selectDayOffset option, #selectRouteNameColour option, #selectStopForDeparturesView option, #analyticsOperatingProfileSelect option,
        #editMasterStopIdSelect option, #routesForStopSelect_StopManagement option { background-color: #34495e; color: #ecf0f1; }


        #inputStopID, #inputLineName, #bulkEditTargetStopID, #bulkEditTargetLineName,
        #editMasterStopIdInput, #findStopIdScheduleInput, #replaceStopIdScheduleInput {
            text-transform: uppercase;
        }

        .button { 
            cursor: pointer; background-color: #3498db; color: white;
            padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem;
            transition: background-color 0.2s; border: none; margin-right: 0.5rem; margin-top:0.5rem;
        }
        .button:hover { background-color: #2980b9; }
        .button.small-action { padding: 0.2rem 0.4rem; font-size: 0.9rem; margin: 0 0.15rem; line-height: 1; min-width: 20px; text-align:center;}
        .button.secondary { background-color: #e74c3c; }
        .button.secondary:hover { background-color: #c0392b; }
        .button.tertiary { background-color: #f39c12; }
        .button.tertiary:hover { background-color: #e67e22; }
        .button.neutral { background-color: #7f8c8d; }
        .button.neutral:hover { background-color: #95a5a6; color: #2c3e50; }


        .file-upload-label { display: inline-block; cursor: pointer; background-color: #95a5a6; color: #2c3e50; padding: 0.6rem 1.2rem; border-radius: 0.25rem; font-size: 0.9rem; transition: background-color 0.2s; margin-bottom: 0.5rem; }
        .file-upload-label:hover { background-color: #7f8c8d; }
        #file-status { font-size: 0.9rem; margin-top: 0.25rem; margin-bottom:1rem; opacity: 0.9; min-height: 1.2em; }

        /* Styles for currentScheduleTableContainer are no longer needed as the table is removed */
        /* table, th, td specific to currentScheduleTableContainer also removed implicitly */

        .actions-section { margin-top: 1.5rem; }
        #stageScheduleButton { background-color: #27ae60; }
        #stagingStatusMessage { text-align:center; margin-bottom: 1rem; font-size: 0.9em; color: #f1c40f; min-height:1.2em; }


        .info-section { margin-top:2rem; padding:1rem; background-color: rgba(0,0,0,0.1); border-radius:0.25rem; font-size:0.8rem; }
        .info-section h3 { font-size:1rem; margin-bottom:0.5rem; color: #ffffff; }
        .info-section p { line-height:1.6; color:#bdc3c7; }

        .tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; font-size:0.8em; background-color:#7f8c8d; color:white; border-radius:50%; width:14px; height:14px; text-align:center; line-height:14px;}
        .tooltip .tooltiptext {
            visibility: hidden; width: 280px; background-color: #34495e; color: #fff;
            text-align: left; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 10; bottom: 135%; left: 50%; margin-left: -140px; opacity: 0; transition: opacity 0.3s;
            font-size: 0.75rem; line-height: 1.4; border: 1px solid #7f8c8d;
        }
        .tooltip .tooltiptext::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #34495e transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; align-items: end;}
        /* filter-controls styles will only apply where this class is still used */

        .current-details-display {
            margin-top: 0.5rem;
            font-size: 0.85em;
            background-color: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 0.25rem;
            color: #bdc3c7;
        }
        .current-details-display p { margin: 0.2rem 0; }
        .current-details-display span { font-style: italic; color: #ecf0f1; }

        .event-section div, .stop-status-section div, .route-colour-management-subsection div, 
        .view-stop-departures div, .analytics-subsection div {
            margin-bottom: 0.75rem;
        }
        .event-section label, .stop-status-section label, .route-colour-management-subsection label, 
        .view-stop-departures label, .analytics-subsection label {
             margin-bottom: 0.25rem;
        }


        #currentRouteColoursListContainer, #duplicateEntriesResults { /* serviceFrequencyResults container removed */
            border: 1px solid #4A5568;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-top: 1rem;
            max-height: 300px; 
            overflow-y: auto;
            background-color: rgba(0,0,0,0.05);
        }
        #currentRouteColoursList li, #duplicateEntriesResults li { /* serviceFrequencyResults li removed */
            display: block; 
            padding: 0.5rem;
            border-bottom: 1px solid #34495e;
            font-size: 0.9rem;
        }
        #currentRouteColoursList li:last-child, #duplicateEntriesResults li:last-child { border-bottom: none; }
        
        #duplicateEntriesResults .duplicate-set { margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #4A5568;}
        #duplicateEntriesResults .duplicate-set:last-child { border-bottom: none; }
        #duplicateEntriesResults .entry-detail { display: block; font-size: 0.85rem; margin-left: 1rem; opacity: 0.9;}


        .colour-preview-box {
            width: 20px;
            height: 20px;
            border: 1px solid #ecf0f1;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
        }
        #currentRouteColoursList .route-info { flex-grow: 1; }

        .route-tile-tools-list { /* Used for route tiles in "View Departures" and "Stop Management" */
            display: inline-block;
            padding: 0.2em 0.55em;
            margin-right: 0.3em; /* Reduced margin for tighter packing if needed */
            margin-bottom: 0.3em; /* Added for wrapping */
            border-radius: 0.25rem;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
            line-height: 1.3;
            min-width: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
            vertical-align: middle;
        }
        #stopDeparturesList li {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.1rem;
            border-bottom: 1px solid #34495e;
            font-size: 0.9rem;
        }
        #stopDeparturesList li:last-child {
            border-bottom: none;
        }

        #masterStopListUL_SM li {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #34495e;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        #masterStopListUL_SM li:last-child {
            border-bottom: none;
        }
        #masterStopListUL_SM li:hover {
            background-color: #34495e;
        }
        #masterStopListUL_SM li .stop-id-master { font-weight: bold; color: #ecf0f1;}
        #masterStopListUL_SM li .stop-name-master { color: #bdc3c7; }
        #masterStopListUL_SM li .stop-direction-master { font-style: italic; font-size: 0.85em; color: #95a5a6; }

        /* Updated Styles for Routes Serving Stop in Stop Management */
        #routesServingStopListContainer_SM { 
            margin-top: 0.5rem;
            max-height: 200px; /* Adjusted height as it might contain fewer items or just tiles */
            overflow-y: auto;
            background-color: rgba(0,0,0,0.05);
            padding:0.75rem; /* Increased padding for better centering */
            border: 1px solid #4A5568; /* Added border for definition */
            border-radius: 0.25rem;
        }
        #routesServingStopList_SM { /* The UL element for route tiles */
            list-style: none;
            padding: 0;
            margin:0;
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; /* Center align the tiles */
            gap: 0.5em; /* Space between tiles */
        }
        #routesServingStopList_SM li { /* Each tile will be an LI */
            padding: 0; /* Remove default li padding */
            border-bottom: none; /* Override general li style if any */
            /* The .route-tile-tools-list class will style the tile itself */
        }

    </style>
</head>
<body lang="en-GB">
    <div class="page-container">
        <h1>Bus Schedule Setup & Management</h1>

        <div id="auth-section" class="section">
            <h2>Admin Login</h2>
            <div id="login-form-container">
                <form id="adminLoginForm">
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div><label for="inputEmail">Email</label><input type="email" id="inputEmail" autocomplete="email"></div>
                        <div><label for="inputPassword">Password</label><input type="password" id="inputPassword" autocomplete="current-password"></div>
                    </div>
                    <button id="loginButton" type="submit" class="button">Login</button>
                </form>
                <p id="auth-status" style="margin-top: 0.5em; color: #f1c40f;"></p>
            </div>
            <div id="logout-container" style="display:none;">
                <p>Logged in as: <span id="loggedInUserEmail"></span></p>
                <button id="logoutButton" class="button secondary">Logout</button>
            </div>
        </div>

        <div id="current-profile-display-container" class="section">
            <p id="current-profile-display">Today's Auto Profile: (determining...)</p>
        </div>

        <div id="top-menu-bar">
            <div id="main-menu-buttons">
                <button class="menu-button" data-section="bulk-edit-tools-section">Bulk Edit & Colours</button>
                <button class="menu-button" data-section="event-generator-section">Event Generator</button>
                <button class="menu-button" data-section="stop-status-section">Stop Status</button>
                <button class="menu-button" data-section="view-departures-section">View Departures</button>
                <button class="menu-button" data-section="deployment-tools-section">Deployment & Entry</button>
                <button class="menu-button" data-section="analytics-validation-section">Analytics & Validation</button>
                <button class="menu-button" data-section="stop-management-tool-section">Stop Management</button>
            </div>
        </div>
        
        <div id="tool-sections-wrapper">
            <div id="bulk-edit-tools-section" class="tool-content-section">
                <div class="section bulk-edit-stop-details-section">
                    <h2>Update Stop Name & Direction by Stop ID</h2>
                    <div class="form-grid" style="grid-template-columns: 1fr; gap: 0.75rem;">
                        <div><label for="bulkEditTargetStopID">Target Stop ID</label><input type="text" id="bulkEditTargetStopID" placeholder="Enter Stop ID" autocomplete="off"></div>
                        <div class="current-details-display"><p><strong>Current Name:</strong> <span id="currentBulkEditStopNameDisplay">-</span></p><p><strong>Current Direction:</strong> <span id="currentBulkEditDirectionDisplay">-</span></p></div>
                        <div><label for="bulkEditNewStopName">New Stop Name</label><input type="text" id="bulkEditNewStopName" placeholder="New stop name" autocomplete="off"></div>
                        <div><label for="bulkEditNewDirection">New "Towards" Text</label><input type="text" id="bulkEditNewDirection" placeholder="New direction" autocomplete="off"></div>
                        <div style="margin-top: 0.5rem;"><button id="bulkUpdateDetailsButton" class="button">Update Stop Details</button></div>
                    </div>
                </div>
                <div class="section bulk-edit-route-destination">
                    <h2>Update Destination for a Route</h2>
                    <div class="form-grid" style="grid-template-columns: 1fr 1.5fr 1.5fr auto; align-items:end; gap: 0.75rem;">
                        <div><label for="bulkEditTargetLineName">Target Line</label><input type="text" id="bulkEditTargetLineName" placeholder="e.g., 186" autocomplete="off"></div>
                        <div><label for="bulkEditOldDestination">Old Destination (optional)</label><input type="text" id="bulkEditOldDestination" placeholder="Blank to update all" autocomplete="off"></div>
                        <div><label for="bulkEditNewDestination">New Destination</label><input type="text" id="bulkEditNewDestination" placeholder="New destination" autocomplete="off"></div>
                        <div style="padding-bottom:0.05rem;"><button id="bulkUpdateRouteDestinationButton" class="button">Update Destination</button></div>
                    </div>
                </div>
                <div class="section route-colour-management-subsection">
                    <h2>Route Tile Colour Management</h2>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:1rem;">Define custom colours for routes on the arrivals board.</p>
                    <div class="form-grid" style="grid-template-columns: 1.5fr 1fr auto; align-items: end; gap: 0.75rem;">
                        <div><label for="selectRouteNameColour">Route Name</label><select id="selectRouteNameColour"><option value="">-- Select Route --</option></select></div>
                        <div><label for="inputRouteColour">Select Colour</label><input type="color" id="inputRouteColour" value="#73809C" autocomplete="off"></div>
                        <div style="padding-bottom:0.05rem;"><button id="saveRouteColourButton" class="button">Save Colour</button></div>
                    </div>
                    <div id="currentRouteColoursListContainer"><h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Current Custom Colours</h3><ul id="currentRouteColoursList"></ul><p id="noCustomColoursMessage">No custom colours set.</p></div>
                    <p id="routeColourStatusMessage" style="min-height:1.2em;"></p>
                </div>
            </div>

            <div id="event-generator-section" class="tool-content-section">
                 <div class="section random-event-generator">
                    <h2>Random Event Generator</h2>
                    <div class="form-grid event-section" style="grid-template-columns: 1.5fr 1.5fr auto; align-items:end;">
                        <div><label for="selectEventRoute">Route</label><select id="selectEventRoute"><option value="">-- Select Route --</option></select></div>
                        <div><label for="selectEventImpactStop">Impact From Stop (Optional)</label><select id="selectEventImpactStop"><option value="">-- Route Wide --</option></select></div>
                        <div style="padding-bottom:0.05rem;"><button id="triggerEventButton" class="button tertiary">Trigger Event</button></div>
                    </div>
                    <p id="eventStatusMessage" style="min-height:1.2em;"></p>
                </div>
            </div>

            <div id="stop-status-section" class="tool-content-section">
                <div class="section stop-status-section">
                    <h2>Manage Bus Stop Status (Live)</h2>
                    <div class="form-grid stop-status-section" style="grid-template-columns: 2fr auto auto; align-items:end;">
                        <div><label for="selectStopForStatusChange">Stop</label><select id="selectStopForStatusChange"><option value="">-- Select Stop --</option></select></div>
                        <div style="padding-bottom:0.05rem;"><button id="closeStopButton" class="button secondary">Close Stop</button></div>
                        <div style="padding-bottom:0.05rem;"><button id="reopenStopButton" class="button" style="background-color: #2ecc71;">Reopen Stop</button></div>
                    </div>
                    <p id="stopStatusMessage" style="min-height:1.2em;"></p>
                </div>
            </div>
            
            <div id="view-departures-section" class="tool-content-section">
                <div class="section view-stop-departures">
                    <h2>View Scheduled Departures by Stop</h2>
                    <div class="form-grid" style="grid-template-columns: 1fr 2fr; align-items: start; gap: 1.5rem;">
                        <div><label for="selectStopForDeparturesView">Bus Stop</label><select id="selectStopForDeparturesView"><option value="">-- Select Stop --</option></select></div>
                        <div><label>Departures</label><div id="stopDeparturesListContainer"><ul id="stopDeparturesList"></ul><p id="noDeparturesForStopMessage">Select stop to view.</p></div></div>
                    </div>
                </div>
            </div>
            
            <div id="deployment-tools-section" class="tool-content-section">
                <div class="section count-file-upload">
                    <h2>Upload Full Schedule</h2>
                    <p style="font-size:0.8em; margin-bottom:0.5em;">Replaces current working schedule.</p>
                    <label for="count-file-input" class="file-upload-label">Choose .COUNT File</label>
                    <input type="file" id="count-file-input" accept=".COUNT,.txt" style="display: none;">
                    <p id="file-status">No file selected.</p>
                </div>
                <div class="actions-section section">
                    <h2>Schedule Deployment Actions</h2>
                    <div id="stagingStatusMessage" style="min-height:1.2em;">Checking status...</div>
                    <button id="stageScheduleButton" class="button">Stage Working Schedule</button>
                    <button id="applyNowButton" class="button tertiary">Apply Staged Live NOW</button>
                    <hr style="margin: 1.5rem 0; border-color: rgba(255,255,255,0.1);">
                    <button id="viewArrivalsButton" class="button">View Arrivals Board</button>
                </div>
            </div>

            <div id="analytics-validation-section" class="tool-content-section">
                <div class="section">
                    <h2>Schedule Analytics & Validation</h2>

                    <div class="subsection analytics-subsection">
                        <h3 class="subsection-title">Duplicate Entry Detection</h3>
                        <button id="detectDuplicatesButton" class="button">Find Duplicate Entries</button>
                        <div id="duplicateEntriesResults" style="margin-top: 0.75rem;">
                            <p>Click the button to scan the current working schedule for duplicate entries.</p>
                        </div>
                    </div>

                    </div>
            </div>

            <div id="stop-management-tool-section" class="tool-content-section">
                <div class="section">
                    <h2>Master List of Unique Stops</h2>
                    <div class="filter-controls" style="grid-template-columns: 1fr auto; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <input type="text" id="masterStopListFilterInput_SM" placeholder="Filter by Stop ID, Name, or Direction...">
                        <button id="refreshMasterStopListButton_SM" class="button neutral">Refresh List</button>
                    </div>
                    <div id="masterStopListContainer_SM" class="subsection" style="max-height: 350px; overflow-y: auto; padding: 0.5rem; background-color: rgba(0,0,0,0.05);">
                        <ul id="masterStopListUL_SM" style="list-style: none; padding: 0;">
                            </ul>
                    </div>
                    <p id="masterStopListStatus_SM" style="text-align: center; margin-top: 0.5rem; min-height: 1.2em;">Click "Refresh List" to load stops from the current working schedule.</p>
                </div>

                <div class="section">
                    <h2>Find and Replace Stop IDs in Working Schedule</h2>
                    <p style="font-size:0.85em; opacity:0.8; margin-bottom:0.75rem;">This utility directly modifies the 'Working Schedule Table'. It changes all occurrences of an old Stop ID to a new Stop ID. The Stop Name and Direction for the new Stop ID will be taken from the first found instance of the 'New Stop ID' in the schedule. If the 'New Stop ID' is not found, you might be prompted or it might use blank values.</p>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 0.75rem;">
                        <div><label for="findStopIdScheduleInput_SM">Stop ID to Find in Schedule</label><input type="text" id="findStopIdScheduleInput_SM" placeholder="e.g., OLDSTOPID"></div>
                        <div><label for="replaceStopIdScheduleInput_SM">Replace with New Stop ID</label><input type="text" id="replaceStopIdScheduleInput_SM" placeholder="e.g., NEWSTOPID"></div>
                        <div style="padding-bottom:0.05rem;"><button id="findReplaceStopIdScheduleButton_SM" class="button tertiary">Execute Find & Replace</button></div>
                    </div>
                    <p id="findReplaceStatusMessage_SM" style="min-height: 1.2em; margin-top: 0.5rem;">-</p>
                </div>

                <div class="section">
                    <h2>Stop Information</h2> <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end; gap: 0.75rem;">
                        <div>
                            <label for="routesForStopSelect_SM">Select Stop ID to View Serving Routes</label> <select id="routesForStopSelect_SM">
                                <option value="">-- Select Stop --</option>
                                </select>
                        </div>
                         <div style="padding-bottom:0.05rem;"><button id="refreshRoutesForStopSelectButton_SM" class="button neutral">Refresh Stop List</button></div>
                    </div>
                    <p id="routesServingStopStatus_SM" style="min-height: 1.2em; margin-top: 0.5rem;">Select a stop to see its serving routes.</p> <div id="routesServingStopListContainer_SM"> <ul id="routesServingStopList_SM"> </ul>
                    </div>
                </div>
            </div>
        </div> 
    </div> 

    <script type="module">
      // Firebase App initialization (NO CHANGES NEEDED HERE)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import { getDatabase, ref, set, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDePDF-kZahjzh9ij6tkuApIhoGePwVQ2s", 
        authDomain: "omsi-c5505.firebaseapp.com",       
        databaseURL: "https://omsi-c5505-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "omsi-c5505",                         
        storageBucket: "omsi-c5505.appspot.com",         
        messagingSenderId: "503595375440",               
        appId: "1:503595375440:web:356be6684b77ff5909ea55",             
        measurementId: "G-VN7X65V3F9"                 
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      window.firebaseOMSI = {
          database: database, auth: auth,
          dbRef: ref, dbSet: set, dbOnValue: onValue, dbGet: get,
          dbChild: child, dbUpdate: update, dbRemove: remove,
          authOnAuthStateChanged: onAuthStateChanged,
          authSignInWithEmailAndPassword: signInWithEmailAndPassword,
          authSignOut: signOut
      };
      console.log("Firebase Initialized for OMSI Tools.");
    </script>

    <script>
        // --- DOM Elements ---
const inputStopID = document.getElementById('inputStopID'); 
const inputStopName = document.getElementById('inputStopName'); 
const inputDirection = document.getElementById('inputDirection'); 
const inputLineName = document.getElementById('inputLineName'); 
const inputDestinationName = document.getElementById('inputDestinationName'); 
const inputScheduledTime = document.getElementById('inputScheduledTime'); 
const inputOperatingProfile = document.getElementById('inputOperatingProfile'); 
const selectDayOffset = document.getElementById('selectDayOffset'); 

const countFileInput = document.getElementById('count-file-input');
const fileStatusElement = document.getElementById('file-status');
const currentProfileDisplayContainer = document.getElementById('current-profile-display-container');
const currentProfileDisplayElement = document.getElementById('current-profile-display');

const bulkEditTargetStopIDInput = document.getElementById('bulkEditTargetStopID');
const currentBulkEditStopNameDisplay = document.getElementById('currentBulkEditStopNameDisplay');
const currentBulkEditDirectionDisplay = document.getElementById('currentBulkEditDirectionDisplay');
const bulkEditNewStopNameInput = document.getElementById('bulkEditNewStopName');
const bulkEditNewDirectionInput = document.getElementById('bulkEditNewDirection');
const bulkUpdateDetailsButton = document.getElementById('bulkUpdateDetailsButton');
const bulkEditTargetLineNameInput = document.getElementById('bulkEditTargetLineName');
const bulkEditOldDestinationInput = document.getElementById('bulkEditOldDestination');
const bulkEditNewDestinationInput = document.getElementById('bulkEditNewDestination');
const bulkUpdateRouteDestinationButton = document.getElementById('bulkUpdateRouteDestinationButton');
const selectEventRoute = document.getElementById('selectEventRoute');
const selectEventImpactStop = document.getElementById('selectEventImpactStop');
const triggerEventButton = document.getElementById('triggerEventButton');
const eventStatusMessage = document.getElementById('eventStatusMessage');
const selectStopForStatusChange = document.getElementById('selectStopForStatusChange');
const closeStopButton = document.getElementById('closeStopButton');
const reopenStopButton = document.getElementById('reopenStopButton');
const stopStatusMessage = document.getElementById('stopStatusMessage');
const stageScheduleButton = document.getElementById('stageScheduleButton');
const applyNowButton = document.getElementById('applyNowButton');
const viewArrivalsButton = document.getElementById('viewArrivalsButton');
const stagingStatusMessage = document.getElementById('stagingStatusMessage');
const selectRouteNameColour = document.getElementById('selectRouteNameColour');
const inputRouteColour = document.getElementById('inputRouteColour');
const saveRouteColourButton = document.getElementById('saveRouteColourButton');
const currentRouteColoursList = document.getElementById('currentRouteColoursList');
const noCustomColoursMessage = document.getElementById('noCustomColoursMessage');
const routeColourStatusMessage = document.getElementById('routeColourStatusMessage');
const selectStopForDeparturesView = document.getElementById('selectStopForDeparturesView');
const stopDeparturesList = document.getElementById('stopDeparturesList');
const noDeparturesForStopMessage = document.getElementById('noDeparturesForStopMessage');
const topMenuBar = document.getElementById('top-menu-bar');
const adminLoginSection = document.getElementById('auth-section');
const loginFormContainer = document.getElementById('login-form-container');
const logoutContainer = document.getElementById('logout-container');
const loginButton = document.getElementById('loginButton');
const logoutButton = document.getElementById('logoutButton');
const inputEmail = document.getElementById('inputEmail');
const inputPassword = document.getElementById('inputPassword');
const authStatus = document.getElementById('auth-status');
const loggedInUserEmailDisplay = document.getElementById('loggedInUserEmail');
const mainMenuButtons = document.querySelectorAll('#main-menu-buttons .menu-button');
const allToolContentSections = document.querySelectorAll('.tool-content-section');

const detectDuplicatesButton = document.getElementById('detectDuplicatesButton');
const duplicateEntriesResults = document.getElementById('duplicateEntriesResults');

// DOM Elements for Stop Management Tool
const masterStopListFilterInput_SM = document.getElementById('masterStopListFilterInput_SM');
const refreshMasterStopListButton_SM = document.getElementById('refreshMasterStopListButton_SM');
const masterStopListUL_SM = document.getElementById('masterStopListUL_SM');
const masterStopListStatus_SM = document.getElementById('masterStopListStatus_SM');

const findStopIdScheduleInput_SM = document.getElementById('findStopIdScheduleInput_SM');
const replaceStopIdScheduleInput_SM = document.getElementById('replaceStopIdScheduleInput_SM');
const findReplaceStopIdScheduleButton_SM = document.getElementById('findReplaceStopIdScheduleButton_SM');
const findReplaceStatusMessage_SM = document.getElementById('findReplaceStatusMessage_SM');
const routesForStopSelect_SM = document.getElementById('routesForStopSelect_SM');
const refreshRoutesForStopSelectButton_SM = document.getElementById('refreshRoutesForStopSelectButton_SM');
const routesServingStopList_SM = document.getElementById('routesServingStopList_SM');
const routesServingStopStatus_SM = document.getElementById('routesServingStopStatus_SM');


// --- Global State ---
let currentUser = null;
let currentWorkingSchedule = [];
let ukBankHolidaysData = { dates: [], titles: {} }; 
const schoolHolidayDateRanges = [ ]; 
let closedStopIDs = []; 
let customRouteColours = {}; 
let effectiveRouteColourMapTools = {}; 
let uniqueStopsMasterList_SM = []; 


// --- Constants ---
const LOCAL_STORAGE_ACTIVE_SECTION_KEY = 'omsiToolsActiveSection';
const FB_PATH_LIVE_SCHEDULE_DATA = '/liveSchedule/allScheduledBusData';
const FB_PATH_LIVE_UNIQUE_STOPS = '/liveSchedule/uniqueBusStops';
const FB_PATH_PENDING_SCHEDULE_DATA = '/pendingSchedule/allScheduledBusData';
const FB_PATH_PENDING_UNIQUE_STOPS = '/pendingSchedule/uniqueBusStops';
const FB_PATH_PENDING_TIMESTAMP = '/pendingSchedule/uploadTimestamp';
const FB_PATH_APPSTATE_STATUS = '/appState/scheduleStatus';
const FB_PATH_APPSTATE_LAST_UPDATED = '/appState/scheduleLastUpdated';
const FB_PATH_APPSTATE_CLOSED_STOPS = '/appState/closedStopIDs';
const FB_PATH_SETTINGS_CUSTOM_COLOURS = '/settings/customRouteColours';

const initialRouteColourMapForTools = { "1": "#DC2626", "2": "#DC2626", "3": "#DC2626", "4": "#00783A", "5": "#00783A", "6": "#00783A", "7": "#FFD300", "8": "#FFD300", "9": "#FFD300", "10": "#970006", "11": "#76D0BD", "12": "#F3A9BB", "186": "#E32017", "32":  "#00A4A7", "N5":  "#0019A8", "C11": "#FFD300","107": "#76D0BD", "221": "#93002F", "240": "#C9A0DC", "251": "#F8A960","303": "#868F98", "305": "#CF7EA2", "SL1": "#5F259F", "SL10": "#A05A2C" };
const DEFAULT_ROUTE_COLOUR_TOOLS = "#73809C";
// Removed original eventTypes array, will be replaced by predefinedEvents in applyRandomEvent

// --- UI Navigation & State ---
function showSection(sectionId) {
    allToolContentSections.forEach(section => {
        section.style.display = 'none';
    });
    const sectionToShow = document.getElementById(sectionId);
    if (sectionToShow) {
        sectionToShow.style.display = 'block';
        const isMainButtonSection = Array.from(mainMenuButtons).some(btn => btn.getAttribute('data-section') === sectionId);
        if (isMainButtonSection) {
            localStorage.setItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY, sectionId);
            if (sectionId === 'stop-management-tool-section') {
                populateMasterStopList_SM(); 
                populateRoutesForStopSelector_SM(); 
            }
        }
    } else {
        console.warn(`Attempted to show non-existent section: ${sectionId}`);
        localStorage.removeItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY);
    }
}

function hideAllToolSections() {
    allToolContentSections.forEach(section => {
        section.style.display = 'none';
    });
}

function updateAuthUI(user) {
    currentUser = user;
    hideAllToolSections();

    if (user) {
        if (adminLoginSection) adminLoginSection.style.display = 'none';
        if (currentProfileDisplayContainer) currentProfileDisplayContainer.style.display = 'block';
        if (topMenuBar) topMenuBar.style.display = 'block';
        if (logoutContainer) logoutContainer.style.display = 'block';
        if (loginFormContainer) loginFormContainer.style.display = 'none';
        if (authStatus) authStatus.textContent = '';
        if (loggedInUserEmailDisplay) loggedInUserEmailDisplay.textContent = user.email;

        const lastActiveSection = localStorage.getItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY);
        if (lastActiveSection) {
            const sectionElement = document.getElementById(lastActiveSection);
            const isKnownMenuSection = Array.from(mainMenuButtons).some(btn => btn.getAttribute('data-section') === lastActiveSection);
            if (sectionElement && isKnownMenuSection) {
                showSection(lastActiveSection);
            } else {
                localStorage.removeItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY);
                 if (mainMenuButtons.length > 0 && mainMenuButtons[0].dataset.section) { 
                    showSection(mainMenuButtons[0].dataset.section);
                 }
            }
        } else {
            if (mainMenuButtons.length > 0 && mainMenuButtons[0].dataset.section) { 
                showSection(mainMenuButtons[0].dataset.section);
            }
        }
    } else {
        if (adminLoginSection) adminLoginSection.style.display = 'block';
        if (currentProfileDisplayContainer) currentProfileDisplayContainer.style.display = 'none';
        if (topMenuBar) topMenuBar.style.display = 'none';
        if (logoutContainer) logoutContainer.style.display = 'none';
        if (loginFormContainer) loginFormContainer.style.display = 'block';
        if (authStatus) authStatus.textContent = 'Please log in to use the tools.';
        if (loggedInUserEmailDisplay) loggedInUserEmailDisplay.textContent = '';
        localStorage.removeItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY);
    }
}

// --- Analytics Functions ---
function detectDuplicateEntries() { 
    if (!currentUser || currentWorkingSchedule.length === 0) {
        if (duplicateEntriesResults) duplicateEntriesResults.innerHTML = '<p>No schedule data loaded or not logged in.</p>';
        return;
    }
    const signatures = new Map();
    const duplicates = [];
    currentWorkingSchedule.forEach((entry, index) => {
        const signature = [
            (entry.stopID || "").toUpperCase(),
            (entry.lineName || "").toUpperCase(),
            entry.scheduledTime || "00:00",
            (entry.OperatingProfile || "").toLowerCase().split(',').map(s => s.trim()).sort().join(','),
            entry.DayOffset || "0",
            (entry.destinationName || "").trim()
        ].join('|');
        if (signatures.has(signature)) {
            signatures.get(signature).push(index);
        } else {
            signatures.set(signature, [index]);
        }
    });
    signatures.forEach((indices, sig) => {
        if (indices.length > 1) {
            duplicates.push(indices.map(originalIndex => ({...currentWorkingSchedule[originalIndex], originalIndex})));
        }
    });
    if (duplicateEntriesResults) {
        if (duplicates.length === 0) {
            duplicateEntriesResults.innerHTML = '<p>No duplicate entries found in the current working schedule.</p>';
        } else {
            let html = `<p>Found ${duplicates.length} set(s) of duplicate entries:</p><ul>`;
            duplicates.forEach((set, i) => {
                html += `<li class="duplicate-set"><strong>Set ${i + 1}:</strong> (Appears ${set.length} times)`;
                set.forEach(entry => {
                    html += `<span class="entry-detail"> - Stop: ${entry.stopID}, Line: ${entry.lineName}, Time: ${entry.scheduledTime}, Profile: ${entry.OperatingProfile}, Dest: ${entry.destinationName} (Original Index: ${entry.originalIndex})</span>`;
                });
                html += `</li>`;
            });
            html += `</ul>`;
            duplicateEntriesResults.innerHTML = html;
        }
    }
}

// --- Utility Functions (Date, Sorting, Parsing etc.) ---
function parseLineName(lineNameStr) { const name = String(lineNameStr || "").toUpperCase().trim(); const numericPrefixRegex = new RegExp(/^(\d+)([A-Z]*)$/); const alphaNumericRegex = new RegExp(/^([A-Z]+)(\d+)?([A-Z]*)$/); const numericPrefixMatch = name.match(numericPrefixRegex); if (numericPrefixMatch) return { type: 'numeric', number: parseInt(numericPrefixMatch[1], 10), suffix: numericPrefixMatch[2] || '', original: name }; const alphaNumericMatch = name.match(alphaNumericRegex); if (alphaNumericMatch) return { type: 'alpha', prefix: alphaNumericMatch[1], number: alphaNumericMatch[2] ? parseInt(alphaNumericMatch[2], 10) : null, suffix: alphaNumericMatch[3] || '', original: name }; return { type: 'other', original: name }; }
function compareLineNames(lineAStr, lineBStr) { const parsedA = parseLineName(lineAStr); const parsedB = parseLineName(lineBStr); if (parsedA.type === 'numeric' && parsedB.type === 'alpha') return -1; if (parsedA.type === 'alpha' && parsedB.type === 'numeric') return 1; if (parsedA.type === 'numeric' && parsedB.type === 'numeric') { if (parsedA.number < parsedB.number) return -1; if (parsedA.number > parsedB.number) return 1; return parsedA.suffix.localeCompare(parsedB.suffix); } if (parsedA.type === 'alpha' && parsedB.type === 'alpha') { const prefixCompare = parsedA.prefix.localeCompare(parsedB.prefix); if (prefixCompare !== 0) return prefixCompare; if (parsedA.number === null && parsedB.number !== null) return -1; if (parsedA.number !== null && parsedB.number === null) return 1; if (parsedA.number !== null && parsedB.number !== null) { if (parsedA.number < parsedB.number) return -1; if (parsedA.number > parsedB.number) return 1; } return parsedA.suffix.localeCompare(parsedB.suffix); } if (parsedA.type !== 'other' && parsedB.type === 'other') return -1; if (parsedA.type === 'other' && parsedB.type !== 'other') return 1; return (parsedA.original || "").localeCompare(parsedB.original || ""); }

function getOperatingCodesForToday_Tools() {
    const n = new Date();
    const dOW = n.getDay();
    const todayDateString = `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
    let dateCodes = new Set();
    let isBankHolidayToday = false;

    if (ukBankHolidaysData && ukBankHolidaysData.dates && ukBankHolidaysData.dates.includes(todayDateString)) {
        const holidayTitle = ukBankHolidaysData.titles[todayDateString] || "";
        isBankHolidayToday = true;
        if (holidayTitle.toLowerCase().includes("good friday")) {
            dateCodes.add("Sa");
        } else {
            dateCodes.add("Su");
        }
    }

    if (!isBankHolidayToday) {
        const isSchHol = isSchoolHolidayPeriodForSetup(n);
        const schoolSuffix = isSchHol ? "NSD" : "Sch";
        let dayCode = "";
        switch (dOW) {
            case 0: dayCode = "Su"; break; case 1: dayCode = "Mo"; break; case 2: dayCode = "Tu"; break;
            case 3: dayCode = "We"; break; case 4: dayCode = "Th"; break; case 5: dayCode = "Fr"; break;
            case 6: dayCode = "Sa"; break;
        }
        dateCodes.add(dayCode);
        if (dOW >= 1 && dOW <= 5) {
            dateCodes.add(dayCode + schoolSuffix); dateCodes.add("MF" + schoolSuffix); dateCodes.add("Mo-Fr");
        }
        if (isSchHol) dateCodes.add("SchoolHoliday");
    } else {
        const isSchHolOnBH = isSchoolHolidayPeriodForSetup(n);
        if (isSchHolOnBH) {
            dateCodes.add("SchoolHoliday");
            if (dateCodes.has("Sa")) dateCodes.add("SaNSD");
            if (dateCodes.has("Su") && !dateCodes.has("Sa")) dateCodes.add("SuNSD");
        }
    }
    return Array.from(dateCodes);
}

async function fetchBankHolidaysForSetup() { try { const response = await fetch('https://www.gov.uk/bank-holidays.json'); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const data = await response.json(); if (data['england-and-wales'] && data['england-and-wales'].events) { const events = data['england-and-wales'].events; ukBankHolidaysData = { dates: events.map(event => event.date), titles: events.reduce((acc, event) => { acc[event.date] = event.title; return acc; }, {}) }; } else { console.warn("Setup: Bank holiday data not in expected format."); ukBankHolidaysData = { dates: [], titles: {} }; } } catch (error) { console.error("Setup: Failed to fetch UK bank holidays:", error); ukBankHolidaysData = { dates: [], titles: {} }; if(currentProfileDisplayElement) currentProfileDisplayElement.textContent = "Today's Auto Profile: (Bank Hol. check failed)"; } updateCurrentProfileDisplayOnSetup(); }
function isSchoolHolidayPeriodForSetup(dateObject) { if (!schoolHolidayDateRanges || schoolHolidayDateRanges.length === 0) return false; const checkTime = dateObject.getTime(); for (const range of schoolHolidayDateRanges) { try { const startTime = new Date(range.start + "T00:00:00").getTime(); const endTime = new Date(range.end + "T23:59:59").getTime(); if (checkTime >= startTime && checkTime <= endTime) return true; } catch (e) { console.error("Invalid date in schoolHolidayDateRanges (setup):", range, e); } } return false; }

function updateCurrentProfileDisplayOnSetup() {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const todayDateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    let profileDisplayText = "";
    let isBankHol = false;
    let serviceTypeDisplay = "";

    if (!ukBankHolidaysData || !ukBankHolidaysData.dates ) { 
        if (currentProfileDisplayElement) currentProfileDisplayElement.textContent = "Today's Auto Profile: (determining bank holidays...)";
        return; 
    }
    
    if (ukBankHolidaysData.dates.includes(todayDateString)) {
        const holidayTitle = ukBankHolidaysData.titles[todayDateString] || "Bank Holiday";
        isBankHol = true;
        if (holidayTitle.toLowerCase().includes("good friday")) {
            profileDisplayText = "Good Friday"; serviceTypeDisplay = "(Sat Service)";
        } else {
            profileDisplayText = holidayTitle; serviceTypeDisplay = "(Sun Service)";
        }
    }

    let dayName = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dayOfWeek];
    if (!isBankHol) {
        profileDisplayText = dayName;
        const isSchHol = isSchoolHolidayPeriodForSetup(now);
        if (isSchHol) profileDisplayText += " (School Hol)";
        else if (dayOfWeek >= 1 && dayOfWeek <= 5) profileDisplayText += " (School Term)";
    } else {
        profileDisplayText += ` ${serviceTypeDisplay} - Observed on a ${dayName}`;
        const isSchHolOnBH = isSchoolHolidayPeriodForSetup(now);
        if (isSchHolOnBH) profileDisplayText += " (School Hol)";
    }
    
    const operatingCodes = getOperatingCodesForToday_Tools();
    if (currentProfileDisplayElement) {
        currentProfileDisplayElement.textContent = `Today's Auto Profile: ${profileDisplayText} [Codes: ${operatingCodes.join(', ')}]`;
    }
}

// --- Form & Data Handling Functions ---
function isValidScheduleDataFromText(jsonData) { if (!jsonData || jsonData.length === 0) return false; const requiredColumns = ['StopID', 'StopName', 'Direction', 'LineName', 'DestinationName', 'ScheduledTime', 'OperatingProfile']; const firstEntry = jsonData[0]; const allColumnsPresent = requiredColumns.every(col => col in firstEntry); if (!allColumnsPresent) { const missingCols = requiredColumns.filter(col => !(col in firstEntry)); alert(`Uploaded .COUNT file is missing expected headers: ${missingCols.join(', ')}.\nExpected: StopID, StopName, Direction, LineName, DestinationName, ScheduledTime, OperatingProfile. Case matters.`); return false; } return true; }
function handleCountFileUpload(event) { const file = event.target.files[0]; if (file) { if (fileStatusElement) fileStatusElement.textContent = `Processing ${file.name}...`; setTimeout(() => { const reader = new FileReader(); reader.onload = function(e) { try { const fileContent = e.target.result; const lines = fileContent.split(/\r?\n/); if (lines.length < 2) { alert("File empty or no data (header + one entry needed)."); if (fileStatusElement) fileStatusElement.textContent = "File processing failed."; if (countFileInput) countFileInput.value = ""; return; } const headers = lines[0].split('\t').map(h => h.trim()); const jsonData = []; for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (line === "") continue; const values = line.split('\t').map(v => v.trim()); if (values.length < headers.length && values.every(v => v === "")) continue; if (values.length < headers.length && values.length > 0) { for(let k = values.length; k < headers.length; k++) { values.push(''); } } let entry = {}; headers.forEach((header, index) => { entry[header] = values[index] !== undefined ? values[index] : ""; }); jsonData.push(entry); } if (isValidScheduleDataFromText(jsonData)) { if (currentWorkingSchedule.length > 0 && !confirm("Replace current working schedule with this file?")) { if (fileStatusElement) fileStatusElement.textContent = "Upload cancelled."; if (countFileInput) countFileInput.value = ""; return; } currentWorkingSchedule = jsonData.map((row, index) => { let scheduledTime = String(row.ScheduledTime || "").trim(); if (scheduledTime.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) { const parts = scheduledTime.split(':'); scheduledTime = `${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}`; } else if (scheduledTime.length === 4 && !scheduledTime.includes(':')) { scheduledTime = `${scheduledTime.substring(0,2)}:${scheduledTime.substring(2,4)}`; } else if (scheduledTime.length === 3 && !scheduledTime.includes(':')) { scheduledTime = `0${scheduledTime.substring(0,1)}:${scheduledTime.substring(1,3)}`; } return { internalId: `${String(row.StopID||'s').trim().toUpperCase()}_${String(row.LineName||'l').trim().toUpperCase()}_${scheduledTime.replace(':','')}_${index}_countfile`, stopID: String(row.StopID || "").trim().toUpperCase(), stopName: String(row.StopName || "").trim(), direction: String(row.Direction || "").trim(), lineName: String(row.LineName || "").trim().toUpperCase(), destinationName: String(row.DestinationName || "").trim(), scheduledTime: scheduledTime, OperatingProfile: String(row.OperatingProfile || "").trim(), DayOffset: String(row.DayOffset || "0").trim() }; }); renderUIDependentElements(); if (fileStatusElement) fileStatusElement.textContent = `${file.name} processed. ${currentWorkingSchedule.length} entries loaded.`; } else { if (fileStatusElement) fileStatusElement.textContent = "File processing failed: Invalid structure/headers."; } } catch (error) { console.error("Error processing .COUNT file:", error); alert(`Error: ${error.message}.`); if (fileStatusElement) fileStatusElement.textContent = "Error loading file."; } if (countFileInput) countFileInput.value = ""; }; reader.onerror = () => { alert("Could not read file."); if (fileStatusElement) fileStatusElement.textContent = "Error reading file."; if (countFileInput) countFileInput.value = ""; }; reader.readAsText(file); }, 50); } }
function handleBulkUpdateStopDetails() { if (!currentUser) { alert("Please log in."); return; } const targetStopID = bulkEditTargetStopIDInput.value.trim().toUpperCase(); const newStopName = bulkEditNewStopNameInput.value.trim(); const newDirection = bulkEditNewDirectionInput.value.trim(); if (!targetStopID) { alert("Target Stop ID required."); bulkEditTargetStopIDInput.focus(); return; } if (!newStopName && !newDirection) { alert("New Stop Name or Direction required."); return; } let updatedCount = 0; currentWorkingSchedule.forEach(entry => { if (entry.stopID && entry.stopID.toUpperCase() === targetStopID) { let entryChanged = false; if (newStopName) { entry.stopName = newStopName; entryChanged = true; } if (newDirection) { entry.direction = newDirection; entryChanged = true; } if (entryChanged) updatedCount++; } }); if (updatedCount > 0) { renderUIDependentElements(); alert(`${updatedCount} entries for Stop ID "${targetStopID}" updated.`); bulkEditNewStopNameInput.value = ''; bulkEditNewDirectionInput.value = ''; displayCurrentDetailsForBulkStopEdit(); } else { alert(`No entries found for Stop ID "${targetStopID}".`); } }
function handleBulkUpdateRouteDestination() { if (!currentUser) { alert("Please log in."); return; } const targetLineName = bulkEditTargetLineNameInput.value.trim().toUpperCase(); const oldDestination = bulkEditOldDestinationInput.value.trim(); const newDestination = bulkEditNewDestinationInput.value.trim(); if (!targetLineName) { alert("Target Line Name required."); bulkEditTargetLineNameInput.focus(); return; } if (!newDestination) { alert("New Destination Name required."); bulkEditNewDestinationInput.focus(); return; } let updatedCount = 0; currentWorkingSchedule.forEach(entry => { if (entry.lineName && entry.lineName.toUpperCase() === targetLineName) { if (oldDestination) { if (entry.destinationName && entry.destinationName.toLowerCase() === oldDestination.toLowerCase()) { entry.destinationName = newDestination; updatedCount++; } } else { entry.destinationName = newDestination; updatedCount++; } } }); if (updatedCount > 0) { renderUIDependentElements(); alert(`${updatedCount} entries for Line "${targetLineName}" updated to "${newDestination}".`); } else { alert(`No entries for Line "${targetLineName}"` + (oldDestination ? ` with Old Destination "${oldDestination}"` : "") + " found."); } }
function displayCurrentDetailsForBulkStopEdit() { const targetStopID = bulkEditTargetStopIDInput.value.trim().toUpperCase(); if (!targetStopID) { currentBulkEditStopNameDisplay.textContent = "-"; currentBulkEditDirectionDisplay.textContent = "-"; return; } const existingEntry = currentWorkingSchedule.find(entry => entry.stopID && entry.stopID.toUpperCase() === targetStopID); if (existingEntry) { currentBulkEditStopNameDisplay.textContent = existingEntry.stopName || "N/A"; currentBulkEditDirectionDisplay.textContent = existingEntry.direction || "N/A"; } else { currentBulkEditStopNameDisplay.textContent = "- Not found -"; currentBulkEditDirectionDisplay.textContent = "- Not found -"; } }

// --- Firebase Data Interaction ---
function handleStageSchedule() { if (!currentUser) { alert("Log in to stage."); return; } if (currentWorkingSchedule.length === 0 && !confirm("Working schedule empty. Stage empty schedule?")) { stagingStatusMessage.textContent = "Staging empty schedule cancelled."; stagingStatusMessage.style.color = "#e74c3c"; return; } let dataToStage = JSON.parse(JSON.stringify(currentWorkingSchedule)); dataToStage.sort((a, b) => { const lineCmp = compareLineNames(a.lineName, b.lineName); if (lineCmp !== 0) return lineCmp; const timeA = (a.scheduledTime || "").replace(':', ''); const timeB = (b.scheduledTime || "").replace(':', ''); const timeCmp = timeA.localeCompare(timeB); if (timeCmp !== 0) return timeCmp; return (a.stopID || "").localeCompare(b.stopID || ""); }); const finalScheduleData = dataToStage.map((entry, index) => ({ ...entry, internalId: entry.internalId || `${entry.stopID.toUpperCase()}_${entry.lineName.toUpperCase()}_${(entry.scheduledTime||"").replace(':','')}_${index}_staged` })); const stopsMap = new Map(); finalScheduleData.forEach(row => { if (row.stopID && !stopsMap.has(row.stopID)) { stopsMap.set(row.stopID, { stopID: row.stopID, stopName: row.stopName, direction: row.direction }); } }); const finalUniqueStops = Array.from(stopsMap.values()).sort((a,b)=>{ const nC=(a.stopName||"").localeCompare(b.stopName||""); return nC!==0?nC:(a.direction||"").localeCompare(b.direction||""); }); if (window.firebaseOMSI) { const { database, dbUpdate, dbRef } = window.firebaseOMSI; const updates = {}; updates[FB_PATH_PENDING_SCHEDULE_DATA] = finalScheduleData; updates[FB_PATH_PENDING_UNIQUE_STOPS] = finalUniqueStops; updates[FB_PATH_PENDING_TIMESTAMP] = new Date().toISOString(); updates[FB_PATH_APPSTATE_STATUS] = 'update_staged'; dbUpdate(dbRef(database), updates) .then(() => { alert("Schedule STAGED to Firebase."); updateStagingStatusDisplay(); }) .catch((e) => { console.error("FB Staging Error: ", e); alert("FB Staging Error. Check console."); if(stagingStatusMessage) { stagingStatusMessage.textContent = "FB Staging Error."; stagingStatusMessage.style.color = "#e74c3c"; } }); } else { alert("Firebase not available."); } }
function handleApplyNow() { if (!currentUser) { alert("Log in to apply."); return; } if (window.firebaseOMSI) { const { database, dbGet, dbUpdate, dbRef, dbChild } = window.firebaseOMSI; dbGet(dbChild(dbRef(database), '/pendingSchedule')) .then((snapshot) => { if (snapshot.exists()) { const pendingData = snapshot.val(); if (!confirm("Apply Firebase staged schedule LIVE NOW?")) { if (stagingStatusMessage) { stagingStatusMessage.textContent = "Apply cancelled."; stagingStatusMessage.style.color = "#e74c3c"; } return; } let liveAllScheduledBusData = Array.isArray(pendingData.allScheduledBusData) ? pendingData.allScheduledBusData.filter(item => item != null) : (typeof pendingData.allScheduledBusData === 'object' && pendingData.allScheduledBusData !== null ? Object.values(pendingData.allScheduledBusData).filter(item => item != null) : []); let liveUniqueBusStops = Array.isArray(pendingData.uniqueBusStops) ? pendingData.uniqueBusStops.filter(item => item != null) : (typeof pendingData.uniqueBusStops === 'object' && pendingData.uniqueBusStops !== null ? Object.values(pendingData.uniqueBusStops).filter(item => item != null) : []); let hasInvalidKey = false; function check(obj, path) { if (typeof obj !== 'object' || obj === null) return; for (const key in obj) { if (/[.#$/\[\]]/.test(key)) { console.error(`INVALID KEY at ${path}: key='${key}'`); hasInvalidKey = true; } if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) { check(obj[key], `${path}.${key}`); } } } liveAllScheduledBusData.forEach((item, i) => { if (typeof item !== 'object' || item === null) { hasInvalidKey = true; return; } check(item, `schedule[${i}]`); }); liveUniqueBusStops.forEach((item, i) => { if (typeof item !== 'object' || item === null) { hasInvalidKey = true; return; } check(item, `stops[${i}]`); }); if (hasInvalidKey) { alert("Invalid keys in data. Cannot apply. Check console."); return; } const liveUpdates = {}; liveUpdates[FB_PATH_LIVE_SCHEDULE_DATA] = liveAllScheduledBusData; liveUpdates[FB_PATH_LIVE_UNIQUE_STOPS] = liveUniqueBusStops; dbUpdate(dbRef(database), liveUpdates) .then(() => { const appUpdates = {}; appUpdates[FB_PATH_APPSTATE_LAST_UPDATED] = new Date().toISOString(); appUpdates[FB_PATH_APPSTATE_STATUS] = 'idle'; appUpdates['/pendingSchedule'] = null; return dbUpdate(dbRef(database), appUpdates); }) .then(() => { alert("Staged schedule APPLIED LIVE!"); updateStagingStatusDisplay(); }) .catch(e => { console.error("FB Apply Error: ", e); alert("FB Apply Error. Check console: " + e.message); }); } else { alert("No Firebase staged schedule to apply."); if (stagingStatusMessage) { stagingStatusMessage.textContent = "No FB staged schedule."; stagingStatusMessage.style.color = "#e74c3c"; } } }).catch(e => { console.error("FB Fetch Pending Error: ", e); alert("FB Fetch Pending Error. Check console: " + e.message); }); } else { alert("Firebase not available."); } }
async function loadInitialData() {
    console.log("Tools: Loading initial data from Firebase...");
    let msg = "Loading data...";
    if (fileStatusElement) fileStatusElement.textContent = msg;
    currentWorkingSchedule = [];
    closedStopIDs = [];
    customRouteColours = {};

    if (!window.firebaseOMSI) {
        msg = "Firebase not connected.";
    } else {
        const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI;
        try {
            const liveSnap = await dbGet(dbChild(dbRef(database), FB_PATH_LIVE_SCHEDULE_DATA));
            if (liveSnap.exists() && Array.isArray(liveSnap.val())) {
                currentWorkingSchedule = liveSnap.val().map((e, i) => ({ ...e, internalId: e.internalId || `${(e.stopID||'s')}_${(e.lineName||'l')}_${(e.scheduledTime||"").replace(':','')}_${i}_fb` }));
            }
            const closedSnap = await dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_CLOSED_STOPS));
            if (closedSnap.exists()) {
                const fbClosed = closedSnap.val();
                for (const id in fbClosed) { if (fbClosed[id] === true) closedStopIDs.push(id); }
            }
            const coloursSnap = await dbGet(dbChild(dbRef(database), FB_PATH_SETTINGS_CUSTOM_COLOURS));
            if (coloursSnap.exists()) customRouteColours = coloursSnap.val();
            msg = `Data loaded from Firebase. ${currentWorkingSchedule.length} entries.`;
        } catch (e) {
            console.error("FB Load Error:", e);
            msg = "FB Load Error. Check console.";
        }
    }
    if (fileStatusElement) fileStatusElement.textContent = msg;
    loadAndApplyCustomRouteColoursForTools();
    renderUIDependentElements(); 
    updateStagingStatusDisplay();
    populateStopStatusSelector();
    fetchBankHolidaysForSetup(); 
}
async function updateStagingStatusDisplay() { let pTime = null; let lTime = null; let fbStatus = "Checking..."; if (window.firebaseOMSI) { const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI; try { const pSnap = await dbGet(dbChild(dbRef(database), FB_PATH_PENDING_TIMESTAMP)); if (pSnap.exists()) pTime = pSnap.val(); const lSnap = await dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_LAST_UPDATED)); if (lSnap.exists()) lTime = lSnap.val(); const sSnap = await dbGet(dbChild(dbRef(database), FB_PATH_APPSTATE_STATUS)); const currentFbSt = sSnap.exists() ? sSnap.val() : 'unknown'; fbStatus = `Firebase status: ${currentFbSt}.`; applyNowButton.disabled = !(currentFbSt === 'update_staged' && pTime); } catch (e) { fbStatus = "FB Status Error."; console.error(fbStatus, e); applyNowButton.disabled = true;} } else { fbStatus = "Firebase not available."; applyNowButton.disabled = true;} let msg = ""; if (pTime && applyNowButton.disabled === false) { msg = `STAGED on: ${new Date(pTime).toLocaleString()}.<br>Ready to 'Apply Staged Live NOW'.`; if(stagingStatusMessage) stagingStatusMessage.style.color = "#2ecc71"; } else { msg = "No schedule staged. Changes can be staged."; if(stagingStatusMessage) stagingStatusMessage.style.color = "#f1c40f"; } msg += lTime ? `<br>LIVE schedule last updated: ${new Date(lTime).toLocaleString()}` : "<br>No LIVE schedule set yet."; msg += `<br><small>(${fbStatus})</small>`; if(stagingStatusMessage) stagingStatusMessage.innerHTML = msg; }
function saveClosedStops() { if (!currentUser) return; if (window.firebaseOMSI) { const { database, dbSet, dbRef } = window.firebaseOMSI; const fbClosed = {}; closedStopIDs.forEach(id => fbClosed[id] = true); dbSet(dbRef(database, FB_PATH_APPSTATE_CLOSED_STOPS), fbClosed) .then(() => dbSet(dbRef(database, FB_PATH_APPSTATE_LAST_UPDATED), new Date().toISOString())) .catch(e => console.error("FB Save Closed Stops Error: ", e)); } }
function saveCustomRouteColours() { if (!currentUser) return; if (window.firebaseOMSI) { const { database, dbSet, dbRef } = window.firebaseOMSI; dbSet(dbRef(database, FB_PATH_SETTINGS_CUSTOM_COLOURS), customRouteColours) .then(() => dbSet(dbRef(database, FB_PATH_APPSTATE_LAST_UPDATED), new Date().toISOString())) .catch(e => console.error("FB Save Colours Error: ", e)); } if (routeColourStatusMessage) { routeColourStatusMessage.textContent = 'Custom colours saved.'; setTimeout(() => { if(routeColourStatusMessage) routeColourStatusMessage.textContent = ''; }, 3000); } loadAndApplyCustomRouteColoursForTools(); if(selectStopForDeparturesView && selectStopForDeparturesView.value) displayDeparturesForSelectedStop(); renderCustomRouteColours(); }

// --- UI Population & Rendering ---
function renderUIDependentElements() {
    populateRouteSelectorForEvents();
    populateStopStatusSelector(); 
    populateRouteSelectorForColours();
    populateStopSelectorForDeparturesView(); 
    renderCustomRouteColours();
    
    if (document.getElementById('stop-management-tool-section') && document.getElementById('stop-management-tool-section').style.display === 'block') {
        populateMasterStopList_SM();
        populateRoutesForStopSelector_SM(); 
    }
}

function populateRouteSelectorForEvents() { if (!selectEventRoute) return; const currentVal = selectEventRoute.value; selectEventRoute.innerHTML = '<option value="">-- Select Route --</option>'; const uniqueLines = [...new Set(currentWorkingSchedule.map(e => e.lineName))].sort(compareLineNames); uniqueLines.forEach(ln => { if (ln) { const opt = document.createElement('option'); opt.value = ln; opt.textContent = ln; selectEventRoute.appendChild(opt); } }); selectEventRoute.value = uniqueLines.includes(currentVal) ? currentVal : ""; populateImpactStopSelector(); }
function populateImpactStopSelector() { if (!selectEventImpactStop || !selectEventRoute) return; const selRoute = selectEventRoute.value; const currentVal = selectEventImpactStop.value; selectEventImpactStop.innerHTML = '<option value="">-- Route Wide --</option>'; if (selRoute) { const stops = currentWorkingSchedule.filter(e => e.lineName === selRoute).map(e => ({ id: e.stopID, name: e.stopName, time: e.scheduledTime })).sort((a,b) => (a.time||"").localeCompare(b.time||"")); const uniqueStops = []; const seen=new Set(); stops.forEach(s => { if (s.id && !seen.has(s.id)) { uniqueStops.push(s); seen.add(s.id); }}); uniqueStops.forEach(s => { const opt = document.createElement('option'); opt.value = s.id; opt.textContent = `${s.stopName || s.id} (${s.id})`; selectEventImpactStop.appendChild(opt); }); selectEventImpactStop.value = seen.has(currentVal) ? currentVal : ""; } } // Changed textContent to include stopName
async function populateStopStatusSelector() { if (!selectStopForStatusChange || !window.firebaseOMSI) return; const currentVal = selectStopForStatusChange.value; selectStopForStatusChange.innerHTML = '<option value="">-- Select Stop --</option>'; const { database, dbGet, dbRef, dbChild } = window.firebaseOMSI; try { const snap = await dbGet(dbChild(dbRef(database), FB_PATH_LIVE_UNIQUE_STOPS)); let stops = []; if (snap.exists() && Array.isArray(snap.val()) && snap.val().length > 0) { stops = snap.val(); } else { stops = getUniqueStopsFromSchedule(); } stops.sort((a,b) => (a.stopName||"").localeCompare(b.stopName||"")); stops.forEach(s => { if(!s || !s.stopID) return; const opt = document.createElement('option'); opt.value = s.stopID; const isClosed = closedStopIDs.includes(s.stopID); opt.textContent = `${s.stopName||s.stopID} (${s.stopID})${isClosed?' (Closed)':''}`; selectStopForStatusChange.appendChild(opt); }); selectStopForStatusChange.value = currentVal && stops.find(s => s && s.stopID === currentVal) ? currentVal : ""; } catch (e) {console.error("Error populating stop status selector", e)} }
function handleStopStatusChange(action) { if (!currentUser) return; const stopID = selectStopForStatusChange.value; if (!stopID) { stopStatusMessage.textContent = "Select a stop."; return; } const idx = closedStopIDs.indexOf(stopID); const name = selectStopForStatusChange.options[selectStopForStatusChange.selectedIndex].text.split(' (')[0]; if (action === 'close') { if (idx === -1) { closedStopIDs.push(stopID); stopStatusMessage.textContent = `Stop '${name}' closed.`; } else { stopStatusMessage.textContent = `Stop '${name}' already closed.`; } } else if (action === 'reopen') { if (idx !== -1) { closedStopIDs.splice(idx, 1); stopStatusMessage.textContent = `Stop '${name}' reopened.`; } else { stopStatusMessage.textContent = `Stop '${name}' not closed.`; } } saveClosedStops(); populateStopStatusSelector(); }

// MODIFIED: applyRandomEvent to be non-destructive and use predefined events
function applyRandomEvent() {
    if (!currentUser) { 
        eventStatusMessage.textContent = "Please log in."; 
        eventStatusMessage.style.color = '#e74c3c';
        return; 
    }
    const selRoute = selectEventRoute.value;
    const impactStopID = selectEventImpactStop.value;
    const selectedStopName = impactStopID ? (selectEventImpactStop.options[selectEventImpactStop.selectedIndex].text.split(' (')[0] || impactStopID) : "Route Wide";

    if (!selRoute) {
        eventStatusMessage.textContent = "Please select a route.";
        eventStatusMessage.style.color = '#e74c3c';
        return;
    }

    // Define specific, named events. You need to customize these with your actual curtailment points (stop names and IDs).
    const predefinedEvents = [
        { 
            name: `Severe Delays on Route ${selRoute}`, 
            type: "LOG_DELAY_ROUTE", 
            baseDetails: `Route ${selRoute} is experiencing severe delays (simulated +%DELAY% mins) due to a major incident.`,
            minDelay: 15, maxDelay: 20
        },
        { 
            name: `Minor Delays on ${selRoute} from ${selectedStopName || 'selected stop'}`, 
            type: "LOG_DELAY_FROM_STOP", 
            condition: !!impactStopID, // Event only makes sense if a stop is selected
            baseDetails: `Route ${selRoute} is experiencing minor delays (simulated +%DELAY% mins) from stop ${selectedStopName || '%STOP%'} onwards due to congestion.`,
            minDelay: 5, maxDelay: 10,
            appliesToStopID: impactStopID 
        },
        {
            name: `Route ${selRoute} Curtailed to Edgware Station`, // Example: Specific curtailment
            type: "LOG_CURTAIL",
            curtailToStopName: "Edgware Station", 
            // IMPORTANT: Add actual StopID for "Edgware Station" if you want to use it programmatically later
            // curtailToStopID: "EDGWS", // Example, replace with actual ID from your data
            baseDetails: `Route ${selRoute} services are now terminating at Edgware Station due to an obstruction. (Simulated)`
        },
        {
            name: `Route ${selRoute} Curtailed to Mill Hill Broadway`, // Example: Specific curtailment
            type: "LOG_CURTAIL",
            curtailToStopName: "Mill Hill Broadway",
            // curtailToStopID: "MHBRWY", // Example, replace with actual ID from your data
            baseDetails: `Route ${selRoute} services are now terminating at Mill Hill Broadway due to a signal failure. (Simulated)`
        }
        // Add more predefined events here.
        // For curtailments, ensure 'curtailToStopName' is meaningful.
        // 'curtailToStopID' would be useful if you wanted to do more advanced checks later.
    ];

    let applicableEvents = predefinedEvents.filter(event => {
        if (event.condition !== undefined && !event.condition) return false;
        // For route-specific events (like the examples above), ensure the event.name template matches the selected route.
        // This is implicitly handled by the event.name template including selRoute.
        // A more robust check might be needed if names are not templated like this.
        return true;
    });
    
    if (applicableEvents.length === 0) {
        eventStatusMessage.textContent = "No predefined applicable events for this selection.";
        eventStatusMessage.style.color = '#f1c40f';
        return;
    }

    const choice = applicableEvents[Math.floor(Math.random() * applicableEvents.length)];
    let eventDetailsText = choice.baseDetails || choice.name; // Use baseDetails if available

    switch (choice.type) {
        case "LOG_DELAY_ROUTE":
        case "LOG_DELAY_FROM_STOP":
            const delay = Math.floor(Math.random() * (choice.maxDelay - choice.minDelay + 1)) + choice.minDelay;
            eventDetailsText = eventDetailsText.replace('%DELAY%', delay);
            if (choice.type === "LOG_DELAY_FROM_STOP" && choice.appliesToStopID !== impactStopID && impactStopID) {
                 // This event was for a specific stop, but the selected impact stop is different
                 // This scenario should ideally be filtered out by applicableEvents if logic is precise.
                 // For now, just log as is, or add a note.
                 console.warn(`Delay from stop event triggered but selected impact stop (${selectedStopName}) might not match event's intended stop if it was hardcoded.`);
            }
            eventDetailsText = eventDetailsText.replace('%STOP%', selectedStopName || 'the specified stop');
            break;
        case "LOG_CURTAIL":
            // eventDetailsText is already set from choice.baseDetails
            // You could add more dynamic info here if needed, e.g.,
            // "Original destination was X, now Y."
            break;
        default:
            console.warn("Unknown event type in predefinedEvents:", choice.type);
    }

    eventStatusMessage.textContent = `SIMULATED EVENT: ${eventDetailsText}`;
    eventStatusMessage.style.color = '#3498db'; // Blue for simulated info
}


function loadAndApplyCustomRouteColoursForTools() { effectiveRouteColourMapTools = { ...initialRouteColourMapForTools, ...customRouteColours }; }
function renderCustomRouteColours() { if (!currentRouteColoursList || !noCustomColoursMessage) return; currentRouteColoursList.innerHTML = ''; const routes = [...new Set(currentWorkingSchedule.map(e => e.lineName))].filter(n => n && n.trim() !== "").sort(compareLineNames); if (routes.length === 0) { noCustomColoursMessage.textContent = 'No routes in working schedule.'; noCustomColoursMessage.style.display = 'block'; return; } noCustomColoursMessage.style.display = 'none'; routes.forEach(rName => { const upName = rName.toUpperCase(); const isCustom = customRouteColours.hasOwnProperty(upName); const color = isCustom ? customRouteColours[upName] : DEFAULT_ROUTE_COLOUR_TOOLS; const li = document.createElement('li'); const box = document.createElement('span'); box.className = 'colour-preview-box'; box.style.backgroundColor = color; const info = document.createElement('span'); info.className = 'route-info'; info.innerHTML = `Route: ${rName} - Colour: ${color.toUpperCase()}${isCustom?"":` <small style="opacity:0.7;">(Default)</small>`}`; const actions = document.createElement('div'); actions.style.marginLeft = 'auto'; if (isCustom) { const btn = document.createElement('button'); btn.textContent = 'Remove'; btn.classList.add('button','small-action','secondary'); btn.onclick=()=>handleRemoveRouteColour(upName); actions.appendChild(btn); } li.appendChild(box); li.appendChild(info); li.appendChild(actions); currentRouteColoursList.appendChild(li); }); }
function populateRouteSelectorForColours() { if (!selectRouteNameColour) return; const currentVal = selectRouteNameColour.value; selectRouteNameColour.innerHTML = '<option value="">-- Select Route --</option>'; const lines = [...new Set(currentWorkingSchedule.map(e => e.lineName))].filter(n => n && n.trim() !== "").sort(compareLineNames); lines.forEach(ln => { const opt = document.createElement('option'); opt.value = ln; opt.textContent = ln; selectRouteNameColour.appendChild(opt); }); if (lines.includes(currentVal)) selectRouteNameColour.value = currentVal; selectRouteNameColour.dispatchEvent(new Event('change')); }
function handleSaveRouteColour() { if (!currentUser) return; if (!selectRouteNameColour || !inputRouteColour || !routeColourStatusMessage) return; const rName = selectRouteNameColour.value; const color = inputRouteColour.value; if (!rName) { routeColourStatusMessage.textContent = 'Select route name.'; routeColourStatusMessage.style.color = '#e74c3c'; return; } if (!color.match(/^#[0-9a-fA-F]{6}$/)) { routeColourStatusMessage.textContent = 'Invalid hex colour (e.g., #RRGGBB).'; routeColourStatusMessage.style.color = '#e74c3c'; return; } customRouteColours[rName.toUpperCase()] = color.toUpperCase(); saveCustomRouteColours(); }
function handleRemoveRouteColour(key) { if (!currentUser) return; if (customRouteColours.hasOwnProperty(key) && confirm(`Remove custom colour for route ${key}?`)) { delete customRouteColours[key]; saveCustomRouteColours(); if (selectRouteNameColour.value.toUpperCase() === key) inputRouteColour.value = DEFAULT_ROUTE_COLOUR_TOOLS; } }
function getRouteTileColourForTools(lineName) { const upName = String(lineName||"").toUpperCase(); if(effectiveRouteColourMapTools[upName]) return effectiveRouteColourMapTools[upName]; if(upName.startsWith("N")) return effectiveRouteColourMapTools["N5"]||DEFAULT_ROUTE_COLOUR_TOOLS; if(upName.startsWith("SL")) return effectiveRouteColourMapTools["SL1"]||DEFAULT_ROUTE_COLOUR_TOOLS; return DEFAULT_ROUTE_COLOUR_TOOLS;}
function getTextColourForBackgroundTools(hex) { if(!hex||hex.length<7)return'#FFFFFF'; const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return((0.299*r+0.587*g+0.114*b)/255)>0.5?'#000000':'#FFFFFF';}
function getDaySortOrder(profile) { if(!profile)return 99;const p=profile.toUpperCase().split(',').map(s=>s.trim());if(p.some(s=>s.startsWith("MO")&&!s.startsWith("MO-FR")))return 1;if(p.some(s=>s.startsWith("TU")))return 2;if(p.some(s=>s.startsWith("WE")))return 3;if(p.some(s=>s.startsWith("TH")))return 4;if(p.some(s=>s.startsWith("FR")&&!s.startsWith("MO-FR")))return 5;if(p.some(s=>s.startsWith("MF")||s.startsWith("MO-FR")))return 6;if(p.some(s=>s.startsWith("SA")))return 7;if(p.some(s=>s.startsWith("SU")))return 8;if(p.includes("GOODFRIDAY"))return 10;if(p.includes("BANKHOLIDAY"))return 11; return 99;}
function populateStopSelectorForDeparturesView() { if (!selectStopForDeparturesView) return; const currentVal = selectStopForDeparturesView.value; selectStopForDeparturesView.innerHTML = '<option value="">-- Select Stop --</option>'; if (currentWorkingSchedule.length === 0) { displayDeparturesForSelectedStop(); return; } const stopsMap = new Map(); currentWorkingSchedule.forEach(e => { if (e.stopID && !stopsMap.has(e.stopID)) stopsMap.set(e.stopID, { stopID: e.stopID, stopName: e.stopName || e.stopID }); }); const sorted = Array.from(stopsMap.values()).sort((a,b)=>(a.stopName.toLowerCase()).localeCompare(b.stopName.toLowerCase())); sorted.forEach(s => { const opt = document.createElement('option'); opt.value = s.stopID; opt.textContent = `${s.stopName} (${s.stopID})`; selectStopForDeparturesView.appendChild(opt); }); if (stopsMap.has(currentVal)) selectStopForDeparturesView.value = currentVal; displayDeparturesForSelectedStop(); }

function displayDeparturesForSelectedStop() {
    if (!selectStopForDeparturesView || !stopDeparturesList || !noDeparturesForStopMessage) return;
    const selStopID = selectStopForDeparturesView.value;
    stopDeparturesList.innerHTML = '';

    if (!selStopID) {
        noDeparturesForStopMessage.textContent = 'Select stop to view.';
        noDeparturesForStopMessage.style.display = 'block';
        return;
    }

    const deps = currentWorkingSchedule
        .filter(e => e.stopID === selStopID)
        .sort((a, b) => {
            // 1. Primary Sort: DayOffset (0 before 1)
            const offsetA = parseInt(a.DayOffset || "0", 10);
            const offsetB = parseInt(b.DayOffset || "0", 10);
            if (offsetA !== offsetB) return offsetA - offsetB;

            // 2. Secondary Sort: Profile Day Order (using existing getDaySortOrder)
            const dayA = getDaySortOrder(a.OperatingProfile);
            const dayB = getDaySortOrder(b.OperatingProfile);
            if (dayA !== dayB) return dayA - dayB;
            
            // 3. Tertiary Sort: Scheduled Time
            const timeA = (a.scheduledTime || "9999").replace(':', '');
            const timeB = (b.scheduledTime || "9999").replace(':', '');
            if (timeA !== timeB) return timeA.localeCompare(timeB);

            // 4. Quaternary Sort: Line Name
            const lineComp = compareLineNames(a.lineName, b.lineName);
            if (lineComp !== 0) return lineComp;

            // 5. Final Sort: Full OperatingProfile string
            return (a.OperatingProfile || "").localeCompare(b.OperatingProfile || "");
        });

    if (deps.length === 0) {
        noDeparturesForStopMessage.textContent = 'No departures for this stop.';
        noDeparturesForStopMessage.style.display = 'block';
    } else {
        noDeparturesForStopMessage.style.display = 'none';
        deps.forEach(d => {
            const li = document.createElement('li');
            const tile = document.createElement('span');
            tile.className = 'route-tile-tools-list';
            tile.textContent = d.lineName || 'N/A';
            const bg = getRouteTileColourForTools(d.lineName);
            tile.style.backgroundColor = bg;
            tile.style.color = getTextColourForBackgroundTools(bg);
            
            const span = document.createElement('span');
            span.innerHTML = ` to ${d.destinationName || 'Unknown'} <strong style="margin-left:0.5em;">at ${d.scheduledTime || 'N/A'}</strong> <small style="opacity:0.7;margin-left:0.75em;">(Profile: ${d.OperatingProfile || 'N/A'})</small>${d.DayOffset && d.DayOffset !== "0" ? `<small style="opacity:0.7;margin-left:0.3em;color:#FFD700;">(+${d.DayOffset}d)</small>` : ''}`;
            
            li.appendChild(tile);
            li.appendChild(span);
            stopDeparturesList.appendChild(li);
        });
    }
}

// --- Stop Management Tool Functions ---
function getUniqueStopsFromSchedule() { 
    if (!currentWorkingSchedule || currentWorkingSchedule.length === 0) return [];
    const stopsMap = new Map();
    for (let i = currentWorkingSchedule.length - 1; i >= 0; i--) {
        const entry = currentWorkingSchedule[i];
        if (entry.stopID && !stopsMap.has(entry.stopID.toUpperCase())) {
            stopsMap.set(entry.stopID.toUpperCase(), {
                stopID: entry.stopID.toUpperCase(),
                stopName: entry.stopName || "Unknown Name",
                direction: entry.direction || "No Direction"
            });
        }
    }
    return Array.from(stopsMap.values()).sort((a, b) => (a.stopName.toLowerCase()).localeCompare(b.stopName.toLowerCase()));
}

function populateMasterStopList_SM() {
    if (!masterStopListUL_SM || !masterStopListStatus_SM) return;
    uniqueStopsMasterList_SM = getUniqueStopsFromSchedule();
    const filterText = masterStopListFilterInput_SM.value.toLowerCase();
    masterStopListUL_SM.innerHTML = '';
    let displayedCount = 0;

    if (uniqueStopsMasterList_SM.length === 0) {
        masterStopListStatus_SM.textContent = 'No unique stops found in the current working schedule.';
        return;
    }

    uniqueStopsMasterList_SM.forEach(stop => {
        if (!stop || !stop.stopID) return;
        const matchesFilter = !filterText ||
                            (stop.stopID && stop.stopID.toLowerCase().includes(filterText)) ||
                            (stop.stopName && stop.stopName.toLowerCase().includes(filterText)) ||
                            (stop.direction && stop.direction.toLowerCase().includes(filterText));

        if (matchesFilter) {
            displayedCount++;
            const li = document.createElement('li');
            li.innerHTML = `<span class="stop-id-master">${stop.stopID}</span><br>
                            <span class="stop-name-master">${stop.stopName}</span><br>
                            <span class="stop-direction-master">Towards: ${stop.direction}</span>`;
            li.dataset.stopid = stop.stopID;
            li.dataset.stopname = stop.stopName;
            li.dataset.direction = stop.direction;
            masterStopListUL_SM.appendChild(li);
        }
    });

    if (displayedCount === 0 && uniqueStopsMasterList_SM.length > 0) {
        masterStopListStatus_SM.textContent = 'No stops match your filter.';
    } else {
        masterStopListStatus_SM.textContent = `Showing ${displayedCount} of ${uniqueStopsMasterList_SM.length} unique stops.`;
    }
}

function handleFindReplaceStopIdInSchedule_SM() {
    if (!currentUser) { alert("Please log in."); return; }
    const findStopID = findStopIdScheduleInput_SM.value.trim().toUpperCase();
    const replaceStopID = replaceStopIdScheduleInput_SM.value.trim().toUpperCase();

    if (!findStopID || !replaceStopID) {
        findReplaceStatusMessage_SM.textContent = "Both 'Stop ID to Find' and 'Replace with New Stop ID' are required.";
        findReplaceStatusMessage_SM.style.color = '#e74c3c';
        return;
    }
    if (findStopID === replaceStopID) {
        findReplaceStatusMessage_SM.textContent = "Find and Replace Stop IDs cannot be the same.";
        findReplaceStatusMessage_SM.style.color = '#f1c40f';
        return;
    }

    if (!confirm(`Are you sure you want to replace ALL occurrences of Stop ID "${findStopID}" with "${replaceStopID}" in the working schedule? This action cannot be undone easily.`)) {
        findReplaceStatusMessage_SM.textContent = "Find and replace operation cancelled.";
        findReplaceStatusMessage_SM.style.color = '#7f8c8d';
        return;
    }

    let replacedCount = 0;
    let newNameForReplaced = "";
    let newDirectionForReplaced = "";
    const existingNewStopEntry = currentWorkingSchedule.find(e => e.stopID.toUpperCase() === replaceStopID);
    if (existingNewStopEntry) {
        newNameForReplaced = existingNewStopEntry.stopName;
        newDirectionForReplaced = existingNewStopEntry.direction;
    } else {
        console.warn(`Details for new Stop ID "${replaceStopID}" not found in schedule. Names/directions for replaced entries might be inconsistent if not updated separately.`);
    }

    currentWorkingSchedule.forEach(entry => {
        if (entry.stopID && entry.stopID.toUpperCase() === findStopID) {
            entry.stopID = replaceStopID;
            if (newNameForReplaced) entry.stopName = newNameForReplaced;
            if (newDirectionForReplaced) entry.direction = newDirectionForReplaced;
            replacedCount++;
        }
    });

    if (replacedCount > 0) {
        renderUIDependentElements();
        findReplaceStatusMessage_SM.textContent = `Replaced ${replacedCount} occurrences of "${findStopID}" with "${replaceStopID}".`;
        if (newNameForReplaced || newDirectionForReplaced) {
            findReplaceStatusMessage_SM.textContent += ` Name/Direction for "${replaceStopID}" set to: "${newNameForReplaced || '(unchanged)'}" / "${newDirectionForReplaced || '(unchanged)'}".`;
        }
        findReplaceStatusMessage_SM.style.color = '#2ecc71';
        findStopIdScheduleInput_SM.value = '';
        replaceStopIdScheduleInput_SM.value = '';
    } else {
        findReplaceStatusMessage_SM.textContent = `No occurrences of Stop ID "${findStopID}" found in the working schedule.`;
        findReplaceStatusMessage_SM.style.color = '#f1c40f';
    }
}

function populateRoutesForStopSelector_SM() {
    if (!routesForStopSelect_SM) return;
    const currentVal = routesForStopSelect_SM.value;
    routesForStopSelect_SM.innerHTML = '<option value="">-- Select Stop --</option>';
    const uniqueStops = getUniqueStopsFromSchedule();

    if (uniqueStops.length === 0) {
        if (routesServingStopStatus_SM) routesServingStopStatus_SM.textContent = 'No stops in working schedule to select from.';
        displayRoutesServingSelectedStop_SM();
        return;
    }

    uniqueStops.forEach(stop => {
        const opt = document.createElement('option');
        opt.value = stop.stopID;
        opt.textContent = `${stop.stopName} (${stop.stopID})`;
        routesForStopSelect_SM.appendChild(opt);
    });

    if (uniqueStops.find(s => s.stopID === currentVal)) {
        routesForStopSelect_SM.value = currentVal;
    }
    displayRoutesServingSelectedStop_SM();
}

function displayRoutesServingSelectedStop_SM() {
    if (!routesForStopSelect_SM || !routesServingStopList_SM || !routesServingStopStatus_SM) return;
    const selectedStopID = routesForStopSelect_SM.value; 
    routesServingStopList_SM.innerHTML = ''; 

    if (!selectedStopID) {
        routesServingStopStatus_SM.textContent = 'Select a stop to view its serving routes.';
        return;
    }

    const servingRoutes = new Set();
    currentWorkingSchedule.forEach(entry => {
        if (entry.stopID.toUpperCase() === selectedStopID.toUpperCase() && entry.lineName) { 
            servingRoutes.add(entry.lineName);
        }
    });

    const sortedRoutes = Array.from(servingRoutes).sort(compareLineNames);

    if (sortedRoutes.length === 0) {
        routesServingStopStatus_SM.textContent = `No routes found serving stop ${selectedStopID} in the current schedule.`;
    } else {
        routesServingStopStatus_SM.textContent = `Serving routes for ${selectedStopID}:`; 
        sortedRoutes.forEach(lineName => {
            const li = document.createElement('li'); 
            const tile = document.createElement('span');
            tile.className = 'route-tile-tools-list';
            tile.textContent = lineName;
            const bgColor = getRouteTileColourForTools(lineName);
            tile.style.backgroundColor = bgColor;
            tile.style.color = getTextColourForBackgroundTools(bgColor);
            
            li.appendChild(tile);
            routesServingStopList_SM.appendChild(li);
        });
    }
}

// --- Event Listeners & Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    if (adminLoginSection) adminLoginSection.style.display = 'block';
    if (currentProfileDisplayContainer) currentProfileDisplayContainer.style.display = 'none';
    if (topMenuBar) topMenuBar.style.display = 'none';
    hideAllToolSections();

    const allMainMenuButtons = document.querySelectorAll('#main-menu-buttons .menu-button');
    allMainMenuButtons.forEach(button => {
        button.addEventListener('click', () => {
            const sectionId = button.getAttribute('data-section');
            if (currentUser) showSection(sectionId);
        });
    });

    if(detectDuplicatesButton) detectDuplicatesButton.addEventListener('click', detectDuplicateEntries);

    if (window.firebaseOMSI && window.firebaseOMSI.auth) {
        const { auth, authOnAuthStateChanged, authSignInWithEmailAndPassword, authSignOut } = window.firebaseOMSI;
        authOnAuthStateChanged(auth, (user) => {
            updateAuthUI(user);
            if (user) {
                console.log("Firebase: User is signed in.");
                fetchBankHolidaysForSetup().then(() => {
                    loadInitialData(); 
                }).catch(error => {
                    console.error("Failed to fetch bank holidays, proceeding with data load.", error);
                    loadInitialData();
                });
            } else {
                console.log("Firebase: User is signed out.");
                currentWorkingSchedule = [];
                renderUIDependentElements(); 
                updateStagingStatusDisplay();
                if (currentProfileDisplayElement) currentProfileDisplayElement.textContent = "Today's Auto Profile: (determining...)";
            }
        });
        if (loginButton) { loginButton.addEventListener('click', (event) => { event.preventDefault(); const email = inputEmail.value; const password = inputPassword.value; if(authStatus) authStatus.textContent = 'Logging in...'; authSignInWithEmailAndPassword(auth, email, password) .catch((error) => { console.error("Login Error:", error); if(authStatus) authStatus.textContent = `Login Error: ${error.message}`; }); }); }
        if (logoutButton) { logoutButton.addEventListener('click', () => { localStorage.removeItem(LOCAL_STORAGE_ACTIVE_SECTION_KEY); authSignOut(auth).catch((e) => console.error("Sign-out Error:", e)); }); }
    } else { console.warn("Firebase Auth not available."); updateAuthUI(null); }

    if (stageScheduleButton) stageScheduleButton.addEventListener('click', handleStageSchedule);
    if (applyNowButton) applyNowButton.addEventListener('click', handleApplyNow);
    if (viewArrivalsButton) viewArrivalsButton.addEventListener('click', () => { window.location.href = "omsi_arrivals.html"; });
    if (countFileInput) countFileInput.addEventListener('change', handleCountFileUpload);
    
    if(bulkEditTargetStopIDInput) { bulkEditTargetStopIDInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); displayCurrentDetailsForBulkStopEdit(); }); bulkEditTargetStopIDInput.addEventListener('blur', displayCurrentDetailsForBulkStopEdit); }
    if(bulkEditTargetLineNameInput) { bulkEditTargetLineNameInput.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); }); }
    if(bulkUpdateDetailsButton) bulkUpdateDetailsButton.addEventListener('click', handleBulkUpdateStopDetails);
    if(bulkUpdateRouteDestinationButton) bulkUpdateRouteDestinationButton.addEventListener('click', handleBulkUpdateRouteDestination);
    if (selectEventRoute) selectEventRoute.addEventListener('change', populateImpactStopSelector);
    if (triggerEventButton) triggerEventButton.addEventListener('click', applyRandomEvent);
    if (closeStopButton) closeStopButton.addEventListener('click', () => handleStopStatusChange('close'));
    if (reopenStopButton) reopenStopButton.addEventListener('click', () => handleStopStatusChange('reopen'));
    if (saveRouteColourButton) saveRouteColourButton.addEventListener('click', handleSaveRouteColour);
    if (selectRouteNameColour) { selectRouteNameColour.addEventListener('change', () => { const selectedRoute = selectRouteNameColour.value; if (selectedRoute && customRouteColours[selectedRoute.toUpperCase()]) { inputRouteColour.value = customRouteColours[selectedRoute.toUpperCase()]; } else { inputRouteColour.value = DEFAULT_ROUTE_COLOUR_TOOLS; } }); }
    if (selectStopForDeparturesView) { selectStopForDeparturesView.addEventListener('change', displayDeparturesForSelectedStop); }

    if (refreshMasterStopListButton_SM) refreshMasterStopListButton_SM.addEventListener('click', populateMasterStopList_SM);
    if (masterStopListFilterInput_SM) masterStopListFilterInput_SM.addEventListener('input', populateMasterStopList_SM);
    if (findStopIdScheduleInput_SM) findStopIdScheduleInput_SM.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
    if (replaceStopIdScheduleInput_SM) replaceStopIdScheduleInput_SM.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
    if (findReplaceStopIdScheduleButton_SM) findReplaceStopIdScheduleButton_SM.addEventListener('click', handleFindReplaceStopIdInSchedule_SM);
    if (routesForStopSelect_SM) routesForStopSelect_SM.addEventListener('change', displayRoutesServingSelectedStop_SM);
    if (refreshRoutesForStopSelectButton_SM) refreshRoutesForStopSelectButton_SM.addEventListener('click', populateRoutesForStopSelector_SM);

    fetchBankHolidaysForSetup();
});
</script>
</body>
</html>
